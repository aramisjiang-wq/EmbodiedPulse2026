# Bç«™æ’­æ”¾é‡é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## ğŸ” é—®é¢˜è¯Šæ–­ç»“æœ

### æ•°æ®åº“é…ç½® âœ…
- ä½¿ç”¨ PostgreSQLï¼š`postgresql://embodied_user:...@localhost:5432/embodied_pulse`
- æ•°æ®åº“è¿æ¥æ­£å¸¸
- æ•°æ®å…³è”æ­£å¸¸ï¼ˆæ— å­¤ç«‹è§†é¢‘ï¼‰

### æ’­æ”¾é‡æ•°æ® âŒ
**æ‰€æœ‰è§†é¢‘çš„æ’­æ”¾é‡éƒ½ä¸ä¸€è‡´ï¼**

| è§†é¢‘BVå· | æ•°æ®åº“æ’­æ”¾é‡ | Bç«™å®é™…æ’­æ”¾é‡ | å·®å¼‚ |
|---------|------------|------------|------|
| BV1L8qEBKEFW | 5,530 | 228,277 | **222,747** |
| BV1bSq3BuER6 | 35,778 | 38,194 | 2,416 |
| BV1omqhB3EX1 | 28,220 | 29,592 | 1,372 |
| BV14fm1B4EJ6 | 50,117 | 53,459 | 3,342 |
| BV13vmjBnE9S | 60,964 | 65,164 | 4,200 |

**æ›´æ–°æ—¶é—´ï¼š** 2025-12-18 17:17:54ï¼ˆæ˜¨å¤©ï¼‰

## ğŸ› é—®é¢˜æ ¹æº

### 1. æ’­æ”¾é‡æ›´æ–°é€»è¾‘é—®é¢˜

**ä»£ç ä½ç½®ï¼š** `fetch_bilibili_data.py:188-193`

**åŸä»£ç ï¼š**
```python
play_raw = video_data.get('play', 0) or 0
if play_raw > 0:
    # åªæœ‰æ’­æ”¾é‡å¤§äº0æ—¶æ‰æ›´æ–°
    video.play = play_raw
    video.play_formatted = format_number(play_raw)
```

**é—®é¢˜ï¼š**
- åªæ›´æ–°å¤§äº0çš„æ’­æ”¾é‡
- å¦‚æœAPIè¿”å›0æˆ–ç¼ºå¤±ï¼Œä¸æ›´æ–°
- å¯¼è‡´æ’­æ”¾é‡æ•°æ®è¿‡æ—¶

**å·²ä¿®å¤ï¼š**
```python
# âœ… ä¿®å¤ï¼šæ€»æ˜¯æ›´æ–°æ’­æ”¾é‡ï¼ˆå¦‚æœAPIè¿”å›äº†æ•°æ®ï¼‰
if 'play' in video_data and video_data['play'] is not None:
    video.play = play_raw
    video.play_formatted = format_number(play_raw)
```

### 2. APIæ•°æ®è·å–é—®é¢˜

**é—®é¢˜ï¼š**
- `fetch_bilibili_data.py` é€šè¿‡UPä¸»è§†é¢‘åˆ—è¡¨APIè·å–æ•°æ®
- è¯¥APIå¯èƒ½è¿”å›ä¸å®Œæ•´çš„æ’­æ”¾é‡æ•°æ®ï¼ˆå—é£æ§é™åˆ¶ï¼‰
- éœ€è¦ç›´æ¥è°ƒç”¨è§†é¢‘è¯¦æƒ…APIè·å–å‡†ç¡®çš„æ’­æ”¾é‡

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨ä¸“é—¨çš„æ’­æ”¾é‡æ›´æ–°è„šæœ¬ `scripts/update_video_play_counts.py`
- è¯¥è„šæœ¬ç›´æ¥è°ƒç”¨ `https://api.bilibili.com/x/web-interface/view` è·å–æ¯ä¸ªè§†é¢‘çš„æ’­æ”¾é‡
- æ›´å‡†ç¡®ã€æ›´å¯é 

## ğŸ”§ ä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šæ‹‰å–æœ€æ–°ä»£ç 

```bash
cd /srv/EmbodiedPulse2026
git pull origin main
```

### æ­¥éª¤2ï¼šæ›´æ–°æ’­æ”¾é‡æ•°æ®

**æ–¹å¼1ï¼šä½¿ç”¨ä¸“é—¨çš„æ’­æ”¾é‡æ›´æ–°è„šæœ¬ï¼ˆæ¨èï¼‰**

```bash
bash scripts/update_all_play_counts.sh
```

æˆ–è€…ç›´æ¥è¿è¡Œï¼š

```bash
python3 scripts/update_video_play_counts.py --force-update
```

**æ–¹å¼2ï¼šä½¿ç”¨fetch_bilibili_data.pyï¼ˆå·²ä¿®å¤é€»è¾‘ï¼‰**

```bash
python3 fetch_bilibili_data.py --fetch-all
```

### æ­¥éª¤3ï¼šéªŒè¯æ›´æ–°ç»“æœ

```bash
bash scripts/check_bilibili_play_counts.sh
```

### æ­¥éª¤4ï¼šæ£€æŸ¥APIè¿”å›æ•°æ®

```bash
bash scripts/check_api_vs_database.sh
```

## ğŸ“‹ ä¿®å¤åçš„éªŒè¯

### é¢„æœŸç»“æœ

1. **æ’­æ”¾é‡æ•°æ®æ›´æ–°ï¼š**
   - æ‰€æœ‰è§†é¢‘çš„æ’­æ”¾é‡åº”è¯¥å’ŒBç«™å®é™…æ’­æ”¾é‡ä¸€è‡´
   - å·®å¼‚åº”è¯¥åœ¨åˆç†èŒƒå›´å†…ï¼ˆ< 1000ï¼‰

2. **æ›´æ–°æ—¶é—´æ›´æ–°ï¼š**
   - `updated_at` å­—æ®µåº”è¯¥æ˜¯æœ€æ–°çš„æ—¶é—´æˆ³

3. **APIè¿”å›æ•°æ®ï¼š**
   - APIè¿”å›çš„æ’­æ”¾é‡åº”è¯¥å’Œæ•°æ®åº“ä¸€è‡´

### éªŒè¯å‘½ä»¤

```bash
# 1. æ£€æŸ¥æ’­æ”¾é‡æ˜¯å¦æ›´æ–°
bash scripts/check_bilibili_play_counts.sh

# 2. æ£€æŸ¥APIè¿”å›æ•°æ®
bash scripts/check_api_vs_database.sh

# 3. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
bash scripts/check_bilibili_data_integrity.sh
```

## ğŸ”„ é•¿æœŸè§£å†³æ–¹æ¡ˆ

### 1. å®šæ—¶ä»»åŠ¡é…ç½®

**å»ºè®®ï¼š** æ¯å¤©è¿è¡Œæ’­æ”¾é‡æ›´æ–°è„šæœ¬

```bash
# æ·»åŠ åˆ° crontab
0 2 * * * cd /srv/EmbodiedPulse2026 && python3 scripts/update_video_play_counts.py
```

### 2. æ•°æ®æ›´æ–°ç­–ç•¥

**å»ºè®®ï¼š**
- **æ–°è§†é¢‘ï¼ˆ30å¤©å†…å‘å¸ƒï¼‰ï¼š** æ¯6å°æ—¶æ›´æ–°ä¸€æ¬¡æ’­æ”¾é‡
- **æ™®é€šè§†é¢‘ï¼š** æ¯7å¤©æ›´æ–°ä¸€æ¬¡æ’­æ”¾é‡
- **æ’­æ”¾é‡ä¸º0çš„è§†é¢‘ï¼š** ç«‹å³æ›´æ–°

**å·²å®ç°ï¼š** `scripts/update_video_play_counts.py` å·²åŒ…å«æ­¤é€»è¾‘

### 3. ç›‘æ§å’Œå‘Šè­¦

**å»ºè®®ï¼š** æ·»åŠ ç›‘æ§è„šæœ¬ï¼Œæ£€æµ‹æ’­æ”¾é‡æ•°æ®æ˜¯å¦è¿‡æ—¶

```bash
# æ£€æŸ¥æ’­æ”¾é‡æ•°æ®æ–°é²œåº¦
bash scripts/check_bilibili_play_counts.sh | grep "âš ï¸"
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `fetch_bilibili_data.py` - æ•°æ®æŠ“å–è„šæœ¬ï¼ˆå·²ä¿®å¤æ’­æ”¾é‡æ›´æ–°é€»è¾‘ï¼‰
- `scripts/update_video_play_counts.py` - ä¸“é—¨çš„æ’­æ”¾é‡æ›´æ–°è„šæœ¬ï¼ˆæ¨èä½¿ç”¨ï¼‰
- `scripts/update_all_play_counts.sh` - æ’­æ”¾é‡æ›´æ–°è„šæœ¬ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹å¼ï¼‰
- `scripts/check_bilibili_play_counts.sh` - æ’­æ”¾é‡æ£€æŸ¥è„šæœ¬
- `scripts/check_api_vs_database.sh` - API vs æ•°æ®åº“å¯¹æ¯”è„šæœ¬

## âœ… ä¿®å¤æ¸…å•

- [x] ä¿®å¤ `fetch_bilibili_data.py` çš„æ’­æ”¾é‡æ›´æ–°é€»è¾‘
- [x] åˆ›å»ºæ’­æ”¾é‡æ›´æ–°è„šæœ¬ `update_all_play_counts.sh`
- [x] åˆ›å»ºæ’­æ”¾é‡æ£€æŸ¥è„šæœ¬ `check_bilibili_play_counts.sh`
- [x] åˆ›å»ºAPI vs æ•°æ®åº“å¯¹æ¯”è„šæœ¬ `check_api_vs_database.sh`
- [ ] åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œæ’­æ”¾é‡æ›´æ–°
- [ ] éªŒè¯æ’­æ”¾é‡æ•°æ®æ˜¯å¦æ›´æ–°
- [ ] é…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

