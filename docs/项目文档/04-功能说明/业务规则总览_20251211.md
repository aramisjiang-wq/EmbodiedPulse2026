# 业务规则总览

## 文档信息
- **文档版本**: v1.0.0
- **创建日期**: 2025-12-11
- **最后更新**: 2025-12-11
- **适用范围**: 整个产品系统的业务逻辑和交互规则

---

## 目录

1. [定时抓取规则](#1-定时抓取规则)
2. [按钮交互规则](#2-按钮交互规则)
3. [数据显示规则](#3-数据显示规则)
4. [搜索和筛选规则](#4-搜索和筛选规则)
5. [新论文红点提示规则](#5-新论文红点提示规则)
6. [具身运势抽签规则](#6-具身运势抽签规则)
7. [数据抓取策略规则](#7-数据抓取策略规则)
8. [数据去重规则](#8-数据去重规则)

---

## 1. 定时抓取规则

### 1.1 定时任务启用条件

**规则**：只有当环境变量 `AUTO_FETCH_ENABLED=true` 时，定时任务才会启动。

**启动方式**：
- **开发环境**：直接运行 `python3 app.py`，在 `if __name__ == '__main__'` 块中检查环境变量
- **生产环境（Gunicorn）**：通过 `gunicorn_config.py` 的 `when_ready` 钩子启动
- **Docker环境**：通过 `docker-compose.yml` 中的环境变量配置

### 1.2 论文抓取定时任务

**任务函数**：`scheduled_fetch()`  
**调用函数**：`fetch_new_data.fetch_papers()`  
**默认时间**：每小时整点执行（Cron: `0 * * * *`）  
**环境变量**：`AUTO_FETCH_SCHEDULE`  
**抓取数量**：由 `AUTO_FETCH_MAX_RESULTS` 控制，默认100篇/类

**Cron表达式格式**：
- 支持单个表达式：`0 * * * *`（每小时整点）
- 支持多个表达式（用分号分隔）：`0 2 * * *;0 14 * * *`（每天2点和14点）

**抓取策略**：
- 优先抓取最新日期的论文（按提交日期倒序）
- 如果某类别论文总数少于1000篇，自动增加抓取数量以补齐历史论文
- 只抓取最近7天的论文（`days_back=7`）
- 启用去重机制（`enable_dedup=True`）
- 启用增量更新（`enable_incremental=True`）

**执行规则**：
- 如果已有抓取任务正在运行，跳过本次执行
- 使用线程锁保护 `fetch_status`，避免并发冲突

### 1.3 新闻抓取定时任务

**任务函数**：`scheduled_fetch_news()`  
**调用函数**：`fetch_news.fetch_and_save_news()`  
**默认时间**：每小时整点执行（Cron: `0 * * * *`）  
**环境变量**：`AUTO_FETCH_NEWS_SCHEDULE`（如果未设置，使用 `AUTO_FETCH_SCHEDULE`）

**抓取源**：
- RSS源（多个具身智能相关RSS）
- NewsAPI.org API
- Orz.ai API

**过滤规则**：
- 只保存24小时内的新闻
- 自动过滤非具身相关新闻（使用关键词匹配）

### 1.4 招聘信息抓取定时任务

**任务函数**：`scheduled_fetch_jobs()`  
**调用函数**：`fetch_jobs.fetch_and_save_jobs()`  
**默认时间**：每小时整点执行（Cron: `0 * * * *`）  
**环境变量**：`AUTO_FETCH_JOBS_SCHEDULE`（如果未设置，使用 `AUTO_FETCH_SCHEDULE`）

**抓取源**：GitHub API（从指定仓库的README.md中解析"滚动招聘"部分）

### 1.5 Semantic Scholar数据更新定时任务

**任务函数**：`scheduled_update_semantic_scholar_with_limit()`  
**调用函数**：`update_semantic_scholar_data.update_all_papers()`  
**默认时间**：每天凌晨3点执行（Cron: `0 3 * * *`）  
**环境变量**：`SEMANTIC_UPDATE_LIMIT`（默认200篇）

**更新规则**：
- 只更新没有Semantic Scholar数据的论文
- 每次最多更新200篇（避免API限制）
- 更新字段：引用数、高影响力引用数、作者机构、发表期刊/会议、发表年份

---

## 2. 按钮交互规则

### 2.1 刷新全局数据按钮（`refreshAllBtn`）

**按钮ID**：`refreshAllBtn`  
**按钮文本**：`刷新全局数据`  
**图标**：`<i class="fas fa-sync-alt"></i>`

**交互规则**：
1. **点击行为**：
   - 立即禁用按钮，显示"刷新中..."状态
   - 同时启动3个后台线程：
     - `refresh_papers()` - 刷新论文数据
     - `refresh_jobs()` - 刷新招聘信息
     - `refresh_news()` - 刷新新闻数据
   - 立即返回响应，不等待完成

2. **状态轮询**：
   - 每2秒轮询一次 `/api/refresh-status` 获取任务状态
   - 显示每个任务的实时状态（pending/running/success/error）
   - 当所有任务完成（success或error）时，停止轮询

3. **任务完成处理**：
   - 如果所有任务都成功，自动刷新页面数据（重新加载论文、新闻、招聘信息）
   - 恢复按钮状态（启用按钮，恢复原始文本）
   - 清除轮询定时器

4. **防重复点击**：
   - 如果已有刷新任务正在运行，返回"刷新任务已在运行中"提示
   - 不启动新的任务

**调用的函数**：
- 论文：`fetch_new_data.fetch_papers()`
- 招聘：`fetch_jobs.fetch_and_save_jobs()`
- 新闻：`fetch_news.fetch_and_save_news()`

### 2.2 抓取新论文按钮（`fetchBtn`）

**按钮ID**：`fetchBtn`  
**按钮文本**：`抓取新论文`  
**图标**：`<i class="fas fa-download"></i>`

**交互规则**：
1. **点击行为**：
   - 打开抓取配置模态框（`fetchModal`）
   - 显示配置选项：
     - 每类论文数量（默认20篇）
     - 配置文件路径（默认`config.yaml`）

2. **确认抓取**：
   - 点击"开始抓取"按钮后：
     - 关闭模态框
     - 显示抓取状态条（`fetchStatus`）
     - 调用 `/api/fetch` API，传递配置参数
     - 开始轮询抓取状态（每1秒）

3. **抓取状态显示**：
   - 显示当前抓取进度（进度条）
   - 显示当前抓取的关键词
   - 显示抓取消息

4. **抓取完成处理**：
   - 隐藏抓取状态条
   - 自动刷新论文数据
   - 重置 `lastFetchUpdate`，确保数据更新

**API端点**：`POST /api/fetch`  
**参数**：
- `maxResults`: 每类论文数量（默认20）
- `configPath`: 配置文件路径（默认`config.yaml`）

### 2.3 搜索按钮（`searchBtn`）

**按钮ID**：`searchBtn`  
**按钮文本**：`搜索`  
**图标**：`<i class="fas fa-search"></i>`

**交互规则**：
1. **触发方式**：
   - 点击搜索按钮
   - 在搜索输入框中按Enter键

2. **搜索逻辑**：
   - 调用 `/api/search` API
   - 传递参数：
     - `q`: 搜索关键词（从搜索输入框获取）
     - `category`: 类别筛选（从类别下拉框获取，可选）

3. **结果显示**：
   - 隐藏原有的论文列表和标签页
   - 显示搜索结果区域（`searchResults`）
   - 显示"清除搜索"按钮
   - 显示搜索结果数量

4. **搜索范围**：
   - 搜索论文标题
   - 搜索作者名称
   - 支持模糊匹配

### 2.4 清除搜索按钮（`clearSearchBtn`）

**按钮ID**：`clearSearchBtn`  
**按钮文本**：`清除搜索`  
**图标**：`<i class="fas fa-times"></i>`

**交互规则**：
1. **点击行为**：
   - 清空搜索输入框和类别筛选
   - 隐藏搜索结果区域
   - 隐藏清除搜索按钮
   - 显示原有的论文列表和标签页
   - 恢复默认的"全量"标签页显示

### 2.5 具身运势抽签按钮（`fortuneTubeMain`）

**元素ID**：`fortuneTubeMain`  
**元素类型**：可点击的抽签筒

**交互规则**：
1. **点击行为**：
   - 检查今天是否已经抽过签（同一研究方向）
   - 如果已抽过，直接显示之前的结果
   - 如果未抽过，执行抽签动画

2. **抽签限制**：
   - 每个研究方向每天只能抽一次
   - 使用 `localStorage` 存储：
     - `fortuneDate`: 抽签日期
     - `fortuneCategory`: 研究方向
     - `fortuneMessage`: 抽签结果

3. **抽签流程**：
   - 选择研究方向（默认"全部"）
   - 点击抽签筒
   - 播放动画（竹签飞出）
   - 显示运势结果

4. **结果展示**：
   - 显示运势消息
   - 显示抽签时间戳
   - 提供"再抽一次"按钮（清除localStorage后重新抽签）

---

## 3. 数据显示规则

### 3.1 论文列表显示规则

**默认显示**：
- 页面加载时，默认显示"全量"标签页
- 显示所有类别的论文，按发布日期倒序排列

**标签页切换**：
- 点击标签页，切换到对应类别的论文列表
- 更新标签页的激活状态（`.active`类）
- 更新论文列表的显示状态（`.active`类）

**论文数量显示**：
- 每个标签页显示该类别的论文数量，格式：`类别名 (数量)`
- "全量"标签显示总论文数

**排序规则**：
- 默认：按发布日期倒序（最新的在前）
- 可选：按被引用数量倒序、按标题字母顺序

**筛选规则**：
- 可按发表场所（venue）筛选
- 筛选后，标签页数量显示会更新

### 3.2 新闻列表显示规则

**时间范围**：
- 只显示24小时内的新闻
- 优先使用 `published_at` 字段，如果没有则使用 `created_at` 字段

**排序规则**：
- 按创建时间倒序（`created_at DESC`）
- 确保最新刷新的新闻在前面

**分页规则**：
- 默认每页30条（`limit=30`）
- 支持分页参数（`offset`）

**平台筛选**：
- 支持按平台筛选（`platform`参数）
- 可选平台：RSS、NewsAPI、Orz.ai等

### 3.3 招聘信息显示规则

**排序规则**：
- 按更新日期从近到远排序（最新的在前）
- 日期格式：`YYYY.M.D`（如：`2025.12.11`）

**分页规则**：
- 默认每页20条（`limit=20`）
- 支持分页参数（`offset`）

### 3.4 数据集信息显示规则

**排序规则**：
- 按创建时间倒序（`created_at DESC`）

**分页规则**：
- 默认每页20条（`limit=20`）
- 支持分页参数（`offset`）

### 3.5 统计信息显示规则

**总论文数**：
- 显示数据库中所有论文的总数
- 实时更新

**类别统计**：
- 显示每个类别的论文数量
- 使用环形图（Donut Chart）可视化
- 点击图表区域可跳转到对应类别的论文列表

---

## 4. 搜索和筛选规则

### 4.1 论文搜索规则

**搜索范围**：
- 论文标题（模糊匹配）
- 作者名称（模糊匹配）

**搜索API**：`GET /api/search`

**参数**：
- `q`: 搜索关键词（必填）
- `category`: 类别筛选（可选）

**搜索逻辑**：
- 使用SQL的 `LIKE` 操作符进行模糊匹配
- 支持多关键词搜索（空格分隔）
- 不区分大小写

### 4.2 论文筛选规则

**筛选字段**：
- 发表场所（venue）：从Semantic Scholar数据中获取
- 类别（category）：从论文类别中获取

**筛选方式**：
- 下拉框选择
- 筛选后，标签页数量显示会实时更新

### 4.3 论文排序规则

**可选排序方式**：
1. **按日期**（默认）：`publish_date DESC`
2. **按被引用数量**：`citation_count DESC`
3. **按标题**：`title ASC`

**排序触发**：
- 通过下拉框选择排序方式
- 立即应用排序，更新论文列表显示

---

## 5. 新论文红点提示规则

### 5.1 计数规则

**核心规则**：今天看昨天的

**具体规则**：
- 红点数量 = 昨天（前一天）新拉取并保存到数据库的论文数量
- 使用 `Paper.created_at` 字段判断
- 查询条件：`Paper.created_at >= 昨天 00:00:00 AND Paper.created_at < 今天 00:00:00`

**示例**：
- 12月11日查看时，显示12月10日新增的论文数量
- 12月12日查看时，显示12月11日新增的论文数量

### 5.2 显示规则

**显示位置**：
- 在"全量"标签旁边
- 不挡住标签中的数字

**显示格式**：
- 如果数量 > 0：显示红点和数量
- 如果数量 > 99：显示 `99+`
- 如果数量 = 0：隐藏红点（添加 `hidden` 类）

**自动重置**：
- 每天 00:00:00 自动重置
- 新的一天开始时，红点数量自动更新为昨天的新论文数量

### 5.3 清除规则

**手动清除**：
- 点击红点可以手动隐藏
- 只隐藏红点，不影响计数逻辑
- 明天如果有新论文，红点会重新显示

**清除机制**：
- 点击红点后，添加 `hidden` 类
- 不更新任何存储（不再依赖 `localStorage`）

---

## 6. 具身运势抽签规则

### 6.1 抽签限制规则

**每日限制**：
- 每个研究方向每天只能抽一次
- 使用 `localStorage` 存储抽签记录：
  - `fortuneDate`: 抽签日期（格式：`new Date().toDateString()`）
  - `fortuneCategory`: 研究方向
  - `fortuneMessage`: 抽签结果

**研究方向**：
- 支持选择不同的研究方向（Perception、VLM、Planning等）
- 每个研究方向独立计算每日限制

### 6.2 抽签流程规则

1. **选择研究方向**：
   - 点击研究方向标签（默认"全部"）
   - 激活的研究方向会高亮显示

2. **点击抽签**：
   - 点击抽签筒（`fortuneTubeMain`）
   - 如果今天已抽过，直接显示结果
   - 如果未抽过，执行抽签动画

3. **抽签动画**：
   - 竹签飞出动画
   - 显示运势结果

4. **结果展示**：
   - 显示运势消息（从预定义的消息池中随机选择）
   - 显示抽签时间戳
   - 提供"再抽一次"按钮

### 6.3 再抽一次规则

**清除记录**：
- 清除 `localStorage` 中的抽签记录
- 允许立即重新抽签

**动画重置**：
- 重置所有动画状态
- 隐藏结果覆盖层

---

## 7. 数据抓取策略规则

### 7.1 论文抓取策略

**优先级规则**：
1. 优先抓取最新日期的论文（按提交日期倒序）
2. 如果某类别论文总数少于1000篇，自动增加抓取数量以补齐历史论文

**时间范围规则**：
- 只抓取最近7天的论文（`days_back=7`）
- 使用 `should_fetch_paper()` 函数判断

**抓取数量规则**：
- 默认每类100篇（`max_results=100`）
- 可通过 `AUTO_FETCH_MAX_RESULTS` 环境变量配置
- 如果类别论文数 < 1000，自动增加抓取量（最多增加到原数量的3倍）

**排序规则**：
- 按提交日期倒序（`SortCriterion.SubmittedDate` + `SortOrder.Descending`）

### 7.2 新闻抓取策略

**时间范围规则**：
- 只保存24小时内的新闻
- 使用 `published_at` 或 `created_at` 字段判断

**过滤规则**：
- 自动过滤非具身相关新闻
- 使用关键词匹配（如：具身智能、机器人、Embodied AI等）

**去重规则**：
- 基于URL去重
- 如果URL已存在，跳过保存

### 7.3 招聘信息抓取策略

**抓取源**：
- GitHub API
- 从指定仓库的README.md中解析"滚动招聘"部分

**解析规则**：
- 查找包含"滚动招聘"或"招聘"的章节
- 解析职位信息、公司、日期等字段

**去重规则**：
- 基于职位标题和公司名称去重

---

## 8. 数据去重规则

### 8.1 论文去重规则

**去重策略（按优先级）**：

1. **ID去重**（最高优先级）：
   - 如果论文ID（ArXiv ID）已存在，更新记录（不创建新记录）
   - 使用数据库主键约束

2. **标题相似度去重**（可选，默认启用）：
   - 如果标题相似度 >= 0.85，跳过保存
   - 使用 `is_duplicate_title()` 函数计算相似度
   - 可通过 `enable_title_dedup` 参数控制（默认True）

**去重函数**：`save_paper_to_db()`  
**返回结果**：
- `('created', True)`: 新建记录
- `('updated', True)`: 更新现有记录
- `('skipped', False)`: 跳过（重复）

### 8.2 新闻去重规则

**去重策略**：
- 基于URL去重
- 如果URL已存在，跳过保存

### 8.3 招聘信息去重规则

**去重策略**：
- 基于职位标题和公司名称去重
- 如果标题和公司都相同，跳过保存

---

## 9. 其他业务规则

### 9.1 数据刷新规则

**刷新时机**：
- 手动点击"刷新全局数据"按钮
- 定时任务自动执行
- 抓取新论文完成后自动刷新

**刷新范围**：
- 论文数据
- 新闻数据
- 招聘信息数据

**刷新方式**：
- 重新调用对应的API
- 更新前端显示

### 9.2 错误处理规则

**API错误处理**：
- 如果API返回错误，显示错误消息
- 不中断其他功能的正常使用

**数据库错误处理**：
- 如果数据库连接失败，回退到JSON文件
- 显示警告信息

**抓取错误处理**：
- 记录错误日志
- 更新任务状态为 `error`
- 不中断其他任务的执行

### 9.3 性能优化规则

**数据库查询优化**：
- 使用索引加速查询
- 使用分页避免一次性加载过多数据

**前端渲染优化**：
- 使用虚拟滚动（如果数据量大）
- 延迟加载非关键内容

**定时任务优化**：
- 使用后台线程执行，不阻塞主线程
- 使用线程锁保护共享状态

---

## 10. 环境变量配置规则

### 10.1 定时任务相关

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `AUTO_FETCH_ENABLED` | 启用自动抓取 | `false` | `true` / `false` |
| `AUTO_FETCH_SCHEDULE` | 论文抓取时间（Cron） | `0 * * * *` | `0 2 * * *` |
| `AUTO_FETCH_NEWS_SCHEDULE` | 新闻抓取时间（Cron） | `0 * * * *` | `0 * * * *` |
| `AUTO_FETCH_JOBS_SCHEDULE` | 招聘抓取时间（Cron） | `0 * * * *` | `0 * * * *` |
| `AUTO_FETCH_MAX_RESULTS` | 每次抓取数量 | `100` | `50`, `100`, `200` |
| `SEMANTIC_UPDATE_LIMIT` | Semantic Scholar更新数量 | `200` | `100`, `200`, `500` |

### 10.2 服务器相关

| 环境变量 | 说明 | 默认值 | 示例 |
|---------|------|--------|------|
| `PORT` | 服务器端口 | `5001` | `5001`, `8080` |
| `FLASK_ENV` | Flask环境 | `production` | `development` / `production` |
| `LOG_LEVEL` | 日志级别 | `info` | `debug`, `info`, `warning`, `error` |

---

## 11. 变更记录

### v1.0.0 (2025-12-11)
- 初始版本
- 整理所有业务规则
- 包括定时抓取、按钮交互、数据显示、搜索筛选、红点提示等规则

---

## 12. 相关文档

- [定时任务自动更新机制说明](./定时任务自动更新机制说明_20251211.md)
- [新论文红点计数规则](./论文抓取/新论文红点计数规则_今天新论文_20251211.md)
- [刷新功能确认](./刷新功能确认_20251210.md)
- [具身运势抽签功能](./互动功能/具身运势抽签功能_20251209.md)





