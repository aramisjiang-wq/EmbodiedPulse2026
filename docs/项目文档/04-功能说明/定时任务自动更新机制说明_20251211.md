# 定时任务自动更新机制说明

**创建时间**：2025年12月11日  
**目的**：详细说明论文、新闻、岗位机会的自动更新脚本机制

---

## 📋 概述

系统使用 **APScheduler** 实现定时任务，支持在开发环境（直接运行 `app.py`）和生产环境（Gunicorn）下自动启动。

---

## 🔧 技术实现

### 1. 定时任务调度器

**使用库**：`APScheduler` (Advanced Python Scheduler)

**调度器类型**：`BackgroundScheduler`（后台调度器，不阻塞主线程）

**配置文件**：
- `app.py` - 定义定时任务和启动逻辑
- `gunicorn_config.py` - Gunicorn启动钩子

---

### 2. 定时任务列表

#### 任务1：论文抓取

**函数**：`scheduled_fetch()`  
**调用**：`daily_arxiv.demo(**config)`  
**默认时间**：每小时整点执行（`0 * * * *`）  
**环境变量**：`AUTO_FETCH_SCHEDULE`  
**配置参数**：
- `max_results`: 100（可通过 `AUTO_FETCH_MAX_RESULTS` 配置）
- `enable_dedup`: True
- `enable_incremental`: True
- `days_back`: 14
- `fetch_semantic_scholar`: True

---

#### 任务2：新闻抓取

**函数**：`scheduled_fetch_news()`  
**调用**：`fetch_news.fetch_and_save_news()`  
**默认时间**：每小时整点执行（`0 * * * *`）  
**环境变量**：`AUTO_FETCH_NEWS_SCHEDULE`  
**功能**：
- 从RSS源、NewsAPI.org、Orz.ai API抓取新闻
- 只保存24小时内的新闻
- 自动过滤非具身相关新闻

---

#### 任务3：招聘信息抓取

**函数**：`scheduled_fetch_jobs()`  
**调用**：`fetch_jobs.fetch_and_save_jobs()`  
**默认时间**：每小时整点执行（`0 * * * *`）  
**环境变量**：`AUTO_FETCH_JOBS_SCHEDULE`  
**功能**：
- 从GitHub API获取招聘信息
- 解析README.md中的"滚动招聘"部分
- 自动保存到数据库

---

#### 任务4：Semantic Scholar数据更新

**函数**：`scheduled_update_semantic_scholar_with_limit()`  
**调用**：`update_semantic_scholar_data.update_all_papers()`  
**默认时间**：每天凌晨3点执行（`0 3 * * *`）  
**环境变量**：`SEMANTIC_UPDATE_LIMIT`（默认200篇）  
**功能**：
- 更新论文的Semantic Scholar数据（引用数、机构等）
- 只更新没有Semantic Scholar数据的论文
- 避免一次性更新太多导致API限制

---

## 🚀 启动机制

### 方式1：直接运行 app.py（开发环境）

**启动命令**：
```bash
python3 app.py
```

**启动逻辑**：
```python
if __name__ == '__main__':
    # 检查 AUTO_FETCH_ENABLED 环境变量
    if auto_fetch_enabled:
        scheduler = start_scheduler()  # 启动定时任务
    app.run(...)
```

**特点**：
- ✅ 适合开发环境
- ✅ 调试方便
- ✅ 定时任务在主进程中运行

---

### 方式2：Gunicorn启动（生产环境）

**启动命令**：
```bash
gunicorn -c gunicorn_config.py app:app
```

**启动逻辑**：
1. Gunicorn加载应用
2. 调用 `gunicorn_config.py` 中的 `when_ready()` hook
3. Hook中调用 `app.init_scheduler()` 启动定时任务

**特点**：
- ✅ 适合生产环境
- ✅ 多进程支持
- ✅ 定时任务在master进程中运行（避免重复执行）

---

### 方式3：Docker部署

**启动命令**：
```bash
docker-compose up
```

**配置**：
- `docker-compose.yml` 中设置环境变量
- `Dockerfile` 中使用 Gunicorn 启动
- 定时任务通过 Gunicorn hook 自动启动

---

## ⚙️ 环境变量配置

### 必需环境变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `AUTO_FETCH_ENABLED` | `false` | 是否启用自动抓取（`true`/`false`） |

### 可选环境变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `AUTO_FETCH_SCHEDULE` | `0 * * * *` | 论文抓取cron表达式（每小时整点） |
| `AUTO_FETCH_NEWS_SCHEDULE` | `0 * * * *` | 新闻抓取cron表达式（每小时整点） |
| `AUTO_FETCH_JOBS_SCHEDULE` | `0 * * * *` | 招聘抓取cron表达式（每小时整点） |
| `AUTO_FETCH_MAX_RESULTS` | `100` | 每次抓取论文数量 |
| `SEMANTIC_UPDATE_LIMIT` | `200` | Semantic Scholar每次更新数量 |

### Cron表达式格式

**格式**：`分钟 小时 日 月 星期`

**示例**：
- `0 * * * *` - 每小时整点执行
- `0 2 * * *` - 每天凌晨2点执行
- `0 8,20 * * *` - 每天8点和20点执行
- `0 2 * * *;0 14 * * *` - 每天2点和14点执行（多个时间用分号分隔）

---

## ✅ 验证机制

### 1. 检查定时任务是否启动

**方法1：查看日志**
```bash
# 直接运行
python3 app.py
# 应该看到：✅ 自动定时抓取已启用

# Gunicorn
gunicorn -c gunicorn_config.py app:app
# 应该看到：✅ 定时任务调度器已在Gunicorn启动时初始化
```

**方法2：检查进程**
```bash
ps aux | grep scheduler
# 应该看到 APScheduler 相关进程
```

**方法3：查看定时任务列表**
```python
from app import scheduler
if scheduler:
    jobs = scheduler.get_jobs()
    for job in jobs:
        print(f"{job.name}: {job.next_run_time}")
```

---

### 2. 测试定时任务执行

**方法1：手动触发**
```python
from app import scheduler
if scheduler:
    # 获取任务并手动执行
    job = scheduler.get_job('hourly_fetch_papers_0')
    job.func()  # 手动执行
```

**方法2：查看日志**
- 定时任务执行时会输出日志
- 检查是否有错误信息

---

## 🔍 问题排查

### 问题1：定时任务未启动

**可能原因**：
1. `AUTO_FETCH_ENABLED` 未设置为 `true`
2. `APScheduler` 未安装
3. Gunicorn hook 未正确配置

**解决方法**：
1. 检查环境变量：`echo $AUTO_FETCH_ENABLED`
2. 安装依赖：`pip install apscheduler`
3. 检查 `gunicorn_config.py` 中的 `when_ready` hook

---

### 问题2：定时任务重复执行

**可能原因**：
- 多个worker进程都启动了定时任务

**解决方法**：
- 确保使用 Gunicorn 的 `when_ready` hook（只在master进程执行）
- 不要在每个worker进程中启动定时任务

---

### 问题3：定时任务执行失败

**可能原因**：
1. 配置文件不存在
2. 依赖模块未安装
3. 网络连接问题

**解决方法**：
1. 检查 `config.yaml` 是否存在
2. 检查所有依赖是否安装：`pip install -r requirements.txt`
3. 查看错误日志

---

## 📊 定时任务状态监控

### 查看当前任务

```python
from app import scheduler
if scheduler:
    jobs = scheduler.get_jobs()
    for job in jobs:
        print(f"任务: {job.name}")
        print(f"下次执行: {job.next_run_time}")
        print(f"触发器: {job.trigger}")
```

### 查看任务执行历史

- 查看应用日志
- 检查数据库更新记录
- 监控API响应时间

---

## 🎯 部署检查清单

### 部署前检查

- [ ] `AUTO_FETCH_ENABLED=true` 已设置
- [ ] `APScheduler` 已安装（`pip install apscheduler`）
- [ ] `gunicorn_config.py` 中的 `when_ready` hook 已配置
- [ ] 环境变量已正确设置（`AUTO_FETCH_SCHEDULE` 等）
- [ ] `config.yaml` 配置文件存在
- [ ] 所有依赖已安装

### 部署后验证

- [ ] 查看启动日志，确认定时任务已启动
- [ ] 等待第一个定时任务执行时间，检查是否正常执行
- [ ] 检查数据库是否有新数据
- [ ] 查看错误日志，确认没有错误

---

## 📝 总结

### 启动方式对比

| 启动方式 | 定时任务启动位置 | 适用场景 |
|---------|----------------|---------|
| `python3 app.py` | `if __name__ == '__main__'` | 开发环境 |
| `gunicorn -c gunicorn_config.py app:app` | `gunicorn_config.py` 的 `when_ready` hook | 生产环境 |
| `docker-compose up` | 通过 Gunicorn hook | 容器部署 |

### 关键点

1. ✅ **开发环境**：定时任务在 `if __name__ == '__main__'` 中启动
2. ✅ **生产环境**：定时任务在 Gunicorn 的 `when_ready` hook 中启动
3. ✅ **环境变量**：`AUTO_FETCH_ENABLED=true` 启用自动抓取
4. ✅ **Cron表达式**：支持自定义执行时间

---

**最后更新**：2025年12月11日  
**维护者**：AI开发助手
