# 招聘信息自动抓取功能说明

**创建日期**: 2025-12-09  
**最后更新**: 2025-12-09

---

## 📋 功能概述

系统已实现自动从GitHub仓库抓取"具身岗位机会"（原"滚动招聘"）信息，并每天定时更新。

---

## 🔧 技术实现

### 1. 核心脚本

#### `github_jobs_client.py`
- **功能**: 从GitHub API获取README.md并解析招聘信息
- **数据来源**: `StarCycle/Awesome-Embodied-AI-Job` 仓库
- **抓取部分**: "Rolling Recruitment | 滚动招聘" 章节
- **特点**:
  - 使用GitHub API获取README内容
  - 自动解析日期、标题、链接
  - 支持重试机制（最多3次，指数退避）
  - 错误处理和日志记录

#### `fetch_jobs.py`
- **功能**: 协调抓取和保存流程
- **特点**:
  - 调用 `github_jobs_client.py` 获取数据
  - 调用 `save_jobs_to_db.py` 保存到数据库
  - 提供统计信息（新建、更新、跳过、错误）

#### `save_jobs_to_db.py`
- **功能**: 保存招聘信息到数据库
- **特点**:
  - 自动去重（基于标题和链接）
  - 支持增量更新
  - 错误处理和日志记录

### 2. 数据库模型

#### `jobs_models.py`
- **表名**: `jobs`
- **字段**:
  - `id`: 主键
  - `title`: 招聘标题
  - `link`: 招聘链接
  - `source`: 数据来源（github）
  - `source_url`: 来源URL
  - `update_date`: 更新日期（从GitHub解析）
  - `created_at`: 创建时间
  - `updated_at`: 更新时间

---

## ⏰ 定时任务配置

### 自动执行

定时任务已集成到Flask应用中，通过APScheduler实现：

- **执行时间**: 每天UTC时间 03:00（北京时间 11:00）
- **任务ID**: `daily_fetch_jobs`
- **任务名称**: `每日招聘信息抓取`
- **触发方式**: Cron触发器

### 配置方式

#### 方式1: 环境变量（推荐）

```bash
# 启用自动抓取
export AUTO_FETCH_ENABLED=true

# 启动Flask服务器
python3 app.py
```

#### 方式2: 启动脚本

```bash
# 使用启动脚本（已配置自动抓取）
./start_with_auto_fetch.sh
```

### 手动执行

```bash
# 直接执行抓取脚本
python3 fetch_jobs.py --yes

# 或交互式执行
python3 fetch_jobs.py
```

---

## 📊 数据流程

```
GitHub仓库 (StarCycle/Awesome-Embodied-AI-Job)
    ↓
github_jobs_client.py (获取README并解析)
    ↓
fetch_jobs.py (协调抓取)
    ↓
save_jobs_to_db.py (保存到数据库，自动去重)
    ↓
jobs.db (SQLite数据库)
    ↓
前端显示 (/api/jobs)
```

---

## 🔍 数据解析规则

### 日期格式
- 支持格式: `[2025.12.7]` 或 `[2025.3.10]`
- 解析规则: 正则表达式 `\*\*\[(\d{4}\.\d{1,2}\.\d{1,2})\]\*\*`

### 标题和链接
- 支持格式: `[标题](链接)`
- 解析规则: Markdown链接格式 `\[([^\]]+)\]\(([^\)]+)\)`

### 公司信息
- 自动提取: 公司名称、地点、职位类型
- 格式: `公司(地点) - 职位描述 - 职位类型`

---

## 🛠️ 错误处理

### 重试机制
- **最大重试次数**: 3次
- **重试策略**: 指数退避（2^attempt 秒）
- **重试场景**:
  - 网络超时
  - SSL错误
  - HTTP 5xx错误
  - GitHub API速率限制（403）

### 错误日志
- 所有错误都会记录到日志
- 日志级别: INFO, WARNING, ERROR
- 日志格式: `[时间] [级别] 消息`

---

## 📈 统计信息

每次抓取完成后，会输出统计信息：

```
总计: X 条
新建: X 条
更新: X 条
跳过: X 条（已存在）
错误: X 条
```

---

## 🔄 去重机制

系统基于以下字段进行去重：
- **标题** (`title`)
- **链接** (`link`)

如果标题和链接都相同，则视为重复，会更新现有记录而不是创建新记录。

---

## 📝 使用示例

### 测试抓取功能

```python
from github_jobs_client import fetch_all_jobs

jobs = fetch_all_jobs()
print(f"获取到 {len(jobs)} 条招聘信息")
for job in jobs[:5]:
    print(f"[{job['update_date']}] {job['title']}")
```

### 手动执行抓取

```bash
# 非交互式执行
python3 fetch_jobs.py --yes

# 交互式执行
python3 fetch_jobs.py
```

### 查看数据库

```python
from jobs_models import get_jobs_session, Job
from sqlalchemy import desc

session = get_jobs_session()
jobs = session.query(Job).order_by(desc(Job.update_date)).limit(10).all()

for job in jobs:
    print(f"[{job.update_date}] {job.title}")
    print(f"  链接: {job.link}")
```

---

## ⚙️ 配置选项

### GitHub仓库配置

在 `github_jobs_client.py` 中：

```python
GITHUB_REPO = "StarCycle/Awesome-Embodied-AI-Job"
GITHUB_API_BASE = "https://api.github.com"
```

### 定时任务配置

在 `app.py` 中：

```python
# 每天UTC 3:00执行
trigger=CronTrigger(hour=3, minute=0)
```

可以修改为其他时间，例如：
- `CronTrigger(hour=2, minute=0)` - UTC 2:00
- `CronTrigger(hour=14, minute=0)` - UTC 14:00

---

## 🐛 常见问题

### 1. 抓取失败：SSL错误

**原因**: 网络连接问题或SSL证书验证失败

**解决方案**:
- 检查网络连接
- 脚本已实现重试机制，会自动重试
- 如果持续失败，检查防火墙设置

### 2. 抓取失败：GitHub API速率限制

**原因**: GitHub API有速率限制（未认证用户每小时60次）

**解决方案**:
- 脚本已实现重试机制和指数退避
- 可以配置GitHub Personal Access Token（未来功能）

### 3. 未获取到招聘信息

**原因**: 
- README格式变化
- 正则表达式不匹配
- 网络问题

**解决方案**:
- 检查GitHub仓库README格式
- 更新正则表达式
- 查看日志了解详细错误

---

## 📚 相关文件

- `github_jobs_client.py` - GitHub API客户端
- `fetch_jobs.py` - 抓取协调脚本
- `save_jobs_to_db.py` - 数据库保存脚本
- `jobs_models.py` - 数据库模型
- `app.py` - Flask应用（定时任务配置）

---

## 🔮 未来优化

1. **GitHub Token支持**: 使用Personal Access Token提高API速率限制
2. **增量抓取**: 只抓取新发布的招聘信息
3. **数据验证**: 验证链接有效性
4. **通知功能**: 新招聘信息推送通知
5. **分类标签**: 自动分类（实习/全职/兼职等）

---

**最后更新**: 2025-12-09

