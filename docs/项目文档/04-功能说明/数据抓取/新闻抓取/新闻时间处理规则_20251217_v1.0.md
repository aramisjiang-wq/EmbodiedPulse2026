# 新闻时间处理规则

## 概述

本文档详细说明新闻挂件的数据抓取、数据存储和数据展示的时间处理规则，确保整个流程的时间处理一致且正确。

## 时间处理流程

### 1. 数据抓取阶段（rss_news_client.py）

#### 1.1 RSS时间格式

不同RSS源的时间格式不同：

- **标准格式**：`Mon, 01 Dec 2025 13:25:44 +0800`（RFC 2822格式）
- **36氪格式**：`2025-12-09 16:20:34  +0800`（非标准格式）
- **无时区格式**：`2025-12-09 16:20:34`（假设为UTC）

#### 1.2 时间解析逻辑

**优先级顺序**：

1. **parsedate_tz解析**（标准格式）
   ```python
   from email.utils import parsedate_tz
   parsed = parsedate_tz(date_str)
   if parsed:
       dt = datetime(*parsed[:6])  # 已经是本地时间
       published_at = dt
   ```

2. **published_parsed + 时区偏移**（parsedate_tz失败时）
   ```python
   if hasattr(entry, 'published_parsed') and entry.published_parsed:
       utc_dt = datetime(*entry.published_parsed[:6])
       published_at = utc_dt + timedelta(hours=offset_hours)
   ```

3. **手动解析**（36氪等非标准格式）
   ```python
   match = re.match(r'(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})\s+([+-])(\d{2})(\d{2})', date_str)
   if match:
       year, month, day, hour, minute, second = map(int, match.groups()[:6])
       published_at = datetime(year, month, day, hour, minute, second)
   ```

4. **默认处理**（无时区信息）
   ```python
   # 假设是UTC时间，转换为北京时间（UTC+8）
   utc_dt = datetime(*entry.published_parsed[:6])
   published_at = utc_dt + timedelta(hours=8)
   ```

#### 1.3 时间存储原则

- **统一存储为本地时间（北京时间）**
- 所有RSS时间都转换为北京时间后存储
- 使用Python `datetime` 对象，不存储时区信息

### 2. 数据存储阶段（save_news_to_db.py）

#### 2.1 时间格式转换

接收的 `published_at` 可能是：
- `datetime` 对象：直接使用
- 字符串：解析为 `datetime` 对象

#### 2.2 解析逻辑

```python
if isinstance(pub_time, str):
    # 标准格式：YYYY-MM-DD HH:MM:SS
    if ' ' in pub_time and len(pub_time) == 19:
        published_at = datetime.strptime(pub_time, '%Y-%m-%d %H:%M:%S')
    # ISO格式：YYYY-MM-DDTHH:MM:SS
    elif 'T' in pub_time:
        published_at = datetime.fromisoformat(pub_time.replace('Z', '+00:00'))
    else:
        published_at = datetime.fromisoformat(pub_time)
elif isinstance(pub_time, datetime):
    published_at = pub_time
```

#### 2.3 数据库存储

- 使用SQLAlchemy `DateTime` 类型
- 存储为 `datetime` 对象（无时区信息）
- 数据库字段：`published_at` (DateTime)

### 3. 数据展示阶段（static/js/app.js）

#### 3.1 API返回格式

`news_models.py` 的 `to_dict()` 方法：
```python
'published_at': self.published_at.strftime('%Y-%m-%d %H:%M:%S') if self.published_at else ''
```

返回格式：`YYYY-MM-DD HH:MM:SS`（字符串）

#### 3.2 前端解析逻辑

```javascript
// 解析时间字符串（格式：2025-12-09 16:20:34）
const timeStr = publishedAt.trim();
if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(timeStr)) {
    const [datePart, timePart] = timeStr.split(' ');
    const [year, month, day] = datePart.split('-').map(Number);
    const [hour, minute, second] = timePart.split(':').map(Number);
    // 使用本地时区创建Date对象
    displayTime = new Date(year, month - 1, day, hour, minute, second);
}
```

#### 3.3 时间显示规则

- **< 1分钟**：显示"刚刚"
- **< 1小时**：显示"X分钟前"
- **< 24小时**：显示"X小时前"
- **< 7天**：显示"X天前"
- **>= 7天**：显示日期（YYYY-MM-DD）

## 时间处理规则总结

### 核心原则

1. **统一时区**：所有时间统一转换为北京时间（UTC+8）存储
2. **无时区信息**：数据库存储的 `datetime` 对象不包含时区信息
3. **本地时间**：前端显示时，将存储的时间视为本地时间（北京时间）

### 时间流转

```
RSS源时间（各种格式）
    ↓
解析为datetime对象（北京时间）
    ↓
存储到数据库（DateTime，无时区）
    ↓
API返回字符串（YYYY-MM-DD HH:MM:SS）
    ↓
前端解析为Date对象（本地时间）
    ↓
计算时间差并显示
```

### 关键检查点

1. **抓取阶段**：
   - ✅ 正确解析RSS时间格式
   - ✅ 转换为北京时间
   - ✅ 使用 `datetime` 对象

2. **存储阶段**：
   - ✅ 正确处理 `datetime` 对象和字符串
   - ✅ 统一格式转换
   - ✅ 错误处理

3. **展示阶段**：
   - ✅ 正确解析时间字符串
   - ✅ 计算时间差
   - ✅ 格式化显示

## 常见问题

### Q1: 为什么显示的时间不对？

**A**: 检查三个环节：
1. RSS时间是否正确解析（查看日志）
2. 数据库存储的时间是否正确（查询数据库）
3. 前端解析是否正确（查看浏览器控制台）

### Q2: 如何处理不同RSS源的时间格式？

**A**: 使用优先级解析：
1. 优先使用 `parsedate_tz`（标准格式）
2. 回退到 `published_parsed + 时区偏移`
3. 最后使用手动解析（非标准格式）

### Q3: 时区转换是否正确？

**A**: 确保：
- RSS时间包含时区信息时，正确转换为北京时间
- RSS时间无时区信息时，假设为UTC并加8小时
- 存储时统一为北京时间（无时区信息）

## 更新记录

- 2025-12-09: 创建文档，规范时间处理规则
- 2025-12-09: 修复36氪RSS时间解析问题
- 2025-12-09: 完善时间处理流程文档


