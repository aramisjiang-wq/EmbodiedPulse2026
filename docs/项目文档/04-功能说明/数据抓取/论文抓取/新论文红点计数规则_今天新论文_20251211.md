# 新论文红点计数规则（今天看昨天的）

## 版本信息
- **文档版本**: v1.1.0
- **创建日期**: 2025-12-11
- **最后更新**: 2025-12-11

## 规则概述

**核心原则**：红点数量 = 昨天（前一天）新拉取并保存到数据库的论文数量

**规则说明**：今天（11号）查看时，显示昨天（10号）新增的论文数量

## 详细规则

### 1. 时间范围定义

- **"昨天"的定义**：从前一天 00:00:00 到 23:59:59
- **判断字段**：使用数据库中的 `Paper.created_at` 字段
- **判断条件**：`Paper.created_at >= 昨天 00:00:00 AND Paper.created_at < 今天 00:00:00`

### 2. 新论文的判定标准

#### 2.1 必须是昨天创建的记录
- 论文的 `created_at` 字段必须是昨天（前一天）的时间戳
- 不包括今天或更早创建的论文
- 不包括昨天更新（`updated_at`）但之前已存在的论文

#### 2.2 必须是新创建的记录（非更新）
- 如果论文ID已存在，更新操作不会创建新记录，不计入红点
- 只有 `save_paper_to_db()` 返回 `action='created'` 的论文才计入
- 更新操作（`action='updated'`）不计入红点数量

### 3. 计数逻辑

#### 3.1 后端API计算逻辑

```python
# 计算昨天新创建的论文数量（今天看昨天的）
from datetime import datetime, date, timedelta

today = date.today()
yesterday = today - timedelta(days=1)
yesterday_start = datetime.combine(yesterday, datetime.min.time())  # 昨天 00:00:00
today_start = datetime.combine(today, datetime.min.time())  # 今天 00:00:00

# 查询昨天创建的论文数量
new_papers_count = session.query(Paper).filter(
    Paper.created_at >= yesterday_start,
    Paper.created_at < today_start
).count()
```

#### 3.2 前端显示逻辑

- 前端不再依赖 `localStorage` 中的 `papersLastViewed`
- 直接显示后端返回的今天新论文数量
- 如果数量为 0，隐藏红点
- 如果数量 > 0，显示红点，数量 > 99 时显示 "99+"

### 4. 清除机制

#### 4.1 自动清除
- **每天 00:00:00 自动重置**：新的一天开始时，红点数量自动更新为昨天的新论文数量
- 例如：12月12日查看时，显示12月11日新增的论文数量

#### 4.2 手动清除
- 用户点击红点时，可以手动清除红点显示
- 但清除操作不影响计数逻辑（仍然显示今天的新论文数量）
- 建议：点击清除后，红点隐藏，但明天如果有新论文，红点会重新显示

### 5. 特殊情况处理

#### 5.1 跨天情况
- 如果用户在 23:59 查看，然后在 00:01 刷新，红点数量会从昨天的数量变为今天的数量
- 这是正常行为，因为规则就是只显示今天的新论文

#### 5.2 时区问题
- 使用服务器本地时区（系统时区）
- `datetime.now()` 返回的是服务器本地时间
- 确保服务器时区设置正确

#### 5.3 数据库迁移影响
- 如果数据库是从JSON迁移的，迁移时所有论文的 `created_at` 都是迁移时间
- 这种情况下，只有迁移当天及之后新拉取的论文才会显示红点
- 这是预期行为，因为迁移的论文不是"今天新拉取的"

### 6. 实现要点

#### 6.1 后端实现（`app.py`）

```python
@app.route('/api/papers')
def get_papers():
    # ... 其他代码 ...
    
    # 计算今天新创建的论文数量（不再使用last_viewed参数）
    from datetime import datetime, date
    today = date.today()
    today_start = datetime.combine(today, datetime.min.time())
    
    new_papers_count = session.query(Paper).filter(
        Paper.created_at >= today_start
    ).count()
    
    # 返回结果
    return jsonify({
        # ... 其他数据 ...
        'new_papers_count': new_papers_count
    })
```

#### 6.2 前端实现（`app.js`）

```javascript
// 不再需要传递last_viewed参数
async function loadPapers(showNewBadge = false) {
    const url = '/api/papers';  // 不再添加?last_viewed参数
    
    const response = await fetch(url);
    const result = await response.json();
    
    if (showNewBadge && result.new_papers_count !== undefined) {
        updateNewPapersBadge(result.new_papers_count);
    }
}

// 清除红点（可选，因为每天会自动重置）
function clearNewPapersBadge() {
    // 可以隐藏红点，但不影响明天的计数
    const badge = document.getElementById('newPapersBadge');
    if (badge) {
        badge.classList.add('hidden');
    }
}
```

### 7. 优势

1. **简单明确**：规则清晰，今天看昨天的新论文
2. **自动重置**：每天自动重置，无需用户操作
3. **准确可靠**：基于数据库 `created_at` 字段，不会因为 `localStorage` 异常导致计数错误
4. **用户友好**：用户每天都能看到昨天新拉取的论文数量，更符合"查看昨日更新"的使用习惯

### 8. 与旧规则的区别

| 项目 | 旧规则 | 新规则 |
|------|--------|--------|
| 时间范围 | 从 `last_viewed` 到现在的所有新论文 | 只计算昨天（前一天）的新论文 |
| 依赖 | 依赖 `localStorage` 的 `papersLastViewed` | 不依赖前端存储，直接查询数据库 |
| 重置机制 | 用户点击红点清除 | 每天 00:00:00 自动重置 |
| 异常处理 | 需要处理 `localStorage` 异常、时间解析异常 | 逻辑简单，异常情况少 |

### 9. 测试验证

#### 9.1 测试场景

1. **昨天有新论文**：
   - 拉取新论文后，红点应显示昨天新创建的论文数量
   - 验证：`new_papers_count == 昨天创建的论文数`

2. **昨天没有新论文**：
   - 红点应隐藏（数量为 0）

3. **跨天测试**：
   - 在 23:59 查看红点数量（显示今天的新论文）
   - 在 00:01 刷新页面
   - 红点数量应更新为昨天的新论文数量（即刚才显示的"今天"的论文）

4. **更新已有论文**：
   - 更新已有论文的 Semantic Scholar 数据
   - 红点数量不应增加（因为不是新创建）

#### 9.2 验证SQL查询

```sql
-- 查询昨天创建的论文数量
SELECT COUNT(*) 
FROM papers 
WHERE created_at >= DATE('now', '-1 day', 'start of day')
  AND created_at < DATE('now', 'start of day');
```

## 变更记录

### v1.1.0 (2025-12-11)
- 更新规则：改为"今天看昨天的"
- 今天（11号）查看时，显示昨天（10号）新增的论文数量
- 修复红点显示问题（延迟查找元素）

### v1.0.0 (2025-12-11)
- 初始版本
- 定义"今天新论文"计数规则
- 不再依赖 `localStorage` 和 `last_viewed` 参数





