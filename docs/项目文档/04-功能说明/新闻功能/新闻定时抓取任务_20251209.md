# 新闻定时抓取任务配置

**文档创建时间**: 2025-12-09  
**最后更新时间**: 2025-12-10

---

## 📋 概述

系统已配置定时任务，自动从RSS源、NewsAPI.org和Orz.ai API抓取机器人具身智能相关新闻。

---

## ⏰ 定时任务配置

### 执行频率
- **每小时执行一次**
- 使用 `interval` 触发器，每小时自动执行

### 配置方式
```python
scheduler.add_job(
    scheduled_fetch_news,
    trigger='interval',
    hours=1,
    id='hourly_fetch_news',
    name='每小时新闻信息抓取',
    replace_existing=True
)
```

### 启用方式
定时任务需要设置 `AUTO_FETCH_ENABLED=true` 环境变量才能启用：

```bash
# 方法1：使用启动脚本（推荐）
./start_server_with_scheduler.sh

# 方法2：手动设置环境变量
AUTO_FETCH_ENABLED=true python3 app.py
```

---

## 🔧 实现方式

### 任务函数
```python
def fetch_news_job():
    """定时抓取新闻的任务"""
    # 调用 fetch_robotics_news.py 脚本
    # 使用 Orz.ai API
```

### 启动方式
定时任务在Flask应用启动时自动配置，无需额外操作。

---

## 📊 任务执行流程

1. **触发条件**：每小时自动触发
2. **执行函数**：`fetch_and_save_news()` 在 `fetch_news.py` 中
3. **数据来源**：
   - RSS源（机器之心、36氪、虎嗅网、极客公园等）
   - NewsAPI.org（备选）
   - Orz.ai API（最后备选）
4. **过滤机制**：
   - 自动过滤机器人具身智能相关内容
   - 只保留24小时内的新闻
   - 目标至少20条新闻
5. **数据保存**：保存到 `news.db` 数据库

---

## 🔍 日志查看

定时任务的执行日志会输出到Flask应用的日志中：

```
[INFO] ============================================================
[INFO] 开始定时抓取新闻
[INFO] ============================================================
[INFO] 正在从 github 获取热点新闻...
[INFO] 成功获取 30 条新闻（github）
[INFO] 过滤后保留 X 条相关新闻（github）
...
[INFO] 新闻抓取完成
```

---

## ⚙️ 自定义配置

### 修改执行频率

编辑 `app.py` 中的定时任务配置：

```python
# 每1小时执行一次
scheduler.add_job(
    fetch_news_job,
    trigger=CronTrigger(
        minute='0',
        hour='*'  # 每小时
    ),
    ...
)

# 每30分钟执行一次
scheduler.add_job(
    fetch_news_job,
    trigger=CronTrigger(
        minute='*/30',  # 每30分钟
        hour='*'
    ),
    ...
)
```

### 禁用定时任务

如果不想使用定时任务，可以注释掉相关代码：

```python
# scheduler.add_job(
#     fetch_news_job,
#     ...
# )
```

---

## 📝 注意事项

1. **服务器运行**
   - 定时任务需要Flask服务器持续运行
   - 如果服务器停止，定时任务也会停止

2. **数据积累**
   - 热点新闻API不是搜索API
   - 如果当前热点中没有机器人相关内容，可能过滤后较少
   - 建议保持定时任务运行，逐步积累数据

3. **资源消耗**
   - Orz.ai API无速率限制，可以频繁请求
   - 每次执行会查询10个平台，耗时约1-2分钟

---

## 🚀 手动执行

如果需要立即抓取新闻，可以：

1. **通过网页界面**：点击「刷新全局数据」按钮
2. **通过命令行**：
```bash
python3 -c "from fetch_news import fetch_and_save_news; fetch_and_save_news()"
```

---

## 📚 相关文档

- `docs/项目文档/功能说明/新闻功能/新闻多源方案_20251209.md` - 新闻多源抓取方案
- `docs/项目文档/问题修复/功能问题/新闻自动更新问题修复_20251210.md` - 问题修复记录
- `fetch_news.py` - 新闻抓取主脚本
- `rss_news_client.py` - RSS新闻客户端
- `news_client.py` - Orz.ai API客户端
- `newsapi_client.py` - NewsAPI.org客户端

---

**操作时间**: 2025-12-10  
**操作人员**: AI Assistant

