# B站Cookie获取指南

## 为什么需要Cookie？

B站API有严格的风控机制，频繁请求会被412错误拦截。配置有效的Cookie可以：
- 提高API请求成功率
- 减少被风控拦截的概率
- 获取更完整的数据

## 需要获取的Cookie字段

代码需要以下4个Cookie值：

1. **SESSDATA** - 登录凭证（最重要）
2. **bili_jct** - CSRF token
3. **buvid3** - 设备标识
4. **DedeUserID** - 用户ID

## 方法一：Chrome浏览器（推荐）

### 步骤1：打开B站并登录
1. 打开Chrome浏览器
2. 访问 https://www.bilibili.com
3. **确保已登录你的B站账号**

### 步骤2：打开开发者工具
1. 按 `F12` 或 `Cmd+Option+I` (Mac) / `Ctrl+Shift+I` (Windows)
2. 点击 **Application** (应用) 标签页
3. 左侧找到 **Cookies** → 展开 → 点击 **https://www.bilibili.com**

### 步骤3：查找需要的Cookie
在右侧Cookie列表中，找到以下字段并复制它们的 **Value**（值）：

| Cookie名称 | 说明 | 示例格式 |
|-----------|------|---------|
| `SESSDATA` | 登录凭证 | `abc123def456...` (很长的一串) |
| `bili_jct` | CSRF token | `abc123def456...` |
| `buvid3` | 设备标识 | `ABC123-DEF4-5678-...` |
| `DedeUserID` | 用户ID | `12345678` (纯数字) |

**注意**：
- `SESSDATA` 通常很长（几百个字符）
- `DedeUserID` 是纯数字
- 如果找不到某个Cookie，可能是名称略有不同，继续往下看

## 方法二：Firefox浏览器

### 步骤1：打开B站并登录
1. 打开Firefox浏览器
2. 访问 https://www.bilibili.com
3. **确保已登录你的B站账号**

### 步骤2：打开开发者工具
1. 按 `F12` 或 `Cmd+Option+I` (Mac) / `Ctrl+Shift+I` (Windows)
2. 点击 **存储** (Storage) 标签页
3. 左侧找到 **Cookie** → 展开 → 点击 **https://www.bilibili.com**

### 步骤3：查找需要的Cookie
在右侧Cookie列表中查找并复制对应的值（同Chrome方法）

## 方法三：使用浏览器扩展（最简单）

### 安装Cookie导出扩展
1. Chrome: 安装 "EditThisCookie" 或 "Cookie-Editor"
2. Firefox: 安装 "Cookie-Editor"

### 导出Cookie
1. 访问 https://www.bilibili.com 并登录
2. 点击扩展图标
3. 找到 `SESSDATA`、`bili_jct`、`buvid3`、`DedeUserID` 的值

## 方法四：从网络请求中获取（最准确）

### 步骤1：打开开发者工具
1. 访问 https://www.bilibili.com 并登录
2. 按 `F12` 打开开发者工具
3. 切换到 **Network** (网络) 标签页

### 步骤2：刷新页面
1. 刷新页面（`F5`）
2. 在Network列表中，找到任意一个请求（如 `index.html`）

### 步骤3：查看请求头
1. 点击该请求
2. 在右侧找到 **Request Headers** (请求头)
3. 找到 **Cookie:** 这一行
4. 复制整个Cookie字符串

### 步骤4：解析Cookie字符串
Cookie字符串格式类似：
```
SESSDATA=abc123...; bili_jct=def456...; buvid3=ABC123-...; DedeUserID=12345678; ...
```

你需要提取出：
- `SESSDATA=` 后面的值（到下一个分号前）
- `bili_jct=` 后面的值
- `buvid3=` 后面的值
- `DedeUserID=` 后面的值

## 配置环境变量

获取到Cookie后，需要设置环境变量。有以下几种方式：

### 方式1：在终端中临时设置（当前会话有效）

```bash
export BILI_SESSDATA="你的SESSDATA值"
export BILI_JCT="你的bili_jct值"
export BILI_BUVID3="你的buvid3值"
export BILI_DEDEUSERID="你的DedeUserID值"
```

### 方式2：添加到 ~/.zshrc 或 ~/.bash_profile（永久生效）

```bash
# 编辑配置文件
nano ~/.zshrc  # Mac默认使用zsh
# 或
nano ~/.bash_profile  # 如果使用bash

# 添加以下内容（替换为你的实际值）
export BILI_SESSDATA="你的SESSDATA值"
export BILI_JCT="你的bili_jct值"
export BILI_BUVID3="你的buvid3值"
export BILI_DEDEUSERID="你的DedeUserID值"

# 保存后重新加载
source ~/.zshrc  # 或 source ~/.bash_profile
```

### 方式3：使用 .env 文件（推荐，更安全）

在项目根目录创建 `.env` 文件：

```bash
cd "/Users/dong/Documents/Cursor/Embodied Pulse"
nano .env
```

添加以下内容：
```
BILI_SESSDATA=你的SESSDATA值
BILI_JCT=你的bili_jct值
BILI_BUVID3=你的buvid3值
BILI_DEDEUSERID=你的DedeUserID值
```

**注意**：`.env` 文件应该添加到 `.gitignore` 中，避免泄露到Git仓库。

### 方式4：在启动脚本中设置

修改启动服务器的脚本，在启动前设置环境变量。

## 验证配置

配置完成后，重启服务器，查看日志中是否有：
```
已加载 B 站凭证，用于减轻 412 风控
```

如果有这条日志，说明Cookie配置成功。

## 安全注意事项

⚠️ **重要警告**：

1. **不要分享Cookie**：Cookie相当于你的账号密码，泄露后他人可以登录你的账号
2. **不要提交到Git**：确保 `.env` 文件在 `.gitignore` 中
3. **定期更新**：Cookie会过期，如果发现请求失败，可能需要重新获取
4. **使用小号**：建议使用B站小号，避免影响主账号

## Cookie有效期

- `SESSDATA` 通常有效期为30天
- 过期后需要重新获取
- 如果频繁出现412错误，可能需要重新登录获取新的Cookie

## 故障排查

### 问题1：找不到某个Cookie
- 确保已登录B站账号
- 尝试刷新页面后再查看
- 某些Cookie可能名称略有不同（如 `DedeUserID` vs `DEDEUSERID`）

### 问题2：配置后仍然412错误
- 检查Cookie是否过期（重新登录获取）
- 检查环境变量是否正确设置（`echo $BILI_SESSDATA`）
- 检查是否有特殊字符需要转义
- 等待一段时间，B站风控可能需要时间解除

### 问题3：Cookie值包含特殊字符
- 如果值中包含空格或特殊字符，需要用引号包裹
- 例如：`export BILI_SESSDATA="值 包含 空格"`

## 快速检查脚本

创建一个测试脚本验证Cookie是否有效：

```python
import os
import requests

sessdata = os.getenv("BILI_SESSDATA")
if sessdata:
    print(f"✅ SESSDATA已配置（长度: {len(sessdata)}）")
else:
    print("❌ SESSDATA未配置")

bili_jct = os.getenv("BILI_JCT")
if bili_jct:
    print(f"✅ BILI_JCT已配置（长度: {len(bili_jct)}）")
else:
    print("❌ BILI_JCT未配置")

buvid3 = os.getenv("BILI_BUVID3")
if buvid3:
    print(f"✅ BILI_BUVID3已配置")
else:
    print("❌ BILI_BUVID3未配置")

dedeuserid = os.getenv("BILI_DEDEUSERID")
if dedeuserid:
    print(f"✅ BILI_DEDEUSERID已配置: {dedeuserid}")
else:
    print("❌ BILI_DEDEUSERID未配置")
```

## 参考链接

- B站官方API文档：https://github.com/SocialSisterYi/bilibili-API-collect
- bilibili-api-python库：https://github.com/Nemo2011/bilibili-api
