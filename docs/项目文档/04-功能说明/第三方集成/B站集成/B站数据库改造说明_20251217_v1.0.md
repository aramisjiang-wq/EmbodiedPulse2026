# B站视频Hub数据库改造说明

## 概述

将B站视频数据从内存缓存改为数据库存储，实现数据持久化和更好的性能。

## 架构变化

### 改造前
- 数据存储在内存缓存中（`bilibili_cache`）
- 每次请求都调用B站API（有缓存时跳过）
- 数据在服务器重启后丢失

### 改造后
- 数据存储在SQLite/PostgreSQL数据库中
- 后端API从数据库读取数据
- 独立的抓取脚本定期更新数据库
- 数据持久化，服务器重启不丢失

## 数据库结构

### 表1: `bilibili_ups` (UP主信息表)
- `uid`: UP主UID（主键）
- `name`: UP主名称
- `fans`: 粉丝数（原始数值）
- `fans_formatted`: 粉丝数（格式化字符串）
- `views_count`: 总播放量
- `likes_count`: 获赞数
- `last_fetch_at`: 最后抓取时间
- `fetch_error`: 抓取错误信息
- `is_active`: 是否活跃（是否在监控列表中）

### 表2: `bilibili_videos` (视频信息表)
- `bvid`: 视频BV号（主键）
- `uid`: UP主UID（外键）
- `title`: 视频标题
- `play`: 播放量（原始数值）
- `play_formatted`: 播放量（格式化字符串）
- `pubdate`: 发布时间（DateTime）
- `pubdate_raw`: 发布时间戳（秒）
- `is_deleted`: 是否已删除

## 使用流程

### 1. 初始化数据库

```bash
# 初始化所有数据库（包括B站数据库）
python init_database.py

# 或只初始化B站数据库
python -c "from bilibili_models import init_bilibili_db; init_bilibili_db()"
```

### 2. 抓取数据

```bash
# 抓取所有UP主的数据（默认每个UP主50个视频）
python fetch_bilibili_data.py

# 指定视频数量
python fetch_bilibili_data.py --video-count 100

# 只抓取指定UID的数据
python fetch_bilibili_data.py --uid 1172054289

# 设置请求间隔（避免风控）
python fetch_bilibili_data.py --delay 2.0
```

### 3. 设置定时任务

使用cron或systemd timer定期运行抓取脚本：

```bash
# 编辑crontab
crontab -e

# 每天凌晨2点抓取数据
0 2 * * * cd /path/to/project && python fetch_bilibili_data.py >> /var/log/bilibili_fetch.log 2>&1

# 每6小时抓取一次
0 */6 * * * cd /path/to/project && python fetch_bilibili_data.py >> /var/log/bilibili_fetch.log 2>&1
```

### 4. API使用

前端代码无需修改，API端点保持不变：

- `GET /api/bilibili/all` - 获取所有UP主和视频数据（从数据库读取）
- `GET /api/bilibili/monthly_stats` - 月度播放量统计（从数据库计算）

## 配置

### 数据库URL

通过环境变量配置数据库：

```bash
# SQLite（默认）
export BILIBILI_DATABASE_URL="sqlite:///./bilibili.db"

# PostgreSQL
export BILIBILI_DATABASE_URL="postgresql://user:password@localhost/bilibili_db"
```

### UP主列表

UP主列表在 `app.py` 中的 `BILIBILI_UP_LIST` 变量定义。抓取脚本会自动从该列表读取。

## 优势

1. **数据持久化**: 数据存储在数据库中，服务器重启不丢失
2. **性能提升**: 从数据库读取比API调用快得多
3. **避免风控**: 减少对B站API的频繁请求
4. **历史数据**: 可以保存历史数据，支持趋势分析
5. **数据完整性**: 数据库约束保证数据完整性

## 注意事项

1. **首次使用**: 首次使用需要先运行 `fetch_bilibili_data.py` 抓取数据
2. **定期更新**: 建议设置定时任务定期更新数据（如每6小时或每天）
3. **数据量**: 每个UP主默认抓取50个视频，可根据需要调整
4. **错误处理**: 抓取失败时会记录错误信息到数据库，可通过 `fetch_error` 字段查看

## 故障排查

### 问题1: API返回空数据

**原因**: 数据库中暂无数据

**解决**: 运行 `python fetch_bilibili_data.py` 抓取数据

### 问题2: 数据不更新

**原因**: 定时任务未设置或未运行

**解决**: 
1. 检查定时任务配置
2. 手动运行抓取脚本
3. 查看日志确认是否有错误

### 问题3: 抓取失败

**原因**: B站API风控或网络问题

**解决**:
1. 检查B站Cookie配置（参考 `B站Cookie获取指南.md`）
2. 增加请求间隔（`--delay` 参数）
3. 查看 `fetch_error` 字段了解具体错误

## 迁移说明

如果之前使用内存缓存，可以：

1. 直接使用新系统：运行 `fetch_bilibili_data.py` 抓取数据
2. 数据会逐步积累，无需一次性迁移

## 相关文件

- `bilibili_models.py` - 数据库模型定义
- `fetch_bilibili_data.py` - 数据抓取脚本
- `app.py` - API端点（已修改为从数据库读取）
- `bilibili_client.py` - B站API客户端（保持不变）
