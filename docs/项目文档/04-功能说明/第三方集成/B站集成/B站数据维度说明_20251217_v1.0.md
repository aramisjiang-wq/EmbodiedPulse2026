# B站数据维度说明文档

**最后更新**：2025-12-14  
**版本**：v1.0

---

## 📋 概述

本文档详细说明从B站（Bilibili）API可以获取的所有数据维度。项目使用 `bilibili-api-python` 库通过B站开放API获取UP主信息和视频数据。

**当前使用的UP主UID**：1172054289（逐际动力）

---

## 🔍 数据获取方式

### API客户端

- **文件位置**：`bilibili_client.py`
- **依赖库**：`bilibili-api-python`、`aiohttp`
- **安装命令**：`pip install bilibili-api-python aiohttp`

### 主要方法

1. `get_user_info(mid)` - 获取UP主基本信息（同步接口）
2. `get_user_videos(mid, pn, ps)` - 获取UP主视频列表（同步接口）
3. `get_user_stat(mid)` - 获取UP主统计数据（同步接口）
4. `get_all_data(mid, video_count)` - 获取完整数据（信息+统计+视频列表）

---

## 📊 数据维度详细说明

### 1. UP主基本信息（user_info）

**获取方法**：`get_user_info(mid)` 或 `_get_user_info_async(mid)`

**数据字段**：

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `mid` | int | UP主的UID（用户ID） | 1172054289 |
| `name` | str | UP主昵称 | "逐际动力" |
| `face` | str | 头像URL | "https://i0.hdslb.com/bfs/face/..." |
| `sign` | str | 个人签名/简介 | "专注于具身智能..." |
| `level` | int | 用户等级 | 0-6（0为未认证，6为最高） |
| `fans` | int | 粉丝数（原始数字） | 12345 |
| `friend` | int | 关注数（原始数字） | 100 |

**数据来源**：`bilibili_api.user.User.get_user_info()`

**使用场景**：
- 显示UP主基本信息
- 展示粉丝数和关注数
- 显示头像和签名

---

### 2. UP主统计数据（user_stat）

**获取方法**：`get_user_stat(mid)` 或 `_get_user_stat_async(mid)`

**数据字段**：

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| `videos` | int | 总播放数 | 从视频列表计算得出 |
| `likes` | int | 获赞总数 | 从用户统计信息获取 |
| `views` | int | 总播放数（同videos） | 与videos字段相同 |

**数据来源**：
- 优先使用 `get_user_stat()` 方法（如果可用）
- 如果不可用，从用户信息中获取 `likes`
- 如果总播放数为0，从视频列表计算（前50个视频的播放数之和）

**使用场景**：
- 展示UP主整体数据统计
- 分析UP主影响力
- 数据可视化展示

**注意事项**：
- `videos` 字段实际表示总播放数，不是视频数量
- 如果API方法不可用，会尝试从视频列表计算，可能不准确
- 返回的数据可能为0（如果获取失败）

---

### 3. 视频列表（videos）

**获取方法**：`get_user_videos(mid, pn, ps)` 或 `_get_user_videos_async(mid, page, page_size)`

**参数说明**：
- `mid`：UP主的UID
- `pn` / `page`：页码（从1开始）
- `ps` / `page_size`：每页数量（默认10）

**单个视频数据字段**：

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `bvid` | str | 视频BV号 | "BV1xx411c7mD" |
| `aid` | int | 视频AV号 | 123456789 |
| `title` | str | 视频标题 | "具身智能最新进展..." |
| `pic` | str | 视频封面图URL | "https://i0.hdslb.com/bfs/archive/..." |
| `play` | int | 播放数（原始数字） | 12345 |
| `video_review` | int | 评论数（原始数字） | 100 |
| `favorites` | int | 收藏数（原始数字） | 500 |
| `pubdate` | int | 发布时间（Unix时间戳，秒） | 1701234567 |
| `description` | str | 视频简介/描述 | "本期视频介绍..." |
| `length` | str | 视频时长 | "10:30"（格式：分:秒） |

**数据来源**：`bilibili_api.user.User.get_videos(pn, ps)`

**数据适配说明**：
- 播放数：优先使用 `play` 字段，如果没有则从 `stat.view` 获取
- 评论数：优先使用 `video_review` 字段，如果没有则从 `stat.reply` 获取
- 收藏数：优先使用 `favorites` 字段，如果没有则从 `stat.favorite` 获取
- 发布时间：优先使用 `created` 字段，如果没有则使用 `pubdate` 字段
- 时间戳处理：如果时间戳看起来像毫秒（大于当前时间戳的10倍），则除以1000转换为秒

**使用场景**：
- 展示UP主最新视频列表
- 视频数据统计和分析
- 视频链接跳转（通过bvid生成视频URL）

**视频URL生成**：
```
https://www.bilibili.com/video/{bvid}
```

---

## 🔄 完整数据获取（get_all_data）

**获取方法**：`get_all_data(mid, video_count=10)`

**功能说明**：
- 使用异步方式并发获取所有数据（用户信息、统计数据、视频列表）
- 提高数据获取效率
- 返回完整的数据字典

**返回数据结构**：

```python
{
    'user_info': {
        'mid': 1172054289,
        'name': '逐际动力',
        'face': '...',
        'sign': '...',
        'level': 0,
        'fans': 12345,
        'friend': 100
    },
    'user_stat': {
        'videos': 100000,  # 总播放数
        'likes': 5000,     # 获赞数
        'views': 100000    # 总播放数（同videos）
    },
    'videos': [
        {
            'bvid': 'BV1xx411c7mD',
            'aid': 123456789,
            'title': '...',
            'pic': '...',
            'play': 12345,
            'video_review': 100,
            'favorites': 500,
            'pubdate': 1701234567,
            'description': '...',
            'length': '10:30'
        },
        # ... 更多视频
    ],
    'updated_at': '2025-12-14T10:30:00'  # ISO格式时间戳
}
```

**性能优化**：
- 使用 `asyncio.gather()` 并发获取三个数据源
- 异常处理：如果某个数据源获取失败，其他数据源仍可正常返回
- 返回 `None` 仅当用户信息获取失败时（用户信息是必需的）

---

## 📈 数据格式化

### 数字格式化（format_number）

**功能**：将大数字格式化为易读格式

**规则**：
- 大于等于1亿：显示为 "X.X亿"
- 大于等于1万：显示为 "X.X万"
- 小于1万：显示原始数字

**示例**：
- `123456789` → `"1.2亿"`
- `12345` → `"1.2万"`
- `123` → `"123"`

### 时间戳格式化（format_timestamp）

**功能**：将Unix时间戳格式化为可读时间

**格式**：`YYYY-MM-DD HH:MM`（中国时区 UTC+8）

**示例**：
- `1701234567` → `"2025-12-14 10:30"`

---

## 🔐 缓存机制

**缓存位置**：`app.py` 中的全局变量 `bilibili_cache`

**缓存策略**：
- **缓存时长**：10分钟（600秒）
- **缓存键**：`bilibili_cache['data']` - 存储完整响应数据
- **过期时间**：`bilibili_cache['expires_at']` - Unix时间戳

**缓存逻辑**：
1. 检查缓存是否存在且未过期
2. 如果缓存有效，直接返回缓存数据
3. 如果缓存无效或不存在，重新获取数据
4. 获取成功后，更新缓存

**使用场景**：
- 减少API调用频率，避免触发B站API频率限制
- 提高响应速度
- 在API失败时，可以返回过期的缓存数据（降级方案）

---

## ⚠️ 注意事项

### API限制

1. **频率限制**：
   - B站API有频率限制，频繁请求可能被限制
   - 建议使用缓存机制，减少API调用

2. **数据准确性**：
   - 统计数据可能不实时更新
   - 视频列表的播放数、评论数等可能有延迟

3. **错误处理**：
   - API调用失败时会返回 `None` 或空字典
   - 需要在前端处理数据为空的情况

### 数据获取失败处理

1. **用户信息获取失败**：
   - `get_all_data()` 会返回 `None`
   - 前端应显示友好的错误提示

2. **统计数据获取失败**：
   - 返回空字典 `{}`
   - 前端应显示默认值（如0）

3. **视频列表获取失败**：
   - 返回空列表 `[]`
   - 前端应显示"暂无视频"提示

### 重试机制

所有同步接口都支持重试：
- **默认重试次数**：2次（总共尝试3次）
- **重试策略**：指数退避（2^attempt 秒）
- **重试条件**：API调用失败或返回None

---

## 📝 使用示例

### 获取完整数据

```python
from bilibili_client import BilibiliClient

client = BilibiliClient()
UP_UID = 1172054289

# 获取完整数据（用户信息+统计数据+视频列表）
data = client.get_all_data(UP_UID, video_count=10)

if data:
    user_info = data['user_info']
    user_stat = data['user_stat']
    videos = data['videos']
    
    print(f"UP主：{user_info['name']}")
    print(f"粉丝数：{user_info['fans']}")
    print(f"视频数：{len(videos)}")
else:
    print("获取数据失败")
```

### 单独获取用户信息

```python
user_info = client.get_user_info(UP_UID)
if user_info:
    print(f"昵称：{user_info['name']}")
    print(f"粉丝数：{user_info['fans']}")
```

### 获取视频列表

```python
videos = client.get_user_videos(UP_UID, pn=1, ps=10)
if videos:
    for video in videos:
        print(f"标题：{video['title']}")
        print(f"播放数：{video['play']}")
        print(f"链接：https://www.bilibili.com/video/{video['bvid']}")
```

---

## 🔗 相关文档

- [API集成目录](./README.md)
- [Semantic Scholar API集成](../Semantic_Scholar/Semantic_Scholar_API集成_20251209.md)
- [APITube API分析](./APITube_API分析_20251209.md)

---

## 📅 更新记录

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2025-12-14 | v1.0 | 初始版本，完整记录B站数据维度 |

---

**最后更新**：2025-12-14  
**维护者**：AI开发助手
