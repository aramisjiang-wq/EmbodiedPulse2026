# 管理后台B站数据手动更新功能说明

## ✅ 功能已添加

在管理后台 `https://admin123.gradmotion.com/admin/bilibili` 添加了"更新B站数据"按钮，可以手动触发数据更新。

## 🎯 功能说明

### 更新内容

点击"更新B站数据"按钮后，系统会：

1. **更新UP主信息**
   - UP主名称、粉丝数、签名等基本信息
   - UP主统计数据（视频数、总播放量、获赞数）

2. **更新视频列表**
   - 新增视频（如果UP主发布了新视频）
   - 视频基本信息（标题、封面、描述等）

3. **更新播放量数据**
   - 直接调用B站API获取每个视频的最新播放量
   - 更新评论数、收藏数等统计数据

4. **清除API缓存**
   - 清除前端API缓存
   - 确保前端立即显示最新数据

5. **同步到前端**
   - 更新完成后，前端页面会自动显示最新数据
   - 无需手动刷新浏览器

## 🚀 使用方法

### 步骤1：在服务器上拉取最新代码

```bash
cd /srv/EmbodiedPulse2026
git pull origin main
```

### 步骤2：重启服务（如果需要）

```bash
systemctl restart embodiedpulse
```

### 步骤3：访问管理后台

1. 访问 `https://admin123.gradmotion.com/admin/bilibili`
2. 登录管理员账号
3. 在页面顶部找到"更新B站数据"按钮
4. 点击按钮，确认更新

### 步骤4：查看更新进度

- 按钮会显示"更新中..."并禁用
- 下方会显示进度条和状态信息
- 更新完成后会自动刷新统计数据

## 📋 更新流程

```
点击按钮
    ↓
确认更新
    ↓
启动后台任务
    ↓
1. 更新UP主信息和视频列表 (20%)
    ↓
2. 更新视频播放量 (60%)
    ↓
3. 清除API缓存 (90%)
    ↓
完成 (100%)
    ↓
自动刷新统计数据
```

## 🔍 技术实现

### 后端API

**端点1：触发更新**
```
POST /api/admin/bilibili/fetch-data
Authorization: Bearer <token>
Content-Type: application/json

{
    "update_play_counts": true,  // 是否更新播放量（默认true）
    "video_count": 50  // 每个UP主抓取的视频数量（默认50）
}
```

**端点2：查询状态**
```
GET /api/admin/bilibili/fetch-status
Authorization: Bearer <token>
```

### 前端功能

- **按钮状态管理**：更新中禁用按钮，显示加载动画
- **实时进度显示**：每2秒轮询一次状态，显示进度条
- **自动刷新**：更新完成后自动刷新统计数据
- **状态持久化**：页面刷新后如果任务还在运行，会继续显示进度

## ⚠️ 注意事项

1. **任务执行时间**
   - 更新所有UP主数据：约5-10分钟（取决于UP主数量）
   - 更新播放量：约10-20分钟（取决于视频数量）
   - 总耗时：约15-30分钟

2. **避免重复点击**
   - 如果任务正在运行，按钮会被禁用
   - 系统会提示"数据更新任务正在运行中"

3. **API限制**
   - B站API有频率限制
   - 脚本已添加延迟，避免触发风控
   - 如果遇到412错误，需要等待一段时间后重试

4. **数据同步**
   - 更新完成后，前端页面会自动显示最新数据
   - 如果前端仍显示旧数据，可以手动刷新页面

## 🔧 故障排查

### 问题1：按钮点击无反应

**检查：**
- 浏览器控制台是否有错误
- 网络请求是否成功
- 管理员权限是否正确

**解决：**
- 刷新页面重试
- 检查浏览器控制台错误信息

### 问题2：更新任务卡住

**检查：**
- 查看服务日志：`journalctl -u embodiedpulse -n 100`
- 检查任务状态：访问 `/api/admin/bilibili/fetch-status`

**解决：**
- 如果任务卡住超过30分钟，可以刷新页面
- 系统会自动检测并重置卡住的任务

### 问题3：更新后前端仍显示旧数据

**检查：**
- 更新任务是否完成
- API缓存是否已清除

**解决：**
- 手动刷新前端页面
- 或访问 `https://essay.gradmotion.com/bilibili` 并点击"刷新数据"按钮

## 📝 相关文件

- `auth_routes.py` - 后端API端点
- `app.py` - 状态变量初始化
- `templates/admin_bilibili.html` - 前端HTML
- `static/js/admin_bilibili.js` - 前端JavaScript
- `static/css/admin.css` - 样式（包含旋转动画）

## ✅ 完成清单

- [x] 添加后端API端点
- [x] 添加前端按钮和状态显示
- [x] 实现后台任务执行
- [x] 实现进度显示和轮询
- [x] 实现缓存清除
- [x] 实现自动刷新
- [x] 提交到GitHub

## 🎉 使用流程

1. **本地开发** → 提交到GitHub
2. **服务器拉取** → `git pull origin main`
3. **重启服务** → `systemctl restart embodiedpulse`
4. **访问管理后台** → 点击"更新B站数据"按钮
5. **等待完成** → 查看进度条和状态
6. **验证结果** → 检查前端页面数据是否更新

所有代码已提交到GitHub，服务器拉取后即可使用！

