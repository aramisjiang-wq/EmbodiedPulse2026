# 自然周数据维度说明

## 概述

系统**完全支持**根据不同年份、不同月份的自然周（周一到周日）进行数据统计和可视化。

## 自然周计算逻辑

### 1. 自然周定义
- **自然周**：从周一到周日，共7天
- 每个自然周都是完整的周一到周日，不受月份或年份边界限制
- 例如：2025年12月8日（周一）- 12月14日（周日）是一个完整的自然周

### 2. 计算算法

系统使用以下算法确保正确识别自然周：

```javascript
// 找到第一个周一（从起始日期开始往前找）
function getFirstMonday(startDate) {
    const firstMonday = new Date(startDate);
    const dayOfWeek = firstMonday.getDay(); // 0=周日, 1=周一, ..., 6=周六
    
    // 正确的计算：找到最近的周一
    // 如果start是周日，往前1天到周一
    // 如果start是周一，就是它自己
    // 如果start是周二到周六，往前(dayOfWeek-1)天到周一
    const daysToMonday = dayOfWeek === 0 ? 1 : (dayOfWeek === 1 ? 0 : dayOfWeek - 1);
    firstMonday.setDate(firstMonday.getDate() - daysToMonday);
    firstMonday.setHours(0, 0, 0, 0);
    
    // 如果第一个周一在start之前，从下一个周一开始
    if (firstMonday < startDate) {
        firstMonday.setDate(firstMonday.getDate() + 7);
    }
    
    return firstMonday;
}

// 生成所有自然周（周一到周日）
let cursor = new Date(firstMonday);
while (cursor <= endDate) {
    const weekStart = new Date(cursor); // 周一
    const weekEnd = new Date(cursor);
    weekEnd.setDate(weekEnd.getDate() + 6); // 周日
    weekEnd.setHours(23, 59, 59, 999);
    
    // 生成自然周数据...
    cursor.setDate(cursor.getDate() + 7); // 移动到下一周（下周一）
}
```

### 3. 验证测试

#### 测试1：2025年12月的自然周
```
开始日期: 2025/11/22 (星期六)
结束日期: 2025/12/21 (星期日)

生成的自然周：
  ✅ 11/24-11/30 (周一到周日)
  ✅ 12/01-12/07 (周一到周日)
  ✅ 12/08-12/14 (周一到周日) ← 您提到的自然周
  ✅ 12/15-12/21 (周一到周日) ← 您提到的自然周
```

#### 测试2：跨年自然周（2024年12月到2025年1月）
```
生成的自然周：
  ✅ 2024-12/23-2024-12/29 (周一到周日)
  ✅ 2024-12/30-2025-01/05 (周一到周日) ← 跨年自然周
  ✅ 2025-01/06-2025-01/12 (周一到周日)
  ✅ 2025-01/13-2025-01/15 (周一到周三) ← 不完整周（截断到今天）
```

## 系统支持的功能

### ✅ 已实现的功能

1. **堆叠面积图（按自然周统计）**
   - 位置：`templates/bilibili.html` → `generateTrendsData()` 函数
   - 功能：按自然周（周一到周日）聚合视频发布数量
   - 显示：近30天的自然周数据

2. **热力图（按自然周统计）**
   - 位置：`templates/bilibili.html` → `renderTrendsHeatmap()` 函数
   - 功能：按自然周（周一到周日）显示各公司的视频发布热力图
   - 显示：近30天的自然周数据

3. **跨年、跨月支持**
   - ✅ 支持跨年自然周（如：2024-12/30 到 2025-01/05）
   - ✅ 支持跨月自然周（如：11/24-11/30）
   - ✅ 自动处理月份和年份边界

4. **数据维度**
   - 时间维度：自然周（周一到周日）
   - 公司维度：按UP主/公司分组
   - 指标维度：视频发布数量

### 📊 数据展示格式

- **周标签格式**：`MM/DD-MM/DD`（如：`12/08-12/14`）
- **周范围**：周一到周日
- **数据聚合**：每个自然周内的所有视频发布数量

## 技术实现细节

### 1. 自然周识别
- 使用JavaScript的`Date.getDay()`方法获取星期几
- 通过计算找到最近的周一作为自然周起点
- 从周一开始，每次加7天生成下一个自然周

### 2. 数据聚合
- 视频发布日期通过`pubdate_raw`（Unix时间戳）获取
- 将视频发布日期映射到对应的自然周
- 统计每个自然周内每个公司的视频发布数量

### 3. 边界处理
- **起始边界**：如果起始日期不是周一，自动找到最近的周一
- **结束边界**：如果结束日期不是周日，最后一个自然周只包含到结束日期
- **跨月/跨年**：自动处理月份和年份的边界，不影响自然周的计算

## 使用示例

### 查看2025年12月的自然周数据

1. 打开"具身视频Hub"页面
2. 查看"视频发布数量趋势"模块
3. 切换到"堆叠面积图"或"热力图"视图
4. 系统会自动显示包含2025年12月8日-14日和12月15日-21日的自然周数据

### 数据维度说明

- **X轴**：自然周（周一到周日），格式为 `MM/DD-MM/DD`
- **Y轴**：视频发布数量
- **颜色**：不同公司用不同颜色区分
- **堆叠**：多个公司的数据堆叠显示，可以看到每周的总发布量

## 总结

✅ **系统完全支持根据不同年份、不同月份的自然周进行数据统计**

- ✅ 正确识别自然周（周一到周日）
- ✅ 支持跨年、跨月的自然周
- ✅ 自动处理边界情况
- ✅ 数据聚合准确
- ✅ 可视化展示清晰

系统已经修复了自然周计算的bug，现在可以准确识别和展示任何年份、任何月份的自然周数据。

