# 飞书扫码登录及管理端系统实现方案 v2.0

## 方案信息
- **生成时间**: 2025-12-16 19:00
- **版本**: v2.0（优化版）
- **技术栈**: Flask + SQLAlchemy + PostgreSQL + Vanilla JS
- **目标**: 集成飞书OAuth2.0登录，构建用户自服务和管理员管理双系统

**更新说明**：
- ✨ 新增用户个人中心功能
- ✨ 明确用户端和管理端的API边界
- ✨ 统一数据库，分层权限控制

---

## 一、需求理解（优化版）

### 1.1 核心功能

#### 用户端（普通用户）
- ✅ 飞书扫码登录
- ✅ 登录后访问网站内容
- ✅ **个人中心**（新增）
  - 查看个人信息（姓名、邮箱、部门、头像等）
  - 查看个人登录历史
  - 查看个人访问记录
  - 修改个人信息（头像、邮箱、手机等）
  - 查看个人权限和角色
  - 查看账号状态
- ✅ 登录状态管理
- ✅ 退出登录

#### 管理端（管理员）
- ✅ 管理员登录（用户名密码 或 飞书扫码）
- ✅ **用户管理**（查看所有用户）
  - 查看、编辑、启用/禁用用户
  - 修改用户角色和权限
  - 批量操作用户
- ✅ **访问日志监控**（查看所有用户日志）
- ✅ **统计数据展示**（全局数据）
- ✅ **超级管理员权限控制**

### 1.2 关键差异

| 功能 | 用户端（User） | 管理端（Admin） | 数据源 |
|------|----------------|-----------------|--------|
| 查看用户信息 | 只能看自己 | 可以看所有人 | 同一个`auth_users`表 |
| 修改用户信息 | 只能改自己的基本信息 | 可以改所有人的所有信息 | 同一个`auth_users`表 |
| 登录历史 | 只能看自己的 | 可以看所有人的 | 同一个`login_history`表 |
| 访问日志 | 只能看自己的 | 可以看所有人的 | 同一个`access_logs`表 |
| 角色权限 | 只能查看，不能修改 | 可以查看和修改所有人 | 同一个`auth_users`表 |

---

## 二、技术架构设计（优化版）

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│             飞书登录系统架构（三层结构）                       │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                        用户端（User）                         │
└─────────────────────────────────────────────────────────────┘

[普通用户浏览器]
    ↓
┌───────────────────────────┐
│ 前端页面                  │
│ - login.html              │ → 飞书扫码登录
│ - index.html              │ → 网站内容（权限保护）
│ - profile.html ✨         │ → 个人中心（新增）
└───────────────────────────┘
    ↓ AJAX
┌───────────────────────────┐
│ 用户API（User API）       │
│ /api/auth/*               │ → 认证相关
│ /api/user/*  ✨          │ → 个人信息（新增）
└───────────────────────────┘
    ↓
┌───────────────────────────┐
│ 权限检查：@login_required │ → 只能访问自己的数据
└───────────────────────────┘
    ↓
┌───────────────────────────┐
│ 飞书开放平台              │ → OAuth2.0认证
└───────────────────────────┘
    ↓
┌───────────────────────────┐
│ JWT Token                 │ → 存储到LocalStorage
└───────────────────────────┘


┌─────────────────────────────────────────────────────────────┐
│                       管理端（Admin）                         │
└─────────────────────────────────────────────────────────────┘

[管理员浏览器]
    ↓
┌───────────────────────────┐
│ 管理前端                  │
│ - admin_login.html        │ → 管理员登录
│ - admin_dashboard.html    │ → 仪表盘
│ - admin_users.html        │ → 用户管理
│ - admin_logs.html         │ → 日志监控
└───────────────────────────┘
    ↓ AJAX
┌───────────────────────────┐
│ 管理API（Admin API）      │
│ /api/admin/*              │ → 管理功能
└───────────────────────────┘
    ↓
┌───────────────────────────┐
│ 权限检查：@admin_required │ → 可以访问所有用户数据
└───────────────────────────┘


┌─────────────────────────────────────────────────────────────┐
│                      数据层（Database）                       │
└─────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────┐
│ PostgreSQL / SQLite                                       │
│                                                           │
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│ │ auth_users  │  │admin_users  │  │access_logs  │       │
│ │ (用户表)    │  │ (管理员表)  │  │ (访问日志)  │       │
│ └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                           │
│ ┌─────────────┐                                          │
│ │login_history│                                          │
│ │ (登录历史)  │                                          │
│ └─────────────┘                                          │
└───────────────────────────────────────────────────────────┘
         ↑                                ↑
         │                                │
    [用户API访问]                    [管理API访问]
    (只能查自己)                     (可以查所有人)
```

### 2.2 数据流示意

#### 用户端数据流
```
用户登录 → JWT Token → /api/user/profile（携带token）
                    ↓
              提取token中的user_id
                    ↓
          查询auth_users表（WHERE id = user_id）
                    ↓
              返回该用户的数据
```

#### 管理端数据流
```
管理员登录 → JWT Token（含admin标识） → /api/admin/users（携带token）
                                      ↓
                                检查是否为admin
                                      ↓
                        查询auth_users表（无限制）
                                      ↓
                              返回所有用户数据
```

---

## 三、数据库设计（不变）

### 3.1 表结构

数据库设计与v1.0保持一致，包括：
1. `auth_users` - 认证用户表
2. `admin_users` - 管理员表
3. `access_logs` - 访问日志表
4. `login_history` - 登录历史表

**关键点**：
- ✅ 用户端和管理端访问**同一个数据库**
- ✅ 通过**API权限控制**区分访问范围
- ✅ 用户只能访问`user_id = 自己ID`的数据
- ✅ 管理员可以访问所有数据

---

## 四、后端API设计（优化版）

### 4.1 认证API（公共）

保持不变：
- `POST /api/auth/feishu/login` - 生成飞书登录URL
- `GET /api/auth/feishu/callback` - 飞书回调处理
- `GET /api/auth/user-info` - 获取当前用户信息（基本）
- `POST /api/auth/logout` - 退出登录

---

### 4.2 用户端API（新增）✨

#### 1. 获取个人详细信息

```python
@app.route('/api/user/profile', methods=['GET'])
@login_required
def get_user_profile():
    """
    获取当前登录用户的详细信息
    
    请求: GET /api/user/profile
    Header: Authorization: Bearer <token>
    
    响应: {
      "success": true,
      "user": {
        "id": 1,
        "feishu_id": "ou_xxx",
        "name": "张三",
        "email": "zhangsan@example.com",
        "mobile": "13800138000",
        "avatar_url": "https://...",
        "department": "技术部",
        "user_type": "内部",
        "role": "user",
        "status": "active",
        "login_count": 50,
        "last_login_at": "2025-12-16 10:00:00",
        "created_at": "2025-01-01 09:00:00"
      }
    }
    """
    user = request.current_user  # 从装饰器获取
    return jsonify({
        'success': True,
        'user': user.to_dict()
    })
```

#### 2. 更新个人信息

```python
@app.route('/api/user/profile', methods=['PUT'])
@login_required
def update_user_profile():
    """
    更新当前用户的个人信息（仅限部分字段）
    
    请求: PUT /api/user/profile
    {
      "email": "newemail@example.com",
      "mobile": "13900139000",
      "avatar_url": "https://new-avatar.png"
    }
    
    限制: 只能修改email、mobile、avatar_url
          不能修改role、status、user_type等关键字段
    
    响应: {
      "success": true,
      "message": "个人信息更新成功",
      "user": {...}
    }
    """
    user = request.current_user
    data = request.get_json()
    
    # 只允许修改特定字段
    allowed_fields = ['email', 'mobile', 'avatar_url']
    
    for field in allowed_fields:
        if field in data:
            setattr(user, field, data[field])
    
    db.session.commit()
    
    return jsonify({
        'success': True,
        'message': '个人信息更新成功',
        'user': user.to_dict()
    })
```

#### 3. 获取个人登录历史

```python
@app.route('/api/user/login-history', methods=['GET'])
@login_required
def get_user_login_history():
    """
    获取当前用户的登录历史
    
    请求: GET /api/user/login-history?page=1&per_page=20
    
    响应: {
      "success": true,
      "history": [
        {
          "id": 100,
          "login_type": "feishu",
          "status": "success",
          "ip_address": "192.168.1.100",
          "location": "北京市",
          "login_time": "2025-12-16 10:00:00"
        },
        ...
      ],
      "total": 50,
      "page": 1,
      "per_page": 20
    }
    """
    user = request.current_user
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    
    # 只查询当前用户的登录历史
    query = LoginHistory.query.filter_by(user_id=user.id)
    pagination = query.order_by(LoginHistory.login_time.desc()).paginate(
        page=page, per_page=per_page, error_out=False
    )
    
    return jsonify({
        'success': True,
        'history': [h.to_dict() for h in pagination.items],
        'total': pagination.total,
        'page': page,
        'per_page': per_page
    })
```

#### 4. 获取个人访问日志

```python
@app.route('/api/user/access-logs', methods=['GET'])
@login_required
def get_user_access_logs():
    """
    获取当前用户的访问日志
    
    请求: GET /api/user/access-logs?page=1&per_page=50&start_date=2025-12-01
    
    响应: {
      "success": true,
      "logs": [
        {
          "id": 1000,
          "page_url": "https://example.com/",
          "page_title": "首页",
          "access_time": "2025-12-16 10:00:00",
          "duration": 120  // 秒
        },
        ...
      ],
      "total": 200,
      "page": 1,
      "per_page": 50
    }
    """
    user = request.current_user
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 50, type=int)
    
    # 只查询当前用户的访问日志
    query = AccessLog.query.filter_by(user_id=user.id)
    
    # 可选的日期筛选
    start_date = request.args.get('start_date')
    if start_date:
        query = query.filter(AccessLog.access_time >= start_date)
    
    pagination = query.order_by(AccessLog.access_time.desc()).paginate(
        page=page, per_page=per_page, error_out=False
    )
    
    return jsonify({
        'success': True,
        'logs': [log.to_dict() for log in pagination.items],
        'total': pagination.total,
        'page': page,
        'per_page': per_page
    })
```

#### 5. 获取个人统计数据

```python
@app.route('/api/user/stats', methods=['GET'])
@login_required
def get_user_stats():
    """
    获取当前用户的统计数据
    
    请求: GET /api/user/stats
    
    响应: {
      "success": true,
      "stats": {
        "total_logins": 50,
        "last_login": "2025-12-16 10:00:00",
        "total_access": 200,
        "today_access": 10,
        "most_visited_page": "/papers",
        "account_age_days": 30
      }
    }
    """
    user = request.current_user
    
    # 计算各种统计数据
    total_logins = user.login_count
    last_login = user.last_login_at
    total_access = AccessLog.query.filter_by(user_id=user.id).count()
    
    today = datetime.now().date()
    today_access = AccessLog.query.filter(
        AccessLog.user_id == user.id,
        AccessLog.access_time >= today
    ).count()
    
    # 最常访问的页面
    most_visited = db.session.query(
        AccessLog.page_url,
        db.func.count(AccessLog.id).label('count')
    ).filter_by(user_id=user.id).group_by(
        AccessLog.page_url
    ).order_by(db.desc('count')).first()
    
    # 账号年龄
    account_age = (datetime.now() - user.created_at).days
    
    return jsonify({
        'success': True,
        'stats': {
            'total_logins': total_logins,
            'last_login': last_login.isoformat() if last_login else None,
            'total_access': total_access,
            'today_access': today_access,
            'most_visited_page': most_visited[0] if most_visited else None,
            'account_age_days': account_age
        }
    })
```

---

### 4.3 管理端API（保持不变）

管理端API与v1.0保持一致：
- `POST /api/admin/login` - 管理员登录
- `GET /api/admin/users` - 获取所有用户列表
- `GET /api/admin/users/<id>` - 获取任意用户详情
- `PUT /api/admin/users/<id>` - 更新任意用户信息
- `GET /api/admin/logs` - 获取所有访问日志
- `GET /api/admin/stats` - 获取全局统计数据

**关键区别**：
- 管理员可以访问**所有用户**的数据
- 管理员可以修改**所有字段**（包括role、status等）
- 需要`@admin_required`装饰器

---

## 五、前端设计（优化版）

### 5.1 用户端页面

#### 1. 登录页面（不变）
- `templates/login.html` - 飞书扫码登录

#### 2. 主页面（不变）
- `templates/index.html` - 网站内容（添加权限检查）

#### 3. 个人中心页面（新增）✨

**`templates/profile.html`**

```html
<!DOCTYPE html>
<html>
<head>
    <title>个人中心 - Embodied Pulse</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/profile.css">
</head>
<body>
    <!-- 导航栏（包含返回主页、个人中心、退出） -->
    <nav class="user-nav">
        <div class="nav-left">
            <a href="/">首页</a>
            <a href="/profile" class="active">个人中心</a>
        </div>
        <div class="nav-right">
            <span class="user-name" id="nav-user-name"></span>
            <button id="logout-btn" class="btn-logout">退出</button>
        </div>
    </nav>
    
    <!-- 主内容 -->
    <div class="profile-container">
        <!-- 侧边栏 -->
        <aside class="profile-sidebar">
            <div class="user-card">
                <img id="user-avatar" src="" alt="头像" class="user-avatar-large">
                <h2 id="user-name"></h2>
                <p id="user-department"></p>
                <span id="user-role-badge" class="badge"></span>
            </div>
            
            <nav class="profile-menu">
                <a href="#info" class="active" data-tab="info">
                    <i class="fa fa-user"></i> 基本信息
                </a>
                <a href="#edit" data-tab="edit">
                    <i class="fa fa-edit"></i> 编辑资料
                </a>
                <a href="#login" data-tab="login">
                    <i class="fa fa-history"></i> 登录历史
                </a>
                <a href="#activity" data-tab="activity">
                    <i class="fa fa-chart-line"></i> 访问记录
                </a>
                <a href="#stats" data-tab="stats">
                    <i class="fa fa-bar-chart"></i> 数据统计
                </a>
            </nav>
        </aside>
        
        <!-- 主内容区 -->
        <main class="profile-main">
            <!-- Tab 1: 基本信息 -->
            <div id="tab-info" class="profile-tab active">
                <h1>基本信息</h1>
                <div class="info-card">
                    <div class="info-row">
                        <label>姓名</label>
                        <span id="info-name"></span>
                    </div>
                    <div class="info-row">
                        <label>邮箱</label>
                        <span id="info-email"></span>
                    </div>
                    <div class="info-row">
                        <label>手机</label>
                        <span id="info-mobile"></span>
                    </div>
                    <div class="info-row">
                        <label>部门</label>
                        <span id="info-department"></span>
                    </div>
                    <div class="info-row">
                        <label>用户类型</label>
                        <span id="info-user-type"></span>
                    </div>
                    <div class="info-row">
                        <label>角色</label>
                        <span id="info-role"></span>
                    </div>
                    <div class="info-row">
                        <label>账号状态</label>
                        <span id="info-status"></span>
                    </div>
                    <div class="info-row">
                        <label>注册时间</label>
                        <span id="info-created"></span>
                    </div>
                    <div class="info-row">
                        <label>最后登录</label>
                        <span id="info-last-login"></span>
                    </div>
                </div>
            </div>
            
            <!-- Tab 2: 编辑资料 -->
            <div id="tab-edit" class="profile-tab">
                <h1>编辑资料</h1>
                <form id="profile-edit-form" class="edit-form">
                    <div class="form-group">
                        <label>邮箱</label>
                        <input type="email" name="email" id="edit-email" required>
                    </div>
                    <div class="form-group">
                        <label>手机</label>
                        <input type="tel" name="mobile" id="edit-mobile">
                    </div>
                    <div class="form-group">
                        <label>头像URL</label>
                        <input type="url" name="avatar_url" id="edit-avatar">
                    </div>
                    <div class="form-notice">
                        <i class="fa fa-info-circle"></i>
                        注意：姓名、部门、角色等信息由管理员管理，无法自行修改
                    </div>
                    <button type="submit" class="btn-primary">保存修改</button>
                </form>
            </div>
            
            <!-- Tab 3: 登录历史 -->
            <div id="tab-login" class="profile-tab">
                <h1>登录历史</h1>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>登录时间</th>
                            <th>登录方式</th>
                            <th>IP地址</th>
                            <th>地理位置</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="login-history-tbody"></tbody>
                </table>
                <div id="login-pagination" class="pagination"></div>
            </div>
            
            <!-- Tab 4: 访问记录 -->
            <div id="tab-activity" class="profile-tab">
                <h1>访问记录</h1>
                <div class="activity-filters">
                    <input type="date" id="activity-start-date" placeholder="开始日期">
                    <button id="activity-filter-btn" class="btn-secondary">筛选</button>
                </div>
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>访问时间</th>
                            <th>页面</th>
                            <th>停留时长</th>
                        </tr>
                    </thead>
                    <tbody id="activity-tbody"></tbody>
                </table>
                <div id="activity-pagination" class="pagination"></div>
            </div>
            
            <!-- Tab 5: 数据统计 -->
            <div id="tab-stats" class="profile-tab">
                <h1>数据统计</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fa fa-sign-in"></i></div>
                        <div class="stat-value" id="stat-total-logins">0</div>
                        <div class="stat-label">总登录次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fa fa-eye"></i></div>
                        <div class="stat-value" id="stat-total-access">0</div>
                        <div class="stat-label">总访问次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fa fa-calendar"></i></div>
                        <div class="stat-value" id="stat-today-access">0</div>
                        <div class="stat-label">今日访问</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fa fa-clock"></i></div>
                        <div class="stat-value" id="stat-account-age">0</div>
                        <div class="stat-label">账号天数</div>
                    </div>
                </div>
                <div class="stats-detail">
                    <h3>最常访问页面</h3>
                    <p id="stat-most-visited">-</p>
                </div>
            </div>
        </main>
    </div>
    
    <script src="/static/js/profile.js"></script>
</body>
</html>
```

**JavaScript逻辑** (`static/js/profile.js`):

```javascript
// 检查登录状态
const token = localStorage.getItem('auth_token');
if (!token) {
    window.location.href = '/login';
}

// 当前Tab
let currentTab = 'info';

// 加载用户详细信息
async function loadUserProfile() {
    try {
        const response = await fetch('/api/user/profile', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('获取用户信息失败');
        }
        
        const data = await response.json();
        if (data.success) {
            displayUserProfile(data.user);
        }
    } catch (error) {
        console.error(error);
        alert('获取用户信息失败');
    }
}

// 显示用户信息
function displayUserProfile(user) {
    // 侧边栏用户卡片
    document.getElementById('user-avatar').src = user.avatar_url || '/static/images/default-avatar.png';
    document.getElementById('user-name').textContent = user.name;
    document.getElementById('user-department').textContent = user.department || '-';
    document.getElementById('user-role-badge').textContent = getRoleLabel(user.role);
    
    // 导航栏
    document.getElementById('nav-user-name').textContent = user.name;
    
    // Tab 1: 基本信息
    document.getElementById('info-name').textContent = user.name;
    document.getElementById('info-email').textContent = user.email || '-';
    document.getElementById('info-mobile').textContent = user.mobile || '-';
    document.getElementById('info-department').textContent = user.department || '-';
    document.getElementById('info-user-type').textContent = user.user_type;
    document.getElementById('info-role').textContent = getRoleLabel(user.role);
    document.getElementById('info-status').textContent = getStatusLabel(user.status);
    document.getElementById('info-created').textContent = formatDateTime(user.created_at);
    document.getElementById('info-last-login').textContent = formatDateTime(user.last_login_at);
    
    // Tab 2: 编辑表单
    document.getElementById('edit-email').value = user.email || '';
    document.getElementById('edit-mobile').value = user.mobile || '';
    document.getElementById('edit-avatar').value = user.avatar_url || '';
}

// 加载登录历史
async function loadLoginHistory(page = 1) {
    try {
        const response = await fetch(`/api/user/login-history?page=${page}&per_page=20`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        if (data.success) {
            displayLoginHistory(data.history);
            displayPagination('login-pagination', page, data.total, 20, loadLoginHistory);
        }
    } catch (error) {
        console.error(error);
    }
}

// 加载访问记录
async function loadAccessLogs(page = 1, startDate = null) {
    try {
        let url = `/api/user/access-logs?page=${page}&per_page=50`;
        if (startDate) {
            url += `&start_date=${startDate}`;
        }
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        if (data.success) {
            displayAccessLogs(data.logs);
            displayPagination('activity-pagination', page, data.total, 50, loadAccessLogs);
        }
    } catch (error) {
        console.error(error);
    }
}

// 加载统计数据
async function loadUserStats() {
    try {
        const response = await fetch('/api/user/stats', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        if (data.success) {
            displayUserStats(data.stats);
        }
    } catch (error) {
        console.error(error);
    }
}

// 更新个人信息
document.getElementById('profile-edit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/user/profile', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('个人信息更新成功');
            loadUserProfile();
        } else {
            alert('更新失败：' + result.message);
        }
    } catch (error) {
        console.error(error);
        alert('更新失败');
    }
});

// Tab切换
document.querySelectorAll('.profile-menu a').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const tab = e.currentTarget.dataset.tab;
        switchTab(tab);
    });
});

function switchTab(tab) {
    // 更新菜单激活状态
    document.querySelectorAll('.profile-menu a').forEach(a => a.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    
    // 更新内容显示
    document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    // 加载对应数据
    currentTab = tab;
    if (tab === 'login') {
        loadLoginHistory();
    } else if (tab === 'activity') {
        loadAccessLogs();
    } else if (tab === 'stats') {
        loadUserStats();
    }
}

// 退出登录
document.getElementById('logout-btn').addEventListener('click', async () => {
    try {
        await fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
    } catch (error) {
        console.error(error);
    } finally {
        localStorage.removeItem('auth_token');
        window.location.href = '/login';
    }
});

// 初始化
loadUserProfile();

// 工具函数
function getRoleLabel(role) {
    const labels = {
        'user': '普通用户',
        'admin': '管理员',
        'super_admin': '超级管理员'
    };
    return labels[role] || role;
}

function getStatusLabel(status) {
    const labels = {
        'active': '正常',
        'inactive': '未激活',
        'banned': '已禁用'
    };
    return labels[status] || status;
}

function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleString('zh-CN');
}
```

---

### 5.2 管理端页面（保持不变）

管理端页面与v1.0保持一致：
- `admin_login.html` - 管理员登录
- `admin_dashboard.html` - 仪表盘
- `admin_users.html` - 用户管理
- `admin_logs.html` - 日志监控

---

## 六、权限控制设计

### 6.1 权限装饰器

```python
# auth_decorators.py

from functools import wraps
from flask import request, jsonify

def login_required(f):
    """
    需要登录（普通用户）
    只能访问自己的数据
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        token = request.headers.get('Authorization', '').replace('Bearer ', '')
        
        if not token:
            return jsonify({'success': False, 'message': '未登录'}), 401
        
        user_id = verify_jwt_token(token, app.config['SECRET_KEY'])
        if not user_id:
            return jsonify({'success': False, 'message': 'Token无效或已过期'}), 401
        
        # 查询用户
        user = db.session.query(AuthUser).get(user_id)
        if not user or user.status != 'active':
            return jsonify({'success': False, 'message': '用户不存在或已被禁用'}), 403
        
        # 将用户信息添加到request对象
        request.current_user = user
        
        return f(*args, **kwargs)
    
    return decorated_function

def admin_required(f):
    """
    需要管理员权限
    可以访问所有用户的数据
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        token = request.headers.get('Authorization', '').replace('Bearer ', '')
        
        if not token:
            return jsonify({'success': False, 'message': '未登录'}), 401
        
        user_id = verify_jwt_token(token, app.config['SECRET_KEY'])
        if not user_id:
            return jsonify({'success': False, 'message': 'Token无效或已过期'}), 401
        
        # 查询用户（可以是auth_users或admin_users）
        user = db.session.query(AuthUser).get(user_id)
        if not user:
            # 尝试查询管理员表
            admin = db.session.query(AdminUser).get(user_id)
            if not admin or admin.status != 'active':
                return jsonify({'success': False, 'message': '权限不足'}), 403
            if admin.role not in ['admin', 'super_admin']:
                return jsonify({'success': False, 'message': '权限不足'}), 403
            request.current_user = admin
        else:
            if user.role not in ['admin', 'super_admin'] or user.status != 'active':
                return jsonify({'success': False, 'message': '权限不足'}), 403
            request.current_user = user
        
        return f(*args, **kwargs)
    
    return decorated_function
```

### 6.2 数据访问权限矩阵

| API端点 | 装饰器 | 数据范围 | 权限说明 |
|---------|--------|----------|----------|
| `/api/user/profile` (GET) | `@login_required` | `user_id = 当前用户` | 只能看自己 |
| `/api/user/profile` (PUT) | `@login_required` | `user_id = 当前用户` | 只能改自己（部分字段） |
| `/api/user/login-history` | `@login_required` | `user_id = 当前用户` | 只能看自己 |
| `/api/user/access-logs` | `@login_required` | `user_id = 当前用户` | 只能看自己 |
| `/api/user/stats` | `@login_required` | `user_id = 当前用户` | 只能看自己 |
| `/api/admin/users` | `@admin_required` | 无限制 | 可以看所有人 |
| `/api/admin/users/<id>` | `@admin_required` | 无限制 | 可以看任何人 |
| `/api/admin/users/<id>` (PUT) | `@admin_required` | 无限制 | 可以改任何人（所有字段） |
| `/api/admin/logs` | `@admin_required` | 无限制 | 可以看所有日志 |
| `/api/admin/stats` | `@admin_required` | 无限制 | 可以看全局统计 |

---

## 七、路由设计（完整版）

### 7.1 前端路由

```python
# app.py - 前端页面路由

@app.route('/')
def index():
    """主页（需要登录）"""
    return render_template('index.html')

@app.route('/login')
def login_page():
    """登录页"""
    return render_template('login.html')

@app.route('/profile')  # ✨ 新增
def profile_page():
    """个人中心（需要登录）"""
    return render_template('profile.html')

@app.route('/admin/login')
def admin_login_page():
    """管理员登录页"""
    return render_template('admin_login.html')

@app.route('/admin/dashboard')
def admin_dashboard_page():
    """管理员仪表盘（需要管理员权限）"""
    return render_template('admin_dashboard.html')

@app.route('/admin/users')
def admin_users_page():
    """用户管理页（需要管理员权限）"""
    return render_template('admin_users.html')

@app.route('/admin/logs')
def admin_logs_page():
    """日志监控页（需要管理员权限）"""
    return render_template('admin_logs.html')
```

### 7.2 API路由（完整版）

```python
# 认证相关（公共）
POST   /api/auth/feishu/login        # 生成飞书登录URL
GET    /api/auth/feishu/callback     # 飞书回调处理
GET    /api/auth/user-info           # 获取当前用户基本信息
POST   /api/auth/logout              # 退出登录

# 用户端API（需要@login_required）✨
GET    /api/user/profile             # 获取个人详细信息
PUT    /api/user/profile             # 更新个人信息
GET    /api/user/login-history       # 获取个人登录历史
GET    /api/user/access-logs         # 获取个人访问日志
GET    /api/user/stats               # 获取个人统计数据

# 管理端API（需要@admin_required）
POST   /api/admin/login              # 管理员登录
GET    /api/admin/users              # 获取所有用户列表
GET    /api/admin/users/<id>         # 获取任意用户详情
PUT    /api/admin/users/<id>         # 更新任意用户信息
POST   /api/admin/users/batch        # 批量操作用户
GET    /api/admin/logs               # 获取所有访问日志
GET    /api/admin/login-history      # 获取所有登录历史
GET    /api/admin/logs/export        # 导出日志
GET    /api/admin/stats              # 获取全局统计数据
GET    /api/admin/recent-activity    # 获取最近活动
```

---

## 八、实现时间估算（更新）

### 8.1 开发时间（工作日）

| 阶段 | 任务 | 时间 | 变化 |
|------|------|------|------|
| Phase 1 | 数据库设计和创建 | 1天 | 不变 |
| Phase 1 | 飞书OAuth2.0集成 | 2天 | 不变 |
| Phase 1 | JWT认证实现 | 1天 | 不变 |
| Phase 2 | 用户端登录页面 | 1天 | 不变 |
| **Phase 2** | **用户个人中心（新增）** | **2天** | **+2天** |
| Phase 3 | 管理API开发 | 2天 | 不变 |
| Phase 3 | 访问日志系统 | 1天 | 不变 |
| Phase 4 | 管理前端页面 | 3天 | 不变 |
| Phase 4 | 数据可视化 | 1天 | 不变 |
| Phase 5 | 测试和修复 | 2天 | 不变 |
| Phase 5 | 部署和文档 | 1天 | 不变 |

**总计**: 约**18-20个工作日**（增加2天用于个人中心开发）

---

## 九、对比总结

### 9.1 v1.0 vs v2.0 主要差异

| 功能点 | v1.0 | v2.0 |
|--------|------|------|
| 用户端功能 | 仅登录+基本信息展示 | 增加完整个人中心 |
| 用户查看自己数据 | ❌ 不支持 | ✅ 支持 |
| 用户修改自己信息 | ❌ 不支持 | ✅ 支持（部分字段） |
| 用户查看登录历史 | ❌ 不支持 | ✅ 支持 |
| 用户查看访问记录 | ❌ 不支持 | ✅ 支持 |
| 用户查看统计数据 | ❌ 不支持 | ✅ 支持 |
| API端点数量 | 10个 | 15个（+5个用户端API） |
| 前端页面数量 | 6个 | 7个（+1个profile.html） |
| 开发时间 | 16-18天 | 18-20天（+2天） |

### 9.2 架构优势

#### 数据库统一
- ✅ 用户端和管理端使用**同一个数据库**
- ✅ 数据一致性有保障
- ✅ 便于维护和扩展

#### 权限分层
- ✅ 通过API装饰器实现权限控制
- ✅ `@login_required`: 用户只能访问自己的数据
- ✅ `@admin_required`: 管理员可以访问所有数据

#### 用户自服务
- ✅ 用户可以自主查看和管理个人信息
- ✅ 减轻管理员工作负担
- ✅ 提升用户体验

---

## 十、实施建议

### 10.1 推荐实施顺序

**阶段1：基础认证**（4天）
1. 数据库设计和创建
2. 飞书OAuth2.0集成
3. JWT认证实现
4. 用户端登录页面

**阶段2：用户个人中心**（2天）✨
1. 用户端API开发（5个API）
2. 个人中心前端页面
3. Tab切换和数据展示
4. 个人信息编辑功能

**阶段3：管理端后端**（4天）
1. 管理员认证API
2. 用户管理API
3. 访问日志API
4. 统计数据API

**阶段4：管理端前端**（4天）
1. 管理端页面开发
2. 数据可视化

**阶段5：测试和部署**（3天）
1. 单元测试和集成测试
2. 安全测试
3. 部署和文档

**总计：18-20个工作日**

---

## 十一、下一步行动

### 选项A：立即开始开发
按照优化后的方案，从Phase 1开始实施

### 选项B：进一步讨论
如果还有其他需求或疑问，可以继续优化方案

### 选项C：分阶段实施
- 先做Phase 1-2（用户端+个人中心）
- 测试通过后再做Phase 3-4（管理端）

---

**方案优化完成**

**版本**: v2.0  
**更新时间**: 2025-12-16 19:00  
**主要改进**: 增加用户个人中心功能模块  
**状态**: ✅ 待审核确认

