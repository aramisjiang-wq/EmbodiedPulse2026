# 上线前故障排查报告

**版本**: v1.0  
**日期**: 2025-12-17  
**目的**: 系统性排查可能影响网站上线的问题

---

## 📋 目录

1. [飞书登录回调地址配置](#一飞书登录回调地址配置-重要)
2. [环境变量配置检查](#二环境变量配置检查)
3. [数据库配置检查](#三数据库配置检查)
4. [服务配置检查](#四服务配置检查)
5. [Nginx 配置检查](#五nginx-配置检查)
6. [HTTPS 证书检查](#六https-证书检查)
7. [定时任务配置检查](#七定时任务配置检查)
8. [API 端点检查](#八api-端点检查)
9. [前端资源检查](#九前端资源检查)
10. [安全配置检查](#十安全配置检查)
11. [性能检查](#十一性能检查)
12. [待办事项清单](#十二待办事项清单)

---

## 一、飞书登录回调地址配置 ⚠️ **重要**

### 1.1 问题描述

**当前状态**: ⚠️ **需要配置**

飞书扫码登录需要在飞书开放平台配置回调地址，否则用户无法完成登录。

### 1.2 回调地址信息

**生产环境回调地址**:
```
https://login.gradmotion.com/api/auth/feishu/callback
```

**备用回调地址**（可选）:
```
https://essay.gradmotion.com/api/auth/feishu/callback
```

### 1.3 配置步骤

1. **访问飞书开放平台**
   - 网址: https://open.feishu.cn
   - 使用管理员账号登录

2. **找到应用**
   - App ID: `cli_a6727c4ffc71d00b`
   - 应用名称: （根据实际情况）

3. **配置回调地址**
   - 进入"安全设置" → "重定向URL"
   - 添加回调地址: `https://login.gradmotion.com/api/auth/feishu/callback`
   - 保存配置

4. **验证配置**
   - 等待配置生效（通常几分钟）
   - 访问 `https://login.gradmotion.com` 测试登录

### 1.4 代码中的回调地址配置

**文件**: `auth_routes.py`

```python
redirect_uri = data.get('redirect_uri') or os.getenv('FEISHU_REDIRECT_URI', 
                                                       'http://localhost:5001/api/auth/feishu/callback')
```

**环境变量配置**（服务器 `.env` 文件）:
```bash
FEISHU_REDIRECT_URI=https://login.gradmotion.com/api/auth/feishu/callback
```

### 1.5 检查命令

```bash
# 在服务器上检查环境变量
cd /srv/EmbodiedPulse2026
cat .env | grep FEISHU_REDIRECT_URI

# 使用检查脚本
python3 scripts/check_feishu_config.py
```

### 1.6 待办事项

- [ ] **立即执行**: 联系负责飞书配置的同事，提供回调地址 `https://login.gradmotion.com/api/auth/feishu/callback`
- [ ] **验证**: 配置完成后，测试登录功能
- [ ] **文档**: 更新配置文档，记录回调地址

---

## 二、环境变量配置检查

### 2.1 必需环境变量

| 变量名 | 当前值 | 状态 | 说明 |
|--------|--------|------|------|
| `FEISHU_APP_ID` | `cli_a6727c4ffc71d00b` | ✅ | 飞书 App ID |
| `FEISHU_APP_SECRET` | `dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI` | ✅ | 飞书 App Secret |
| `FEISHU_REDIRECT_URI` | `https://login.gradmotion.com/api/auth/feishu/callback` | ⚠️ | **需要确认已配置** |
| `JWT_SECRET_KEY` | `embodied-pulse-jwt-secret-key-2025` | ✅ | JWT 密钥 |
| `AUTO_FETCH_ENABLED` | `true` | ✅ | 定时任务开关 |
| `FLASK_ENV` | `production` | ✅ | Flask 环境 |

### 2.2 检查方法

```bash
# 检查 .env 文件
cd /srv/EmbodiedPulse2026
cat .env

# 检查 systemd 服务是否加载环境变量
cat /etc/systemd/system/embodiedpulse.service | grep EnvironmentFile

# 检查环境变量是否生效
systemctl show embodiedpulse | grep Environment
```

### 2.3 潜在问题

- ⚠️ **问题1**: systemd 服务未加载 `.env` 文件
  - **影响**: 环境变量未生效，定时任务无法启动
  - **检查**: `cat /etc/systemd/system/embodiedpulse.service | grep EnvironmentFile`
  - **修复**: 确保服务文件包含 `EnvironmentFile=/srv/EmbodiedPulse2026/.env`

- ⚠️ **问题2**: `FEISHU_REDIRECT_URI` 配置错误
  - **影响**: 飞书登录回调失败
  - **检查**: `cat .env | grep FEISHU_REDIRECT_URI`
  - **修复**: 确保值为 `https://login.gradmotion.com/api/auth/feishu/callback`

### 2.4 待办事项

- [ ] 确认服务器 `.env` 文件包含所有必需配置
- [ ] 确认 systemd 服务配置包含 `EnvironmentFile`
- [ ] 重启服务验证环境变量生效

---

## 三、数据库配置检查

### 3.1 数据库文件检查

| 数据库 | 文件路径 | 必需 | 状态 |
|--------|----------|------|------|
| 论文数据库 | `/srv/EmbodiedPulse2026/instance/papers.db` | ✅ | ⚠️ 需要确认 |
| B站视频数据库 | `/srv/EmbodiedPulse2026/bilibili.db` | ✅ | ⚠️ 需要确认 |
| 认证数据库 | `/srv/EmbodiedPulse2026/instance/auth.db` | ✅ | ⚠️ 需要确认 |

### 3.2 检查方法

```bash
# 检查数据库文件是否存在
cd /srv/EmbodiedPulse2026
ls -lh instance/papers.db
ls -lh bilibili.db
ls -lh instance/auth.db

# 检查数据库内容
sqlite3 instance/papers.db "SELECT COUNT(*) FROM papers;"
sqlite3 bilibili.db "SELECT COUNT(*) FROM bilibili_up;"
sqlite3 instance/auth.db "SELECT COUNT(*) FROM auth_users;"

# 检查文件权限
ls -l instance/papers.db bilibili.db instance/auth.db
```

### 3.3 潜在问题

- ⚠️ **问题1**: 数据库文件不存在
  - **影响**: 应用无法启动或数据为空
  - **修复**: 从本地复制数据库文件到服务器

- ⚠️ **问题2**: 数据库文件权限错误
  - **影响**: 应用无法读写数据库
  - **修复**: `chmod 644 instance/papers.db bilibili.db instance/auth.db`

- ⚠️ **问题3**: 数据库文件为空
  - **影响**: 页面显示无数据
  - **修复**: 从本地备份恢复数据

### 3.4 待办事项

- [ ] 确认所有数据库文件已上传到服务器
- [ ] 确认数据库文件权限正确（644）
- [ ] 确认数据库文件有数据（非空）

---

## 四、服务配置检查

### 4.1 systemd 服务检查

**服务名称**: `embodiedpulse`

**检查命令**:
```bash
# 检查服务状态
systemctl status embodiedpulse

# 检查服务配置
cat /etc/systemd/system/embodiedpulse.service

# 检查服务日志
journalctl -u embodiedpulse -n 50
```

### 4.2 关键配置项

| 配置项 | 要求 | 检查方法 |
|--------|------|----------|
| `EnvironmentFile` | 必须包含 | `grep EnvironmentFile /etc/systemd/system/embodiedpulse.service` |
| `WorkingDirectory` | `/srv/EmbodiedPulse2026` | `grep WorkingDirectory /etc/systemd/system/embodiedpulse.service` |
| `ExecStart` | Gunicorn 启动命令 | `grep ExecStart /etc/systemd/system/embodiedpulse.service` |
| `Restart` | `always` | `grep Restart /etc/systemd/system/embodiedpulse.service` |

### 4.3 潜在问题

- ⚠️ **问题1**: 端口被占用
  - **影响**: 服务无法启动
  - **检查**: `lsof -i:5001`
  - **修复**: `bash scripts/fix_port_and_service.sh`

- ⚠️ **问题2**: 环境变量未加载
  - **影响**: 定时任务无法启动
  - **检查**: `systemctl show embodiedpulse | grep Environment`
  - **修复**: 确保服务文件包含 `EnvironmentFile`

- ⚠️ **问题3**: 服务未设置为开机自启
  - **影响**: 服务器重启后服务不会自动启动
  - **检查**: `systemctl is-enabled embodiedpulse`
  - **修复**: `systemctl enable embodiedpulse`

### 4.4 待办事项

- [ ] 确认服务运行正常
- [ ] 确认服务配置正确
- [ ] 确认服务已设置为开机自启

---

## 五、Nginx 配置检查

### 5.1 Nginx 配置检查

**配置文件**: `/etc/nginx/sites-available/embodiedpulse.conf`

**检查命令**:
```bash
# 检查配置语法
nginx -t

# 查看配置内容
cat /etc/nginx/sites-available/embodiedpulse.conf

# 检查服务状态
systemctl status nginx
```

### 5.2 关键配置项

| 域名 | 路由 | 状态 |
|------|------|------|
| `login.gradmotion.com` | `/login` | ⚠️ 需要验证 |
| `essay.gradmotion.com` | `/` | ⚠️ 需要验证 |
| `blibli.gradmotion.com` | `/bilibili` | ⚠️ 需要验证 |
| `admin123.gradmotion.com` | `/admin` | ⚠️ 需要验证 |

### 5.3 潜在问题

- ⚠️ **问题1**: 静态资源404
  - **影响**: 页面样式和脚本无法加载
  - **检查**: 浏览器控制台查看404错误
  - **修复**: 确保 Nginx 配置包含 `location /static/` 块

- ⚠️ **问题2**: API 路由404
  - **影响**: 前端无法获取数据
  - **检查**: 浏览器网络面板查看API请求
  - **修复**: 确保 Nginx 配置包含 `location /api/` 块

- ⚠️ **问题3**: 域名路由错误
  - **影响**: 访问域名跳转到错误页面
  - **检查**: 访问各个域名测试
  - **修复**: 使用 `bash scripts/nginx_config_fix.sh` 重新配置

### 5.4 待办事项

- [ ] 确认 Nginx 配置语法正确
- [ ] 确认所有域名路由正确
- [ ] 确认静态资源和API路由正常

---

## 六、HTTPS 证书检查

### 6.1 SSL 证书检查

**检查命令**:
```bash
# 查看证书列表
certbot certificates

# 测试 HTTPS
curl -I https://login.gradmotion.com
curl -I https://essay.gradmotion.com
curl -I https://blibli.gradmotion.com
curl -I https://admin123.gradmotion.com
```

### 6.2 证书状态

| 域名 | 证书状态 | 到期时间 | 状态 |
|------|----------|----------|------|
| `login.gradmotion.com` | ⚠️ 需要检查 | - | ⚠️ |
| `essay.gradmotion.com` | ⚠️ 需要检查 | - | ⚠️ |
| `blibli.gradmotion.com` | ⚠️ 需要检查 | - | ⚠️ |
| `admin123.gradmotion.com` | ⚠️ 需要检查 | - | ⚠️ |

### 6.3 潜在问题

- ⚠️ **问题1**: 证书未配置
  - **影响**: 浏览器显示不安全警告
  - **修复**: `bash scripts/setup_https.sh`

- ⚠️ **问题2**: 证书即将到期
  - **影响**: 证书过期后HTTPS无法访问
  - **检查**: `certbot certificates`
  - **修复**: Certbot 会自动续期，但需要确认定时任务正常

- ⚠️ **问题3**: HTTP 未自动跳转到 HTTPS
  - **影响**: 用户可能通过HTTP访问，不安全
  - **检查**: `curl -I http://essay.gradmotion.com`
  - **修复**: 确保 Certbot 配置包含 `--redirect` 参数

### 6.4 待办事项

- [ ] 确认所有域名都有有效的 SSL 证书
- [ ] 确认 HTTP 自动跳转到 HTTPS
- [ ] 确认证书自动续期已启用

---

## 七、定时任务配置检查

### 7.1 定时任务配置

**检查命令**:
```bash
# 检查环境变量
cd /srv/EmbodiedPulse2026
cat .env | grep AUTO_FETCH

# 检查服务日志中的定时任务信息
journalctl -u embodiedpulse | grep -i "scheduler\|定时任务"
```

### 7.2 定时任务列表

| 任务 | 调度 | 状态 |
|------|------|------|
| 论文抓取 | `0 * * * *`（每小时） | ⚠️ 需要验证 |
| B站数据抓取 | `0 */6 * * *`（每6小时） | ⚠️ 需要验证 |
| 新闻抓取 | `0 * * * *`（每小时） | ⚠️ 需要验证 |
| 招聘信息抓取 | `0 * * * *`（每小时） | ⚠️ 需要验证 |
| 全量论文抓取 | `0 2 * * *`（每天2点） | ⚠️ 需要验证 |

### 7.3 潜在问题

- ⚠️ **问题1**: 定时任务未启动
  - **影响**: 数据不会自动更新
  - **检查**: 日志中查看"定时任务调度器已启动"
  - **修复**: 确保 `AUTO_FETCH_ENABLED=true` 且环境变量已加载

- ⚠️ **问题2**: 定时任务执行失败
  - **影响**: 数据更新失败
  - **检查**: `journalctl -u embodiedpulse | grep -i error`
  - **修复**: 检查错误日志，修复问题

### 7.4 待办事项

- [ ] 确认定时任务已启动
- [ ] 确认定时任务执行正常
- [ ] 确认数据自动更新正常

---

## 八、API 端点检查

### 8.1 关键 API 端点

| 端点 | 方法 | 用途 | 状态 |
|------|------|------|------|
| `/api/papers` | GET | 获取论文数据 | ⚠️ 需要验证 |
| `/api/bilibili/all` | GET | 获取B站数据 | ⚠️ 需要验证 |
| `/api/auth/feishu/login` | POST | 飞书登录 | ⚠️ 需要验证 |
| `/api/auth/feishu/callback` | GET | 飞书回调 | ⚠️ 需要验证 |
| `/api/fetch` | POST | 手动抓取论文 | ⚠️ 需要验证 |
| `/api/fetch-status` | GET | 抓取状态 | ⚠️ 需要验证 |

### 8.2 检查方法

```bash
# 测试本地API
curl http://127.0.0.1:5001/api/papers
curl http://127.0.0.1:5001/api/bilibili/all

# 测试域名API
curl https://essay.gradmotion.com/api/papers
curl https://blibli.gradmotion.com/api/bilibili/all
```

### 8.3 潜在问题

- ⚠️ **问题1**: API 返回401（未授权）
  - **影响**: 前端无法获取数据
  - **检查**: 浏览器控制台查看API响应
  - **修复**: 检查JWT token和认证逻辑

- ⚠️ **问题2**: API 返回500（服务器错误）
  - **影响**: 功能无法使用
  - **检查**: 服务器日志查看错误信息
  - **修复**: 根据错误信息修复代码

### 8.4 待办事项

- [ ] 确认所有API端点正常响应
- [ ] 确认API返回数据格式正确
- [ ] 确认API错误处理正常

---

## 九、前端资源检查

### 9.1 静态资源检查

**检查方法**:
- 打开浏览器开发者工具
- 查看 Network 面板
- 检查 CSS、JS、图片等资源是否正常加载

### 9.2 潜在问题

- ⚠️ **问题1**: 静态资源404
  - **影响**: 页面样式和功能异常
  - **检查**: 浏览器控制台查看404错误
  - **修复**: 确保 Nginx 配置包含 `location /static/` 块

- ⚠️ **问题2**: 资源加载慢
  - **影响**: 用户体验差
  - **检查**: Network 面板查看加载时间
  - **修复**: 优化资源大小，启用CDN（可选）

### 9.3 待办事项

- [ ] 确认所有静态资源正常加载
- [ ] 确认页面样式正常
- [ ] 确认页面功能正常

---

## 十、安全配置检查

### 10.1 安全检查项

- [ ] **密码安全**: 服务器密码强度
- [ ] **SSH 密钥**: 使用密钥认证（禁用密码登录）
- [ ] **HTTPS**: 所有域名使用HTTPS
- [ ] **JWT 密钥**: 使用强密钥
- [ ] **环境变量**: 敏感信息存储在环境变量中
- [ ] **文件权限**: 数据库文件权限正确（644）

### 10.2 潜在问题

- ⚠️ **问题1**: 使用弱密码
  - **影响**: 服务器安全风险
  - **修复**: 使用强密码或SSH密钥

- ⚠️ **问题2**: HTTP 未强制跳转到 HTTPS
  - **影响**: 数据可能被窃听
  - **修复**: 确保 Nginx 配置HTTP跳转到HTTPS

### 10.3 待办事项

- [ ] 确认所有安全检查项已通过
- [ ] 确认敏感信息已妥善保护

---

## 十一、性能检查

### 11.1 性能检查项

- [ ] **响应时间**: 页面加载时间 < 3秒
- [ ] **API 响应**: API响应时间 < 1秒
- [ ] **数据库查询**: 查询时间 < 500ms
- [ ] **并发处理**: 支持至少10个并发用户

### 11.2 潜在问题

- ⚠️ **问题1**: 页面加载慢
  - **影响**: 用户体验差
  - **检查**: 浏览器 Network 面板
  - **修复**: 优化资源大小，启用缓存

- ⚠️ **问题2**: API 响应慢
  - **影响**: 功能使用体验差
  - **检查**: 服务器日志查看响应时间
  - **修复**: 优化数据库查询，添加索引

### 11.3 待办事项

- [ ] 确认性能指标达标
- [ ] 确认用户体验良好

---

## 十二、待办事项清单

### 12.1 紧急待办（上线前必须完成）

- [ ] **飞书回调地址配置** ⚠️ **最重要**
  - [ ] 联系负责飞书配置的同事
  - [ ] 提供回调地址: `https://login.gradmotion.com/api/auth/feishu/callback`
  - [ ] 确认配置完成
  - [ ] 测试登录功能

- [ ] **环境变量配置**
  - [ ] 确认服务器 `.env` 文件包含所有必需配置
  - [ ] 确认 `FEISHU_REDIRECT_URI` 配置正确
  - [ ] 确认 systemd 服务加载环境变量

- [ ] **数据库迁移**
  - [ ] 确认数据库文件已上传到服务器
  - [ ] 确认数据库文件权限正确
  - [ ] 确认数据库文件有数据

- [ ] **服务配置**
  - [ ] 确认服务运行正常
  - [ ] 确认服务已设置为开机自启
  - [ ] 确认定时任务已启动

- [ ] **Nginx 配置**
  - [ ] 确认所有域名路由正确
  - [ ] 确认静态资源和API路由正常
  - [ ] 确认配置语法正确

- [ ] **HTTPS 证书**
  - [ ] 确认所有域名都有有效的 SSL 证书
  - [ ] 确认 HTTP 自动跳转到 HTTPS
  - [ ] 确认证书自动续期已启用

### 12.2 重要待办（上线后尽快完成）

- [ ] **功能测试**
  - [ ] 测试登录功能
  - [ ] 测试论文页面
  - [ ] 测试视频页面
  - [ ] 测试管理端

- [ ] **性能优化**
  - [ ] 优化页面加载速度
  - [ ] 优化API响应时间
  - [ ] 优化数据库查询

- [ ] **监控配置**
  - [ ] 配置日志监控
  - [ ] 配置错误告警
  - [ ] 配置性能监控

### 12.3 检查脚本

**一键检查所有项目**:
```bash
cd /srv/EmbodiedPulse2026
bash scripts/check_deployment_status.sh
```

---

## 十三、总结

### 13.1 关键问题

1. **飞书回调地址配置** ⚠️ **最重要**
   - 需要立即联系同事配置
   - 影响用户登录功能

2. **环境变量配置**
   - 确保所有必需配置已设置
   - 确保 systemd 服务加载环境变量

3. **数据库迁移**
   - 确保数据库文件已上传
   - 确保数据库文件有数据

### 13.2 建议

1. **立即执行**: 联系飞书配置同事，配置回调地址
2. **全面检查**: 使用 `check_deployment_status.sh` 脚本全面检查
3. **功能测试**: 上线前进行完整的功能测试
4. **监控配置**: 上线后配置监控和告警

---

**文档版本**: v1.0  
**最后更新**: 2025-12-17  
**维护者**: AI Assistant

