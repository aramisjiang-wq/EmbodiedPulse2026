# 运维监控与故障恢复方案

**版本**: v1.0  
**日期**: 2025-12-17  
**目的**: 建立完善的运维监控体系和故障恢复机制

---

## 📋 目录

1. [数据库自动备份](#一数据库自动备份)
2. [系统监控告警](#二系统监控告警)
3. [故障恢复方案](#三故障恢复方案)
4. [监控指标说明](#四监控指标说明)
5. [告警处理流程](#五告警处理流程)
6. [备份恢复流程](#六备份恢复流程)

---

## 一、数据库自动备份

### 1.1 备份策略

**备份频率**: 每天凌晨2点自动备份  
**保留时间**: 7天  
**备份位置**: `/srv/EmbodiedPulse2026/backups/`  
**备份格式**: `.db.gz`（压缩格式）

### 1.2 备份内容

- ✅ 论文数据库 (`papers.db`)
- ✅ B站视频数据库 (`bilibili.db`)
- ✅ 认证数据库 (`instance/papers.db`，如果存在)

### 1.3 设置自动备份

**首次设置**:

```bash
cd /srv/EmbodiedPulse2026
chmod +x scripts/setup_backup_and_monitor.sh
bash scripts/setup_backup_and_monitor.sh
```

**手动执行备份**:

```bash
cd /srv/EmbodiedPulse2026
bash scripts/backup_databases.sh
```

### 1.4 备份文件命名规则

```
papers_YYYYMMDD_HHMMSS.db.gz
bilibili_YYYYMMDD_HHMMSS.db.gz
auth_YYYYMMDD_HHMMSS.db.gz
```

**示例**:
- `papers_20251217_020000.db.gz`
- `bilibili_20251217_020000.db.gz`

### 1.5 备份验证

**查看备份文件**:

```bash
ls -lht /srv/EmbodiedPulse2026/backups/
```

**查看备份日志**:

```bash
tail -f /srv/EmbodiedPulse2026/logs/backup.log
```

**验证备份文件完整性**:

```bash
# 解压测试
gunzip -t /srv/EmbodiedPulse2026/backups/papers_20251217_020000.db.gz

# 查看备份内容
gunzip -c /srv/EmbodiedPulse2026/backups/papers_20251217_020000.db.gz | sqlite3 - "SELECT COUNT(*) FROM papers;"
```

---

## 二、系统监控告警

### 2.1 监控频率

**检查频率**: 每30分钟执行一次  
**监控日志**: `/srv/EmbodiedPulse2026/logs/monitor.log`

### 2.2 监控项目

| 监控项 | 检查内容 | 告警阈值 |
|--------|----------|----------|
| **服务状态** | embodiedpulse, nginx | 服务未运行 |
| **端口监听** | 5001, 80, 443 | 端口未监听 |
| **磁盘空间** | 磁盘使用率 | ≥ 80% |
| **内存使用** | 内存使用率 | ≥ 90% |
| **数据库文件** | papers.db, bilibili.db | 文件不存在 |
| **错误日志** | 最近1小时错误数 | > 10条 |
| **定时任务** | 定时任务运行状态 | 未启动 |

### 2.3 设置监控

**首次设置**:

```bash
cd /srv/EmbodiedPulse2026
bash scripts/setup_backup_and_monitor.sh
```

**手动执行监控**:

```bash
cd /srv/EmbodiedPulse2026
bash scripts/monitor_system.sh
```

### 2.4 监控日志查看

**实时查看监控日志**:

```bash
tail -f /srv/EmbodiedPulse2026/logs/monitor.log
```

**查看最近的监控结果**:

```bash
tail -100 /srv/EmbodiedPulse2026/logs/monitor.log
```

**搜索错误告警**:

```bash
grep "ERROR\|WARNING" /srv/EmbodiedPulse2026/logs/monitor.log
```

### 2.5 告警通知（可选）

**配置邮件告警**:

编辑 `scripts/monitor_system.sh`，设置告警邮箱：

```bash
ALERT_EMAIL="admin@example.com"
```

**安装邮件工具**（如果需要）:

```bash
apt install -y mailutils
```

---

## 三、故障恢复方案

### 3.1 故障恢复脚本

**使用交互式恢复菜单**:

```bash
cd /srv/EmbodiedPulse2026
chmod +x scripts/disaster_recovery.sh
bash scripts/disaster_recovery.sh
```

**恢复菜单选项**:
1. 恢复服务（重启所有服务）
2. 恢复数据库（从备份恢复）
3. 修复端口占用
4. 修复环境变量
5. 修复Nginx配置
6. 完整系统检查
7. 查看最近备份
8. 查看服务日志

### 3.2 常见故障处理

#### 故障1：服务无法启动

**症状**: `systemctl status embodiedpulse` 显示失败

**处理步骤**:

```bash
# 1. 查看错误日志
journalctl -u embodiedpulse -n 50

# 2. 检查端口占用
lsof -i:5001

# 3. 修复端口占用
bash scripts/fix_port_and_service.sh

# 4. 重启服务
systemctl restart embodiedpulse
```

#### 故障2：数据库损坏或丢失

**症状**: 网站显示"数据库错误"或数据为空

**处理步骤**:

```bash
# 1. 使用恢复脚本
bash scripts/disaster_recovery.sh
# 选择选项2：恢复数据库

# 或手动恢复
cd /srv/EmbodiedPulse2026

# 2. 列出可用备份
ls -lht backups/*.db.gz

# 3. 停止服务
systemctl stop embodiedpulse

# 4. 恢复数据库（以papers.db为例）
gunzip -c backups/papers_20251217_020000.db.gz > papers.db

# 5. 设置权限
chmod 644 papers.db
chown root:root papers.db

# 6. 启动服务
systemctl start embodiedpulse
```

#### 故障3：端口被占用

**症状**: 服务启动失败，提示"Address already in use"

**处理步骤**:

```bash
# 方法1：使用修复脚本
bash scripts/fix_port_and_service.sh

# 方法2：手动修复
systemctl stop embodiedpulse
lsof -ti:5001 | xargs kill -9
systemctl start embodiedpulse
```

#### 故障4：环境变量未加载

**症状**: 定时任务未启动，日志显示 `AUTO_FETCH_ENABLED=false`

**处理步骤**:

```bash
# 1. 检查 .env 文件
cat /srv/EmbodiedPulse2026/.env | grep AUTO_FETCH_ENABLED

# 2. 检查 systemd 服务配置
cat /etc/systemd/system/embodiedpulse.service | grep EnvironmentFile

# 3. 修复配置（如果缺少）
bash scripts/fix_port_and_service.sh

# 或手动修复
sed -i '/\[Service\]/a EnvironmentFile=/srv/EmbodiedPulse2026/.env' /etc/systemd/system/embodiedpulse.service
systemctl daemon-reload
systemctl restart embodiedpulse
```

#### 故障5：Nginx配置错误

**症状**: 网站无法访问，Nginx返回502或404

**处理步骤**:

```bash
# 1. 检查Nginx配置
nginx -t

# 2. 使用修复脚本
bash scripts/nginx_config_fix.sh

# 3. 重载Nginx
systemctl reload nginx
```

#### 故障6：磁盘空间不足

**症状**: 监控告警"磁盘使用率超过80%"

**处理步骤**:

```bash
# 1. 检查磁盘使用
df -h

# 2. 清理旧备份（保留最近7天）
find /srv/EmbodiedPulse2026/backups -name "*.db.gz" -mtime +7 -delete

# 3. 清理日志文件
journalctl --vacuum-time=7d

# 4. 检查大文件
du -sh /srv/EmbodiedPulse2026/* | sort -h
```

---

## 四、监控指标说明

### 4.1 服务状态监控

**检查命令**:
```bash
systemctl is-active embodiedpulse
systemctl is-active nginx
```

**正常状态**: `active`  
**异常状态**: `inactive` 或 `failed`

### 4.2 端口监听监控

**检查命令**:
```bash
lsof -i:5001  # Gunicorn
lsof -i:80    # HTTP
lsof -i:443   # HTTPS
```

**正常状态**: 有进程监听  
**异常状态**: 无进程监听

### 4.3 资源使用监控

**磁盘使用率**:
```bash
df -h /srv/EmbodiedPulse2026 | awk 'NR==2 {print $5}'
```

**内存使用率**:
```bash
free | awk 'NR==2{printf "%.0f", $3*100/$2}'
```

**告警阈值**:
- 磁盘使用率 ≥ 80%: 警告
- 内存使用率 ≥ 90%: 警告

### 4.4 数据库监控

**检查数据库文件**:
```bash
ls -lh /srv/EmbodiedPulse2026/papers.db
ls -lh /srv/EmbodiedPulse2026/bilibili.db
```

**检查数据库内容**:
```bash
sqlite3 /srv/EmbodiedPulse2026/papers.db "SELECT COUNT(*) FROM papers;"
sqlite3 /srv/EmbodiedPulse2026/bilibili.db "SELECT COUNT(*) FROM bilibili_ups;"
```

### 4.5 错误日志监控

**检查最近错误**:
```bash
journalctl -u embodiedpulse --since "1 hour ago" | grep -i "error\|exception\|failed" | wc -l
```

**告警阈值**: 最近1小时错误数 > 10条

---

## 五、告警处理流程

### 5.1 告警级别

| 级别 | 说明 | 处理优先级 |
|------|------|-----------|
| **ERROR** | 严重错误，服务不可用 | 🔴 立即处理 |
| **WARNING** | 警告，可能影响服务 | 🟡 尽快处理 |
| **INFO** | 信息，正常状态 | 🟢 记录即可 |

### 5.2 告警处理流程

```
1. 收到告警
   ↓
2. 查看监控日志，确认问题
   ↓
3. 根据故障类型选择处理方案
   ↓
4. 执行恢复操作
   ↓
5. 验证恢复结果
   ↓
6. 记录故障和处理过程
```

### 5.3 告警响应时间

- **ERROR级别**: 15分钟内响应
- **WARNING级别**: 1小时内响应
- **INFO级别**: 记录即可

---

## 六、备份恢复流程

### 6.1 备份验证

**定期验证备份文件**:

```bash
# 每周验证一次备份文件完整性
cd /srv/EmbodiedPulse2026/backups

# 随机选择一个备份文件测试
backup_file=$(ls -t *.db.gz | head -1)
gunzip -t "$backup_file"

# 验证数据完整性
gunzip -c "$backup_file" | sqlite3 - "SELECT COUNT(*) FROM papers;" 2>/dev/null || echo "验证失败"
```

### 6.2 恢复测试

**定期进行恢复测试**（建议每月一次）:

```bash
# 1. 选择测试备份
backup_file="/srv/EmbodiedPulse2026/backups/papers_20251217_020000.db.gz"

# 2. 创建测试环境
test_db="/tmp/papers_test.db"
gunzip -c "$backup_file" > "$test_db"

# 3. 验证数据
sqlite3 "$test_db" "SELECT COUNT(*) FROM papers;"

# 4. 清理测试文件
rm "$test_db"
```

### 6.3 恢复操作步骤

**完整恢复流程**:

1. **停止服务**
   ```bash
   systemctl stop embodiedpulse
   ```

2. **备份当前数据库**（防止恢复失败）
   ```bash
   cp papers.db papers.db.backup.$(date +%Y%m%d_%H%M%S)
   ```

3. **选择备份文件**
   ```bash
   ls -lht backups/*.db.gz
   ```

4. **恢复数据库**
   ```bash
   gunzip -c backups/papers_YYYYMMDD_HHMMSS.db.gz > papers.db
   ```

5. **设置权限**
   ```bash
   chmod 644 papers.db
   chown root:root papers.db
   ```

6. **启动服务**
   ```bash
   systemctl start embodiedpulse
   ```

7. **验证恢复**
   ```bash
   systemctl status embodiedpulse
   # 访问网站验证数据
   ```

---

## 七、定时任务配置

### 7.1 查看当前定时任务

```bash
crontab -l
```

### 7.2 定时任务列表

| 任务 | 时间 | 脚本 | 日志 |
|------|------|------|------|
| 数据库备份 | 每天 02:00 | `backup_databases.sh` | `logs/backup.log` |
| 系统监控 | 每30分钟 | `monitor_system.sh` | `logs/monitor.log` |

### 7.3 手动添加定时任务

```bash
# 编辑crontab
crontab -e

# 添加任务（示例）
0 2 * * * /srv/EmbodiedPulse2026/scripts/backup_databases.sh >> /srv/EmbodiedPulse2026/logs/backup.log 2>&1
*/30 * * * * /srv/EmbodiedPulse2026/scripts/monitor_system.sh >> /srv/EmbodiedPulse2026/logs/monitor.log 2>&1
```

---

## 八、日志管理

### 8.1 日志文件位置

| 日志类型 | 位置 | 说明 |
|---------|------|------|
| 服务日志 | `journalctl -u embodiedpulse` | systemd 日志 |
| Nginx日志 | `/var/log/nginx/` | Nginx 访问和错误日志 |
| 备份日志 | `/srv/EmbodiedPulse2026/logs/backup.log` | 备份执行日志 |
| 监控日志 | `/srv/EmbodiedPulse2026/logs/monitor.log` | 监控检查日志 |

### 8.2 日志清理

**清理systemd日志**（保留7天）:

```bash
journalctl --vacuum-time=7d
```

**清理应用日志**（保留30天）:

```bash
find /srv/EmbodiedPulse2026/logs -name "*.log" -mtime +30 -delete
```

---

## 九、最佳实践

### 9.1 备份最佳实践

1. ✅ **定期验证备份**: 每周验证备份文件完整性
2. ✅ **异地备份**: 定期将备份文件复制到其他服务器
3. ✅ **备份加密**: 敏感数据备份建议加密
4. ✅ **恢复测试**: 每月进行一次恢复测试

### 9.2 监控最佳实践

1. ✅ **设置告警阈值**: 根据实际情况调整告警阈值
2. ✅ **及时响应告警**: ERROR级别告警15分钟内响应
3. ✅ **记录处理过程**: 记录故障和处理过程，便于后续分析
4. ✅ **定期审查**: 每月审查监控日志，优化监控策略

### 9.3 故障恢复最佳实践

1. ✅ **先备份再恢复**: 恢复前先备份当前数据
2. ✅ **测试恢复流程**: 定期测试恢复流程，确保可行
3. ✅ **记录故障**: 详细记录故障原因和处理过程
4. ✅ **预防措施**: 根据故障原因，采取预防措施

---

## 十、快速参考

### 10.1 常用命令

```bash
# 查看备份
ls -lht /srv/EmbodiedPulse2026/backups/

# 执行备份
bash /srv/EmbodiedPulse2026/scripts/backup_databases.sh

# 执行监控
bash /srv/EmbodiedPulse2026/scripts/monitor_system.sh

# 故障恢复
bash /srv/EmbodiedPulse2026/scripts/disaster_recovery.sh

# 查看监控日志
tail -f /srv/EmbodiedPulse2026/logs/monitor.log

# 查看备份日志
tail -f /srv/EmbodiedPulse2026/logs/backup.log
```

### 10.2 紧急联系方式

**故障处理流程**:
1. 查看监控日志确认问题
2. 使用故障恢复脚本处理
3. 如无法解决，查看详细日志
4. 记录故障和处理过程

---

**文档版本**: v1.0  
**最后更新**: 2025-12-17  
**维护者**: AI Assistant

