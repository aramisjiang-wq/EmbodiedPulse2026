# 数据更新脚本使用指南

## 概述

本指南介绍两个安全的数据更新脚本的使用方法：
1. **论文数据更新脚本** - 抓取指定日期的论文
2. **Bilibili数据更新脚本** - 从Bilibili API获取最新视频数据

## 脚本1：论文数据更新脚本

### 功能说明

`scripts/fetch_dec17_papers.py` - 安全地抓取2025年12月17日发布的论文

### 特性

- ✅ **安全可靠**：完整的错误处理和事务回滚
- ✅ **进度显示**：实时显示抓取进度和统计信息
- ✅ **日志记录**：详细的日志记录，便于排查问题
- ✅ **数据验证**：自动验证和过滤数据
- ✅ **去重处理**：自动检测并更新已存在的论文

### 使用方法

#### 本地使用

```bash
cd /path/to/EmbodiedPulse2026
source venv/bin/activate  # 如果使用虚拟环境
python3 scripts/fetch_dec17_papers.py
```

#### 服务器使用

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 scripts/fetch_dec17_papers.py
```

### 输出示例

```
============================================================
开始抓取 2025-12-17 发布的论文
============================================================
加载了 24 个论文类别

[1/24] 处理类别: Manipulation
  找到 5 篇 2025-12-17 的论文
  ✅ 成功: 新增 3 篇，更新 2 篇

[2/24] 处理类别: Locomotion
  找到 8 篇 2025-12-17 的论文
  ✅ 成功: 新增 6 篇，更新 2 篇

...

============================================================
抓取完成统计:
  总类别数: 24
  成功类别: 24
  失败类别: 0
  总论文数: 156
  新增论文: 142
  更新论文: 14
============================================================
✅ 论文抓取任务完成
```

### 修改目标日期

如果需要抓取其他日期的论文，修改脚本中的 `TARGET_DATE`：

```python
# 修改这一行
TARGET_DATE = datetime(2025, 12, 18).date()  # 改为目标日期
```

### 注意事项

1. **日期范围**：脚本会自动扩大日期范围（前后各1天）以确保不遗漏论文
2. **API限制**：ArXiv API有频率限制，脚本会自动处理
3. **数据库连接**：确保 `.env` 文件中的 `DATABASE_URL` 配置正确

---

## 脚本2：Bilibili数据更新脚本

### 功能说明

`scripts/fetch_bilibili_update.py` - 安全地从Bilibili API获取最新视频数据

### 特性

- ✅ **频率限制**：内置请求频率限制，避免触发Bilibili风控
- ✅ **重试机制**：自动重试失败的请求（最多3次）
- ✅ **错误处理**：完整的错误处理和日志记录
- ✅ **增量更新**：只更新变化的视频数据
- ✅ **安全延迟**：UP主之间自动延迟，避免频率限制

### 使用方法

#### 本地使用

```bash
cd /path/to/EmbodiedPulse2026
source venv/bin/activate  # 如果使用虚拟环境
python3 scripts/fetch_bilibili_update.py
```

#### 服务器使用

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 scripts/fetch_bilibili_update.py
```

### 输出示例

```
============================================================
开始从Bilibili API获取更新数据
UP主数量: 7
每个UP主视频数: 50
UP主间延迟: 5 秒
============================================================

[1/7] 处理UP主: 1172054289
开始抓取UP主 1172054289 的数据 (尝试 1/3)...
  ✅ UP主信息更新成功: 逐际动力 (粉丝: 12.3万)
  处理 50 个视频...
  ✅ 视频数据更新成功: 新增 2 个，更新 48 个
等待 5 秒后处理下一个UP主...

[2/7] 处理UP主: 3546728498202679
...

============================================================
抓取完成统计:
  总UP主数: 7
  成功UP主: 7
  失败UP主: 0
  新增视频: 5
  更新视频: 345
============================================================
✅ Bilibili数据更新任务完成
```

### 配置参数

可以在脚本中修改以下参数：

```python
# 每个UP主抓取的视频数量
video_count=50

# UP主之间的延迟（秒）
delay_between_ups=5

# 最大重试次数
max_retries=3
```

### Bilibili凭证配置（可选）

为了提高通过风控的概率，可以在 `.env` 文件中配置Bilibili凭证：

```bash
# Bilibili凭证（可选，用于减轻412风控）
BILI_SESSDATA=your_sessdata
BILI_JCT=your_jct
BILI_BUVID3=your_buvid3
BILI_DEDEUSERID=your_dedeuserid
```

**如何获取凭证**：
1. 登录Bilibili网站
2. 打开浏览器开发者工具（F12）
3. 查看Cookie中的 `SESSDATA`、`bili_jct`、`buvid3`、`DedeUserID` 值
4. 复制到 `.env` 文件中

### 注意事项

1. **频率限制**：
   - 脚本内置了请求频率限制（最小间隔2秒）
   - UP主之间自动延迟5秒
   - 如果触发412错误，会自动重试并增加延迟

2. **重试机制**：
   - 每个UP主最多重试3次
   - 重试间隔递增（5s, 10s, 15s）
   - 如果所有重试都失败，会记录错误并继续下一个UP主

3. **数据安全**：
   - 使用数据库事务，确保数据一致性
   - 失败时自动回滚，不会污染数据
   - 详细的错误日志，便于排查问题

4. **UP主列表**：
   - UP主列表从 `app.py` 的 `BILIBILI_UP_LIST` 导入
   - 如果无法导入，使用脚本中的默认列表

---

## 常见问题

### Q1: 论文抓取失败，提示"加载配置文件失败"

**A**: 确保 `config.yaml` 文件存在于项目根目录，并且格式正确。

### Q2: Bilibili数据更新时频繁出现412错误

**A**: 
1. 检查是否配置了Bilibili凭证（见上方配置说明）
2. 增加 `delay_between_ups` 参数的值（例如改为10秒）
3. 检查网络连接是否稳定

### Q3: 数据库连接失败

**A**: 
1. 检查 `.env` 文件中的 `DATABASE_URL` 配置
2. 确保数据库服务正在运行
3. 检查数据库权限

### Q4: 脚本执行很慢

**A**: 
- 论文脚本：ArXiv API有频率限制，这是正常的
- Bilibili脚本：为了安全，内置了延迟机制，这是预期的行为

### Q5: 如何查看详细的错误信息

**A**: 脚本会输出详细的日志信息，包括：
- 每个步骤的执行状态
- 错误信息和堆栈跟踪
- 最终的统计信息

---

## 安全建议

1. **定期备份**：在执行数据更新前，建议备份数据库
2. **监控日志**：定期检查日志文件，及时发现异常
3. **频率控制**：不要频繁执行脚本，避免触发API限制
4. **凭证安全**：Bilibili凭证是敏感信息，不要泄露

---

## 技术支持

如果遇到问题，请：
1. 查看脚本输出的错误日志
2. 检查数据库连接和配置
3. 确认网络连接正常
4. 联系技术支持团队

