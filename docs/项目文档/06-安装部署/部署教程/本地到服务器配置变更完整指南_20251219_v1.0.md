# 本地到服务器配置变更完整指南

**文档版本**: v1.0  
**创建日期**: 2025-12-19  
**最后更新**: 2025-12-19  
**目标读者**: 零基础小白，第一次部署项目到服务器

---

## 📋 目录

1. [核心概念：什么需要改，什么不需要改](#核心概念什么需要改什么不需要改)
2. [路由配置：需要改吗？](#路由配置需要改吗)
3. [环境变量配置（.env文件）](#环境变量配置env文件)
4. [数据库配置](#数据库配置)
5. [域名和URL配置](#域名和url配置)
6. [OAuth回调URL配置](#oauth回调url配置)
7. [端口配置](#端口配置)
8. [静态文件路径](#静态文件路径)
9. [日志路径配置](#日志路径配置)
10. [Nginx配置](#nginx配置)
11. [第三方服务配置](#第三方服务配置)
12. [配置变更检查清单](#配置变更检查清单)

---

## 核心概念：什么需要改，什么不需要改

### ✅ 不需要改的东西（代码层面）

**1. Flask路由定义**
- ❌ **不需要改**：代码中的 `@app.route('/api/papers')` 等路由定义
- **原因**：Flask路由是相对的，不依赖域名或端口
- **示例**：
  ```python
  # 本地和服务器都一样，不需要改
  @app.route('/api/papers')
  def get_papers():
      return jsonify({'data': papers})
  ```

**2. 前端API调用**
- ❌ **不需要改**：JavaScript中的 `fetch('/api/papers')` 等相对路径
- **原因**：相对路径会自动使用当前域名和协议
- **示例**：
  ```javascript
  // 本地和服务器都一样，不需要改
  fetch('/api/papers')
    .then(response => response.json())
    .then(data => console.log(data));
  ```

**3. 静态文件引用**
- ❌ **不需要改**：HTML中的 `{{ url_for('static', filename='css/style.css') }}`
- **原因**：Flask的`url_for`会自动生成正确的URL
- **示例**：
  ```html
  <!-- 本地和服务器都一样，不需要改 -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  ```

**4. 代码逻辑**
- ❌ **不需要改**：业务逻辑、数据处理、算法等
- **原因**：代码逻辑与环境无关

### ⚠️ 必须改的东西（配置层面）

**1. 环境变量（.env文件）**
- ✅ **必须改**：数据库连接、OAuth回调URL、密钥等
- **原因**：本地和服务器环境不同

**2. 域名和协议**
- ✅ **必须改**：从 `localhost:5001` 改为 `your-domain.com`
- **原因**：服务器使用真实域名

**3. OAuth回调URL**
- ✅ **必须改**：飞书等第三方服务的回调地址
- **原因**：第三方服务需要知道回调地址

**4. 数据库连接**
- ✅ **必须改**：从本地数据库改为服务器数据库
- **原因**：数据库位置不同

**5. 端口配置**
- ✅ **可能需要改**：根据服务器配置调整
- **原因**：服务器可能使用不同端口

---

## 路由配置：需要改吗？

### 答案：❌ 不需要改

**原因**：Flask路由是相对的，不依赖域名、端口或协议。

### 示例说明

**本地环境**：
```python
# app.py
@app.route('/api/papers')
def get_papers():
    return jsonify({'data': papers})
```

**访问方式**：
- 本地：`http://localhost:5001/api/papers`
- 服务器：`https://essay.gradmotion.com/api/papers`

**代码不变**：路由定义 `/api/papers` 在本地和服务器都一样。

### 前端调用也不需要改

**JavaScript代码**：
```javascript
// 本地和服务器都一样
fetch('/api/papers')
  .then(response => response.json())
  .then(data => console.log(data));
```

**工作原理**：
- 本地：`http://localhost:5001/api/papers`
- 服务器：`https://essay.gradmotion.com/api/papers`
- 浏览器会自动使用当前页面的域名和协议

### 总结

| 项目 | 本地 | 服务器 | 需要改吗？ |
|------|------|--------|-----------|
| 路由定义 | `/api/papers` | `/api/papers` | ❌ 不需要 |
| 前端调用 | `fetch('/api/papers')` | `fetch('/api/papers')` | ❌ 不需要 |
| 静态文件 | `url_for('static', ...)` | `url_for('static', ...)` | ❌ 不需要 |

---

## 环境变量配置（.env文件）

### 什么是环境变量？

**环境变量**：存储在`.env`文件中的配置信息，用于区分本地和服务器环境。

### 本地 vs 服务器环境变量对比

#### 本地环境变量（.env.local）

```bash
# ==================== 飞书OAuth配置 ====================
FEISHU_APP_ID=cli_a6727c4ffc71d00b
FEISHU_APP_SECRET=dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI
FEISHU_REDIRECT_URI=http://localhost:5001/api/auth/feishu/callback

# ==================== JWT配置 ====================
JWT_SECRET_KEY=embodied-pulse-jwt-secret-key-2025
JWT_ACCESS_TOKEN_EXPIRES=86400

# ==================== 数据库配置 ====================
DATABASE_URL=sqlite:///./papers.db
# 或
# DATABASE_URL=postgresql://user:password@localhost:5432/embodied_pulse

# ==================== Flask配置 ====================
FLASK_ENV=development
FLASK_DEBUG=1
PORT=5001
```

#### 服务器环境变量（.env.production）

```bash
# ==================== 飞书OAuth配置 ====================
FEISHU_APP_ID=cli_a6727c4ffc71d00b
FEISHU_APP_SECRET=dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI
# ⚠️ 必须改：改为服务器域名
FEISHU_REDIRECT_URI=https://login.gradmotion.com/api/auth/feishu/callback

# ==================== JWT配置 ====================
# ⚠️ 建议改：使用更强的密钥
JWT_SECRET_KEY=your-production-secret-key-here-make-it-long-and-random
JWT_ACCESS_TOKEN_EXPIRES=86400

# ==================== 数据库配置 ====================
# ⚠️ 必须改：改为服务器数据库
DATABASE_URL=postgresql://embodied_user:password@localhost:5432/embodied_pulse

# ==================== Flask配置 ====================
# ⚠️ 必须改：生产环境配置
FLASK_ENV=production
FLASK_DEBUG=0
PORT=5001
```

### 必须修改的环境变量

#### 1. FEISHU_REDIRECT_URI（飞书OAuth回调地址）

**本地**：
```bash
FEISHU_REDIRECT_URI=http://localhost:5001/api/auth/feishu/callback
```

**服务器**：
```bash
FEISHU_REDIRECT_URI=https://login.gradmotion.com/api/auth/feishu/callback
```

**为什么必须改**：
- 飞书OAuth需要知道回调地址
- 本地和服务器域名不同
- 必须使用HTTPS（生产环境）

**如何修改**：
1. 在服务器上编辑`.env`文件
2. 修改`FEISHU_REDIRECT_URI`为服务器域名
3. 在飞书开放平台配置相同的回调地址

#### 2. DATABASE_URL（数据库连接）

**本地**：
```bash
# SQLite（开发环境）
DATABASE_URL=sqlite:///./papers.db

# 或本地PostgreSQL
DATABASE_URL=postgresql://user:password@localhost:5432/embodied_pulse
```

**服务器**：
```bash
# 服务器PostgreSQL
DATABASE_URL=postgresql://embodied_user:password@localhost:5432/embodied_pulse
```

**为什么必须改**：
- 本地和服务器数据库不同
- 服务器使用PostgreSQL（生产环境）
- 数据库用户名、密码、数据库名可能不同

**如何修改**：
1. 在服务器上创建PostgreSQL数据库
2. 修改`.env`文件中的`DATABASE_URL`
3. 确保数据库用户有足够权限

#### 3. FLASK_ENV（Flask环境）

**本地**：
```bash
FLASK_ENV=development
FLASK_DEBUG=1
```

**服务器**：
```bash
FLASK_ENV=production
FLASK_DEBUG=0
```

**为什么必须改**：
- `development`模式会显示详细错误信息（不安全）
- `production`模式会隐藏错误详情（安全）
- `DEBUG=1`会暴露敏感信息（不安全）

#### 4. JWT_SECRET_KEY（JWT密钥）

**本地**：
```bash
JWT_SECRET_KEY=embodied-pulse-jwt-secret-key-2025
```

**服务器**：
```bash
JWT_SECRET_KEY=your-production-secret-key-here-make-it-long-and-random
```

**为什么建议改**：
- 使用更强的密钥提高安全性
- 本地和服务器密钥应该不同

**如何生成强密钥**：
```python
import secrets
print(secrets.token_urlsafe(32))
```

### 可选修改的环境变量

#### PORT（端口）

**本地**：
```bash
PORT=5001
```

**服务器**：
```bash
PORT=5001  # 通常不需要改，除非服务器有特殊要求
```

**说明**：
- 如果使用Nginx反向代理，端口通常不需要改
- 如果直接暴露端口，可能需要改

---

## 数据库配置

### 数据库连接URL格式

**SQLite（本地开发）**：
```
sqlite:///./papers.db
```

**PostgreSQL（服务器生产）**：
```
postgresql://用户名:密码@主机:端口/数据库名
```

### 本地 vs 服务器数据库配置

#### 本地数据库配置

**方式1：SQLite（最简单）**
```bash
DATABASE_URL=sqlite:///./papers.db
```

**方式2：本地PostgreSQL**
```bash
DATABASE_URL=postgresql://robotics_user:robotics_password@localhost:5432/robotics_arxiv
```

#### 服务器数据库配置

**PostgreSQL（生产环境）**
```bash
DATABASE_URL=postgresql://embodied_user:MyStrongPass123!@#@localhost:5432/embodied_pulse
```

### 数据库配置变更步骤

#### 步骤1：在服务器上创建数据库

```bash
# SSH登录服务器
ssh root@your-server-ip

# 切换到postgres用户
sudo -u postgres psql

# 创建数据库和用户
CREATE DATABASE embodied_pulse;
CREATE USER embodied_user WITH PASSWORD 'MyStrongPass123!@#';
GRANT ALL PRIVILEGES ON DATABASE embodied_pulse TO embodied_user;
\q
```

#### 步骤2：修改.env文件

```bash
# 在服务器上编辑.env文件
nano /srv/EmbodiedPulse2026/.env

# 修改DATABASE_URL
DATABASE_URL=postgresql://embodied_user:MyStrongPass123!@#@localhost:5432/embodied_pulse
```

#### 步骤3：初始化数据库

```bash
# 激活虚拟环境
source venv/bin/activate

# 运行初始化脚本
python init_database.py
```

### 数据库迁移（从本地到服务器）

如果需要将本地数据迁移到服务器：

```bash
# 1. 在本地导出数据
pg_dump -U robotics_user -d robotics_arxiv > backup.sql

# 2. 上传到服务器
scp backup.sql root@your-server-ip:/tmp/

# 3. 在服务器上导入数据
psql -U embodied_user -d embodied_pulse < /tmp/backup.sql
```

---

## 域名和URL配置

### 本地 vs 服务器URL对比

| 环境 | 协议 | 域名 | 端口 | 完整URL |
|------|------|------|------|---------|
| **本地** | http | localhost | 5001 | http://localhost:5001 |
| **服务器** | https | essay.gradmotion.com | 443 | https://essay.gradmotion.com |

### 需要修改的地方

#### 1. 前端硬编码的URL（如果有）

**检查代码中是否有硬编码URL**：

```bash
# 搜索硬编码的localhost
grep -r "localhost" templates/ static/
grep -r "http://" templates/ static/
grep -r "https://" templates/ static/
```

**如果有硬编码URL，需要修改**：

```javascript
// ❌ 错误：硬编码URL
const apiUrl = 'http://localhost:5001/api/papers';

// ✅ 正确：使用相对路径
const apiUrl = '/api/papers';

// ✅ 或使用动态获取
const apiUrl = `${window.location.origin}/api/papers`;
```

#### 2. 第三方服务配置（OAuth回调等）

**飞书OAuth回调URL**：
- 本地：`http://localhost:5001/api/auth/feishu/callback`
- 服务器：`https://login.gradmotion.com/api/auth/feishu/callback`

**需要在两个地方修改**：
1. 服务器`.env`文件
2. 飞书开放平台配置

---

## OAuth回调URL配置

### 什么是OAuth回调URL？

**OAuth回调URL**：第三方服务（如飞书）在用户授权后，重定向回你的应用的地址。

### 本地 vs 服务器回调URL

#### 本地回调URL

```bash
# .env文件
FEISHU_REDIRECT_URI=http://localhost:5001/api/auth/feishu/callback
```

**飞书开放平台配置**：
```
http://localhost:5001/api/auth/feishu/callback
```

#### 服务器回调URL

```bash
# .env文件
FEISHU_REDIRECT_URI=https://login.gradmotion.com/api/auth/feishu/callback
```

**飞书开放平台配置**：
```
https://login.gradmotion.com/api/auth/feishu/callback
```

### 修改步骤

#### 步骤1：修改服务器.env文件

```bash
# SSH登录服务器
ssh root@your-server-ip

# 编辑.env文件
nano /srv/EmbodiedPulse2026/.env

# 修改FEISHU_REDIRECT_URI
FEISHU_REDIRECT_URI=https://login.gradmotion.com/api/auth/feishu/callback
```

#### 步骤2：修改飞书开放平台配置

1. 登录飞书开放平台：https://open.feishu.cn/
2. 进入应用管理
3. 找到"安全设置" → "重定向URL"
4. 添加服务器回调URL：`https://login.gradmotion.com/api/auth/feishu/callback`
5. 保存配置

**注意**：
- 可以同时配置多个回调URL（本地和服务器）
- 回调URL必须完全匹配（包括协议、域名、路径）

### 自动检测回调URL（推荐）

**Embodied Pulse的实现**：

```python
# auth_routes.py
# 自动检测当前协议和域名
scheme = 'https' if request.is_secure or request.headers.get('X-Forwarded-Proto') == 'https' else 'http'
host = request.headers.get('Host', 'localhost:5001')
default_redirect = f"{scheme}://{host}/api/auth/feishu/callback"
```

**优点**：
- 不需要硬编码URL
- 自动适配HTTP/HTTPS
- 本地和服务器都能正常工作

---

## 端口配置

### 本地 vs 服务器端口

| 环境 | 应用端口 | Nginx端口 | 说明 |
|------|---------|----------|------|
| **本地** | 5001 | 无 | 直接访问应用端口 |
| **服务器** | 5001 | 80/443 | Nginx反向代理到应用端口 |

### 端口配置说明

#### 本地开发

**直接运行Flask**：
```bash
python app.py
# 访问：http://localhost:5001
```

**使用Gunicorn**：
```bash
gunicorn -c gunicorn_config.py app:app
# 访问：http://localhost:5001
```

#### 服务器生产

**应用端口（内部）**：
```bash
# Gunicorn监听5001端口（内部）
bind = "0.0.0.0:5001"
```

**Nginx端口（外部）**：
```nginx
# Nginx监听80和443端口（外部）
server {
    listen 80;   # HTTP
    listen 443 ssl;  # HTTPS
    server_name essay.gradmotion.com;
    
    # 反向代理到应用
    location / {
        proxy_pass http://127.0.0.1:5001;
    }
}
```

### 端口配置变更

**通常不需要改**：
- 应用端口（5001）在本地和服务器可以一样
- Nginx会处理外部端口（80/443）

**可能需要改的情况**：
- 服务器5001端口被占用
- 使用Docker，端口映射不同
- 使用云平台，自动分配端口

**如何修改**：

```bash
# 修改gunicorn_config.py
port = os.getenv('PORT', '5002')  # 改为5002
bind = f"0.0.0.0:{port}"

# 修改Nginx配置
proxy_pass http://127.0.0.1:5002;  # 改为5002
```

---

## 静态文件路径

### 静态文件路径需要改吗？

**答案**：❌ **通常不需要改**

### 为什么不需要改？

**Flask的静态文件处理**：

```python
# app.py
app = Flask(__name__, 
            template_folder=TEMPLATE_DIR,
            static_folder=STATIC_DIR)
```

**工作原理**：
- Flask会自动处理静态文件路径
- `url_for('static', filename='css/style.css')`会自动生成正确的URL
- 本地和服务器路径结构相同，不需要改

### 静态文件路径结构

**本地和服务器都一样**：
```
项目根目录/
├── static/
│   ├── css/
│   │   └── style.css
│   ├── js/
│   │   └── app.js
│   └── images/
│       └── logo.svg
└── templates/
    └── index.html
```

### Nginx静态文件优化（可选）

**直接由Nginx提供静态文件**（提升性能）：

```nginx
# Nginx配置
server {
    # 静态文件直接由Nginx提供
    location /static {
        alias /srv/EmbodiedPulse2026/static;
        expires 30d;  # 缓存30天
    }
    
    # 其他请求代理到Flask
    location / {
        proxy_pass http://127.0.0.1:5001;
    }
}
```

**注意**：
- 这是性能优化，不是必须的
- 如果使用Nginx提供静态文件，需要确保路径正确

---

## 日志路径配置

### 本地 vs 服务器日志路径

#### 本地开发

**日志输出到控制台**：
```python
# app.py
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)
logger.info("应用启动")
# 输出到：控制台
```

#### 服务器生产

**日志输出到文件或systemd**：

**方式1：输出到文件**
```python
# app.py
logging.basicConfig(
    level=logging.INFO,
    handlers=[
        logging.FileHandler('/var/log/my-project/app.log'),
        logging.StreamHandler()  # 同时输出到控制台
    ]
)
```

**方式2：使用systemd日志（推荐）**
```python
# app.py
# 不需要特殊配置，systemd会自动捕获日志
logging.basicConfig(level=logging.INFO)
```

**查看systemd日志**：
```bash
journalctl -u my-project -f
```

### Gunicorn日志配置

**gunicorn_config.py**：

```python
# 本地开发
accesslog = "/tmp/gunicorn_access.log"
errorlog = "/tmp/gunicorn_error.log"

# 服务器生产（使用systemd）
accesslog = "-"  # 输出到stdout
errorlog = "-"   # 输出到stderr
# systemd会自动捕获并记录到journal
```

### 日志路径变更步骤

**通常不需要改**：
- 如果使用systemd，日志自动管理
- 如果使用文件日志，需要确保目录存在且有写权限

**创建日志目录**：
```bash
sudo mkdir -p /var/log/my-project
sudo chown root:root /var/log/my-project
sudo chmod 755 /var/log/my-project
```

---

## Nginx配置

### Nginx配置必须改

**原因**：Nginx需要知道域名、SSL证书、代理地址等。

### 本地 vs 服务器Nginx配置

#### 本地开发（通常不用Nginx）

**直接运行Flask**：
```bash
python app.py
# 访问：http://localhost:5001
```

#### 服务器生产（必须配置Nginx）

**Nginx配置示例**：

```nginx
# /etc/nginx/sites-available/my-project

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name essay.gradmotion.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS配置
server {
    listen 443 ssl http2;
    server_name essay.gradmotion.com;

    # SSL证书（必须配置）
    ssl_certificate /etc/letsencrypt/live/essay.gradmotion.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/essay.gradmotion.com/privkey.pem;

    # 静态文件
    location /static {
        alias /srv/EmbodiedPulse2026/static;
        expires 30d;
    }

    # API和页面
    location / {
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### Nginx配置必须修改的地方

#### 1. server_name（域名）

**必须改**：
```nginx
# 改为你的域名
server_name essay.gradmotion.com;
```

#### 2. SSL证书路径

**必须改**：
```nginx
# 改为你的证书路径
ssl_certificate /etc/letsencrypt/live/essay.gradmotion.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/essay.gradmotion.com/privkey.pem;
```

#### 3. 静态文件路径

**必须改**：
```nginx
# 改为你的项目路径
location /static {
    alias /srv/EmbodiedPulse2026/static;
}
```

#### 4. 代理地址

**通常不需要改**：
```nginx
# 如果应用端口是5001，不需要改
proxy_pass http://127.0.0.1:5001;
```

### 多域名配置

**Embodied Pulse的多域名配置**：

```nginx
# 论文页面
server {
    listen 443 ssl http2;
    server_name essay.gradmotion.com;
    # ... 配置 ...
    location / {
        proxy_pass http://127.0.0.1:5001/;
    }
}

# 登录页面
server {
    listen 443 ssl http2;
    server_name login.gradmotion.com;
    # ... 配置 ...
    location / {
        proxy_pass http://127.0.0.1:5001/;
    }
}

# 管理后台
server {
    listen 443 ssl http2;
    server_name admin123.gradmotion.com;
    # ... 配置 ...
    location / {
        proxy_pass http://127.0.0.1:5001/admin/;
    }
}
```

---

## 第三方服务配置

### 需要修改的第三方服务配置

#### 1. 飞书开放平台

**需要修改的配置**：
- **重定向URL**：从 `http://localhost:5001/api/auth/feishu/callback` 改为 `https://login.gradmotion.com/api/auth/feishu/callback`

**修改步骤**：
1. 登录飞书开放平台：https://open.feishu.cn/
2. 进入应用管理
3. 找到"安全设置" → "重定向URL"
4. 添加服务器回调URL
5. 保存配置

**注意**：
- 可以同时配置多个回调URL（本地和服务器）
- 回调URL必须完全匹配

#### 2. 其他第三方服务

**如果有其他OAuth服务（如GitHub、Google等）**：
- 同样需要修改回调URL
- 在对应的开放平台配置服务器回调地址

---

## 配置变更检查清单

### 部署前检查清单

#### 1. 环境变量（.env文件）

- [ ] `FEISHU_REDIRECT_URI` 已改为服务器域名
- [ ] `DATABASE_URL` 已改为服务器数据库
- [ ] `FLASK_ENV` 已改为 `production`
- [ ] `FLASK_DEBUG` 已改为 `0`
- [ ] `JWT_SECRET_KEY` 已使用强密钥
- [ ] 其他环境变量已正确配置

#### 2. 数据库配置

- [ ] 服务器PostgreSQL已安装并运行
- [ ] 数据库和用户已创建
- [ ] `.env`文件中的`DATABASE_URL`已更新
- [ ] 数据库初始化脚本已运行
- [ ] 数据库连接测试通过

#### 3. 域名和URL配置

- [ ] 域名DNS已解析到服务器IP
- [ ] Nginx配置中的`server_name`已更新
- [ ] SSL证书已配置
- [ ] HTTPS访问正常

#### 4. OAuth配置

- [ ] 飞书开放平台回调URL已配置
- [ ] `.env`文件中的`FEISHU_REDIRECT_URI`已更新
- [ ] OAuth登录测试通过

#### 5. Nginx配置

- [ ] Nginx配置文件已创建
- [ ] `server_name`已配置正确域名
- [ ] SSL证书路径正确
- [ ] 静态文件路径正确
- [ ] 代理地址正确
- [ ] Nginx配置测试通过：`nginx -t`
- [ ] Nginx已重启：`systemctl restart nginx`

#### 6. 服务配置

- [ ] systemd服务文件已创建
- [ ] 服务路径正确
- [ ] 环境变量文件路径正确
- [ ] 服务已启动：`systemctl start my-project`
- [ ] 服务已启用（开机自启）：`systemctl enable my-project`

#### 7. 功能验证

- [ ] 首页可以正常访问
- [ ] API接口正常返回数据
- [ ] 静态文件正常加载
- [ ] 登录功能正常
- [ ] 数据库操作正常
- [ ] 定时任务正常运行

---

## 配置变更对比表

### 完整对比表

| 配置项 | 本地 | 服务器 | 需要改吗？ | 如何改 |
|--------|------|--------|-----------|--------|
| **Flask路由** | `/api/papers` | `/api/papers` | ❌ 不需要 | - |
| **前端API调用** | `fetch('/api/papers')` | `fetch('/api/papers')` | ❌ 不需要 | - |
| **静态文件引用** | `url_for('static', ...)` | `url_for('static', ...)` | ❌ 不需要 | - |
| **FEISHU_REDIRECT_URI** | `http://localhost:5001/...` | `https://login.gradmotion.com/...` | ✅ 必须改 | 修改.env文件 + 飞书平台配置 |
| **DATABASE_URL** | `sqlite:///./papers.db` | `postgresql://...` | ✅ 必须改 | 修改.env文件 |
| **FLASK_ENV** | `development` | `production` | ✅ 必须改 | 修改.env文件 |
| **FLASK_DEBUG** | `1` | `0` | ✅ 必须改 | 修改.env文件 |
| **JWT_SECRET_KEY** | `简单密钥` | `强密钥` | ⚠️ 建议改 | 修改.env文件 |
| **PORT** | `5001` | `5001` | ⚠️ 通常不改 | - |
| **Nginx server_name** | 无 | `essay.gradmotion.com` | ✅ 必须配置 | 创建Nginx配置 |
| **SSL证书** | 无 | `/etc/letsencrypt/...` | ✅ 必须配置 | 申请SSL证书 |
| **日志路径** | 控制台 | systemd日志 | ⚠️ 可选改 | 使用systemd自动管理 |

---

## 实际案例：Embodied Pulse配置变更

### 本地配置（.env.local）

```bash
# 飞书OAuth
FEISHU_REDIRECT_URI=http://localhost:5001/api/auth/feishu/callback

# 数据库
DATABASE_URL=sqlite:///./papers.db

# Flask
FLASK_ENV=development
FLASK_DEBUG=1
```

### 服务器配置（.env.production）

```bash
# 飞书OAuth
FEISHU_REDIRECT_URI=https://login.gradmotion.com/api/auth/feishu/callback

# 数据库
DATABASE_URL=postgresql://embodied_user:password@localhost:5432/embodied_pulse

# Flask
FLASK_ENV=production
FLASK_DEBUG=0
```

### Nginx配置（服务器）

```nginx
# 论文页面
server {
    listen 443 ssl http2;
    server_name essay.gradmotion.com;
    ssl_certificate /etc/letsencrypt/live/essay.gradmotion.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/essay.gradmotion.com/privkey.pem;
    location / {
        proxy_pass http://127.0.0.1:5001;
    }
}

# 登录页面
server {
    listen 443 ssl http2;
    server_name login.gradmotion.com;
    ssl_certificate /etc/letsencrypt/live/login.gradmotion.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/login.gradmotion.com/privkey.pem;
    location / {
        proxy_pass http://127.0.0.1:5001;
    }
}
```

---

## 常见问题

### Q1: 路由需要改吗？

**A**: ❌ **不需要改**。Flask路由是相对的，代码中的路由定义在本地和服务器都一样。

**示例**：
```python
# 本地和服务器都一样
@app.route('/api/papers')
def get_papers():
    return jsonify({'data': papers})
```

### Q2: 前端API调用需要改吗？

**A**: ❌ **不需要改**。使用相对路径（如`/api/papers`）会自动使用当前域名。

**示例**：
```javascript
// 本地和服务器都一样
fetch('/api/papers')
```

### Q3: 静态文件路径需要改吗？

**A**: ❌ **不需要改**。Flask的`url_for`会自动生成正确的URL。

**示例**：
```html
<!-- 本地和服务器都一样 -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
```

### Q4: 哪些配置必须改？

**A**: 必须改的配置：
1. **环境变量**：`.env`文件中的数据库连接、OAuth回调URL等
2. **Nginx配置**：域名、SSL证书路径
3. **第三方服务**：飞书等OAuth服务的回调URL

### Q5: 如何快速检查配置是否正确？

**A**: 使用检查清单：
1. 检查`.env`文件中的关键配置
2. 检查Nginx配置：`nginx -t`
3. 检查服务状态：`systemctl status my-project`
4. 测试功能：访问网站，测试登录、API等

---

## 总结

### 核心要点

1. **代码不需要改**：路由、API调用、静态文件引用都不需要改
2. **配置必须改**：环境变量、数据库连接、OAuth回调URL必须改
3. **服务器需要配置**：Nginx、SSL证书、systemd服务需要配置

### 配置变更原则

- **代码层面**：尽量使用相对路径，避免硬编码URL
- **配置层面**：使用环境变量管理配置，区分本地和服务器
- **自动化**：使用脚本自动化配置变更

### 快速参考

**必须改的配置**：
1. `.env`文件：`FEISHU_REDIRECT_URI`、`DATABASE_URL`、`FLASK_ENV`
2. Nginx配置：`server_name`、SSL证书路径
3. 第三方服务：OAuth回调URL

**不需要改的配置**：
1. Flask路由定义
2. 前端API调用（使用相对路径）
3. 静态文件引用（使用`url_for`）

---

**最后更新**：2025-12-19  
**维护者**：AI开发助手  
**版本**：v1.0

