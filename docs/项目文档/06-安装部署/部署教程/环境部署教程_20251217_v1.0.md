## 一、文档目的与适用范围

本教程用于指导「EmbodiedPulse2026」项目从零部署到一台新服务器，并讲清楚：

- **整体架构与流转关系**（用户访问路径、数据流转路径、发版路径）
- **一次性部署步骤**（系统环境、代码、Python 依赖、数据库、服务管理、Nginx、HTTPS）
- **后续发版流程**（本地开发 → GitHub `main` → 服务器自动更新）

适用场景：

- 单机部署（1 台服务器，IP 例如 `101.200.222.139`）
- 前端 + 后端 + 定时任务全部由 Flask 应用承担，前面使用 Nginx 做反向代理

---

## 二、整体架构与流转关系

### 2.1 用户访问路径（请求流转）

- 用户浏览器访问 4 个域名：
  - 登录页：`login.gradmotion.com`
  - 具身论文页：`essay.gradmotion.com`
  - 具身视频页：`blibli.gradmotion.com`
  - 管理端：`admin123.gradmotion.com`
- DNS 将以上域名解析到服务器 IP（如 `101.200.222.139`）
- 服务器上的 **Nginx** 收到 80/443 端口请求，根据 Host 做反向代理：
  - `essay.gradmotion.com` → 代理到 Flask 的 `/`（具身论文）
  - `blibli.gradmotion.com` → 代理到 Flask 的 `/bilibili`（具身视频）
  - `login.gradmotion.com` → 代理到 Flask 的 `/login`（登录页）
  - `admin123.gradmotion.com` → 代理到 Flask 的 `/admin`（管理端）
- Flask 应用由 **Gunicorn** 在 `127.0.0.1:5001` 上提供服务：
  - 页面路由：`/`、`/bilibili`、`/login`、`/admin/...`
  - API 路由：`/api/papers`、`/api/bilibili/all` 等
- Flask 内部通过 SQLAlchemy 访问本地 SQLite 数据库：
  - 论文库：`instance/papers.db`
  - B 站库：`bilibili.db`
  - 其他：`news.db`、`jobs.db` 等
- APScheduler 定时任务按 `.env` 中的 CRON 配置周期性抓取 ArXiv / B 站 / Semantic Scholar 等数据并写入数据库。

> 关键点：**所有域名背后只有一个 Flask 服务实例**，只是入口 URL 不同；前端页面、API、定时任务都在这一个应用中。

### 2.2 代码发布路径（发版流转）

1. 本地开发 & 测试，通过后：
   - `git commit` → `git push origin main` 到仓库  
     `https://github.com/aramisjiang-wq/EmbodiedPulse2026`
2. GitHub Actions 监听 `main` 分支的 push 事件，自动通过 SSH 登录服务器：
   - `cd /srv/EmbodiedPulse2026`
   - `git pull origin main`
   - `pip install -r requirements.txt`（如依赖变化）
   - `systemctl restart embodiedpulse.service`
3. 几十秒内，Nginx 反向代理到的 Gunicorn 已经是最新代码，对应 4 个域名全部更新。

> 关键点：**人工只负责本地开发 + 推代码，服务器更新由 GitHub Actions + 部署脚本自动完成。**

---

## 三、一次性部署流程（从空服务器到可用服务）

以下步骤默认使用 Ubuntu / Debian 系服务器，且以 `/srv/EmbodiedPulse2026` 为部署目录，可根据实际调整。

### 3.1 准备服务器基础环境

**需要人工在服务器上执行：**

1. 登录服务器：

```bash
ssh root@101.200.222.139
```

2. 更新系统并安装基础工具：

```bash
apt update && apt upgrade -y
apt install -y git python3 python3-venv python3-pip nginx
```

> 安全建议：后续可以创建非 root 用户（如 `deploy`），并使用 SSH key 登录代替密码。

### 3.2 拉取代码 & 创建 Python 虚拟环境

**需要人工在服务器上执行：**

```bash
mkdir -p /srv
cd /srv
git clone https://github.com/aramisjiang-wq/EmbodiedPulse2026.git
cd EmbodiedPulse2026

python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

### 3.3 配置环境变量 `.env`

本地仓库中 `.env` 被忽略，线上需要手动创建一份：

**在 `/srv/EmbodiedPulse2026` 内编辑 `.env`（示例模板）：**

```ini
FLASK_ENV=production
SECRET_KEY=请替换为一串高强度随机字符串

# 自动定时抓取总开关
AUTO_FETCH_ENABLED=true

# 论文抓取计划（示例：每小时）
AUTO_FETCH_SCHEDULE=0 * * * *

# 新闻抓取、岗位抓取（视需要配置）
AUTO_FETCH_NEWS_SCHEDULE=0 * * * *
AUTO_FETCH_JOBS_SCHEDULE=0 * * * *

# 论文全量抓取（示例：每天 02:00）
AUTO_FETCH_FULL_SCHEDULE=0 2 * * *

# B 站抓取计划（示例：每 6 小时）
AUTO_FETCH_BILIBILI_SCHEDULE=0 */6 * * *

# Semantic Scholar 每日更新上限
SEMANTIC_UPDATE_LIMIT=200

# 其他你已有的配置项（如第三方 Key、Feishu 回调配置等）
```

> 原则：**线上 `.env` 与本地 `.env` 保持字段一致，但敏感信息不提交到 GitHub，只保存在服务器。**

### 3.4 初始化数据库（仅首发 / 或迁移）

#### 3.4.1 首次初始化

如果是全新部署，没有历史数据，可以在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

python init_database.py      # 初始化论文等基础库
python init_auth_db.py       # 初始化认证/用户库
```

视项目实际还可以执行：

```bash
python migrate_add_semantic_scholar_fields.py
python migrate_sqlite_to_postgresql.py   # 如未来迁到 Postgres 时使用
```

#### 3.4.2 从本地迁移 SQLite

如果本地开发环境中已有较完整的数据（如 `papers.db`、`bilibili.db`），可手动上传：

1. 本地执行：

```bash
cd /Users/dong/Documents/Cursor/Embodied Pulse
scp instance/papers.db root@101.200.222.139:/srv/EmbodiedPulse2026/instance/papers.db
scp bilibili.db        root@101.200.222.139:/srv/EmbodiedPulse2026/bilibili.db
```

2. 覆盖服务器上的对应文件后，重启 Flask 服务即可。

### 3.5 校验 Flask + Gunicorn 启动（临时）

在引入 systemd 之前，先直接用 Gunicorn 跑一遍，验证启动是否正常：

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

gunicorn -w 4 -b 127.0.0.1:5001 app:app
```

在服务器上新开一个终端窗口，执行：

```bash
curl -I http://127.0.0.1:5001/
curl -I http://127.0.0.1:5001/bilibili
curl -I http://127.0.0.1:5001/login
curl -I http://127.0.0.1:5001/admin
```

返回 200 即代表应用基本正常。

停止 Gunicorn（Ctrl + C），进入下一步使用 systemd 托管。

### 3.6 配置 systemd 服务（长期运行）

**需要人工在服务器上创建服务文件：**

1. 新建 `/etc/systemd/system/embodiedpulse.service`：

```ini
[Unit]
Description=EmbodiedPulse Flask App (gunicorn)
After=network.target

[Service]
User=root
WorkingDirectory=/srv/EmbodiedPulse2026
Environment="PATH=/srv/EmbodiedPulse2026/venv/bin"
ExecStart=/srv/EmbodiedPulse2026/venv/bin/gunicorn -w 4 -b 127.0.0.1:5001 app:app
Restart=always

[Install]
WantedBy=multi-user.target
```

2. 重新加载 systemd 并启动服务：

```bash
systemctl daemon-reload
systemctl enable embodiedpulse
systemctl start embodiedpulse
systemctl status embodiedpulse
```

看到 `active (running)` 即可。

> 之后每次只需 `systemctl restart embodiedpulse` 即可重启后端。

### 3.7 配置 Nginx 反向代理 + 多域名

#### 3.7.1 域名 DNS

在域名管理平台中将下列记录指向服务器 IP：

- `login.gradmotion.com` → A 记录 → `101.200.222.139`
- `essay.gradmotion.com` → A 记录 → `101.200.222.139`
- `blibli.gradmotion.com` → A 记录 → `101.200.222.139`
- `admin123.gradmotion.com` → A 记录 → `101.200.222.139`

#### 3.7.2 Nginx 站点配置（HTTP 版本）

在服务器上创建 `/etc/nginx/sites-available/embodiedpulse.conf`：

```nginx
# 登录页
server {
    listen 80;
    server_name login.gradmotion.com;

    location / {
        proxy_pass http://127.0.0.1:5001/login;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 具身论文页
server {
    listen 80;
    server_name essay.gradmotion.com;

    location / {
        proxy_pass http://127.0.0.1:5001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 具身视频页
server {
    listen 80;
    server_name blibli.gradmotion.com;

    location / {
        proxy_pass http://127.0.0.1:5001/bilibili;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 管理端
server {
    listen 80;
    server_name admin123.gradmotion.com;

    location / {
        proxy_pass http://127.0.0.1:5001/admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

启用站点并重载：

```bash
ln -s /etc/nginx/sites-available/embodiedpulse.conf /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

此时用 HTTP 访问四个域名应能打开对应页面（无 HTTPS）。

### 3.8 配置 HTTPS（Let’s Encrypt）

安装 certbot 及其 Nginx 插件：

```bash
apt install -y certbot python3-certbot-nginx
```

为四个域名申请证书并自动配置：

```bash
certbot --nginx \
  -d login.gradmotion.com \
  -d essay.gradmotion.com \
  -d blibli.gradmotion.com \
  -d admin123.gradmotion.com
```

根据提示选择自动重定向 HTTP → HTTPS。Certbot 会：

- 在 Nginx 配置中自动添加 `listen 443 ssl`、证书路径
- 配置 `cron` 或 systemd timer 定期自动续期

> 建议稍后执行 `certbot renew --dry-run` 验证自动续期是否成功。

---

## 四、自动化发版流程（本地 → GitHub → 服务器）

### 4.1 部署脚本 `deploy_server.sh`

在仓库 `scripts/` 目录下提供一个统一部署脚本模板（已由 AI 写入仓库）：

```bash
#!/usr/bin/env bash
set -e

APP_DIR="/srv/EmbodiedPulse2026"

cd "$APP_DIR"

echo "[deploy] 拉取最新代码..."
git fetch origin
git checkout main
git pull origin main

echo "[deploy] 更新依赖..."
source venv/bin/activate
pip install -r requirements.txt

echo "[deploy] 重启服务..."
systemctl restart embodiedpulse

echo "[deploy] 完成。"
```

线上使用时建议复制到 `/srv/EmbodiedPulse2026/deploy.sh` 并赋予执行权限：

```bash
cp scripts/deploy_server.sh /srv/EmbodiedPulse2026/deploy.sh
chmod +x /srv/EmbodiedPulse2026/deploy.sh
```

测试一次手工部署：

```bash
/srv/EmbodiedPulse2026/deploy.sh
```

### 4.2 GitHub Actions 自动部署工作流

在仓库 `.github/workflows/deploy.yml` 中定义 CI/CD 流程（已由 AI 写入模板）：

- 触发条件：`main` 分支有新的 push
- 工作步骤：
  1. `checkout` 代码（只是占位）
  2. 使用 `appleboy/ssh-action` 通过 SSH 登录服务器
  3. 在服务器执行 `/srv/EmbodiedPulse2026/deploy.sh`

你需要在 GitHub 仓库的 **Settings → Secrets and variables → Actions** 中配置以下 Secrets：

- `SERVER_HOST`：`101.200.222.139`
- `SERVER_USER`：部署用户（建议新建如 `deploy`，不要用 root）
- `SERVER_SSH_KEY`：上述用户的私钥内容

配置完成后，流程为：

1. 本地开发 → 测试通过
2. `git commit` → `git push origin main`
3. GitHub Actions 自动执行 `deploy.yml`
4. 部署脚本在服务器上拉取最新代码并重启 Gunicorn 服务
5. 所有域名访问即是最新版本

---

## 五、运维检查清单（快速确认线上健康）

### 5.1 服务状态

- `systemctl status embodiedpulse`：Flask/Gunicorn 是否在运行
- `systemctl status nginx`：Nginx 是否在运行

### 5.2 HTTP/HTTPS 访问

- 浏览器访问：
  - `https://essay.gradmotion.com`
  - `https://blibli.gradmotion.com`
  - `https://login.gradmotion.com`
  - `https://admin123.gradmotion.com`
- 检查页面是否加载正常、数据是否展示、登录/管理端是否可用

### 5.3 定时任务（自动抓取）健康检查

- 确认 `.env` 中 `AUTO_FETCH_ENABLED=true`
- 查看应用日志（如 `flask.log` 或系统日志），是否出现：
  - APScheduler 启动日志
  - 论文/B 站/新闻抓取任务在预期时间执行的日志
- 手工访问健康脚本（如 `scripts/check_bilibili_api_to_db.py`、`scripts/diagnose_paper_fetch.py`），确认数据是否在近几小时更新

---

## 六、日常发版流程（给产品&开发的“操作说明”）

1. **本地开发**
   - 在本地仓库中修改代码、跑本地 Flask + 前端验证功能
2. **更新文档**
   - 按 `AI开发原则与规范_20251217_v1.0.md` 和文档更新清单规范，更新 PRD / SPEC / CHANGELOG / README 等必需文档
3. **代码提交**
   - `git add ...`
   - `git commit -m "feat/fix: xxx"`
   - `git push origin main`
4. **线上自动部署**
   - 等待 GitHub Actions `Deploy to Server` workflow 执行完成（在 GitHub Actions 页可以查看日志）
5. **线上验证**
   - 用四个域名打开页面，按测试清单快速回归关键功能
6. **回滚方案**
   - 如线上出现严重问题，可在服务器手工执行：
     - `cd /srv/EmbodiedPulse2026`
     - `git checkout 上一个稳定 tag 或 commit`
     - `/srv/EmbodiedPulse2026/deploy.sh`

---

## 七、后续可优化方向

- 将 SQLite 迁移到托管的 Postgres/MySQL，提高并发与数据可靠性
- 为 Gunicorn 增加更细致的日志与 metrics，接入监控告警（如 Prometheus + Grafana）
- 在 Nginx 层增加基础限流、防护规则
- 引入蓝绿/灰度发布（双实例 + Nginx upstream）

本教程后续如有变更，应按「文档命名规范」与「文档更新检查清单」更新版本号与日期，并记录于发版 CHANGELOG 中。***

