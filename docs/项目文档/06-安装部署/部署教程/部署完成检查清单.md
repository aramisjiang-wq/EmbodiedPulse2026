# 部署完成检查清单

## 一、服务器端配置

### ✅ 1. Systemd 服务配置

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
chmod +x scripts/create_systemd_service.sh
sudo bash scripts/create_systemd_service.sh
sudo systemctl start embodiedpulse
sudo systemctl status embodiedpulse
```

**验证：**
- [ ] 服务状态为 `active (running)`
- [ ] 日志无错误信息
- [ ] 端口 5001 正在监听

### ✅ 2. Nginx 配置

**当前状态：** ✅ 已完成
- [x] 配置文件已创建：`/etc/nginx/sites-available/embodiedpulse.conf`
- [x] 所有域名路由已配置
- [x] 静态资源和 API 路由已配置

**验证：**
```bash
nginx -t
systemctl status nginx
```

### ✅ 3. HTTPS 证书配置

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
chmod +x scripts/setup_https.sh
sudo bash scripts/setup_https.sh
```

**验证：**
- [ ] 所有域名都有 SSL 证书
- [ ] HTTP 自动跳转到 HTTPS
- [ ] 证书自动续期已启用

**手动验证：**
```bash
certbot certificates
```

### ✅ 4. 部署验证

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
chmod +x scripts/verify_deployment.sh
bash scripts/verify_deployment.sh
```

**检查项：**
- [ ] 所有服务正常运行
- [ ] 所有端口正常监听
- [ ] 所有域名可访问
- [ ] 数据库文件存在

---

## 二、GitHub Actions 自动部署配置

### ✅ 1. 配置 GitHub Secrets

在 GitHub 仓库设置中添加以下 Secrets：

1. **SERVER_HOST**: `101.200.222.139`
2. **SERVER_USER**: `root`
3. **SERVER_SSH_KEY**: 服务器 SSH 私钥（完整内容）
4. **SERVER_SSH_PORT**: `22`（默认）

**配置步骤：**
1. 进入 GitHub 仓库：`https://github.com/aramisjiang-wq/EmbodiedPulse2026`
2. 点击 `Settings` → `Secrets and variables` → `Actions`
3. 点击 `New repository secret`
4. 依次添加上述 4 个 secrets

### ✅ 2. 生成 SSH 密钥对（如果还没有）

在服务器上执行：

```bash
# 如果已有密钥，跳过此步
ssh-keygen -t rsa -b 4096 -C "github-actions" -f ~/.ssh/github_actions

# 将公钥添加到 authorized_keys
cat ~/.ssh/github_actions.pub >> ~/.ssh/authorized_keys

# 查看私钥（复制到 GitHub Secrets）
cat ~/.ssh/github_actions
```

### ✅ 3. 测试自动部署

1. 在本地做一个小的修改（如添加注释）
2. 提交并推送到 `main` 分支：
   ```bash
   git add .
   git commit -m "test: 测试自动部署"
   git push origin main
   ```
3. 在 GitHub 仓库的 `Actions` 标签页查看部署日志
4. 验证服务器上的代码是否已更新

---

## 三、域名 DNS 配置

### ✅ 检查 DNS 解析

确保以下域名都正确解析到服务器 IP `101.200.222.139`：

- [ ] `login.gradmotion.com` → A 记录 → `101.200.222.139`
- [ ] `essay.gradmotion.com` → A 记录 → `101.200.222.139`
- [ ] `blibli.gradmotion.com` → A 记录 → `101.200.222.139`
- [ ] `admin123.gradmotion.com` → A 记录 → `101.200.222.139`

**验证命令：**
```bash
dig login.gradmotion.com
dig essay.gradmotion.com
dig blibli.gradmotion.com
dig admin123.gradmotion.com
```

---

## 四、功能测试清单

### ✅ 1. 登录功能
- [ ] `http://login.gradmotion.com` 可访问
- [ ] 飞书扫码登录正常
- [ ] 登录后跳转正常

### ✅ 2. 具身论文页面
- [ ] `http://essay.gradmotion.com` 可访问
- [ ] 未登录时自动跳转到登录页
- [ ] 登录后显示论文列表
- [ ] 刷新论文数据功能正常

### ✅ 3. 具身视频页面
- [ ] `http://blibli.gradmotion.com` 可访问
- [ ] 视频数据正常加载
- [ ] 图表正常显示
- [ ] 刷新数据功能正常

### ✅ 4. 管理端
- [ ] `http://admin123.gradmotion.com` 可访问
- [ ] 管理员登录正常
- [ ] 用户管理功能正常
- [ ] 论文管理功能正常
- [ ] 视频管理功能正常

---

## 五、定时任务验证

### ✅ 检查定时任务状态

```bash
# 查看应用日志
journalctl -u embodiedpulse -f

# 检查 .env 配置
cat /srv/EmbodiedPulse2026/.env | grep AUTO_FETCH
```

**验证项：**
- [ ] `AUTO_FETCH_ENABLED=true`
- [ ] 定时任务调度器已启动
- [ ] 日志中有定时任务执行记录

---

## 六、性能监控

### ✅ 1. 服务状态监控

```bash
# 查看服务状态
systemctl status embodiedpulse
systemctl status nginx

# 查看资源使用
top -p $(pgrep -f gunicorn)
```

### ✅ 2. 日志监控

```bash
# 应用日志
journalctl -u embodiedpulse -f

# Nginx 访问日志
tail -f /var/log/nginx/access.log

# Nginx 错误日志
tail -f /var/log/nginx/error.log
```

---

## 七、备份策略

### ✅ 数据库备份

建议设置定时备份：

```bash
# 创建备份脚本
cat > /srv/EmbodiedPulse2026/scripts/backup_db.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/srv/backups/embodiedpulse"
mkdir -p "$BACKUP_DIR"
DATE=$(date +%Y%m%d_%H%M%S)
cp /srv/EmbodiedPulse2026/instance/papers.db "$BACKUP_DIR/papers_$DATE.db"
cp /srv/EmbodiedPulse2026/bilibili.db "$BACKUP_DIR/bilibili_$DATE.db"
# 保留最近7天的备份
find "$BACKUP_DIR" -name "*.db" -mtime +7 -delete
EOF

chmod +x /srv/EmbodiedPulse2026/scripts/backup_db.sh

# 添加到 crontab（每天凌晨2点备份）
(crontab -l 2>/dev/null; echo "0 2 * * * /srv/EmbodiedPulse2026/scripts/backup_db.sh") | crontab -
```

---

## 八、常见问题排查

### 问题1：服务无法启动

```bash
# 查看详细错误
journalctl -u embodiedpulse -n 50

# 检查虚拟环境
ls -la /srv/EmbodiedPulse2026/venv/bin/

# 手动测试启动
cd /srv/EmbodiedPulse2026
source venv/bin/activate
gunicorn -c gunicorn_config.py app:app
```

### 问题2：Nginx 502 Bad Gateway

```bash
# 检查 Flask 应用是否运行
curl http://127.0.0.1:5001/

# 检查 Nginx 错误日志
tail -f /var/log/nginx/error.log
```

### 问题3：域名无法访问

```bash
# 检查 DNS 解析
dig your-domain.com

# 检查 Nginx 配置
nginx -t

# 检查防火墙
ufw status
```

---

## 完成标志

当所有检查项都完成后，部署工作即告完成！

**最后验证：**
```bash
cd /srv/EmbodiedPulse2026
bash scripts/verify_deployment.sh
```

所有项目显示 ✓ 即为部署成功！

