# 数据库迁移指南

## 一、数据库文件说明

本项目使用 SQLite 数据库，数据库文件存储在项目目录中：

- **论文数据库**：`instance/papers.db`
- **B站视频数据库**：`bilibili.db`
- **新闻数据库**：`news.db`（如果启用）
- **招聘数据库**：`jobs.db`（如果启用）

---

## 二、数据库迁移方案

### 方案1：从本地复制到服务器（推荐，适合已有数据）

如果你在本地开发时已经有数据，需要迁移到服务器：

#### 步骤1：在本地备份数据库

```bash
# 在本地项目目录执行
cd "/Users/dong/Documents/Cursor/Embodied Pulse"

# 创建备份目录
mkdir -p backups

# 备份数据库文件
cp instance/papers.db backups/papers_$(date +%Y%m%d).db
cp bilibili.db backups/bilibili_$(date +%Y%m%d).db

# 如果有其他数据库，也一起备份
# cp news.db backups/news_$(date +%Y%m%d).db
# cp jobs.db backups/jobs_$(date +%Y%m%d).db
```

#### 步骤2：上传到服务器

**方法A：使用 scp 命令（推荐）**

```bash
# 在本地终端执行（不是服务器）
scp instance/papers.db root@101.200.222.139:/srv/EmbodiedPulse2026/instance/
scp bilibili.db root@101.200.222.139:/srv/EmbodiedPulse2026/

# 如果有其他数据库
# scp news.db root@101.200.222.139:/srv/EmbodiedPulse2026/
# scp jobs.db root@101.200.222.139:/srv/EmbodiedPulse2026/
```

**方法B：使用 SFTP 工具（如 FileZilla、WinSCP）**

1. 连接到服务器：`sftp://root@101.200.222.139`
2. 上传文件到对应目录

#### 步骤3：在服务器上设置权限

```bash
# SSH 登录服务器
ssh root@101.200.222.139

# 进入项目目录
cd /srv/EmbodiedPulse2026

# 确保目录存在
mkdir -p instance

# 设置正确的权限（确保应用可以读写）
chmod 644 instance/papers.db
chmod 644 bilibili.db
chown root:root instance/papers.db
chown root:root bilibili.db
```

#### 步骤4：重启服务

```bash
systemctl restart embodiedpulse
systemctl status embodiedpulse
```

---

### 方案2：让服务器自动创建（适合新部署，无历史数据）

如果这是全新部署，没有历史数据，可以让应用自动创建数据库：

#### 步骤1：确保数据库目录存在

```bash
ssh root@101.200.222.139
cd /srv/EmbodiedPulse2026
mkdir -p instance
```

#### 步骤2：启动应用（会自动创建数据库）

```bash
# 如果数据库不存在，应用启动时会自动创建
systemctl start embodiedpulse

# 查看日志，确认数据库已创建
journalctl -u embodiedpulse -f
```

#### 步骤3：初始化数据（如果需要）

数据库创建后，可以通过以下方式初始化数据：

**方式A：手动触发数据抓取**
- 访问 `http://essay.gradmotion.com`，点击"刷新论文数据"
- 访问 `http://blibli.gradmotion.com`，点击"刷新数据"

**方式B：手动执行脚本**
```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 fetch_new_data.py --papers
python3 fetch_bilibili_data.py
```

---

## 三、数据库验证

### 3.1 检查数据库文件是否存在

```bash
ssh root@101.200.222.139
cd /srv/EmbodiedPulse2026

# 检查文件
ls -lh instance/papers.db
ls -lh bilibili.db

# 查看文件大小（应该大于 0）
du -h instance/papers.db
du -h bilibili.db
```

### 3.2 检查数据库内容

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

# 使用 Python 检查数据库
python3 << EOF
import sqlite3

# 检查论文数据库
conn = sqlite3.connect('instance/papers.db')
cursor = conn.cursor()
cursor.execute("SELECT COUNT(*) FROM papers")
count = cursor.fetchone()[0]
print(f"论文数量: {count}")
conn.close()

# 检查 B站数据库
conn = sqlite3.connect('bilibili.db')
cursor = conn.cursor()
cursor.execute("SELECT COUNT(*) FROM bilibili_up")
up_count = cursor.fetchone()[0]
cursor.execute("SELECT COUNT(*) FROM bilibili_video")
video_count = cursor.fetchone()[0]
print(f"UP主数量: {up_count}")
print(f"视频数量: {video_count}")
conn.close()
EOF
```

### 3.3 通过网页验证

1. **访问论文页面**：`http://essay.gradmotion.com`
   - 应该能看到论文列表
   - 检查论文数量是否正确

2. **访问视频页面**：`http://blibli.gradmotion.com`
   - 应该能看到视频数据
   - 检查公司列表是否显示

---

## 四、数据库备份策略

### 4.1 创建自动备份脚本

```bash
# 在服务器上创建备份脚本
cat > /srv/EmbodiedPulse2026/scripts/backup_db.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/srv/backups/embodiedpulse"
mkdir -p "$BACKUP_DIR"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份数据库
cp /srv/EmbodiedPulse2026/instance/papers.db "$BACKUP_DIR/papers_$DATE.db"
cp /srv/EmbodiedPulse2026/bilibili.db "$BACKUP_DIR/bilibili_$DATE.db"

# 压缩备份（可选）
gzip "$BACKUP_DIR/papers_$DATE.db"
gzip "$BACKUP_DIR/bilibili_$DATE.db"

# 保留最近7天的备份
find "$BACKUP_DIR" -name "*.db.gz" -mtime +7 -delete

echo "备份完成: $DATE"
EOF

chmod +x /srv/EmbodiedPulse2026/scripts/backup_db.sh
```

### 4.2 设置定时备份（每天凌晨2点）

```bash
# 添加到 crontab
(crontab -l 2>/dev/null; echo "0 2 * * * /srv/EmbodiedPulse2026/scripts/backup_db.sh") | crontab -

# 验证
crontab -l
```

---

## 五、数据库恢复

如果需要恢复数据库：

```bash
# 1. 停止服务
systemctl stop embodiedpulse

# 2. 恢复数据库文件
cd /srv/EmbodiedPulse2026
cp /srv/backups/embodiedpulse/papers_20251217.db.gz instance/papers.db.gz
gunzip instance/papers.db.gz

# 3. 设置权限
chmod 644 instance/papers.db

# 4. 重启服务
systemctl start embodiedpulse
```

---

## 六、常见问题

### Q1: 数据库文件权限错误

**错误信息：** `Permission denied` 或 `database is locked`

**解决方法：**
```bash
chmod 644 instance/papers.db
chmod 644 bilibili.db
chown root:root instance/papers.db
chown root:root bilibili.db
```

### Q2: 数据库文件损坏

**解决方法：**
```bash
# 尝试修复
sqlite3 instance/papers.db ".recover" | sqlite3 instance/papers_fixed.db
mv instance/papers_fixed.db instance/papers.db
```

### Q3: 数据库文件太大

**解决方法：**
- 定期清理旧数据
- 使用 SQLite 的 `VACUUM` 命令压缩数据库

```bash
sqlite3 instance/papers.db "VACUUM;"
```

---

## 七、推荐方案

**对于你的情况（从本地迁移到服务器）：**

1. ✅ **使用方案1：从本地复制**
   - 保留所有历史数据
   - 最简单直接

2. ✅ **设置自动备份**
   - 防止数据丢失
   - 每天自动备份

3. ✅ **验证数据完整性**
   - 检查记录数量
   - 通过网页验证功能

---

## 完成标志

- [ ] 数据库文件已上传到服务器
- [ ] 文件权限设置正确
- [ ] 服务重启后数据正常显示
- [ ] 自动备份已配置

