# é£ä¹¦ç™»å½•ç³»ç»Ÿå¿«é€Ÿé›†æˆæŒ‡å—

## ğŸ“‹ å‰ææ¡ä»¶

å·²å®Œæˆå¼€å‘çš„æ¨¡å—ï¼š
- âœ… æ•°æ®åº“æ¨¡å‹
- âœ… é£ä¹¦OAuth2.0å®¢æˆ·ç«¯
- âœ… JWTè®¤è¯ç³»ç»Ÿ
- âœ… æƒé™è£…é¥°å™¨
- âœ… è®¤è¯APIï¼ˆ11ä¸ªç«¯ç‚¹ï¼‰
- âœ… ç”¨æˆ·ä¸ªäººä¸­å¿ƒAPIï¼ˆ5ä¸ªç«¯ç‚¹ï¼‰
- âœ… ç®¡ç†å‘˜ç™»å½•API

---

## ğŸš€ å¿«é€Ÿé›†æˆæ­¥éª¤ï¼ˆ5åˆ†é’Ÿï¼‰

### æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–

```bash
cd "/Users/dong/Documents/Cursor/Embodied Pulse"
pip install PyJWT==2.8.0 werkzeug==3.0.1
```

### æ­¥éª¤2ï¼šé…ç½®ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•çš„`.env`æ–‡ä»¶ä¸­æ·»åŠ ï¼ˆå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºï¼‰ï¼š

```bash
# é£ä¹¦OAuth2.0é…ç½®
FEISHU_APP_ID=cli_a6727c4ffc71d00b
FEISHU_APP_SECRET=dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI
FEISHU_REDIRECT_URI=http://localhost:5001/api/auth/feishu/callback

# JWTé…ç½®
JWT_SECRET_KEY=$(openssl rand -hex 32)
JWT_EXPIRES_HOURS=24

# è¶…çº§ç®¡ç†å‘˜é…ç½®
SUPER_ADMIN_USERNAME=limx
SUPER_ADMIN_PASSWORD=limx123456
```

### æ­¥éª¤3ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
python init_auth_db.py init
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
============================================================
å¼€å§‹åˆå§‹åŒ–è®¤è¯ç³»ç»Ÿæ•°æ®åº“...
============================================================

1. åˆ›å»ºæ•°æ®åº“è¡¨...
âœ… æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
   - auth_users (è®¤è¯ç”¨æˆ·è¡¨)
   - admin_users (ç®¡ç†å‘˜è¡¨)
   - access_logs (è®¿é—®æ—¥å¿—è¡¨)
   - login_history (ç™»å½•å†å²è¡¨)

2. æ£€æŸ¥è¶…çº§ç®¡ç†å‘˜...
âœ… è¶…çº§ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸ
   - ç”¨æˆ·å: limx
   - å§“å: è¶…çº§ç®¡ç†å‘˜
```

### æ­¥éª¤4ï¼šé›†æˆåˆ°app.py

åœ¨`app.py`ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

#### 4.1 åœ¨æ–‡ä»¶é¡¶éƒ¨å¯¼å…¥
```python
# åœ¨ç°æœ‰importä¹‹åæ·»åŠ 
from auth_routes import auth_bp, user_bp, admin_bp
```

#### 4.2 æ³¨å†Œè“å›¾
```python
# åœ¨appå®šä¹‰ä¹‹åï¼Œè·¯ç”±å®šä¹‰ä¹‹å‰æ·»åŠ 
app.register_blueprint(auth_bp)
app.register_blueprint(user_bp)
app.register_blueprint(admin_bp)
```

#### 4.3 æ·»åŠ å‰ç«¯è·¯ç”±ï¼ˆä¸´æ—¶ï¼Œç­‰å¾…å‰ç«¯é¡µé¢å¼€å‘ï¼‰
```python
@app.route('/login')
def login_page():
    return """
    <html>
    <head><title>é£ä¹¦ç™»å½•</title></head>
    <body>
        <h1>é£ä¹¦æ‰«ç ç™»å½•</h1>
        <button onclick="login()">é£ä¹¦ç™»å½•</button>
        <script>
        async function login() {
            const response = await fetch('/api/auth/feishu/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await response.json();
            if (data.success) {
                window.location.href = data.login_url;
            }
        }
        </script>
    </body>
    </html>
    """

@app.route('/profile')
def profile_page():
    return """
    <html>
    <head><title>ä¸ªäººä¸­å¿ƒ</title></head>
    <body>
        <h1>ä¸ªäººä¸­å¿ƒ</h1>
        <div id="profile"></div>
        <script>
        const token = new URLSearchParams(window.location.search).get('token');
        if (token) {
            localStorage.setItem('auth_token', token);
            window.history.replaceState({}, '', '/profile');
        }
        const authToken = localStorage.getItem('auth_token');
        if (!authToken) {
            window.location.href = '/login';
        } else {
            fetch('/api/user/profile', {
                headers: {'Authorization': `Bearer ${authToken}`}
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('profile').innerHTML = 
                    '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            });
        }
        </script>
    </body>
    </html>
    """
```

### æ­¥éª¤5ï¼šå¯åŠ¨åº”ç”¨

```bash
python app.py
```

---

## âœ… æµ‹è¯•æ¸…å•

### æµ‹è¯•1ï¼šç®¡ç†å‘˜ç™»å½•

ä½¿ç”¨curlæˆ–Postmanï¼š

```bash
curl -X POST http://localhost:5001/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"limx","password":"limx123456"}'
```

é¢„æœŸå“åº”ï¼š
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "admin": {
    "id": 1,
    "username": "limx",
    "name": "è¶…çº§ç®¡ç†å‘˜",
    "role": "super_admin"
  }
}
```

### æµ‹è¯•2ï¼šé£ä¹¦ç™»å½•

1. è®¿é—®ï¼šhttp://localhost:5001/login
2. ç‚¹å‡»"é£ä¹¦ç™»å½•"æŒ‰é’®
3. ä½¿ç”¨é£ä¹¦æ‰«ç 
4. è‡ªåŠ¨è·³è½¬å›ä¸ªäººä¸­å¿ƒ

### æµ‹è¯•3ï¼šä¸ªäººä¸­å¿ƒAPI

ä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„tokenï¼š

```bash
# è·å–ä¸ªäººä¿¡æ¯
curl -X GET http://localhost:5001/api/user/profile \
  -H "Authorization: Bearer YOUR_TOKEN"

# è·å–ç™»å½•å†å²
curl -X GET http://localhost:5001/api/user/login-history \
  -H "Authorization: Bearer YOUR_TOKEN"

# è·å–ç»Ÿè®¡æ•°æ®
curl -X GET http://localhost:5001/api/user/stats \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### æµ‹è¯•4ï¼šæ›´æ–°ä¸ªäººä¿¡æ¯

```bash
curl -X PUT http://localhost:5001/api/user/profile \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"email":"new@example.com","mobile":"13900139000"}'
```

---

## ğŸ“Š å¯ç”¨çš„APIç«¯ç‚¹

### è®¤è¯APIï¼ˆ/api/auth/*ï¼‰
- âœ… `POST /api/auth/feishu/login` - ç”Ÿæˆé£ä¹¦ç™»å½•URL
- âœ… `GET /api/auth/feishu/callback` - é£ä¹¦å›è°ƒå¤„ç†
- âœ… `GET /api/auth/user-info` - è·å–å½“å‰ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- âœ… `POST /api/auth/logout` - é€€å‡ºç™»å½•
- âœ… `POST /api/auth/log-access` - è®°å½•é¡µé¢è®¿é—®

### ç”¨æˆ·APIï¼ˆ/api/user/*ï¼‰
- âœ… `GET /api/user/profile` - è·å–ä¸ªäººè¯¦ç»†ä¿¡æ¯
- âœ… `PUT /api/user/profile` - æ›´æ–°ä¸ªäººä¿¡æ¯
- âœ… `GET /api/user/login-history` - è·å–ä¸ªäººç™»å½•å†å²
- âœ… `GET /api/user/access-logs` - è·å–ä¸ªäººè®¿é—®æ—¥å¿—
- âœ… `GET /api/user/stats` - è·å–ä¸ªäººç»Ÿè®¡æ•°æ®

### ç®¡ç†å‘˜APIï¼ˆ/api/admin/*ï¼‰
- âœ… `POST /api/admin/login` - ç®¡ç†å‘˜ç™»å½•
- â³ å…¶ä»–ç®¡ç†ç«¯APIå¾…å¼€å‘

---

## ğŸ” æ•°æ®åº“æŸ¥çœ‹

### æŸ¥çœ‹ç”¨æˆ·
```sql
SELECT * FROM auth_users;
```

### æŸ¥çœ‹ç®¡ç†å‘˜
```sql
SELECT * FROM admin_users;
```

### æŸ¥çœ‹ç™»å½•å†å²
```sql
SELECT * FROM login_history ORDER BY login_time DESC LIMIT 10;
```

### æŸ¥çœ‹è®¿é—®æ—¥å¿—
```sql
SELECT * FROM access_logs ORDER BY access_time DESC LIMIT 10;
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šé£ä¹¦ç™»å½•å¤±è´¥
**åŸå› **ï¼šApp IDæˆ–App Secreté…ç½®é”™è¯¯  
**è§£å†³**ï¼šæ£€æŸ¥`.env`ä¸­çš„é…ç½®æ˜¯å¦æ­£ç¡®

### é—®é¢˜2ï¼šTokenéªŒè¯å¤±è´¥
**åŸå› **ï¼šJWT_SECRET_KEYæœªé…ç½®  
**è§£å†³**ï¼šåœ¨`.env`ä¸­æ·»åŠ JWT_SECRET_KEY

### é—®é¢˜3ï¼šæ•°æ®åº“åˆå§‹åŒ–å¤±è´¥
**åŸå› **ï¼šdatabase.pyä¸­çš„dbå¯¹è±¡æœªæ­£ç¡®é…ç½®  
**è§£å†³**ï¼šç¡®ä¿database.pyä¸­çš„init_db()å·²è¢«è°ƒç”¨

### é—®é¢˜4ï¼šå›è°ƒåœ°å€ä¸åŒ¹é…
**åŸå› **ï¼šé£ä¹¦å¹³å°é…ç½®çš„å›è°ƒåœ°å€ä¸ä»£ç ä¸­ä¸ä¸€è‡´  
**è§£å†³**ï¼šç¡®ä¿FEISHU_REDIRECT_URIä¸é£ä¹¦å¹³å°é…ç½®ä¸€è‡´

---

## ğŸ“ ä¸‹ä¸€æ­¥å¼€å‘

### ä¼˜å…ˆçº§P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
1. â³ ç”¨æˆ·ç™»å½•é¡µé¢ï¼ˆlogin.html + login.jsï¼‰
2. â³ ä¸ªäººä¸­å¿ƒé¡µé¢ï¼ˆprofile.html + profile.jsï¼‰
3. â³ ç®¡ç†å‘˜ç™»å½•é¡µé¢ï¼ˆadmin_login.htmlï¼‰

### ä¼˜å…ˆçº§P1ï¼ˆç®¡ç†åŠŸèƒ½ï¼‰
1. â³ ç®¡ç†ç«¯ç”¨æˆ·ç®¡ç†API
2. â³ ç®¡ç†ç«¯æ—¥å¿—æŸ¥çœ‹API
3. â³ ç®¡ç†ç«¯ä»ªè¡¨ç›˜é¡µé¢

### ä¼˜å…ˆçº§P2ï¼ˆä¼˜åŒ–åŠŸèƒ½ï¼‰
1. â³ è®¿é—®æ—¥å¿—ä¸­é—´ä»¶è‡ªåŠ¨åŒ–
2. â³ Tokené»‘åå•æœºåˆ¶
3. â³ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### æ–¹æ¡ˆAï¼šç›´æ¥ä½¿ç”¨APIï¼ˆæ¨èç”¨äºå¼€å‘æµ‹è¯•ï¼‰
- ä½¿ç”¨Postmanæˆ–curlç›´æ¥æµ‹è¯•API
- å¿«é€ŸéªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- é€‚åˆåç«¯å¼€å‘å’Œè°ƒè¯•

### æ–¹æ¡ˆBï¼šç­‰å¾…å‰ç«¯é¡µé¢å¼€å‘å®Œæˆ
- å®Œæ•´çš„ç”¨æˆ·ä½“éªŒ
- æ›´ç¾è§‚çš„ç•Œé¢
- é€‚åˆæœ€ç»ˆç”¨æˆ·ä½¿ç”¨

### æ–¹æ¡ˆCï¼šè‡ªå·±å¼€å‘å‰ç«¯é¡µé¢
- åŸºäºv2.0æ–¹æ¡ˆä¸­çš„å‰ç«¯è®¾è®¡
- ä½¿ç”¨å·²æä¾›çš„API
- å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚å®šåˆ¶

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æŠ€æœ¯æ–¹æ¡ˆ**ï¼š`docs/é¡¹ç›®æ–‡æ¡£/01-éœ€æ±‚æ–‡æ¡£/é£ä¹¦ç™»å½•ç³»ç»Ÿå®ç°æ–¹æ¡ˆ_v2.0_20251216.md`
- **ä»»åŠ¡æ¸…å•**ï¼š`docs/é¡¹ç›®æ–‡æ¡£/01-éœ€æ±‚æ–‡æ¡£/é£ä¹¦ç™»å½•ç³»ç»Ÿä»»åŠ¡æ¸…å•_v2.0_20251216.md`
- **å¼€å‘è¿›åº¦**ï¼š`docs/é¡¹ç›®æ–‡æ¡£/05-å¼€å‘è®°å½•/é£ä¹¦ç™»å½•ç³»ç»Ÿå¼€å‘è¿›åº¦_20251216.md`
- **é…ç½®æŒ‡å—**ï¼š`docs/é¡¹ç›®æ–‡æ¡£/06-å®‰è£…é…ç½®/é£ä¹¦ç™»å½•ç³»ç»Ÿé…ç½®æŒ‡å—.md`

---

**é›†æˆå®Œæˆåï¼Œä½ å°±å¯ä»¥å¼€å§‹æµ‹è¯•é£ä¹¦ç™»å½•ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½äº†ï¼** ğŸ‰

å¦‚éœ€å®Œæ•´çš„å‰ç«¯é¡µé¢ï¼Œè¯·ç»§ç»­å¼€å‘æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

