# 飞书登录系统配置指南

## 生成时间
2025-12-16 19:30

## 环境配置

### 1. 安装依赖包

在项目根目录执行：

```bash
pip install PyJWT==2.8.0
pip install werkzeug==3.0.1
```

### 2. 配置环境变量

在项目根目录的`.env`文件中添加以下配置：

```bash
# 飞书OAuth2.0配置
FEISHU_APP_ID=cli_a6727c4ffc71d00b
FEISHU_APP_SECRET=dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI
FEISHU_REDIRECT_URI=http://localhost:5001/api/auth/feishu/callback

# JWT配置
JWT_SECRET_KEY=your-jwt-secret-key-change-this-in-production
JWT_EXPIRES_HOURS=24

# 超级管理员配置
SUPER_ADMIN_USERNAME=limx
SUPER_ADMIN_PASSWORD=limx123456
```

**重要提示**：
- `JWT_SECRET_KEY` 在生产环境必须修改为强密码
- `FEISHU_REDIRECT_URI` 需要与飞书开放平台配置一致
- 生产环境建议使用HTTPS

### 3. 初始化数据库

执行初始化脚本：

```bash
cd "/Users/dong/Documents/Cursor/Embodied Pulse"
python init_auth_db.py init
```

这将：
- 创建认证系统所需的4张数据库表
- 创建超级管理员账号（limx/limx123456）

### 4. 验证配置

启动Flask应用后，访问：
- 管理员登录页面：http://localhost:5001/admin/login
- 用户登录页面：http://localhost:5001/login

## 数据库表说明

### auth_users（认证用户表）
飞书登录的用户信息

### admin_users（管理员表）
用户名密码登录的管理员

### access_logs（访问日志表）
记录用户访问行为

### login_history（登录历史表）
记录用户登录历史

## 超级管理员信息

默认超级管理员：
- 用户名：`limx`
- 密码：`limx123456`
- 登录地址：http://localhost:5001/admin/login

**生产环境务必修改默认密码！**

## 飞书开放平台配置

### 1. 应用信息
- App ID：`cli_a6727c4ffc71d00b`
- App Secret：`dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI`

### 2. 回调地址配置
在飞书开放平台后台配置回调地址：
- 开发环境：`http://localhost:5001/api/auth/feishu/callback`
- 生产环境：`https://your-domain.com/api/auth/feishu/callback`

### 3. 权限申请
需要申请以下权限：
- 获取用户身份信息
- 获取用户基本信息
- 获取用户邮箱
- 获取用户手机号

## 安全配置建议

### 1. JWT密钥
生产环境必须使用强密码：
```bash
JWT_SECRET_KEY=$(openssl rand -hex 32)
```

### 2. HTTPS
生产环境必须启用HTTPS：
- 配置SSL证书
- 强制HTTPS重定向
- 设置Secure Cookie

### 3. 跨域配置
如果前后端分离，需配置CORS：
```python
from flask_cors import CORS
CORS(app, origins=['https://your-frontend.com'])
```

### 4. 速率限制
建议为API添加速率限制，防止暴力破解：
```python
from flask_limiter import Limiter
limiter = Limiter(app, key_func=lambda: request.remote_addr)
```

## 故障排查

### 问题1：飞书登录失败
- 检查App ID和App Secret是否正确
- 检查回调地址是否与飞书平台配置一致
- 检查网络连接是否正常

### 问题2：Token验证失败
- 检查JWT_SECRET_KEY是否配置
- 检查token是否过期
- 检查token格式是否正确（Bearer + token）

### 问题3：数据库初始化失败
- 检查数据库连接是否正常
- 检查数据库权限是否足够
- 查看错误日志定位具体问题

## 日志查看

查看认证系统日志：
```bash
tail -f app.log | grep -E "auth|login|jwt"
```

## 下一步

完成配置后，可以开始：
1. 测试飞书登录流程
2. 测试管理员登录
3. 测试用户个人中心
4. 配置生产环境部署

## 联系支持

如有问题，请查看：
- 飞书开放平台文档：https://open.feishu.cn/document
- 项目文档：`docs/项目文档/`
- 技术方案：`docs/项目文档/01-需求文档/飞书登录系统实现方案_v2.0_20251216.md`

