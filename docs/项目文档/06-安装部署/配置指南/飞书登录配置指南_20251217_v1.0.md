# 飞书登录配置指南

**版本**: v1.0  
**日期**: 2025-12-17

---

## 📋 配置要求

飞书登录需要以下配置项：

1. **FEISHU_APP_ID**: 飞书应用的App ID
2. **FEISHU_APP_SECRET**: 飞书应用的App Secret
3. **FEISHU_REDIRECT_URI**: OAuth回调地址

---

## 🔧 配置步骤

### 步骤1：在飞书开放平台获取配置信息

1. 登录 [飞书开放平台](https://open.feishu.cn/)
2. 进入你的应用
3. 在"应用信息"中获取：
   - **App ID** (应用ID)
   - **App Secret** (应用密钥)

### 步骤2：配置回调地址

在飞书开放平台的"安全设置"中，配置以下回调地址：

**生产环境**：
```
https://login.gradmotion.com/api/auth/feishu/callback
```

**或**：
```
https://essay.gradmotion.com/api/auth/feishu/callback
```

**注意**：
- 回调地址必须与服务器上配置的`FEISHU_REDIRECT_URI`完全一致
- 必须使用HTTPS（生产环境）
- 必须包含完整的路径：`/api/auth/feishu/callback`

### 步骤3：在服务器上配置环境变量

编辑服务器上的`.env`文件：

```bash
cd /srv/EmbodiedPulse2026
nano .env
```

添加或修改以下配置：

```bash
# ==================== 飞书OAuth配置 ====================
FEISHU_APP_ID=你的App_ID
FEISHU_APP_SECRET=你的App_Secret
FEISHU_REDIRECT_URI=https://login.gradmotion.com/api/auth/feishu/callback
```

**重要**：
- `FEISHU_REDIRECT_URI`必须与飞书开放平台配置的回调地址完全一致
- 如果使用`essay.gradmotion.com`，则改为：
  ```
  FEISHU_REDIRECT_URI=https://essay.gradmotion.com/api/auth/feishu/callback
  ```

### 步骤4：验证配置

运行配置检查脚本：

```bash
bash scripts/check_and_fix_feishu_config.sh
```

脚本会：
- 检查所有必需的配置项
- 验证配置是否可以正确加载
- 提供缺失配置的提示

### 步骤5：重启服务

配置完成后，重启服务以加载新配置：

```bash
systemctl restart embodiedpulse
```

验证服务状态：

```bash
systemctl status embodiedpulse
```

---

## 🔍 故障排查

### 问题1：生成登录URL失败: 飞书App ID和App Secret未配置

**原因**：
- `.env`文件中缺少`FEISHU_APP_ID`或`FEISHU_APP_SECRET`
- 服务未加载`.env`文件

**解决方法**：
1. 检查`.env`文件是否存在且包含配置
2. 检查systemd服务是否加载`.env`文件：
   ```bash
   cat /etc/systemd/system/embodiedpulse.service | grep EnvironmentFile
   ```
   应该看到：`EnvironmentFile=/srv/EmbodiedPulse2026/.env`
3. 如果缺少，运行：
   ```bash
   bash scripts/fix_port_and_service.sh
   ```
4. 重启服务：
   ```bash
   systemctl restart embodiedpulse
   ```

### 问题2：回调地址不匹配

**错误信息**：
- 飞书回调时返回错误
- 无法完成登录流程

**解决方法**：
1. 确保飞书开放平台配置的回调地址与`.env`中的`FEISHU_REDIRECT_URI`完全一致
2. 检查域名是否正确（`login.gradmotion.com`或`essay.gradmotion.com`）
3. 确保使用HTTPS（生产环境）

### 问题3：IP白名单限制

**错误信息**：
- 请求被拒绝
- 无法访问飞书API

**解决方法**：
1. 在飞书开放平台的"安全设置"中，添加服务器IP到IP白名单
2. 服务器IP：`101.200.222.139`

---

## 📝 快速检查命令

```bash
# 检查配置
bash scripts/check_and_fix_feishu_config.sh

# 检查服务配置
cat /etc/systemd/system/embodiedpulse.service | grep EnvironmentFile

# 检查环境变量是否加载
systemctl show embodiedpulse | grep Environment

# 查看服务日志
journalctl -u embodiedpulse -n 50 | grep -i feishu
```

---

## ✅ 验证配置成功

配置成功后，访问登录页面：
- `https://login.gradmotion.com/`
- 或 `https://essay.gradmotion.com/login`

点击"飞书登录"按钮，应该能够：
1. 跳转到飞书登录页面
2. 扫码登录后跳转回网站
3. 成功完成登录流程

---

**文档版本**: v1.0  
**最后更新**: 2025-12-17

