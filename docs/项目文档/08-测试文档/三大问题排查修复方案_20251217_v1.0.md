# 三大问题排查修复方案

**版本**: v1.0  
**日期**: 2025-12-17

---

## 📋 问题清单

1. **具身论文页面**：没有2025年12月17日的新论文
2. **具身视频页面**：7家公司数据缺失，可能是数据库迁移时丢失
3. **登录验证**：两个页面都没有强制飞书扫码登录

---

## 🔍 问题1：论文数据缺失排查

### 排查步骤

#### 1.1 检查数据库中的论文数据

```bash
cd /srv/EmbodiedPulse2026
bash scripts/run_diagnose.sh
# 或
venv/bin/python3 scripts/diagnose_data_issues.py
```

**检查要点**：
- 总论文数
- 12月17日的论文数
- 最新论文日期
- 今天创建的论文数

#### 1.2 检查定时任务配置和运行状态

```bash
# 检查环境变量
cat .env | grep AUTO_FETCH

# 检查服务状态
systemctl status embodiedpulse

# 检查定时任务日志
journalctl -u embodiedpulse -n 100 | grep -E "定时|scheduled|fetch|抓取"
```

**预期结果**：
- `AUTO_FETCH_ENABLED=true`
- `AUTO_FETCH_SCHEDULE=0 * * * *` (每小时执行)
- 服务运行中
- 日志中有定时任务执行记录

#### 1.3 检查抓取逻辑

**关键配置**：
- `fetch_new_data.py` 中 `days_back = 21` (应该能覆盖12月17日)
- `config.yaml` 中的关键词配置
- ArXiv API 查询日期范围

#### 1.4 手动抓取测试

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 scripts/fix_paper_fetch_dec17.py
```

### 修复方案

**如果定时任务未运行**：
1. 检查并修复环境变量
2. 重启服务
3. 验证定时任务启动

**如果数据库没有12月17日的论文**：
1. 手动抓取12月17日的论文
2. 检查ArXiv API是否返回数据
3. 检查去重逻辑是否误过滤

**如果前端未显示**：
1. 清除浏览器缓存
2. 检查API返回数据
3. 检查前端过滤逻辑

---

## 🔍 问题2：视频数据缺失排查

### 排查步骤

#### 2.1 检查数据库完整性

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 scripts/check_bilibili_data_integrity.py
```

**检查要点**：
- 总UP主数（应该是7个）
- 各UP主的视频数量
- 最近30天的视频数
- 数据更新时间

#### 2.2 检查数据库迁移历史

```bash
# 检查PostgreSQL数据库
psql -U postgres -d embodied_pulse -c "SELECT COUNT(*) FROM bilibili_ups;"
psql -U postgres -d embodied_pulse -c "SELECT name, uid FROM bilibili_ups WHERE is_active = true;"
```

#### 2.3 对比API数据

脚本会自动对比API返回的数据和数据库中的数据，找出丢失的视频。

### 修复方案

**如果数据确实丢失**：
1. 从本地备份恢复（如果有）
2. 重新抓取所有UP主数据
3. 验证数据完整性

**如果只是部分数据缺失**：
1. 手动触发抓取
2. 检查抓取日志
3. 验证数据更新

---

## 🔍 问题3：登录验证失效排查

### 排查步骤

#### 3.1 检查脚本加载

**确认 `user_menu.js` 已加载**：
- ✅ `templates/index.html` 第328行
- ✅ `templates/bilibili.html` 第2593行

#### 3.2 检查白名单配置

```bash
grep -A 2 "publicPages" static/js/user_menu.js
```

**预期结果**：
```javascript
const publicPages = ['/login', '/auth/callback', '/admin/login', '/test'];
// 不应该包含 '/bilibili' 或 '/'
```

#### 3.3 检查浏览器缓存

**可能原因**：
- 浏览器缓存了旧版本的 `user_menu.js`
- localStorage 中有旧的 token

**解决方法**：
1. 清除浏览器缓存（Ctrl+Shift+R）
2. 清除 localStorage：`localStorage.clear()`
3. 检查服务器上的 `user_menu.js` 是否为最新版本

#### 3.4 检查API端点

```bash
# 测试登录验证API
curl -H "Authorization: Bearer invalid_token" http://127.0.0.1:5001/api/user/profile
```

**预期结果**：返回 401 或 403

### 修复方案

**如果脚本未加载**：
1. 确认所有页面都引用了 `user_menu.js`
2. 检查脚本路径是否正确
3. 检查Nginx配置是否正确代理静态文件

**如果白名单配置错误**：
1. 检查并修复 `publicPages` 数组
2. 确保 `/` 和 `/bilibili` 不在白名单中
3. 重新部署并清除缓存

**如果浏览器缓存问题**：
1. 添加版本号到脚本引用（强制刷新）
2. 在服务器上设置正确的缓存头
3. 用户手动清除缓存

---

## 🔧 综合修复脚本

已创建 `scripts/comprehensive_diagnosis.sh`，可以一次性执行所有诊断：

```bash
cd /srv/EmbodiedPulse2026
git pull origin main
bash scripts/comprehensive_diagnosis.sh
```

---

## ✅ 验证修复

### 论文数据验证

1. 执行诊断脚本，确认12月17日的论文已存在
2. 访问前端页面，确认论文显示正常
3. 检查API返回：`https://essay.gradmotion.com/api/papers`

### 视频数据验证

1. 执行完整性检查脚本，确认7家公司数据完整
2. 访问前端页面，确认所有公司显示正常
3. 检查API返回：`https://essay.gradmotion.com/api/bilibili/all`

### 登录验证验证

1. 清除浏览器缓存
2. 访问 `https://essay.gradmotion.com/`，应该跳转到登录页
3. 访问 `https://essay.gradmotion.com/bilibili`，应该跳转到登录页
4. 登录后，应该能正常访问页面

---

**文档版本**: v1.0  
**最后更新**: 2025-12-17

