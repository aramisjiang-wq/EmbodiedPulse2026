# 具身视频数据修复任务清单

## 环境说明
- **本地环境**：开发测试环境
- **生产环境**：服务器生产环境
- **无独立测试环境**：需要在本地充分测试后再部署到生产

---

## 阶段1：本地环境准备与验证（必须完成）

### 任务1.1：备份生产数据库 ⚠️ 高风险
**优先级**：🔴 最高  
**预计时间**：10分钟  
**执行环境**：生产环境  
**操作步骤**：
1. SSH登录生产服务器
2. 执行数据库备份命令：
   ```bash
   cd /srv/EmbodiedPulse2026
   source venv/bin/activate
   python3 -c "
   from bilibili_models import get_bilibili_engine
   import os
   from datetime import datetime
   
   # 如果是PostgreSQL
   if os.getenv('BILIBILI_DATABASE_URL', '').startswith('postgresql'):
       os.system('pg_dump $BILIBILI_DATABASE_URL > backups/bilibili_backup_$(date +%Y%m%d_%H%M%S).sql')
   else:
       # SQLite备份
       import shutil
       backup_file = f'backups/bilibili_backup_{datetime.now().strftime(\"%Y%m%d_%H%M%S\")}.db'
       shutil.copy('bilibili.db', backup_file)
       print(f'备份完成: {backup_file}')
   "
   ```
3. 验证备份文件存在且大小合理
4. 下载备份文件到本地保存

**验收标准**：
- ✅ 备份文件已创建
- ✅ 备份文件大小 > 0
- ✅ 备份文件已下载到本地

---

### 任务1.2：检查当前数据库状态
**优先级**：🟡 高  
**预计时间**：5分钟  
**执行环境**：生产环境  
**操作步骤**：
1. 检查数据库中的UP主数量
2. 检查视频数量
3. 检查统计数据（播放量、视频数）
4. 检查`pubdate`字段类型

**验收标准**：
- ✅ 确认当前数据状态
- ✅ 记录问题数据数量
- ✅ 确认`pubdate`字段类型

---

### 任务1.3：在本地环境复现问题
**优先级**：🟡 高  
**预计时间**：15分钟  
**执行环境**：本地环境  
**操作步骤**：
1. 拉取最新代码
2. 配置本地数据库（PostgreSQL或SQLite）
3. 运行`scripts/fetch_bilibili_update.py`
4. 观察错误日志
5. 确认问题复现

**验收标准**：
- ✅ 问题已复现
- ✅ 错误日志已记录
- ✅ 理解问题根源

---

## 阶段2：代码修复（本地环境）

### 任务2.1：修复`scripts/fetch_bilibili_update.py`
**优先级**：🔴 最高  
**预计时间**：30分钟  
**执行环境**：本地环境  
**修复内容**：

1. **修复pubdate类型转换**（第179行）：
   ```python
   # 错误代码
   video.pubdate = video_data.get('pubdate', 0)
   
   # 修复为
   pubdate_raw = video_data.get('pubdate', 0)
   if pubdate_raw:
       video.pubdate_raw = pubdate_raw
       video.pubdate = datetime.fromtimestamp(pubdate_raw)
   ```

2. **修复字段映射错误**（第180-197行）：
   - 删除`video.pubdate_formatted`（不存在）
   - 删除`video.danmaku`相关字段（不存在）
   - 删除`video.like`, `video.coin`, `video.favorite`, `video.share`, `video.reply`（不存在）
   - 删除`video.last_updated`（应该是`updated_at`）
   - 使用正确的字段：`video_review`, `favorites`

3. **参考`fetch_bilibili_data.py`的正确实现**（第126-150行）

**验收标准**：
- ✅ 代码已修复
- ✅ 字段映射正确
- ✅ 类型转换正确
- ✅ 代码通过语法检查

---

### 任务2.2：添加错误处理和事务管理
**优先级**：🟡 高  
**预计时间**：20分钟  
**执行环境**：本地环境  
**修复内容**：

1. **添加单个视频的错误处理**：
   ```python
   for video_data in videos:
       try:
           # 处理视频数据
           ...
       except Exception as e:
           logger.error(f"处理视频失败 ({video_data.get('bvid', 'unknown')}): {e}")
           result['errors'].append(f"视频 {video_data.get('bvid', 'unknown')}: {str(e)}")
           session.rollback()  # 回滚当前视频的事务
           continue  # 继续处理下一个视频
   ```

2. **使用`session.no_autoflush`避免过早刷新**：
   ```python
   with session.no_autoflush:
       # 批量处理视频
       for video_data in videos:
           # 处理视频
   ```

3. **添加详细的错误日志**

**验收标准**：
- ✅ 错误处理已添加
- ✅ 事务管理正确
- ✅ 日志记录完善

---

### 任务2.3：修复UP主统计数据更新
**优先级**：🟡 高  
**预计时间**：15分钟  
**执行环境**：本地环境  
**修复内容**：

1. **在视频数据保存成功后，重新计算统计数据**：
   ```python
   # 视频保存成功后
   if videos:
       # 重新计算UP主的统计数据
       up.videos_count = len(videos)  # 或从数据库查询实际数量
       up.views_count = sum(v.play or 0 for v in videos)
       up.views_formatted = format_number(up.views_count)
       session.commit()
   ```

2. **确保统计数据正确更新**

**验收标准**：
- ✅ 统计数据更新逻辑正确
- ✅ 数据计算准确

---

### 任务2.4：本地环境测试修复后的脚本
**优先级**：🔴 最高  
**预计时间**：30分钟  
**执行环境**：本地环境  
**测试步骤**：

1. 清理本地测试数据库（可选）
2. 运行修复后的`scripts/fetch_bilibili_update.py`
3. 检查日志输出
4. 验证数据库中的数据：
   - UP主信息是否正确
   - 视频数据是否正确保存
   - `pubdate`字段是否正确
   - 统计数据是否正确

**验收标准**：
- ✅ 脚本运行无错误
- ✅ 数据正确保存到数据库
- ✅ `pubdate`字段类型正确
- ✅ 统计数据正确
- ✅ 日志输出正常

---

## 阶段3：生产环境部署（谨慎执行）

### 任务3.1：代码部署到生产环境
**优先级**：🔴 最高  
**预计时间**：10分钟  
**执行环境**：生产环境  
**操作步骤**：

1. **提交代码到GitHub**：
   ```bash
   git add scripts/fetch_bilibili_update.py
   git commit -m "fix: 修复Bilibili视频数据更新脚本的pubdate类型错误和字段映射问题"
   git push origin main
   ```

2. **在生产服务器拉取代码**：
   ```bash
   ssh user@server
   cd /srv/EmbodiedPulse2026
   git pull origin main
   ```

3. **验证代码已更新**：
   ```bash
   git log -1
   # 确认最新提交包含修复
   ```

**验收标准**：
- ✅ 代码已提交到GitHub
- ✅ 生产服务器代码已更新
- ✅ 代码版本正确

---

### 任务3.2：创建数据修复脚本（可选）
**优先级**：🟢 中  
**预计时间**：20分钟  
**执行环境**：生产环境  
**脚本功能**：

1. 检查所有`pubdate`为NULL或0的视频
2. 从`pubdate_raw`重新计算`pubdate`
3. 重新计算UP主的统计数据

**验收标准**：
- ✅ 修复脚本已创建
- ✅ 脚本逻辑正确
- ✅ 脚本已测试（在本地）

---

### 任务3.3：执行数据修复（如果需要）
**优先级**：🟢 中  
**预计时间**：10分钟  
**执行环境**：生产环境  
**前提条件**：
- 任务3.2已完成
- 已确认需要修复的数据

**操作步骤**：
1. 运行数据修复脚本
2. 检查修复结果
3. 验证数据正确性

**验收标准**：
- ✅ 数据修复完成
- ✅ 数据验证通过

---

### 任务3.4：运行修复后的更新脚本（小规模测试）
**优先级**：🔴 最高  
**预计时间**：15分钟  
**执行环境**：生产环境  
**操作步骤**：

1. **先测试单个UP主**：
   ```bash
   cd /srv/EmbodiedPulse2026
   source venv/bin/activate
   python3 -c "
   from scripts.fetch_bilibili_update import fetch_and_save_up_data_safe
   # 测试单个UP主（选择一个数据量小的）
   result = fetch_and_save_up_data_safe(1172054289, video_count=10)
   print(result)
   "
   ```

2. **检查结果**：
   - 查看日志输出
   - 检查数据库中的数据
   - 验证统计数据

**验收标准**：
- ✅ 单个UP主测试成功
- ✅ 数据正确保存
- ✅ 无错误日志

---

### 任务3.5：运行完整数据更新
**优先级**：🔴 最高  
**预计时间**：30-60分钟（取决于UP主数量）  
**执行环境**：生产环境  
**前提条件**：
- 任务3.4已成功完成

**操作步骤**：
1. 运行完整的更新脚本：
   ```bash
   python3 scripts/fetch_bilibili_update.py
   ```

2. **监控执行过程**：
   - 实时查看日志输出
   - 检查是否有错误
   - 监控数据库连接

3. **等待执行完成**

**验收标准**：
- ✅ 脚本执行完成
- ✅ 所有UP主数据更新成功
- ✅ 统计数据正确
- ✅ 无严重错误

---

## 阶段4：验证与监控

### 任务4.1：验证数据库数据
**优先级**：🔴 最高  
**预计时间**：15分钟  
**执行环境**：生产环境  
**验证项**：

1. **UP主数据**：
   ```sql
   SELECT uid, name, videos_count, views_count, views_formatted 
   FROM bilibili_ups 
   WHERE is_active = true;
   ```

2. **视频数据**：
   ```sql
   SELECT COUNT(*) as total_videos, 
          COUNT(CASE WHEN pubdate IS NOT NULL THEN 1 END) as videos_with_date,
          SUM(play) as total_play
   FROM bilibili_videos 
   WHERE is_deleted = false;
   ```

3. **检查pubdate字段**：
   ```sql
   SELECT bvid, pubdate, pubdate_raw 
   FROM bilibili_videos 
   WHERE pubdate IS NULL OR pubdate_raw IS NULL
   LIMIT 10;
   ```

**验收标准**：
- ✅ UP主统计数据 > 0
- ✅ 视频数据完整
- ✅ `pubdate`字段正确
- ✅ 无NULL值异常

---

### 任务4.2：验证前端显示
**优先级**：🟡 高  
**预计时间**：10分钟  
**执行环境**：生产环境  
**验证项**：

1. 访问`https://blibli.gradmotion.com/bilibili`
2. 检查UP主卡片显示
3. 检查视频列表显示
4. 检查统计数据（播放量、视频数）
5. 检查图表数据

**验收标准**：
- ✅ 页面正常加载
- ✅ UP主信息显示正确
- ✅ 视频列表显示正确
- ✅ 统计数据 > 0
- ✅ 图表数据正常

---

### 任务4.3：验证API接口
**优先级**：🟡 高  
**预计时间**：10分钟  
**执行环境**：生产环境  
**验证项**：

1. 测试`/api/bilibili/all`接口
2. 测试`/api/bilibili/yearly_stats`接口
3. 测试`/api/bilibili/monthly_stats`接口
4. 检查返回数据格式
5. 检查统计数据

**验收标准**：
- ✅ API接口正常响应
- ✅ 数据格式正确
- ✅ 统计数据 > 0
- ✅ 无错误返回

---

### 任务4.4：监控后续数据更新
**优先级**：🟢 中  
**预计时间**：持续监控  
**执行环境**：生产环境  
**监控项**：

1. 监控定时任务执行
2. 检查数据更新日志
3. 验证统计数据变化
4. 检查错误日志

**验收标准**：
- ✅ 定时任务正常运行
- ✅ 数据正常更新
- ✅ 无错误日志

---

## 回滚方案（如果出现问题）

### 回滚步骤

1. **停止数据更新**：
   ```bash
   # 停止定时任务或手动停止脚本
   ```

2. **恢复数据库**：
   ```bash
   # 从备份恢复数据库
   cd /srv/EmbodiedPulse2026
   # PostgreSQL恢复
   psql $BILIBILI_DATABASE_URL < backups/bilibili_backup_YYYYMMDD_HHMMSS.sql
   # 或SQLite恢复
   cp backups/bilibili_backup_YYYYMMDD_HHMMSS.db bilibili.db
   ```

3. **回滚代码**：
   ```bash
   git revert HEAD
   git push origin main
   ```

---

## 任务执行顺序

```
阶段1：准备与验证
├── 1.1 备份生产数据库 ⚠️
├── 1.2 检查当前数据库状态
└── 1.3 在本地环境复现问题

阶段2：代码修复（本地）
├── 2.1 修复fetch_bilibili_update.py
├── 2.2 添加错误处理和事务管理
├── 2.3 修复UP主统计数据更新
└── 2.4 本地环境测试修复后的脚本 ✅ 必须通过

阶段3：生产环境部署
├── 3.1 代码部署到生产环境
├── 3.2 创建数据修复脚本（可选）
├── 3.3 执行数据修复（如果需要）
├── 3.4 运行修复后的更新脚本（小规模测试） ✅ 必须通过
└── 3.5 运行完整数据更新

阶段4：验证与监控
├── 4.1 验证数据库数据 ✅ 必须通过
├── 4.2 验证前端显示 ✅ 必须通过
├── 4.3 验证API接口 ✅ 必须通过
└── 4.4 监控后续数据更新
```

---

## 关键检查点（Checkpoint）

### Checkpoint 1：本地测试通过
**位置**：阶段2完成后  
**要求**：
- ✅ 修复后的脚本在本地运行无错误
- ✅ 数据正确保存
- ✅ 统计数据正确

**通过后才能进入阶段3**

---

### Checkpoint 2：生产小规模测试通过
**位置**：任务3.4完成后  
**要求**：
- ✅ 单个UP主测试成功
- ✅ 数据正确保存
- ✅ 无错误日志

**通过后才能执行任务3.5**

---

### Checkpoint 3：生产验证通过
**位置**：阶段4完成后  
**要求**：
- ✅ 数据库数据正确
- ✅ 前端显示正常
- ✅ API接口正常

**通过后任务完成**

---

## 风险提示

### 🔴 高风险操作
- **任务1.1**：备份数据库（如果失败，无法回滚）
- **任务3.5**：运行完整数据更新（可能影响生产数据）

### 🟡 中等风险操作
- **任务3.1**：代码部署（需要确保代码正确）
- **任务3.4**：小规模测试（可能影响部分数据）

### 🟢 低风险操作
- **任务2.x**：本地环境修复（不影响生产）
- **任务4.x**：验证操作（只读操作）

---

## 预计总时间

- **阶段1**：30分钟
- **阶段2**：95分钟（1.5小时）
- **阶段3**：85分钟（1.5小时）
- **阶段4**：35分钟

**总计**：约4小时（包含等待和验证时间）

---

## 注意事项

1. ⚠️ **必须完成备份**：任务1.1是必须的，不能跳过
2. ⚠️ **本地充分测试**：阶段2必须全部通过才能进入阶段3
3. ⚠️ **小规模测试**：任务3.4必须通过才能执行任务3.5
4. ⚠️ **监控执行**：任务3.5执行过程中需要实时监控
5. ⚠️ **准备回滚**：随时准备执行回滚方案

---

## 联系方式

如遇到问题，请：
1. 立即停止操作
2. 保存错误日志
3. 联系技术支持
4. 准备执行回滚方案

