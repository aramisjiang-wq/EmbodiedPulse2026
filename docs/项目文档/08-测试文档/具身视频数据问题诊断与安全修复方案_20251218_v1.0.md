# 具身视频数据问题诊断与安全修复方案

## 问题诊断

### 1. 单个视频数据是否有？

**需要确认**：单个视频的播放量、评论数等数据是否在数据库中？

**检查方法**：
```bash
# 在服务器上运行诊断脚本
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 scripts/check_bilibili_data_status.py
```

**预期结果**：
- 如果视频数据存在，会显示每个视频的播放量、评论数等
- 如果数据不存在或为0，会显示警告

---

### 2. 公司总播放量和视频数为什么是0？

**问题根源**：发现了代码逻辑错误！

**位置1**：`bilibili_client.py` 第390-394行
```python
return {
    'videos': total_views,  # ❌ 错误！应该是视频数量，不是总播放量
    'likes': likes,
    'views': total_views,
}
```

**位置2**：`bilibili_client.py` 第212-217行（fallback方法）
```python
total_views = sum(v.get('play', 0) or 0 for v in videos)
return {
    'videos': total_views,  # ❌ 错误！应该是视频数量
    'likes': likes,
    'views': total_views,
}
```

**位置3**：`fetch_bilibili_data.py` 第91行
```python
up.videos_count = user_stat.get('videos', 0)  # 这里获取的是总播放量，不是视频数量！
```

**问题说明**：
1. `user_stat`中的`'videos'`字段被错误地设置为总播放量（`total_views`）
2. 但`fetch_bilibili_data.py`中把它当作视频数量赋值给`up.videos_count`
3. 如果API返回失败，使用fallback方法时，`videos`字段也是总播放量
4. 这导致`up.videos_count`可能是一个很大的数字（总播放量），或者如果API失败返回0

---

### 3. 数据库迁移是否导致问题？

**可能的原因**：
1. **数据迁移时字段映射错误**：如果从SQLite迁移到PostgreSQL时，`videos_count`和`views_count`字段可能没有正确迁移
2. **迁移后数据未更新**：迁移后，这些统计字段可能还是旧值或0
3. **新数据库字段未初始化**：如果迁移时只迁移了表结构，没有迁移数据，这些字段就是0

**检查方法**：
运行诊断脚本，对比：
- `up.videos_count`（数据库中的值）
- 实际从`bilibili_videos`表统计的视频数量
- `up.views_count`（数据库中的值）
- 实际从`bilibili_videos`表统计的总播放量

---

## 安全修复方案（分步执行）

### 阶段1：诊断问题（只读，不修改数据）

#### 任务1.1：运行诊断脚本
**目的**：确认当前数据状态

**操作**：
```bash
# 在服务器上
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 scripts/check_bilibili_data_status.py
```

**检查项**：
1. ✅ 每个UP主的`videos_count`和实际视频数量是否一致
2. ✅ 每个UP主的`views_count`和实际总播放量是否一致
3. ✅ 视频数据是否存在（播放量、评论数等）
4. ✅ 是否有`pubdate`为NULL的视频

**输出结果**：
- 如果数据一致 → 问题可能是前端显示问题
- 如果数据不一致 → 需要修复统计数据
- 如果视频数据缺失 → 需要重新抓取

---

### 阶段2：修复代码逻辑（最小改动）

#### 任务2.1：修复`bilibili_client.py`中的统计逻辑
**优先级**：🔴 最高  
**风险**：🟢 低（只修复逻辑，不修改数据）

**修复内容**：

1. **修复`_get_user_stat_async`方法**（第390-394行）：
   ```python
   # 修复前
   return {
       'videos': total_views,  # ❌ 错误
       'likes': likes,
       'views': total_views,
   }
   
   # 修复后
   # 需要计算视频数量
   video_count = len(vlist) if 'vlist' in locals() else 0
   return {
       'videos': video_count,  # ✅ 正确：视频数量
       'likes': likes,
       'views': total_views,  # ✅ 正确：总播放量
   }
   ```

2. **修复`_fallback_user_stat`方法**（第212-217行）：
   ```python
   # 修复前
   total_views = sum(v.get('play', 0) or 0 for v in videos)
   return {
       'videos': total_views,  # ❌ 错误
       'likes': likes,
       'views': total_views,
   }
   
   # 修复后
   total_views = sum(v.get('play', 0) or 0 for v in videos)
   video_count = len(videos)  # ✅ 正确：视频数量
   return {
       'videos': video_count,  # ✅ 正确：视频数量
       'likes': likes,
       'views': total_views,  # ✅ 正确：总播放量
   }
   ```

**验收标准**：
- ✅ 代码逻辑修复
- ✅ `videos`字段返回视频数量
- ✅ `views`字段返回总播放量

---

### 阶段3：修复现有数据（可选，根据诊断结果决定）

#### 任务3.1：创建数据修复脚本
**优先级**：🟡 中  
**风险**：🟡 中（修改数据库，但只修复统计数据）

**脚本功能**：
1. 从`bilibili_videos`表重新计算每个UP主的统计数据
2. 更新`bilibili_ups`表中的`videos_count`和`views_count`
3. 不修改视频数据本身

**执行条件**：
- 只有在诊断脚本显示数据不一致时才执行
- 执行前备份数据库

---

### 阶段4：验证修复效果

#### 任务4.1：重新运行数据更新
**操作**：
```bash
# 使用修复后的代码运行一次数据更新
python3 fetch_bilibili_data.py --video-count 10  # 先测试少量视频
```

**检查**：
1. ✅ 新更新的UP主，`videos_count`是否正确
2. ✅ 新更新的UP主，`views_count`是否正确
3. ✅ 前端显示是否正常

---

## 执行顺序

```
1. 运行诊断脚本（任务1.1）
   ↓
2. 根据诊断结果决定：
   ├─ 如果视频数据存在，统计数据错误 → 执行任务2.1 + 任务3.1
   ├─ 如果视频数据缺失 → 执行任务2.1 + 重新抓取数据
   └─ 如果数据都正常 → 可能是前端问题，检查前端代码
   ↓
3. 验证修复效果（任务4.1）
```

---

## 风险评估

### 低风险操作
- ✅ **任务1.1**：诊断脚本（只读，不修改数据）
- ✅ **任务2.1**：修复代码逻辑（不修改现有数据）

### 中等风险操作
- ⚠️ **任务3.1**：修复统计数据（修改数据库，但只修复统计字段）

### 注意事项
- 所有修改前先备份数据库
- 先修复代码，再修复数据
- 小规模测试后再大规模执行

---

## 预期效果

修复后：
1. ✅ `user_stat['videos']`返回视频数量（不是总播放量）
2. ✅ `up.videos_count`正确显示视频数量
3. ✅ `up.views_count`正确显示总播放量
4. ✅ 前端显示正常

---

## 如果诊断结果显示视频数据缺失

如果诊断脚本显示视频数据缺失或为0，需要：

1. **检查数据更新脚本是否正常运行**
2. **检查是否有错误日志**
3. **可能需要重新抓取数据**（但先修复代码逻辑）

---

## 总结

**核心问题**：
- `bilibili_client.py`中`user_stat`的`'videos'`字段被错误地设置为总播放量，而不是视频数量
- 这导致`up.videos_count`显示错误

**修复方案**：
1. 先诊断确认问题
2. 修复代码逻辑（最小改动）
3. 根据诊断结果决定是否需要修复现有数据
4. 验证修复效果

**优势**：
- 只修复代码逻辑，不修改现有视频数据
- 先诊断后修复，安全可控
- 最小改动，风险低

