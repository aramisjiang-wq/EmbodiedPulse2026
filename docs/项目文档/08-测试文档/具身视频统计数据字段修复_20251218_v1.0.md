# 具身视频统计数据字段修复

**日期**: 2025-12-18  
**问题**: 管理端看不到总播放数和总视频数

---

## 一、问题诊断结果

### 1.1 数据库检查结果

运行 `scripts/fix_bilibili_stats.py` 检查结果：
- ✅ **所有12个UP主的统计数据都正确**
- ✅ `videos_count` 字段有值
- ✅ `views_count` 字段有值
- ✅ 统计数据与视频表实际数据一致

**结论**：数据库中的数据是正确的，问题不在数据库层面。

### 1.2 问题根源

**字段名不一致问题**：

在 `bilibili_models.py` 的 `BilibiliUp.to_dict()` 方法中：
- 返回的字段名是：`'views'` 和 `'views_raw'`
- 但前端 `admin_bilibili.js` 期望的字段名是：`'views_formatted'` 和 `'views_count'`

**代码位置**：
- `bilibili_models.py` 第60-61行：返回 `'views'` 和 `'views_raw'`
- `static/js/admin_bilibili.js` 第161行：期望 `up.views_formatted` 或 `up.views_count`

---

## 二、修复方案

### 2.1 修复内容

修改 `bilibili_models.py` 的 `to_dict()` 方法，同时返回：
1. **向后兼容字段**：`views` 和 `views_raw`（保持现有代码兼容）
2. **前端期望字段**：`views_formatted` 和 `views_count`（供管理端使用）
3. **确保字段不为None**：`videos_count` 确保返回0而不是None

### 2.2 修复后的字段映射

```python
{
    'videos_count': self.videos_count or 0,  # 确保不为None
    'views': self.views_formatted or '0',  # 向后兼容
    'views_formatted': self.views_formatted or '0',  # 前端期望字段
    'views_raw': self.views_count,  # 向后兼容
    'views_count': self.views_count or 0,  # 前端期望字段
    # ... 其他字段
}
```

---

## 三、验证步骤

### 3.1 重启应用

修复后需要重启应用使更改生效：

```bash
# 在服务器上
cd /srv/EmbodiedPulse2026
# 重启应用（根据你的部署方式）
# 如果使用systemd:
sudo systemctl restart embodied-pulse
# 如果使用gunicorn:
pkill -f gunicorn
# 然后重新启动应用
```

### 3.2 检查管理端

1. **访问管理端**：`http://your-domain/admin/bilibili`
2. **检查UP主列表**：
   - 视频数列应该显示数字（如：50）
   - 总播放量列应该显示格式化数字（如：1.2万）
3. **检查浏览器控制台**：
   - 打开开发者工具（F12）
   - 查看Network标签，检查 `/api/admin/bilibili/ups` 返回的数据
   - 确认返回的数据包含 `videos_count` 和 `views_formatted` 字段

### 3.3 测试API

```bash
# 使用curl测试API（需要替换YOUR_TOKEN）
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:5000/api/admin/bilibili/ups?page=1&per_page=5
```

检查返回的JSON数据中是否包含：
- `videos_count`: 数字（如：50）
- `views_formatted`: 字符串（如："1.2万"）
- `views_count`: 数字（如：12000）

---

## 四、相关文件

### 修改的文件
- `bilibili_models.py` - 修复 `BilibiliUp.to_dict()` 方法

### 相关文件
- `static/js/admin_bilibili.js` - 前端显示逻辑（无需修改）
- `templates/admin_bilibili.html` - 管理端页面（无需修改）
- `auth_routes.py` - 管理端API路由（无需修改）

---

## 五、预期结果

修复后：
- ✅ 管理端UP主列表能正确显示视频数
- ✅ 管理端UP主列表能正确显示总播放量
- ✅ API返回的数据包含所有必要字段
- ✅ 向后兼容，不影响其他使用 `views` 和 `views_raw` 的代码

---

## 六、后续优化建议

1. **统一字段命名规范**：建议统一使用 `*_formatted` 和 `*_count` 的命名规范
2. **API文档**：更新API文档，明确说明返回的字段名
3. **前端类型检查**：在前端添加类型检查，确保字段存在

---

**修复完成时间**: 2025-12-18  
**修复状态**: ✅ 已完成

