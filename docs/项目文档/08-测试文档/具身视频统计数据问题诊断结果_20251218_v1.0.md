# 具身视频统计数据问题诊断结果

**日期**: 2025-12-18  
**检查脚本**: `scripts/check_bilibili_data_integrity.py`

---

## 一、检查结果摘要

### ✅ 正常情况
1. **数据更新时间正常**：所有12个UP主的数据都在2025-12-18 14:53-14:57之间更新
2. **视频数据完整**：总共516个视频，最近30天有36个视频
3. **数据抓取正常**：定时任务正常执行，数据已更新

### ⚠️ 需要确认的问题
1. **统计数据字段**：需要检查`videos_count`和`views_count`字段是否有值
2. **管理端显示**：管理端可能没有正确显示这些统计数据

---

## 二、详细检查结果

### 2.1 UP主数据检查

| UP主名称 | UID | 视频数 | 粉丝数 | 最后更新 |
|---------|-----|--------|--------|----------|
| 傅利叶Fourier | 519804427 | 50 | 9096 | 2025-12-18 14:55:56 |
| Unitree宇树科技 | 521974986 | 50 | 636365 | 2025-12-18 14:56:04 |
| 优必选科技 | 472153261 | 50 | 11171 | 2025-12-18 14:56:26 |
| 逐际动力 | 1172054289 | 49 | 20753 | 2025-12-18 14:53:44 |
| 银河通用机器人 | 3546595559737798 | 18 | 4844 | 2025-12-18 14:54:06 |
| 智元AGIBOT | 3494380742642452 | 50 | 232913 | 2025-12-18 14:54:28 |
| 加速进化机器人 | 3546665977907667 | 50 | 3078 | 2025-12-18 14:54:50 |
| 众擎机器人 | 3546728498202679 | 35 | 86635 | 2025-12-18 14:55:12 |
| 云深处科技 | 22477177 | 50 | 104896 | 2025-12-18 14:55:34 |
| 松延动力 | 3546714680068378 | 50 | 8416 | 2025-12-18 14:56:48 |
| 乐聚机器人LEJUROBOT | 3537120496978247 | 34 | 2639 | 2025-12-18 14:57:10 |
| 星动纪元ROBOTERA | 3546561487309464 | 30 | 2913 | 2025-12-18 14:57:33 |

### 2.2 视频数据检查

- **总视频数**: 516个
- **未删除视频数**: 516个
- **已删除视频数**: 0个
- **最近30天视频数**: 36个

### 2.3 数据更新时间

所有UP主的数据都在**2025-12-18 14:53-14:57**之间更新，说明：
- ✅ 定时任务正常执行
- ✅ 数据抓取脚本正常工作
- ✅ 12月18日的数据已存在

---

## 三、问题分析

### 3.1 问题1：总播放数和总视频数缺失

**可能原因**：
1. **数据库字段值为0或NULL**：`videos_count`和`views_count`字段可能没有正确保存
2. **API获取失败**：Bilibili API返回412错误（风控），统计数据可能获取失败
3. **数据保存逻辑问题**：`fetch_bilibili_data.py`中保存统计数据时可能出错

**检查方法**：
```bash
# 运行专门的统计数据字段检查脚本
venv/bin/python3 scripts/check_bilibili_stats_fields.py
```

### 3.2 问题2：管理端显示问题

**可能原因**：
1. **API返回数据格式问题**：`/api/admin/bilibili/ups`可能没有返回`videos_count`和`views_count`
2. **前端显示逻辑问题**：管理端前端可能没有正确显示这些字段
3. **字段映射问题**：数据库字段名和API返回字段名不一致

**检查方法**：
1. 检查`auth_routes.py`中的`get_bilibili_ups()`函数
2. 检查`admin_bilibili.html`和`admin_bilibili.js`的显示逻辑

---

## 四、下一步操作

### 4.1 立即执行（诊断问题）

1. **检查统计数据字段**：
   ```bash
   venv/bin/python3 scripts/check_bilibili_stats_fields.py
   ```
   这会显示：
   - 数据库中`videos_count`和`views_count`的实际值
   - 从视频表统计的实际值
   - 两者是否一致

2. **检查管理端API**：
   ```bash
   # 查看API返回的数据格式
   curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:5000/api/admin/bilibili/ups
   ```

3. **检查数据库直接查询**：
   ```sql
   SELECT uid, name, videos_count, views_count, views_formatted 
   FROM bilibili_ups 
   WHERE is_active = true;
   ```

### 4.2 修复步骤

#### 如果统计数据字段为0或NULL：

1. **运行修复脚本**：
   ```bash
   venv/bin/python3 scripts/fix_bilibili_stats.py
   ```
   这会从视频表重新计算并更新`videos_count`和`views_count`

2. **验证修复结果**：
   ```bash
   venv/bin/python3 scripts/check_bilibili_stats_fields.py
   ```

#### 如果API返回数据格式问题：

1. **检查`auth_routes.py`**：
   - 确认`get_bilibili_ups()`返回的数据包含`videos_count`和`views_count`
   - 确认`BilibiliUp.to_dict()`方法包含这些字段

2. **检查前端显示**：
   - 确认`admin_bilibili.html`的表格列包含这些字段
   - 确认`admin_bilibili.js`正确显示这些数据

---

## 五、相关文件

### 检查脚本
- `scripts/check_bilibili_data_integrity.py` - 数据完整性检查
- `scripts/check_bilibili_stats_fields.py` - 统计数据字段检查（新建）

### 修复脚本
- `scripts/fix_bilibili_stats.py` - 修复统计数据

### 代码文件
- `bilibili_models.py` - 数据库模型
- `fetch_bilibili_data.py` - 数据抓取和保存
- `bilibili_client.py` - Bilibili API客户端
- `auth_routes.py` - 管理端API路由
- `templates/admin_bilibili.html` - 管理端页面
- `static/js/admin_bilibili.js` - 管理端JS

---

## 六、预期结果

修复后应该：
- ✅ 数据库中所有UP主的`videos_count`和`views_count`都有正确的值
- ✅ 管理端能正确显示总播放数和总视频数
- ✅ 统计数据与实际视频表数据一致

---

**文档结束**

