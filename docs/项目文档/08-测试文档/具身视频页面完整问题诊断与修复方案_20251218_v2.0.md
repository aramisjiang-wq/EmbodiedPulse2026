# 具身视频页面完整问题诊断与修复方案

**版本**: v2.0  
**日期**: 2025-12-18  
**问题**: 刷新后总播放数等没有显示，也没有更新12月18日的新视频

---

## 一、问题分析

### 1.1 总播放数显示问题

**问题现象**：前端页面不显示总播放数

**根本原因**：
1. **前端显示逻辑**：`bilibili.html` 第1806行只显示 `userStat.views`，但没有显示总视频数
2. **API返回数据**：`/api/bilibili/all` 返回的 `user_stat` 包含：
   - `videos`: 格式化后的视频数（如"50"）
   - `views`: 格式化后的总播放数（如"1.2万"）
   - `likes`: 格式化后的获赞数
3. **前端显示缺失**：前端只显示了"总播放"和"粉丝"，没有显示"总视频数"

**代码位置**：
- `templates/bilibili.html` 第1819-1828行：只显示总播放和粉丝
- `app.py` 第1311-1315行：API返回 `user_stat` 数据

### 1.2 12月18日新视频问题

**问题现象**：没有看到12月18日的新视频

**可能原因**：
1. **数据抓取问题**：定时任务可能没有成功抓取12月18日的视频
2. **前端过滤问题**：前端过滤逻辑可能过滤掉了12月18日的视频
3. **数据库问题**：数据库中可能没有12月18日的视频

**代码位置**：
- `templates/bilibili.html` 第2097-2103行：前端过滤逻辑（只保留近30天）
- `fetch_bilibili_data.py` 第109-150行：视频数据保存逻辑

---

## 二、完整数据流程检查

### 2.1 数据流程

```
Bilibili API
    ↓
bilibili_client.py (get_all_data)
    ↓
fetch_bilibili_data.py (fetch_and_save_up_data)
    ↓
bilibili.db (PostgreSQL)
    ↓
app.py (/api/bilibili/all)
    ↓
templates/bilibili.html (前端显示)
```

### 2.2 关键检查点

1. **API获取统计数据**：`bilibili_client.py` 的 `get_user_stat()` 是否正确返回 `videos` 和 `views`
2. **数据保存**：`fetch_bilibili_data.py` 是否正确保存 `videos_count` 和 `views_count`
3. **API返回**：`app.py` 的 `/api/bilibili/all` 是否正确返回 `user_stat`
4. **前端显示**：`bilibili.html` 是否正确显示统计数据

---

## 三、修复方案

### 3.1 修复前端显示（添加总视频数）

**文件**: `templates/bilibili.html`

**修改位置**: 第1819-1828行

**修改内容**：添加总视频数显示

```javascript
// 修改前
<div class="bilibili-card-stats">
    <div class="bilibili-card-stat">
        <div class="bilibili-card-stat-value">${viewsValue}</div>
        <div class="bilibili-card-stat-label">总播放</div>
    </div>
    <div class="bilibili-card-stat">
        <div class="bilibili-card-stat-value">${fansValue}</div>
        <div class="bilibili-card-stat-label">粉丝</div>
    </div>
</div>

// 修改后
<div class="bilibili-card-stats">
    <div class="bilibili-card-stat">
        <div class="bilibili-card-stat-value">${viewsValue}</div>
        <div class="bilibili-card-stat-label">总播放</div>
    </div>
    <div class="bilibili-card-stat">
        <div class="bilibili-card-stat-value">${escapeHtml(userStat.videos || '0')}</div>
        <div class="bilibili-card-stat-label">总视频</div>
    </div>
    <div class="bilibili-card-stat">
        <div class="bilibili-card-stat-value">${fansValue}</div>
        <div class="bilibili-card-stat-label">粉丝</div>
    </div>
</div>
```

### 3.2 检查并修复统计数据获取

**问题**：如果API返回的统计数据为0，需要从视频表重新计算

**解决方案**：在 `fetch_bilibili_data.py` 中添加数据验证和修复逻辑

### 3.3 检查12月18日视频数据

**步骤**：
1. 检查数据库中是否有12月18日的视频
2. 如果没有，手动执行数据抓取
3. 检查前端过滤逻辑是否正确

---

## 四、立即执行的检查步骤

### 步骤1：检查数据库中的统计数据

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 -c "
from bilibili_models import get_bilibili_session, BilibiliUp
session = get_bilibili_session()
ups = session.query(BilibiliUp).filter_by(is_active=True).limit(3).all()
for up in ups:
    print(f'{up.name}: videos_count={up.videos_count}, views_count={up.views_count}')
session.close()
"
```

### 步骤2：检查12月18日的视频

```bash
venv/bin/python3 -c "
from bilibili_models import get_bilibili_session, BilibiliVideo
from datetime import datetime
from sqlalchemy import func
session = get_bilibili_session()
date_1218 = datetime(2025, 12, 18).date()
count = session.query(func.count(BilibiliVideo.bvid)).filter(
    func.date(BilibiliVideo.pubdate) == date_1218
).scalar()
print(f'12月18日的视频数: {count}')
if count > 0:
    videos = session.query(BilibiliVideo).filter(
        func.date(BilibiliVideo.pubdate) == date_1218
    ).limit(5).all()
    for v in videos:
        print(f'  - {v.title[:50]}')
session.close()
"
```

### 步骤3：检查API返回的数据

```bash
# 在浏览器控制台或使用curl
curl http://your-domain/api/bilibili/all | jq '.data[0].user_stat'
```

### 步骤4：手动抓取数据（如果需要）

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 fetch_bilibili_data.py --video-count 50
```

---

## 五、修复代码

### 5.1 修复前端显示

需要修改 `templates/bilibili.html`，添加总视频数显示。

### 5.2 修复统计数据获取

如果API返回的统计数据为0，需要改进 `bilibili_client.py` 的统计数据获取逻辑。

### 5.3 修复数据保存

确保 `fetch_bilibili_data.py` 正确保存统计数据。

---

## 六、验证步骤

修复后需要验证：
1. ✅ 前端页面显示总播放数
2. ✅ 前端页面显示总视频数
3. ✅ 12月18日的视频能正常显示
4. ✅ 统计数据与实际数据一致

---

**文档结束**

