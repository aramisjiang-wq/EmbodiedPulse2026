# 完整问题诊断和修复方案

**日期**: 2025-12-18  
**问题**: API返回user_stat全为0，但数据库有值，代码逻辑正确

---

## 一、问题确认

### 1.1 数据库数据 ✅
- `videos_count` 有值（49, 18, 50等）
- `views_count` 有值（3307108, 337029等）
- `views_formatted` 有值（'330.7万', '33.7万'等）

### 1.2 代码逻辑 ✅
- `app.py` 第1311-1315行代码正确
- 调试脚本显示逻辑正确，返回 `{'videos': '49', 'views': '330.7万'}`

### 1.3 API返回 ❌
- 实际API返回 `{"videos": "0", "views": "0", "likes": "0"}`

---

## 二、可能的原因

### 2.1 异常被捕获（最可能）

**代码位置**：`app.py` 第1328-1347行

```python
except Exception as e:
    logger.error(f"处理UP主 {up.uid} 数据失败: {e}")
    # 添加错误数据
    all_data.append({
        ...
        'user_stat': {},  # ❌ 返回空的user_stat
        ...
    })
```

**检查方法**：
```bash
sudo journalctl -u embodiedpulse -n 200 --no-pager | grep "处理UP主.*数据失败"
```

### 2.2 代码没有真正执行

可能代码路径不对，或者有其他地方覆盖了数据。

---

## 三、立即修复方案

### 方案1：检查异常日志

```bash
cd /srv/EmbodiedPulse2026
sudo journalctl -u embodiedpulse -n 500 --no-pager | grep -i "error\|exception\|失败" | grep -i "bilibili\|UP主" | tail -30
```

### 方案2：添加详细日志

在 `app.py` 第1311行前添加：

```python
logger.info(f"DEBUG: {up.name} - videos_count={up.videos_count}, views_count={up.views_count}, views_formatted={up.views_formatted}")
```

### 方案3：直接测试代码

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

# 模拟完整的API流程
from bilibili_models import get_bilibili_session, BilibiliUp, BilibiliVideo
from bilibili_client import format_number, format_timestamp

session = get_bilibili_session()
ups = session.query(BilibiliUp).filter_by(is_active=True).all()

print(f"处理 {len(ups)} 个UP主\n")

for up in ups[:3]:  # 只处理前3个
    try:
        # 完全模拟API代码
        videos_query = session.query(BilibiliVideo).filter_by(
            uid=up.uid,
            is_deleted=False
        ).order_by(BilibiliVideo.pubdate_raw.desc()).limit(200)
        videos = videos_query.all()
        
        formatted_videos = []
        for video in videos[:5]:  # 只处理前5个视频
            formatted_videos.append({
                'bvid': video.bvid,
                'title': video.title or '',
                'play': video.play_formatted or '0',
            })
        
        user_stat = {
            'videos': format_number(up.videos_count) if up.videos_count else '0',
            'likes': up.likes_formatted or (format_number(up.likes_count) if up.likes_count else '0'),
            'views': up.views_formatted or (format_number(up.views_count) if up.views_count else '0'),
        }
        
        print(f"✅ {up.name}: {user_stat}")
        
    except Exception as e:
        print(f"❌ {up.name}: 异常 - {e}")
        import traceback
        traceback.print_exc()

session.close()
EOF
```

---

## 四、如果异常被捕获

如果发现异常，需要修复异常原因。常见异常：
1. `format_number` 函数调用失败
2. 数据库字段访问失败
3. 类型转换错误

---

**文档结束**

