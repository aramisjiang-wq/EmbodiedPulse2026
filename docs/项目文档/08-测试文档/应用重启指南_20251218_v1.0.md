# 应用重启指南

**日期**: 2025-12-18  
**问题**: 执行 `pkill -f gunicorn` 后应用未自动重启

---

## 一、问题说明

`pkill -f gunicorn` 只是停止进程，不会自动重启应用。需要手动重启。

---

## 二、重启方法

### 方法1：使用 systemd 服务（推荐）

如果应用是通过 systemd 服务管理的：

```bash
# 检查服务是否存在
systemctl status embodiedpulse

# 如果服务存在，使用以下命令重启
sudo systemctl restart embodiedpulse

# 查看服务状态
systemctl status embodiedpulse

# 查看日志
journalctl -u embodiedpulse -f --lines=50
```

### 方法2：手动启动 Gunicorn

如果应用不是通过 systemd 管理的：

```bash
cd /srv/EmbodiedPulse2026

# 激活虚拟环境
source venv/bin/activate

# 启动 Gunicorn（后台运行）
nohup gunicorn -c gunicorn_config.py app:app > /dev/null 2>&1 &

# 或者使用 screen/tmux 保持会话
screen -S embodied-pulse
# 在screen中运行：
gunicorn -c gunicorn_config.py app:app
# 按 Ctrl+A 然后 D 退出screen（应用继续运行）
```

### 方法3：使用启动脚本

如果有启动脚本：

```bash
cd /srv/EmbodiedPulse2026
bash scripts/quick_restart_and_check.sh
```

---

## 三、检查应用状态

### 3.1 检查进程

```bash
# 检查 gunicorn 进程是否运行
ps aux | grep gunicorn

# 检查端口是否被占用
lsof -i:5001
# 或
netstat -tlnp | grep 5001
```

### 3.2 检查服务状态

```bash
# 如果使用 systemd
systemctl status embodiedpulse

# 查看最近50行日志
journalctl -u embodiedpulse -n 50 --no-pager
```

### 3.3 测试应用

```bash
# 测试应用是否响应
curl http://localhost:5001/api/stats

# 或测试首页
curl http://localhost:5001/
```

---

## 四、常见问题

### 4.1 502 Bad Gateway

**原因**：
- 应用进程未运行
- Nginx/反向代理配置错误
- 端口被占用

**解决方法**：
1. 检查应用是否运行：`ps aux | grep gunicorn`
2. 检查端口：`lsof -i:5001`
3. 重启应用（使用上述方法）
4. 检查 Nginx 配置（如果使用）

### 4.2 端口被占用

```bash
# 查找占用端口的进程
lsof -ti:5001

# 杀死占用端口的进程
kill -9 $(lsof -ti:5001)

# 或使用 fuser
fuser -k 5001/tcp
```

### 4.3 应用启动失败

```bash
# 查看详细错误日志
cd /srv/EmbodiedPulse2026
source venv/bin/activate
gunicorn -c gunicorn_config.py app:app

# 或查看 systemd 日志
journalctl -u embodiedpulse -f
```

---

## 五、快速重启命令

### 如果使用 systemd：

```bash
sudo systemctl restart embodiedpulse && systemctl status embodiedpulse
```

### 如果手动管理：

```bash
cd /srv/EmbodiedPulse2026
pkill -f gunicorn
sleep 2
source venv/bin/activate
nohup gunicorn -c gunicorn_config.py app:app > /tmp/gunicorn.log 2>&1 &
sleep 3
ps aux | grep gunicorn
curl http://localhost:5001/api/stats
```

---

## 六、建议

1. **使用 systemd 管理**：更稳定，自动重启，便于管理
2. **设置开机自启**：`systemctl enable embodiedpulse`
3. **监控日志**：定期检查日志，及时发现问题
4. **使用进程管理器**：如 supervisor 或 pm2（可选）

---

**文档结束**

