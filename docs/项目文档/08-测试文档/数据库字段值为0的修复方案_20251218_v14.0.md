# 数据库字段值为0的修复方案

**问题确认**：
- 前端通过 `/api/bilibili/all` API从数据库获取数据 ✅
- API从数据库读取 `videos_count` 和 `views_count` ✅
- 但数据库中"逐际动力"的这两个字段值是0 ❌

---

## 立即检查数据库中的实际值

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026

# 检查数据库中"逐际动力"的实际值
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from bilibili_models import get_bilibili_session, BilibiliUp, BilibiliVideo
from sqlalchemy import func

session = get_bilibili_session()
up = session.query(BilibiliUp).filter_by(name='逐际动力', is_active=True).first()

if up:
    print(f"UP主: {up.name} (UID: {up.uid})")
    print(f"\n数据库中的值:")
    print(f"  videos_count = {up.videos_count}")
    print(f"  views_count = {up.views_count}")
    print(f"  views_formatted = {up.views_formatted!r}")
    
    # 计算实际值
    actual_video_count = session.query(func.count(BilibiliVideo.bvid)).filter_by(
        uid=up.uid,
        is_deleted=False
    ).scalar()
    
    actual_total_views = session.query(func.sum(BilibiliVideo.play)).filter_by(
        uid=up.uid,
        is_deleted=False
    ).scalar() or 0
    
    print(f"\n实际计算的值:")
    print(f"  实际视频数 = {actual_video_count}")
    print(f"  实际总播放量 = {actual_total_views}")
    
    print(f"\n差异:")
    print(f"  videos_count差异: {actual_video_count - (up.videos_count or 0)}")
    print(f"  views_count差异: {actual_total_views - (up.views_count or 0)}")
else:
    print("❌ 找不到UP主")

session.close()
EOF
```

---

## 如果数据库中的值确实是0，运行修复脚本

```bash
cd /srv/EmbodiedPulse2026

# 运行修复脚本
venv/bin/python3 scripts/fix_bilibili_stats.py

# 验证修复结果
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from bilibili_models import get_bilibili_session, BilibiliUp

session = get_bilibili_session()
up = session.query(BilibiliUp).filter_by(name='逐际动力', is_active=True).first()

if up:
    print(f"修复后的值:")
    print(f"  videos_count = {up.videos_count}")
    print(f"  views_count = {up.views_count}")
    print(f"  views_formatted = {up.views_formatted!r}")

session.close()
EOF

# 重启应用
sudo systemctl restart embodiedpulse
sleep 5

# 验证API返回
curl 'http://localhost:5001/api/bilibili/all?force=1' 2>/dev/null | python3 -c "
import sys, json
data = json.load(sys.stdin)
if data.get('success') and data.get('data') and len(data['data']) > 0:
    card = data['data'][0]
    user_stat = card.get('user_stat', {})
    print('第一个UP主:', card.get('user_info', {}).get('name'))
    print('user_stat.videos:', user_stat.get('videos'))
    print('user_stat.views:', user_stat.get('views'))
"
```

---

**文档结束**

