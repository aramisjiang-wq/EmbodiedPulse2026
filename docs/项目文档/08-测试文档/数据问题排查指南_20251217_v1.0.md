# 数据问题排查指南

**版本**: v1.0  
**日期**: 2025-12-17

---

## 📋 问题描述

1. **具身论文页面**：没有2025年12月17日的最新论文
2. **具身视频页面**：数据库丢失了很多数据

---

## 🔍 问题1：论文数据排查

### 步骤1：检查数据库中的论文数据

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
python3 scripts/diagnose_data_issues.py
```

**检查要点**：
- 总论文数
- 12月17日的论文数
- 最新论文的日期
- 今天创建的论文数

### 步骤2：检查定时任务配置

```bash
# 检查环境变量
cat .env | grep AUTO_FETCH

# 应该看到：
# AUTO_FETCH_ENABLED=true
# AUTO_FETCH_SCHEDULE=0 * * * *  (每小时执行)
```

### 步骤3：检查定时任务是否运行

```bash
# 检查服务日志
journalctl -u embodiedpulse -n 100 | grep "定时论文抓取"

# 检查是否有错误
journalctl -u embodiedpulse -n 100 | grep -i error
```

### 步骤4：手动抓取12月17日的论文

```bash
cd /srv/EmbodiedPulse2026
python3 scripts/fix_paper_fetch_dec17.py
```

**预期结果**：
- 脚本会抓取12月17日的论文
- 显示抓取到的论文数量和列表

### 步骤5：检查前端API

访问：`https://essay.gradmotion.com/api/papers`

检查返回的JSON中是否包含12月17日的论文。

### 步骤6：检查前端显示

1. 清除浏览器缓存（Ctrl+Shift+R）
2. 访问 `https://essay.gradmotion.com/`
3. 检查论文列表是否显示12月17日的论文

---

## 🔍 问题2：视频数据排查

### 步骤1：检查数据库中的视频数据

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
python3 scripts/check_bilibili_data_integrity.py
```

**检查要点**：
- 总UP主数
- 总视频数
- 各UP主的视频数量
- 最近30天的视频数
- 数据更新时间

### 步骤2：对比API数据

脚本会自动对比API返回的数据和数据库中的数据，找出丢失的视频。

### 步骤3：检查定时任务配置

```bash
# 检查B站抓取配置
cat .env | grep BILIBILI

# 应该看到：
# AUTO_FETCH_BILIBILI_SCHEDULE=0 */6 * * *  (每6小时执行)
```

### 步骤4：检查定时任务是否运行

```bash
# 检查服务日志
journalctl -u embodiedpulse -n 100 | grep "Bilibili"

# 检查是否有错误
journalctl -u embodiedpulse -n 100 | grep -i "bilibili.*error"
```

### 步骤5：手动刷新B站数据

如果发现数据丢失，可以手动触发抓取：

```bash
cd /srv/EmbodiedPulse2026
python3 -c "
from fetch_bilibili_data import fetch_all_bilibili_data
fetch_all_bilibili_data(video_count=50, delay_between_requests=2.0)
"
```

---

## 🔧 常见问题修复

### 问题1：定时任务未运行

**原因**：
- `AUTO_FETCH_ENABLED=false`
- 服务未加载`.env`文件
- 定时任务配置错误

**修复**：
```bash
# 1. 检查并修复环境变量
bash scripts/check_and_fix_scheduler.sh

# 2. 确保服务加载.env
bash scripts/fix_port_and_service.sh

# 3. 重启服务
systemctl restart embodiedpulse
```

### 问题2：论文抓取日期范围不够

**原因**：
- `days_back`设置太小（默认21天）

**修复**：
编辑 `fetch_new_data.py`，增加 `days_back`：
```python
config['days_back'] = 30  # 增加到30天
```

### 问题3：视频数据丢失

**原因**：
- 定时任务未执行
- API请求失败
- 数据库写入失败

**修复**：
1. 检查定时任务是否运行
2. 手动触发抓取
3. 检查数据库连接和权限

---

## 📊 数据恢复方案

### 论文数据恢复

如果发现12月17日的论文缺失：

1. **手动抓取**：
   ```bash
   python3 scripts/fix_paper_fetch_dec17.py
   ```

2. **扩大日期范围抓取**：
   ```bash
   # 修改 fetch_new_data.py 中的 days_back
   # 然后手动触发抓取
   python3 -c "from fetch_new_data import fetch_papers; fetch_papers()"
   ```

### 视频数据恢复

如果发现视频数据丢失：

1. **手动抓取所有UP主数据**：
   ```bash
   python3 -c "
   from fetch_bilibili_data import fetch_all_bilibili_data
   fetch_all_bilibili_data(video_count=100, delay_between_requests=2.0)
   "
   ```

2. **检查并修复数据库**：
   ```bash
   python3 scripts/check_bilibili_data_integrity.py
   ```

---

## ✅ 验证修复

### 论文数据验证

1. 执行诊断脚本，确认12月17日的论文已存在
2. 访问前端页面，确认论文显示正常
3. 检查API返回，确认数据完整

### 视频数据验证

1. 执行完整性检查脚本，确认视频数量正常
2. 访问前端页面，确认视频显示正常
3. 对比API数据，确认没有丢失

---

## 📝 预防措施

1. **定期检查定时任务**：
   ```bash
   journalctl -u embodiedpulse -n 50 | grep "定时"
   ```

2. **定期检查数据完整性**：
   ```bash
   python3 scripts/diagnose_data_issues.py
   ```

3. **设置监控告警**：
   - 监控定时任务执行情况
   - 监控数据量变化
   - 监控API错误率

---

**文档版本**: v1.0  
**最后更新**: 2025-12-17

