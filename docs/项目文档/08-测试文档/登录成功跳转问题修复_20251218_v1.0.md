# 登录成功跳转问题修复

**日期**: 2025-12-18  
**版本**: v1.0  
**状态**: ✅ 已修复

## 问题描述

1. **页面循环刷新**：登录成功后，`https://login.gradmotion.com/` 页面反复刷新，没有跳转到具身论文或具身视频页面
2. **用户数据库状态**：担心数据库迁移后用户信息数据库的状态

## 根本原因

### 问题1：页面循环刷新

1. **跳转逻辑问题**：
   - 登录成功后，`auth_callback.html` 跳转到 `redirectUrl`（默认是 `/`）
   - 但 `/` 在 `login.gradmotion.com` 域名下会被 Nginx 代理到 `/login`
   - `/login` 页面加载时，`user_menu.js` 检测到已登录，但可能因为某些原因又触发了跳转
   - 导致在 `login.gradmotion.com` 上循环

2. **域名丢失**：
   - 用户从 `essay.gradmotion.com` 或 `blibli.gradmotion.com` 跳转到登录页时，没有保存原始域名
   - 登录成功后，跳转回 `/`，但仍在 `login.gradmotion.com` 域名下

### 问题2：用户数据库状态

- 从 SQLite 迁移到 PostgreSQL 时，认证相关的表（`auth_users`, `admin_users` 等）可能没有被创建
- 需要检查并确保所有认证表都存在

## 修复方案

### 修复1：改进跳转逻辑

**修改文件**: 
- `templates/auth_callback.html`
- `static/js/user_menu.js`

**修改内容**:

1. **保存原始域名**：
   - 在 `user_menu.js` 中，当用户被重定向到登录页时，保存原始域名到 `localStorage`

2. **智能跳转**：
   - 在 `auth_callback.html` 中，如果当前在 `login.gradmotion.com`，且 `redirectUrl` 是相对路径，则：
     - 如果有保存的原始域名，跳转到原始域名
     - 否则，默认跳转到 `essay.gradmotion.com`

3. **防止循环**：
   - 在 `auth_callback.html` 的 `<head>` 中添加保护逻辑，如果没有 token 且当前在 `login.gradmotion.com`，立即跳转到登录页

### 修复2：检查用户数据库状态

**新增脚本**: `scripts/check_auth_database_status.sh`

**功能**:
- 检查数据库类型（PostgreSQL 或 SQLite）
- 检查认证相关表是否存在
- 显示用户数据统计

## 部署步骤

### 步骤1：拉取最新代码

```bash
cd /srv/EmbodiedPulse2026
git pull origin main
```

### 步骤2：检查用户数据库状态

```bash
bash scripts/check_auth_database_status.sh
```

如果发现表不存在，运行：

```bash
bash scripts/fix_auth_database.sh
```

### 步骤3：重启服务

```bash
sudo systemctl restart embodiedpulse
sleep 3
sudo systemctl status embodiedpulse
```

## 测试验证

### 测试1：从论文页面登录

1. 访问 `https://essay.gradmotion.com/`
2. 应该跳转到 `https://login.gradmotion.com/login`
3. 点击"飞书扫码登录"
4. 授权后，应该跳转回 `https://essay.gradmotion.com/`（不是 `login.gradmotion.com`）

### 测试2：从视频页面登录

1. 访问 `https://blibli.gradmotion.com/`
2. 应该跳转到 `https://login.gradmotion.com/login`
3. 点击"飞书扫码登录"
4. 授权后，应该跳转回 `https://blibli.gradmotion.com/`（不是 `login.gradmotion.com`）

### 测试3：直接访问登录页

1. 直接访问 `https://login.gradmotion.com/login`
2. 点击"飞书扫码登录"
3. 授权后，应该跳转到 `https://essay.gradmotion.com/`（默认跳转）

## 预期效果

修复后：
1. ✅ 登录成功后，正确跳转到原始访问的域名（essay 或 blibli）
2. ✅ 不会在 `login.gradmotion.com` 上循环刷新
3. ✅ 用户数据库表存在且数据正常

## 修改文件清单

1. **templates/auth_callback.html**
   - 添加防止循环刷新的保护逻辑
   - 改进跳转逻辑，支持跨域名跳转

2. **static/js/user_menu.js**
   - 保存原始域名到 localStorage
   - 确保跳转时使用正确的域名

3. **scripts/check_auth_database_status.sh**
   - 新增脚本，用于检查用户数据库状态

