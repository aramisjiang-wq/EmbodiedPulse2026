# 登录验证和CSP问题修复指南

**日期**: 2025-12-18  
**版本**: v1.0  
**状态**: ✅ 已修复

## 问题描述

1. **强制登录验证不生效**：用户可以直接访问页面，Tab栏右边显示的是登录按钮，说明强制登录验证没有拦截未登录用户
2. **飞书登录失败**：点击飞书扫码登录后，可以关联到飞书，但回调处理失败，出现CSP（Content Security Policy）错误

## 根本原因

### 问题1：登录验证不生效

1. **执行时机问题**：`user_menu.js` 虽然移到了 `<head>` 部分，但执行逻辑可能等待了 DOMContentLoaded，导致在页面渲染后才执行
2. **脚本加载失败**：浏览器可能缓存了旧版本的HTML，导致 `user_menu.js` 加载失败（404错误）

### 问题2：CSP错误

1. **51.la统计脚本**：在 `<head>` 中直接加载51.la统计脚本，该脚本可能使用了 `eval()` 或 `new Function()`，触发了CSP限制
2. **第三方脚本冲突**：51.la脚本与登录验证脚本同时加载，可能影响登录流程

## 修复方案

### 修复1：优化登录验证执行逻辑

**修改文件**: `static/js/user_menu.js`

**修改内容**:
1. 将登录检查改为立即执行（不等待任何DOM事件）
2. 按钮更新逻辑等待DOM加载完成（因为按钮元素需要渲染）

```javascript
// 立即执行，不等待任何事件
(async function initAuth() {
    // 1. 先执行强制登录检测（这会阻止未登录用户访问）
    const isAuthenticated = await checkAuthRequired();
    
    // 2. 如果通过验证，等待DOM加载后更新导航栏按钮
    if (isAuthenticated) {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateUserButton);
        } else {
            updateUserButton();
        }
    }
})();
```

### 修复2：延迟加载51.la统计脚本

**修改文件**: `templates/index.html`

**修改内容**:
1. 移除 `<head>` 中的直接加载51.la脚本
2. 改为在 `window.load` 事件后动态加载，避免影响登录验证和CSP

```javascript
// 延迟加载51.la统计脚本，避免CSP错误和影响登录验证
window.addEventListener('load', function() {
    const script = document.createElement('script');
    script.charset = 'UTF-8';
    script.id = 'LA_COLLECT';
    script.src = '//sdk.51.la/js-sdk-pro.min.js';
    script.onerror = function() {
        console.warn('51.la统计脚本加载失败，已跳过');
    };
    script.onload = function() {
        if (typeof LA !== 'undefined') {
            try {
                LA.init({id:"3OKJnG7Jx3IolNJ3",ck:"3OKJnG7Jx3IolNJ3",autoTrack:true,hashMode:true});
            } catch(e) {
                console.warn('51.la初始化失败:', e);
            }
        }
    };
    document.head.appendChild(script);
});
```

## 部署步骤

### 步骤1：解决服务器Git冲突

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026

# 备份本地修改（如果有）
git stash save "本地修改备份 $(date +%Y%m%d_%H%M%S)"

# 拉取最新代码
git pull origin main
```

或者使用提供的脚本：

```bash
cd /srv/EmbodiedPulse2026
bash scripts/fix_git_conflict_and_deploy.sh
```

### 步骤2：重启服务

```bash
sudo systemctl restart embodiedpulse
sleep 3
sudo systemctl status embodiedpulse
```

### 步骤3：清除浏览器缓存（重要！）

**必须清除浏览器缓存，否则可能仍加载旧版本的HTML和JavaScript**：

1. **方法1：硬刷新**
   - Windows/Linux: `Ctrl + Shift + R` 或 `Ctrl + F5`
   - Mac: `Cmd + Shift + R`

2. **方法2：清除缓存**
   - 按 F12 打开开发者工具
   - 右键点击刷新按钮
   - 选择"清空缓存并硬性重新加载"

3. **方法3：无痕模式**
   - 使用浏览器的无痕/隐私模式访问

4. **方法4：清除localStorage**
   - 按 F12 打开开发者工具
   - Application → Local Storage → 清除所有数据

## 测试验证

### 测试1：强制登录验证

1. **清除浏览器缓存**（必须！）
2. 访问 `https://essay.gradmotion.com/`
3. **预期结果**：
   - ✅ 应该立即跳转到 `https://essay.gradmotion.com/login`
   - ✅ 浏览器控制台（F12 → Console）没有404错误
   - ✅ `user_menu.js` 已加载（Network标签中返回200）

### 测试2：飞书登录流程

1. 在登录页面点击"飞书扫码登录"按钮
2. **预期结果**：
   - ✅ 跳转到飞书授权页面
   - ✅ 授权后成功返回
   - ✅ 没有CSP错误（浏览器控制台没有CSP相关错误）
   - ✅ 成功登录并跳转到目标页面

### 测试3：已登录用户访问

1. 已登录状态下访问 `https://essay.gradmotion.com/`
2. **预期结果**：
   - ✅ 直接显示页面内容，不跳转到登录页
   - ✅ Tab栏右边显示用户名（不是登录按钮）

## 如果还有问题

### 检查1：确认脚本已加载

在浏览器控制台（F12 → Console）输入：
```javascript
typeof checkAuthRequired
```

- ✅ 返回 `"function"`：脚本已加载
- ❌ 返回 `"undefined"`：脚本未加载，检查Network标签

### 检查2：查看网络请求

在浏览器开发者工具（F12 → Network）中：
1. 刷新页面
2. 搜索 `user_menu.js`
3. 检查请求状态：
   - ✅ 200 OK：脚本加载成功
   - ❌ 404 Not Found：脚本路径错误或文件不存在
   - ❌ 其他错误：网络或服务器问题

### 检查3：查看服务器日志

```bash
sudo journalctl -u embodiedpulse -f
```

查看是否有相关错误。

### 检查4：确认Git代码已更新

```bash
cd /srv/EmbodiedPulse2026
git log --oneline -5
```

确认最新的提交包含修复内容。

## 预期效果

修复后：
1. ✅ 未登录用户访问页面时，立即跳转到登录页
2. ✅ `user_menu.js` 在 `<head>` 部分立即执行，不等待DOM加载
3. ✅ 51.la统计脚本延迟加载，不影响登录验证和CSP
4. ✅ 飞书登录流程正常，没有CSP错误
5. ✅ 已登录用户正常访问，Tab栏显示用户名

## 修改文件清单

1. **static/js/user_menu.js**
   - 优化登录验证执行逻辑，立即执行不等待DOM事件

2. **templates/index.html**
   - 延迟加载51.la统计脚本，避免CSP错误

3. **scripts/fix_git_conflict_and_deploy.sh**
   - 新增脚本，用于解决Git冲突并部署

