# 管理员登录问题排查指南

## 问题描述

管理员登录失败：用户名 `limx`，密码 `limx123456`，登录时提示"用户名或密码错误"。

## 可能原因

1. **数据库中不存在管理员账号**
2. **密码哈希不匹配**（密码被错误修改）
3. **管理员账号状态不是 `active`**
4. **数据库连接配置错误**（使用了错误的数据库）

## 排查步骤

### 1. 检查管理员账号是否存在

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 scripts/check_and_fix_admin.py
```

这个脚本会：
- 检查 `limx` 账号是否存在
- 如果不存在，自动创建
- 如果存在但密码不匹配，自动重置密码
- 确保账号状态为 `active`

### 2. 手动检查数据库

如果脚本执行失败，可以手动检查：

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 << 'EOF'
from flask import Flask
from database import db
from auth_models import AdminUser
import os
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('DATABASE_URL', 'sqlite:///./papers.db')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db.init_app(app)

with app.app_context():
    admin = AdminUser.query.filter_by(username='limx').first()
    if admin:
        print(f"✅ 管理员账号存在")
        print(f"   - ID: {admin.id}")
        print(f"   - 用户名: {admin.username}")
        print(f"   - 状态: {admin.status}")
        print(f"   - 角色: {admin.role}")
    else:
        print("❌ 管理员账号不存在")
EOF
```

### 3. 手动创建/重置管理员账号

如果账号不存在或密码错误，可以手动创建/重置：

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 << 'EOF'
from flask import Flask
from database import db
from auth_models import AdminUser
from werkzeug.security import generate_password_hash
import os
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('DATABASE_URL', 'sqlite:///./papers.db')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db.init_app(app)

with app.app_context():
    username = 'limx'
    password = 'limx123456'
    
    admin = AdminUser.query.filter_by(username=username).first()
    
    if admin:
        print("账号已存在，重置密码...")
        admin.password_hash = generate_password_hash(password)
        admin.status = 'active'
        db.session.commit()
        print("✅ 密码已重置")
    else:
        print("创建新管理员账号...")
        admin = AdminUser(
            username=username,
            password_hash=generate_password_hash(password),
            name='超级管理员',
            role='super_admin',
            status='active'
        )
        db.session.add(admin)
        db.session.commit()
        print(f"✅ 管理员账号创建成功，ID: {admin.id}")
EOF
```

### 4. 检查数据库配置

确认 `.env` 文件中的 `DATABASE_URL` 配置正确：

```bash
cd /srv/EmbodiedPulse2026
grep DATABASE_URL .env
```

确保使用的是正确的数据库（PostgreSQL 或 SQLite）。

### 5. 检查服务日志

查看 Flask 服务日志，看是否有错误信息：

```bash
sudo journalctl -u embodiedpulse -n 100 --no-pager | grep -i "admin\|login\|error"
```

## 快速修复命令

一键修复（推荐）：

```bash
cd /srv/EmbodiedPulse2026
git pull origin main
source venv/bin/activate
python3 scripts/check_and_fix_admin.py
sudo systemctl restart embodiedpulse
```

## 验证登录

修复后，访问 `https://admin123.gradmotion.com/admin/login`，使用以下凭据登录：
- 用户名：`limx`
- 密码：`limx123456`

## 注意事项

1. **密码安全**：生产环境建议修改默认密码
2. **数据库备份**：修改前建议备份数据库
3. **权限检查**：确保 Flask 应用有数据库读写权限

