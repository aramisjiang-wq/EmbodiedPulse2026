# 跨域登录验证修复操作指南

## 修复内容总结

### 问题描述
从 `login.gradmotion.com/profile` 点击"论文清单"或"具身视频"时，页面会在目标页面和登录页面之间不断刷新循环。

### 问题根源
1. 跨域跳转时，token 没有通过 URL 参数传递
2. 目标域名的 localStorage 无法访问源域名的 localStorage
3. `user_menu.js` 检测不到 token，跳转回登录页
4. 形成无限循环

### 修复方案
修改了 `static/js/nav_links.js`：
- `fixNavLink()`: 修正链接时，如果从 `login.gradmotion.com` 跳转到其他域名，自动添加 token 参数
- `navigateTo()`: 使用 `navigateTo()` 跳转时，同样添加 token 参数

## 完整操作步骤

### 第一步：服务器端更新代码

```bash
# 1. SSH 登录服务器
ssh root@your-server-ip

# 2. 进入项目目录
cd /srv/EmbodiedPulse2026

# 3. 拉取最新代码
git pull origin main

# 4. 检查是否有更新
git log --oneline -5

# 5. 重启 Flask 服务（清除缓存）
sudo systemctl restart embodiedpulse

# 6. 检查服务状态
sudo systemctl status embodiedpulse

# 7. 查看服务日志（可选，用于排查问题）
sudo journalctl -u embodiedpulse -f --lines=50
```

### 第二步：客户端测试准备

1. **清除浏览器缓存**
   - Chrome/Edge: `Ctrl+Shift+R` (Windows) 或 `Cmd+Shift+R` (Mac)
   - Firefox: `Ctrl+F5` (Windows) 或 `Cmd+Shift+R` (Mac)
   - Safari: `Cmd+Option+R` (Mac)

2. **打开浏览器开发者工具**
   - 按 `F12` 或 `Ctrl+Shift+I` (Windows) / `Cmd+Option+I` (Mac)
   - 切换到 **Console** 标签
   - 切换到 **Network** 标签（可选，用于查看网络请求）

### 第三步：完整测试流程

#### 测试场景 1：从个人中心跳转到论文页面

1. **访问个人中心**
   ```
   https://login.gradmotion.com/profile
   ```

2. **检查控制台日志**
   - 应该看到：`✅ 已修正 X 个导航链接`
   - 应该看到：用户信息加载成功

3. **点击"论文清单"链接**
   - 观察控制台日志，应该看到：
     ```
     🔗 [fixNavLink] 跨域跳转，添加token参数: essay.gradmotion.com
     ```

4. **跳转后检查**
   - URL 应该包含 token 参数：`https://essay.gradmotion.com/?token=xxx`
   - 控制台应该看到：
     ```
     ✅ 从URL参数中提取到token，正在保存到当前域名: essay.gradmotion.com
     ✅ Token已保存到 essay.gradmotion.com 并清除URL参数
     🔐 [initAuth] 开始初始化登录验证...
     🔍 [checkAuthRequired] 开始检查...
     ✅ [checkAuthRequired] Token验证成功，用户: XXX
     ```
   - 页面应该正常显示，不再跳转回登录页

#### 测试场景 2：从个人中心跳转到视频页面

1. **访问个人中心**
   ```
   https://login.gradmotion.com/profile
   ```

2. **点击"具身视频"链接**
   - 观察控制台日志

3. **跳转后检查**
   - URL 应该包含 token 参数：`https://blibli.gradmotion.com/?token=xxx`
   - 页面应该正常显示视频内容

#### 测试场景 3：直接访问论文/视频页面（已登录状态）

1. **确保已在 `login.gradmotion.com` 登录**
   - 访问 `https://login.gradmotion.com/profile` 确认已登录

2. **在新标签页直接访问**
   ```
   https://essay.gradmotion.com/
   https://blibli.gradmotion.com/
   ```

3. **预期行为**
   - 如果没有 token，应该跳转到登录页
   - 如果之前已经通过 URL 参数保存过 token，应该正常显示

### 第四步：验证修复效果

#### ✅ 成功标志

1. **不再循环刷新**
   - 页面加载后，不会自动跳转回登录页
   - 不会出现页面不断刷新的情况

2. **控制台日志正常**
   - 没有错误信息
   - token 提取和保存成功
   - API 验证成功

3. **功能正常**
   - 可以正常浏览论文/视频内容
   - 导航栏显示用户名
   - 可以正常切换页面

#### ❌ 如果还有问题

**问题 1：仍然循环刷新**

检查步骤：
1. 查看控制台日志，找到错误信息
2. 检查 Network 标签，查看 `/api/auth/user-info` 请求的状态码
3. 检查 localStorage：
   ```javascript
   // 在控制台执行
   localStorage.getItem('auth_token')
   ```

可能原因：
- Token 已过期（需要重新登录）
- API 返回 401（token 无效）
- 网络错误导致验证失败

**问题 2：跳转后没有 token 参数**

检查步骤：
1. 查看控制台日志，确认 `fixNavLink` 是否执行
2. 检查链接的 href 属性：
   ```javascript
   // 在控制台执行
   document.querySelector('a[href*="papers"]').href
   document.querySelector('a[href*="bilibili"]').href
   ```

可能原因：
- `nav_links.js` 没有正确加载
- 链接不是通过 `fixNavLink` 修正的

**问题 3：Token 提取失败**

检查步骤：
1. 查看 URL 中是否有 token 参数
2. 检查控制台日志，确认 `extractAndSaveTokenFromUrl` 是否执行
3. 手动测试：
   ```javascript
   // 在控制台执行
   const urlParams = new URLSearchParams(window.location.search);
   console.log('Token in URL:', urlParams.get('token'));
   ```

### 第五步：故障排查命令

如果遇到问题，可以使用以下命令排查：

```bash
# 1. 检查服务状态
sudo systemctl status embodiedpulse

# 2. 查看服务日志
sudo journalctl -u embodiedpulse -n 100 --no-pager

# 3. 检查 Nginx 配置
sudo nginx -t

# 4. 检查 Nginx 日志
sudo tail -f /var/log/nginx/error.log

# 5. 检查静态文件是否正确部署
ls -la /srv/EmbodiedPulse2026/static/js/nav_links.js

# 6. 检查文件内容（确认修复已应用）
grep -n "跨域跳转" /srv/EmbodiedPulse2026/static/js/nav_links.js
```

### 第六步：回滚方案（如果修复失败）

如果修复后出现新问题，可以回滚到之前的版本：

```bash
# 1. 查看提交历史
cd /srv/EmbodiedPulse2026
git log --oneline -10

# 2. 回滚到修复前的版本（替换 COMMIT_HASH 为实际值）
git reset --hard COMMIT_HASH

# 3. 重启服务
sudo systemctl restart embodiedpulse
```

## 预期结果

修复成功后，应该能够：

1. ✅ 从 `login.gradmotion.com/profile` 正常跳转到 `essay.gradmotion.com` 或 `blibli.gradmotion.com`
2. ✅ 跳转后页面正常显示，不再循环刷新
3. ✅ 可以正常浏览论文和视频内容
4. ✅ 导航栏显示正确的用户信息
5. ✅ 可以在不同域名之间正常切换

## 注意事项

1. **清除缓存很重要**
   - 浏览器可能缓存了旧的 JavaScript 文件
   - 必须强制刷新才能加载新代码

2. **跨域 localStorage 限制**
   - 不同域名的 localStorage 是完全隔离的
   - 必须通过 URL 参数传递 token

3. **Token 安全性**
   - Token 通过 URL 参数传递后，会被立即清除
   - 不会在浏览器历史记录中保留 token

4. **日志监控**
   - 建议在生产环境监控相关日志
   - 关注 token 验证失败的情况

## 相关文件

- `static/js/nav_links.js` - 导航链接修正工具（已修复）
- `static/js/user_menu.js` - 登录验证逻辑（已优化）
- `templates/profile.html` - 个人中心页面
- `templates/auth_callback.html` - 登录回调页面

## 更新记录

- 2025-12-18 v1.0: 初始版本，修复跨域跳转 token 传递问题

