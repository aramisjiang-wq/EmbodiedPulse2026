# 飞书登录问题排查指南

**日期**: 2025-12-18  
**版本**: v1.0

## 问题描述

飞书扫码登录授权后，提示"登录验证失败，请重试"，同时可能有CSP错误。

## 排查步骤

### 步骤1：在服务器上运行诊断脚本

```bash
cd /srv/EmbodiedPulse2026
bash scripts/diagnose_feishu_login.sh
```

这个脚本会检查：
- 飞书环境变量配置
- 服务运行状态
- 最近的错误日志
- 飞书API连接

### 步骤2：查看实时日志

在服务器上执行：

```bash
sudo journalctl -u embodiedpulse -f
```

然后重新尝试登录，观察日志输出。

### 步骤3：检查常见问题

#### 问题1：State参数验证失败

**症状**: 日志显示 "无效的state参数"

**原因**: 
- State参数过期（超过10分钟）
- 多次点击登录按钮导致state被消费

**解决**: 
- 重新点击登录按钮
- 确保在10分钟内完成授权

#### 问题2：飞书API调用失败

**症状**: 日志显示 "获取app_access_token失败" 或 "获取user_access_token失败"

**原因**:
- 飞书App ID或App Secret配置错误
- 网络连接问题
- 飞书API限流

**解决**:
1. 检查 `.env` 文件中的配置：
   ```bash
   cd /srv/EmbodiedPulse2026
   grep FEISHU .env
   ```

2. 验证配置是否正确：
   ```bash
   bash scripts/diagnose_feishu_login.sh
   ```

3. 检查飞书开放平台配置：
   - 确认App ID和App Secret正确
   - 确认回调地址配置正确：`https://login.gradmotion.com/api/auth/feishu/callback`

#### 问题3：无法获取用户ID

**症状**: 日志显示 "无法获取飞书用户ID"

**原因**:
- 飞书API返回的用户信息格式不正确
- 用户信息中缺少 `user_id` 或 `open_id`

**解决**:
- 查看详细日志，确认飞书API返回的数据格式
- 检查飞书应用权限配置

#### 问题4：CSP错误

**症状**: 浏览器控制台显示CSP错误

**原因**:
- 51.la统计脚本使用了 `eval()`
- 其他第三方脚本触发了CSP限制

**解决**:
- 51.la脚本已延迟加载，不应该影响登录流程
- 如果仍有问题，可以暂时禁用51.la统计

## 错误代码说明

根据URL参数中的 `error` 值，可以判断具体错误：

- `missing_params`: 回调参数缺失（code或state）
- `invalid_state`: State参数验证失败
- `no_user_id`: 无法获取飞书用户ID
- `callback_failed`: 回调处理失败（通用错误）
- `feishu_config_error`: 飞书配置错误
- `invalid_code`: 授权码无效或已过期

## 调试技巧

### 1. 查看完整错误堆栈

在服务器日志中查找 `traceback` 或 `Exception`，查看完整的错误信息。

### 2. 检查回调URL

确认飞书回调URL是否正确：
- 应该指向：`https://login.gradmotion.com/api/auth/feishu/callback`
- 在飞书开放平台中配置的回调地址必须完全匹配

### 3. 测试飞书API连接

```bash
cd /srv/EmbodiedPulse2026
python3 << 'EOF'
import os
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
from dotenv import load_dotenv
load_dotenv()

from feishu_auth import FeishuAuth

try:
    auth = FeishuAuth()
    token = auth.get_app_access_token()
    print(f"✅ 成功获取app_access_token: {token[:20]}...")
except Exception as e:
    print(f"❌ 失败: {e}")
    import traceback
    traceback.print_exc()
EOF
```

### 4. 检查数据库连接

确保数据库连接正常，用户信息可以正确保存。

## 修复后的改进

1. **增强错误日志**: 所有错误都会记录详细的日志信息
2. **自动清理过期state**: 超过10分钟的state会自动清理
3. **更详细的错误信息**: 回调页面会显示具体的错误原因
4. **诊断脚本**: 提供自动化诊断工具

## 如果问题仍然存在

1. **收集信息**:
   - 运行诊断脚本的输出
   - 服务器日志（最近100行）
   - 浏览器控制台的错误信息
   - 网络请求详情（F12 → Network）

2. **检查配置**:
   - 飞书开放平台的回调地址配置
   - 服务器上的 `.env` 文件
   - Nginx配置（确保HTTPS正确配置）

3. **测试步骤**:
   - 清除浏览器缓存
   - 使用无痕模式测试
   - 检查网络连接

