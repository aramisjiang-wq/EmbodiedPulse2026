# 飞书登录验证失败问题排查

**日期**: 2025-12-18  
**版本**: v1.0

## 问题描述

点击"飞书扫码登录"按钮后，可以跳转到飞书授权页面，但授权后返回时提示"登录验证失败，请重试"。

## 可能原因

### 1. State参数过期或已被消费（最常见）

**症状**: 
- 日志显示 "无效的state参数"
- 错误信息：`invalid_state`

**原因**:
- State参数有效期只有10分钟
- 如果用户授权时间过长，state可能过期
- 如果多次点击登录按钮，之前的state可能已被消费

**解决**:
1. 重新点击"飞书扫码登录"按钮
2. 确保在10分钟内完成授权
3. 不要多次点击登录按钮

### 2. 飞书API调用失败

**症状**:
- 日志显示 "获取app_access_token失败" 或 "获取user_access_token失败"
- 错误信息：`feishu_config_error` 或 `invalid_code`

**原因**:
- 飞书App ID或App Secret配置错误
- 网络连接问题
- 飞书API限流

**解决**:
1. 检查服务器配置：
   ```bash
   cd /srv/EmbodiedPulse2026
   grep FEISHU .env
   ```

2. 运行诊断脚本：
   ```bash
   bash scripts/diagnose_feishu_login.sh
   ```

3. 检查飞书开放平台配置

### 3. 无法获取用户ID

**症状**:
- 日志显示 "无法获取飞书用户ID"
- 错误信息：`no_user_id`

**原因**:
- 飞书API返回的用户信息格式不正确
- 用户信息中缺少 `user_id` 或 `open_id`

**解决**:
- 查看服务器日志，确认飞书API返回的数据格式
- 检查飞书应用权限配置

## 排查步骤

### 步骤1：运行错误检查脚本

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
bash scripts/check_feishu_login_error.sh
```

这个脚本会：
- 显示最近的飞书登录相关日志
- 显示最近的错误和异常
- 测试飞书API连接

### 步骤2：查看实时日志

```bash
sudo journalctl -u embodiedpulse -f
```

然后重新尝试登录，观察日志输出。

### 步骤3：检查具体错误

根据日志中的错误信息，参考上面的"可能原因"进行修复。

## 常见错误代码

| 错误代码 | 含义 | 解决方法 |
|---------|------|---------|
| `invalid_state` | State参数验证失败 | 重新点击登录按钮 |
| `missing_params` | 回调参数缺失 | 检查飞书回调配置 |
| `no_user_id` | 无法获取用户ID | 检查飞书应用权限 |
| `callback_failed` | 回调处理失败 | 查看详细日志 |
| `feishu_config_error` | 飞书配置错误 | 检查.env配置 |
| `invalid_code` | 授权码无效 | 重新登录 |

## 关于CSP错误

浏览器控制台中的CSP错误（`bdms.js`、`28506.js`）通常来自：
- 浏览器扩展
- 第三方注入脚本

这些错误**不会影响**飞书登录功能，可以忽略。

如果CSP错误确实影响了功能，可以：
1. 禁用浏览器扩展后重试
2. 使用无痕模式测试

## 快速修复

如果遇到"登录验证失败，请重试"：

1. **清除浏览器缓存**（重要！）
   - 硬刷新：`Ctrl + Shift + R` (Windows) 或 `Cmd + Shift + R` (Mac)
   - 或使用无痕模式

2. **重新点击登录按钮**
   - 不要多次点击
   - 确保在10分钟内完成授权

3. **检查服务器日志**
   ```bash
   sudo journalctl -u embodiedpulse -n 50 | grep -i "feishu\|error"
   ```

## 如果问题仍然存在

1. **收集信息**:
   - 运行 `bash scripts/check_feishu_login_error.sh` 的输出
   - 服务器日志（最近100行）
   - 浏览器控制台的错误信息

2. **检查配置**:
   - 飞书开放平台的回调地址：`https://login.gradmotion.com/api/auth/feishu/callback`
   - 服务器上的 `.env` 文件中的飞书配置

3. **测试步骤**:
   - 清除浏览器缓存
   - 使用无痕模式
   - 检查网络连接

