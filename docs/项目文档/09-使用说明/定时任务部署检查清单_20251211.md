# 定时任务部署检查清单

**创建时间**：2025年12月11日  
**目的**：确保部署上线后，论文、新闻、岗位机会能够自动更新

---

## ✅ 部署前检查

### 1. 依赖检查

- [ ] **APScheduler 已安装**
  ```bash
  pip install apscheduler
  # 或
  pip install -r requirements.txt
  ```

- [ ] **所有Python依赖已安装**
  ```bash
  pip install -r requirements.txt
  ```

---

### 2. 环境变量配置

#### 必需环境变量

- [ ] **`AUTO_FETCH_ENABLED=true`**
  ```bash
  export AUTO_FETCH_ENABLED=true
  ```

#### 可选环境变量（建议配置）

- [ ] **`AUTO_FETCH_SCHEDULE`** - 论文抓取时间（默认：`0 * * * *`，每小时整点）
  ```bash
  export AUTO_FETCH_SCHEDULE="0 * * * *"
  ```

- [ ] **`AUTO_FETCH_NEWS_SCHEDULE`** - 新闻抓取时间（默认：`0 * * * *`，每小时整点）
  ```bash
  export AUTO_FETCH_NEWS_SCHEDULE="0 * * * *"
  ```

- [ ] **`AUTO_FETCH_JOBS_SCHEDULE`** - 招聘抓取时间（默认：`0 * * * *`，每小时整点）
  ```bash
  export AUTO_FETCH_JOBS_SCHEDULE="0 * * * *"
  ```

- [ ] **`AUTO_FETCH_MAX_RESULTS`** - 每次抓取论文数量（默认：100）
  ```bash
  export AUTO_FETCH_MAX_RESULTS=100
  ```

---

### 3. 配置文件检查

- [ ] **`config.yaml` 存在且配置正确**
  ```bash
  ls -l config.yaml
  ```

- [ ] **数据库文件可写**
  ```bash
  touch papers.db news.db jobs.db
  chmod 666 papers.db news.db jobs.db
  ```

---

### 4. 代码检查

- [ ] **`gunicorn_config.py` 中的 `when_ready` hook 已配置**
  ```python
  def when_ready(server):
      from app import init_scheduler
      init_scheduler()
  ```

- [ ] **`app.py` 中的 `init_scheduler()` 函数存在**

---

## 🚀 部署方式

### 方式1：直接运行（开发环境）

**启动命令**：
```bash
export AUTO_FETCH_ENABLED=true
python3 app.py
```

**验证**：
- 查看启动日志，应该看到：`✅ 自动定时抓取已启用`
- 检查定时任务是否启动

---

### 方式2：Gunicorn启动（生产环境）

**启动命令**：
```bash
export AUTO_FETCH_ENABLED=true
gunicorn -c gunicorn_config.py app:app
```

**验证**：
- 查看启动日志，应该看到：`✅ 定时任务调度器已在Gunicorn启动时初始化`
- 检查定时任务是否启动

---

### 方式3：Docker部署

**启动命令**：
```bash
docker-compose up -d
```

**配置检查**：
- [ ] `docker-compose.yml` 中设置了 `AUTO_FETCH_ENABLED=true`
- [ ] `docker-compose.yml` 中设置了所有必要的环境变量

**验证**：
- 查看容器日志：`docker-compose logs web`
- 应该看到定时任务启动的日志

---

### 方式4：免费平台部署（Railway/Render/Fly.io）

**配置检查**：
- [ ] 在平台设置中添加环境变量 `AUTO_FETCH_ENABLED=true`
- [ ] 在平台设置中添加其他环境变量（如 `AUTO_FETCH_SCHEDULE` 等）
- [ ] `Procfile` 或启动命令使用 Gunicorn

**验证**：
- 查看平台日志
- 应该看到定时任务启动的日志

---

## 🔍 部署后验证

### 1. 检查定时任务是否启动

**方法1：查看日志**
```bash
# 直接运行
tail -f app.log | grep "定时任务"

# Gunicorn
gunicorn -c gunicorn_config.py app:app 2>&1 | grep "定时任务"

# Docker
docker-compose logs web | grep "定时任务"
```

**应该看到**：
- `✅ 定时任务调度器已启动`
- `定时任务已配置 (每小时论文抓取_1): 0 * * * *`
- `招聘信息抓取定时任务已配置`
- `新闻信息抓取定时任务已配置`

---

### 2. 检查定时任务列表

**Python脚本**：
```python
from app import scheduler
if scheduler:
    jobs = scheduler.get_jobs()
    for job in jobs:
        print(f"{job.name}: 下次执行时间 = {job.next_run_time}")
else:
    print("定时任务未启动")
```

**应该看到**：
- `每小时论文抓取_1: 下次执行时间 = ...`
- `招聘信息抓取_1: 下次执行时间 = ...`
- `新闻信息抓取_1: 下次执行时间 = ...`
- `每天Semantic Scholar数据更新: 下次执行时间 = ...`

---

### 3. 等待第一个定时任务执行

**方法1：查看日志**
- 等待到下一个整点（如果配置为每小时整点）
- 查看日志，应该看到任务执行的日志

**方法2：检查数据库**
- 等待定时任务执行后
- 检查数据库是否有新数据

---

### 4. 手动触发测试

**方法1：通过API**
```bash
curl -X POST http://localhost:5001/api/refresh-all
```

**方法2：直接调用函数**
```python
from fetch_new_data import fetch_papers
from fetch_news import fetch_and_save_news
from fetch_jobs import fetch_and_save_jobs

fetch_papers()
fetch_and_save_news()
fetch_and_save_jobs()
```

---

## ⚠️ 常见问题

### 问题1：定时任务未启动

**症状**：
- 日志中没有看到定时任务启动的信息
- 数据库没有自动更新

**排查步骤**：
1. 检查 `AUTO_FETCH_ENABLED` 是否为 `true`
2. 检查 `APScheduler` 是否安装：`pip list | grep apscheduler`
3. 检查 `gunicorn_config.py` 中的 `when_ready` hook 是否存在
4. 查看错误日志

---

### 问题2：定时任务重复执行

**症状**：
- 同一时间执行了多次相同的任务
- 日志中出现重复的执行记录

**原因**：
- 多个worker进程都启动了定时任务

**解决方法**：
- 确保使用 Gunicorn 的 `when_ready` hook（只在master进程执行）
- 不要在每个worker进程中启动定时任务

---

### 问题3：定时任务执行失败

**症状**：
- 日志中出现错误信息
- 数据库没有更新

**排查步骤**：
1. 查看错误日志，找到具体错误信息
2. 检查配置文件是否存在：`ls -l config.yaml`
3. 检查依赖是否安装：`pip install -r requirements.txt`
4. 检查网络连接（如果涉及外部API）

---

## 📋 快速检查命令

```bash
# 1. 检查环境变量
echo "AUTO_FETCH_ENABLED=$AUTO_FETCH_ENABLED"
echo "AUTO_FETCH_SCHEDULE=$AUTO_FETCH_SCHEDULE"

# 2. 检查依赖
pip list | grep -E "apscheduler|flask|gunicorn"

# 3. 检查配置文件
ls -l config.yaml gunicorn_config.py

# 4. 测试定时任务启动
python3 -c "from app import init_scheduler; import os; os.environ['AUTO_FETCH_ENABLED']='true'; s = init_scheduler(); print('✅ 定时任务启动成功' if s else '❌ 定时任务启动失败')"

# 5. 查看定时任务列表
python3 -c "from app import scheduler; [print(f'{j.name}: {j.next_run_time}') for j in (scheduler.get_jobs() if scheduler else [])]"
```

---

## 🎯 部署成功标志

部署成功后，应该满足以下条件：

1. ✅ **启动日志显示定时任务已启动**
2. ✅ **定时任务列表包含4个任务**（论文、新闻、招聘、Semantic Scholar）
3. ✅ **等待到执行时间后，日志显示任务执行**
4. ✅ **数据库中有新数据**
5. ✅ **API可以正常访问**

---

**最后更新**：2025年12月11日  
**维护者**：AI开发助手





