# 定时任务配置说明

**创建时间**：2025年12月10日  
**项目名称**：Robotics ArXiv Daily (Embodied Pulse)  
**版本**：v1.2.2

---

## 📋 目录

1. [概述](#概述)
2. [Cron表达式格式](#cron表达式格式)
3. [环境变量配置](#环境变量配置)
4. [配置示例](#配置示例)
5. [常见场景](#常见场景)
6. [验证配置](#验证配置)
7. [故障排查](#故障排查)

---

## 📖 概述

项目支持使用**Cron表达式**来配置定时任务，可以灵活控制论文抓取和新闻刷新的执行时间。

### 支持的定时任务

1. **论文抓取**：从ArXiv抓取最新论文
2. **新闻抓取**：抓取具身智能相关新闻
3. **招聘信息抓取**：抓取招聘信息（可选，支持cron或interval）

### 配置方式

- **环境变量**：通过环境变量配置cron表达式
- **Docker Compose**：在`docker-compose.yml`中配置
- **直接运行**：在启动命令中设置环境变量

---

## ⏰ Cron表达式格式

### 标准格式

```
分钟 小时 日 月 星期
```

### 字段说明

| 字段 | 取值范围 | 说明 |
|------|---------|------|
| **分钟** | 0-59 | 每小时的第几分钟执行 |
| **小时** | 0-23 | 每天的第几小时执行 |
| **日** | 1-31 | 每月的第几天执行 |
| **月** | 1-12 | 每年的第几月执行 |
| **星期** | 0-7 | 每周的第几天执行（0和7都表示周日） |

### 特殊字符

| 字符 | 说明 | 示例 |
|------|------|------|
| `*` | 匹配所有值 | `* * * * *` 表示每分钟执行 |
| `,` | 指定多个值 | `0 8,20 * * *` 表示每天8点和20点执行 |
| `-` | 指定范围 | `0 9-17 * * *` 表示每天9点到17点每小时执行 |
| `/` | 指定间隔 | `0 */6 * * *` 表示每6小时执行一次（0点、6点、12点、18点） |

---

## ⚙️ 环境变量配置

### 论文抓取配置

**环境变量**：`AUTO_FETCH_SCHEDULE`

**说明**：配置论文抓取的cron表达式

**默认值**：`0 * * * *`（每小时整点执行）

**示例**：
```bash
# 每小时整点执行
AUTO_FETCH_SCHEDULE="0 * * * *"

# 每天凌晨2点执行
AUTO_FETCH_SCHEDULE="0 2 * * *"

# 每天8点和20点执行
AUTO_FETCH_SCHEDULE="0 8,20 * * *"

# 每6小时执行一次
AUTO_FETCH_SCHEDULE="0 */6 * * *"

# 支持多个时间点（用分号分隔）
AUTO_FETCH_SCHEDULE="0 8 * * *;0 20 * * *"  # 每天8点和20点
```

### 新闻抓取配置

**环境变量**：`AUTO_FETCH_NEWS_SCHEDULE`

**说明**：配置新闻抓取的cron表达式

**默认值**：`0 * * * *`（每小时整点执行）

**示例**：
```bash
# 每小时整点执行
AUTO_FETCH_NEWS_SCHEDULE="0 * * * *"

# 每30分钟执行一次
AUTO_FETCH_NEWS_SCHEDULE="*/30 * * * *"

# 每天8点、12点、18点执行
AUTO_FETCH_NEWS_SCHEDULE="0 8,12,18 * * *"
```

### 招聘信息抓取配置（可选）

**环境变量**：`AUTO_FETCH_JOBS_SCHEDULE`

**说明**：配置招聘信息抓取的cron表达式（如果未设置，默认使用interval模式，每小时执行一次）

**示例**：
```bash
# 使用cron表达式：每天8点执行
AUTO_FETCH_JOBS_SCHEDULE="0 8 * * *"

# 不设置此变量：使用默认的interval模式（每小时执行一次）
```

### 其他配置

| 环境变量 | 说明 | 默认值 |
|---------|------|--------|
| `AUTO_FETCH_ENABLED` | 是否启用自动抓取 | `false` |
| `AUTO_FETCH_MAX_RESULTS` | 每次抓取最大论文数 | `10` |

---

## 📝 配置示例

### 示例1：每小时执行一次（推荐）

**场景**：希望每小时自动抓取最新论文和新闻

**配置**：
```bash
AUTO_FETCH_ENABLED=true
AUTO_FETCH_SCHEDULE="0 * * * *"          # 每小时整点抓取论文
AUTO_FETCH_NEWS_SCHEDULE="0 * * * *"    # 每小时整点抓取新闻
AUTO_FETCH_MAX_RESULTS=100
```

**执行时间**：每天0:00, 1:00, 2:00, ..., 23:00

### 示例2：每天特定时间执行

**场景**：希望每天8点和20点各执行一次

**配置**：
```bash
AUTO_FETCH_ENABLED=true
AUTO_FETCH_SCHEDULE="0 8,20 * * *"      # 每天8点和20点抓取论文
AUTO_FETCH_NEWS_SCHEDULE="0 8,20 * * *" # 每天8点和20点抓取新闻
AUTO_FETCH_MAX_RESULTS=100
```

**执行时间**：每天8:00和20:00

### 示例3：每6小时执行一次

**场景**：希望每6小时执行一次

**配置**：
```bash
AUTO_FETCH_ENABLED=true
AUTO_FETCH_SCHEDULE="0 */6 * * *"       # 每6小时执行一次（0点、6点、12点、18点）
AUTO_FETCH_NEWS_SCHEDULE="0 */6 * * *" # 每6小时执行一次
AUTO_FETCH_MAX_RESULTS=100
```

**执行时间**：每天0:00, 6:00, 12:00, 18:00

### 示例4：论文和新闻不同频率

**场景**：论文每小时抓取，新闻每30分钟抓取

**配置**：
```bash
AUTO_FETCH_ENABLED=true
AUTO_FETCH_SCHEDULE="0 * * * *"         # 每小时整点抓取论文
AUTO_FETCH_NEWS_SCHEDULE="*/30 * * * *" # 每30分钟抓取新闻
AUTO_FETCH_MAX_RESULTS=100
```

**执行时间**：
- 论文：0:00, 1:00, 2:00, ..., 23:00
- 新闻：0:00, 0:30, 1:00, 1:30, ..., 23:30

### 示例5：Docker Compose配置

**文件**：`docker-compose.yml`

```yaml
services:
  web:
    environment:
      - AUTO_FETCH_ENABLED=true
      - AUTO_FETCH_SCHEDULE=0 * * * *          # 每小时整点执行论文抓取
      - AUTO_FETCH_NEWS_SCHEDULE=0 * * * *     # 每小时整点执行新闻抓取
      - AUTO_FETCH_MAX_RESULTS=100
```

---

## 🎯 常见场景

### 场景1：开发环境（频繁更新）

**需求**：开发时希望频繁更新数据

**配置**：
```bash
AUTO_FETCH_SCHEDULE="*/30 * * * *"      # 每30分钟执行一次
AUTO_FETCH_NEWS_SCHEDULE="*/30 * * * *" # 每30分钟执行一次
```

### 场景2：生产环境（稳定运行）

**需求**：生产环境每小时更新一次

**配置**：
```bash
AUTO_FETCH_SCHEDULE="0 * * * *"        # 每小时整点执行
AUTO_FETCH_NEWS_SCHEDULE="0 * * * *"   # 每小时整点执行
```

### 场景3：节省资源（低频更新）

**需求**：每天只更新几次，节省服务器资源

**配置**：
```bash
AUTO_FETCH_SCHEDULE="0 8,14,20 * * *"  # 每天8点、14点、20点执行
AUTO_FETCH_NEWS_SCHEDULE="0 8,14,20 * * *"
```

### 场景4：工作日更新

**需求**：只在工作日（周一到周五）更新

**配置**：
```bash
AUTO_FETCH_SCHEDULE="0 9 * * 1-5"      # 工作日每天9点执行
AUTO_FETCH_NEWS_SCHEDULE="0 9 * * 1-5" # 工作日每天9点执行
```

---

## ✅ 验证配置

### 1. 查看日志

启动服务器后，查看日志确认定时任务已配置：

```bash
# 查看日志
tail -f /path/to/logfile

# 或查看Docker日志
docker-compose logs -f web
```

**预期输出**：
```
定时任务已配置 (每小时论文抓取_1): 0 * * * *
新闻信息抓取定时任务已配置 (定时新闻抓取_1): 0 * * * *
```

### 2. 检查环境变量

```bash
# 在容器中检查
docker-compose exec web env | grep AUTO_FETCH

# 或直接运行Python检查
python3 -c "import os; print('论文:', os.getenv('AUTO_FETCH_SCHEDULE', '未设置')); print('新闻:', os.getenv('AUTO_FETCH_NEWS_SCHEDULE', '未设置'))"
```

### 3. 测试执行

手动触发一次抓取，确认功能正常：

```bash
# 通过API触发
curl -X POST http://localhost:5001/api/refresh-all
```

### 4. 查看下次执行时间

查看APScheduler的日志，确认下次执行时间：

```bash
# 查看日志中的定时任务信息
grep "定时任务已配置" /path/to/logfile
```

---

## 🔧 故障排查

### 问题1：定时任务不执行

**可能原因**：
1. `AUTO_FETCH_ENABLED`未设置为`true`
2. Cron表达式格式错误
3. APScheduler未正确启动

**解决方法**：
```bash
# 1. 检查环境变量
echo $AUTO_FETCH_ENABLED
echo $AUTO_FETCH_SCHEDULE

# 2. 检查日志
grep "定时任务已配置" /path/to/logfile

# 3. 检查APScheduler是否启动
grep "scheduler" /path/to/logfile
```

### 问题2：Cron表达式格式错误

**错误示例**：
```bash
# 错误：缺少字段
AUTO_FETCH_SCHEDULE="0 * * *"

# 错误：字段值超出范围
AUTO_FETCH_SCHEDULE="60 * * * *"  # 分钟不能是60
```

**正确格式**：
```bash
# 正确：5个字段
AUTO_FETCH_SCHEDULE="0 * * * *"
```

### 问题3：任务执行但无数据

**可能原因**：
1. ArXiv没有新论文
2. 网络连接问题
3. API限制

**解决方法**：
```bash
# 1. 查看抓取日志
grep "开始执行定时抓取任务" /path/to/logfile

# 2. 手动触发一次，查看详细日志
curl -X POST http://localhost:5001/api/refresh-all

# 3. 检查网络连接
curl https://arxiv.org/list/cs.RO/recent
```

### 问题4：任务执行时间不准确

**可能原因**：
1. 服务器时区设置不正确
2. Cron表达式理解错误

**解决方法**：
```bash
# 1. 检查服务器时区
date
timedatectl  # Linux系统

# 2. 确认Cron表达式
# 注意：Cron表达式使用的是服务器本地时间
```

---

## 📚 Cron表达式参考

### 常用表达式

| 表达式 | 说明 | 执行时间 |
|--------|------|---------|
| `0 * * * *` | 每小时整点 | 0:00, 1:00, 2:00, ..., 23:00 |
| `*/30 * * * *` | 每30分钟 | 0:00, 0:30, 1:00, 1:30, ... |
| `0 */6 * * *` | 每6小时 | 0:00, 6:00, 12:00, 18:00 |
| `0 8,20 * * *` | 每天8点和20点 | 每天8:00和20:00 |
| `0 9 * * 1-5` | 工作日每天9点 | 周一到周五9:00 |
| `0 2 * * *` | 每天凌晨2点 | 每天2:00 |
| `0 0 1 * *` | 每月1号凌晨 | 每月1号0:00 |

### 在线工具

- **Crontab Guru**：https://crontab.guru/
- **Cron Expression Generator**：https://www.freeformatter.com/cron-expression-generator-quartz.html

---

## 📝 更新记录

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|---------|--------|
| 2025-12-10 | v1.0 | 初始版本，支持cron表达式配置 | AI开发助手 |

---

**最后更新**：2025年12月10日  
**维护者**：开发团队





