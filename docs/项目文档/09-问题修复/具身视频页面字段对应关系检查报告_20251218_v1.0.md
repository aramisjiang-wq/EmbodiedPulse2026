# å…·èº«è§†é¢‘é¡µé¢å­—æ®µå¯¹åº”å…³ç³»æ£€æŸ¥æŠ¥å‘Š

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-18  
**æ£€æŸ¥èŒƒå›´**: å‰ç«¯ã€åç«¯APIã€æ•°æ®åº“ä¸‰è€…çš„å­—æ®µå¯¹åº”å…³ç³»

---

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

æœ¬æ¬¡æ£€æŸ¥é’ˆå¯¹å…·èº«è§†é¢‘é¡µé¢ä¸­"æ€»æ’­æ”¾"å’Œ"æ€»è§†é¢‘"ä¸¤ä¸ªå­—æ®µï¼ŒéªŒè¯å‰ç«¯æ˜¾ç¤ºã€åç«¯APIè¿”å›å’Œæ•°æ®åº“å­˜å‚¨ä¹‹é—´çš„å¯¹åº”å…³ç³»æ˜¯å¦æ­£ç¡®ã€‚

---

## ğŸ” å­—æ®µå¯¹åº”å…³ç³»åˆ†æ

### 1. æ•°æ®åº“å­—æ®µï¼ˆbilibili_models.pyï¼‰

**è¡¨å**: `bilibili_ups`

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `videos_count` | Integer | è§†é¢‘æ€»æ•° |
| `views_count` | BigInteger | æ€»æ’­æ”¾é‡ï¼ˆåŸå§‹æ•°å€¼ï¼‰ |
| `views_formatted` | String | æ€»æ’­æ”¾é‡ï¼ˆæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¦‚"1.2ä¸‡"ï¼‰ |

**æ•°æ®æ¥æº**: 
- `videos_count` â† `user_stat.get('videos', 0)` ï¼ˆfetch_bilibili_data.py ç¬¬91è¡Œï¼‰
- `views_count` â† `user_stat.get('views', 0)` ï¼ˆfetch_bilibili_data.py ç¬¬92è¡Œï¼‰

---

### 2. åç«¯APIè¿”å›ï¼ˆapp.py `/api/bilibili/all`ï¼‰

**ä»£ç ä½ç½®**: `app.py` ç¬¬1320-1346è¡Œ

```python
# æ„å»ºuser_statï¼ˆç¡®ä¿æ­£ç¡®å¤„ç†ï¼‰
videos_val = format_number(up.videos_count) if up.videos_count else '0'
views_val = up.views_formatted or (format_number(up.views_count) if up.views_count else '0')
likes_val = up.likes_formatted or (format_number(up.likes_count) if up.likes_count else '0')

# æ„å»ºå“åº”æ•°æ®
card_data = {
    'user_stat': {
        'videos': videos_val,  # æ€»è§†é¢‘æ•°ï¼ˆæ ¼å¼åŒ–ï¼‰
        'likes': likes_val,
        'views': views_val,    # æ€»æ’­æ”¾é‡ï¼ˆæ ¼å¼åŒ–ï¼‰
    },
    ...
}
```

**å­—æ®µæ˜ å°„**:
- æ•°æ®åº“ `videos_count` â†’ API `user_stat.videos` âœ…
- æ•°æ®åº“ `views_count` / `views_formatted` â†’ API `user_stat.views` âœ…

---

### 3. å‰ç«¯æ˜¾ç¤ºï¼ˆbilibili.htmlï¼‰

**ä»£ç ä½ç½®**: `bilibili.html` ç¬¬1806å’Œ1825è¡Œ

```javascript
const userStat = card.user_stat || {};
const viewsValue = escapeHtml(userStat.views || '0');
const videosValue = escapeHtml(userStat.videos || '0');

// æ˜¾ç¤º
<div class="bilibili-card-stat-value">${viewsValue}</div>
<div class="bilibili-card-stat-label">æ€»æ’­æ”¾</div>

<div class="bilibili-card-stat-value">${videosValue}</div>
<div class="bilibili-card-stat-label">æ€»è§†é¢‘</div>
```

**å­—æ®µæ˜ å°„**:
- API `user_stat.views` â†’ å‰ç«¯æ˜¾ç¤º"æ€»æ’­æ”¾" âœ…
- API `user_stat.videos` â†’ å‰ç«¯æ˜¾ç¤º"æ€»è§†é¢‘" âœ…

---

## âœ… å¯¹åº”å…³ç³»æ€»ç»“

### å®Œæ•´æ•°æ®æµ

```
Bç«™API (bilibili_client.py)
    â†“
    user_stat = {
        'videos': video_count,    # è§†é¢‘æ•°é‡
        'views': total_views,      # æ€»æ’­æ”¾æ•°
    }
    â†“
æ•°æ®åº“ (fetch_bilibili_data.py)
    â†“
    up.videos_count = user_stat.get('videos', 0)  # è§†é¢‘æ•°é‡ âœ…
    up.views_count = user_stat.get('views', 0)    # æ€»æ’­æ”¾æ•° âœ…
    â†“
åç«¯API (app.py)
    â†“
    user_stat = {
        'videos': format_number(up.videos_count),  # æ€»è§†é¢‘æ•° âœ…
        'views': format_number(up.views_count),     # æ€»æ’­æ”¾é‡ âœ…
    }
    â†“
å‰ç«¯æ˜¾ç¤º (bilibili.html)
    â†“
    userStat.views â†’ "æ€»æ’­æ”¾" âœ…
    userStat.videos â†’ "æ€»è§†é¢‘" âœ…
```

---

## ğŸ” è¯¦ç»†æ£€æŸ¥ç»“æœ

### æ£€æŸ¥é¡¹1ï¼šæ•°æ®åº“å­—æ®µå®šä¹‰

**æ–‡ä»¶**: `bilibili_models.py`

**æ£€æŸ¥ç»“æœ**: âœ… **æ­£ç¡®**
- `videos_count` (Integer) - è§†é¢‘æ€»æ•°
- `views_count` (BigInteger) - æ€»æ’­æ”¾é‡
- `views_formatted` (String) - æ€»æ’­æ”¾é‡ï¼ˆæ ¼å¼åŒ–ï¼‰

**å­—æ®µå«ä¹‰æ¸…æ™°ï¼Œæ— æ­§ä¹‰**

---

### æ£€æŸ¥é¡¹2ï¼šæ•°æ®æŠ“å–æ—¶çš„å­—æ®µæ˜ å°„

**æ–‡ä»¶**: `fetch_bilibili_data.py` ç¬¬91-92è¡Œ

```python
up.videos_count = user_stat.get('videos', 0)  # è§†é¢‘æ•°é‡
up.views_count = user_stat.get('views', 0)    # æ€»æ’­æ”¾æ•°
```

**æ£€æŸ¥ç»“æœ**: âœ… **æ­£ç¡®**
- `user_stat['videos']` â†’ `videos_count` âœ…
- `user_stat['views']` â†’ `views_count` âœ…

**æ˜ å°„å…³ç³»æ­£ç¡®**

---

### æ£€æŸ¥é¡¹3ï¼šAPIè¿”å›æ—¶çš„å­—æ®µæ˜ å°„

**æ–‡ä»¶**: `app.py` ç¬¬1321-1345è¡Œ

```python
videos_val = format_number(up.videos_count) if up.videos_count else '0'
views_val = up.views_formatted or (format_number(up.views_count) if up.views_count else '0')

user_stat = {
    'videos': videos_val,  # æ€»è§†é¢‘æ•°
    'views': views_val,    # æ€»æ’­æ”¾é‡
}
```

**æ£€æŸ¥ç»“æœ**: âœ… **æ­£ç¡®**
- `up.videos_count` â†’ `user_stat.videos` âœ…
- `up.views_count` / `up.views_formatted` â†’ `user_stat.views` âœ…

**æ˜ å°„å…³ç³»æ­£ç¡®ï¼Œä¼˜å…ˆä½¿ç”¨æ ¼å¼åŒ–å­—æ®µ**

---

### æ£€æŸ¥é¡¹4ï¼šå‰ç«¯æ˜¾ç¤ºæ—¶çš„å­—æ®µä½¿ç”¨

**æ–‡ä»¶**: `bilibili.html` ç¬¬1806å’Œ1825è¡Œ

```javascript
const viewsValue = escapeHtml(userStat.views || '0');
const videosValue = escapeHtml(userStat.videos || '0');

// æ˜¾ç¤º
<div>${viewsValue}</div>  // æ ‡ç­¾ï¼šæ€»æ’­æ”¾
<div>${videosValue}</div> // æ ‡ç­¾ï¼šæ€»è§†é¢‘
```

**æ£€æŸ¥ç»“æœ**: âœ… **æ­£ç¡®**
- `userStat.views` â†’ æ˜¾ç¤ºä¸º"æ€»æ’­æ”¾" âœ…
- `userStat.videos` â†’ æ˜¾ç¤ºä¸º"æ€»è§†é¢‘" âœ…

**å­—æ®µä½¿ç”¨æ­£ç¡®ï¼Œæ ‡ç­¾åŒ¹é…**

---

## ğŸ¯ ç»“è®º

### å­—æ®µå¯¹åº”å…³ç³»ï¼šâœ… **å®Œå…¨æ­£ç¡®**

**æ€»æ’­æ”¾é‡**:
- æ•°æ®åº“: `views_count` / `views_formatted`
- API: `user_stat.views`
- å‰ç«¯: `userStat.views` â†’ æ˜¾ç¤º"æ€»æ’­æ”¾"
- âœ… **å¯¹åº”å…³ç³»æ­£ç¡®**

**æ€»è§†é¢‘æ•°**:
- æ•°æ®åº“: `videos_count`
- API: `user_stat.videos`
- å‰ç«¯: `userStat.videos` â†’ æ˜¾ç¤º"æ€»è§†é¢‘"
- âœ… **å¯¹åº”å…³ç³»æ­£ç¡®**

---

## âš ï¸ æ½œåœ¨é—®é¢˜æ£€æŸ¥

### é—®é¢˜1ï¼šæ•°æ®æºå­—æ®µå«ä¹‰ç¡®è®¤

**æ£€æŸ¥**: `bilibili_client.py` ä¸­ `_get_user_stat_async` æ–¹æ³•è¿”å›çš„å­—æ®µå«ä¹‰

**ä»£ç ä½ç½®**: `bilibili_client.py` ç¬¬402-406è¡Œ

```python
return {
    'videos': video_count,  # âœ… è§†é¢‘æ•°é‡ï¼ˆä¸æ˜¯æ€»æ’­æ”¾é‡ï¼‰
    'likes': likes,         # è·èµæ•°
    'views': total_views,   # âœ… æ€»æ’­æ”¾æ•°
}
```

**æ£€æŸ¥ç»“æœ**: âœ… **æ­£ç¡®**
- `videos` è¡¨ç¤ºè§†é¢‘æ•°é‡ï¼ˆä¸æ˜¯æ€»æ’­æ”¾é‡ï¼‰
- `views` è¡¨ç¤ºæ€»æ’­æ”¾æ•°
- å­—æ®µå«ä¹‰æ¸…æ™°ï¼Œæ— æ··æ·†

---

### é—®é¢˜2ï¼šæ•°æ®æŠ“å–æ—¶çš„å­—æ®µèµ‹å€¼

**æ£€æŸ¥**: `fetch_bilibili_data.py` ä¸­å­—æ®µèµ‹å€¼æ˜¯å¦æ­£ç¡®

**ä»£ç ä½ç½®**: `fetch_bilibili_data.py` ç¬¬91-92è¡Œ

```python
up.videos_count = user_stat.get('videos', 0)  # âœ… æ­£ç¡®ï¼šè§†é¢‘æ•°é‡
up.views_count = user_stat.get('views', 0)    # âœ… æ­£ç¡®ï¼šæ€»æ’­æ”¾æ•°
```

**æ£€æŸ¥ç»“æœ**: âœ… **æ­£ç¡®**
- èµ‹å€¼å…³ç³»æ­£ç¡®ï¼Œæ— å­—æ®µæ··æ·†

---

### é—®é¢˜3ï¼šAPIè¿”å›æ—¶çš„å­—æ®µæ ¼å¼åŒ–

**æ£€æŸ¥**: APIè¿”å›æ—¶æ˜¯å¦æ­£ç¡®å¤„ç†äº†æ ¼å¼åŒ–å­—æ®µ

**ä»£ç ä½ç½®**: `app.py` ç¬¬1321-1323è¡Œ

```python
videos_val = format_number(up.videos_count) if up.videos_count else '0'
views_val = up.views_formatted or (format_number(up.views_count) if up.views_count else '0')
```

**æ£€æŸ¥ç»“æœ**: âœ… **æ­£ç¡®**
- ä¼˜å…ˆä½¿ç”¨æ ¼å¼åŒ–å­—æ®µ `views_formatted`
- å¦‚æœæ²¡æœ‰æ ¼å¼åŒ–å­—æ®µï¼Œåˆ™æ ¼å¼åŒ–åŸå§‹æ•°å€¼
- å¤„ç†é€»è¾‘æ­£ç¡®

---

### é—®é¢˜4ï¼šå‰ç«¯å­—æ®µä½¿ç”¨

**æ£€æŸ¥**: å‰ç«¯æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº†APIè¿”å›çš„å­—æ®µ

**ä»£ç ä½ç½®**: `bilibili.html` ç¬¬1806å’Œ1825è¡Œ

```javascript
const viewsValue = escapeHtml(userStat.views || '0');   // âœ… æ€»æ’­æ”¾
const videosValue = escapeHtml(userStat.videos || '0'); // âœ… æ€»è§†é¢‘
```

**æ£€æŸ¥ç»“æœ**: âœ… **æ­£ç¡®**
- å­—æ®µä½¿ç”¨æ­£ç¡®
- æ ‡ç­¾åŒ¹é…æ­£ç¡®

---

## ğŸ” æ·±åº¦æ£€æŸ¥ï¼šæ˜¯å¦å­˜åœ¨å­—æ®µæ··æ·†

### æ£€æŸ¥åœºæ™¯1ï¼šæ•°æ®æŠ“å–æ—¶

**å¯èƒ½çš„é—®é¢˜**: `user_stat.get('videos')` æ˜¯å¦å¯èƒ½è¢«è¯¯è®¤ä¸ºæ˜¯æ€»æ’­æ”¾é‡ï¼Ÿ

**æ£€æŸ¥ç»“æœ**: âœ… **æ— é—®é¢˜**
- `bilibili_client.py` ä¸­æ˜ç¡®æ³¨é‡Šï¼š`'videos': video_count,  # âœ… ä¿®å¤ï¼šè§†é¢‘æ•°é‡ï¼ˆä¸æ˜¯æ€»æ’­æ”¾é‡ï¼‰`
- ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ— æ··æ·†

---

### æ£€æŸ¥åœºæ™¯2ï¼šAPIè¿”å›æ—¶

**å¯èƒ½çš„é—®é¢˜**: `user_stat.videos` å’Œ `user_stat.views` æ˜¯å¦å¯èƒ½è¢«æ··æ·†ï¼Ÿ

**æ£€æŸ¥ç»“æœ**: âœ… **æ— é—®é¢˜**
- APIè¿”å›æ—¶å­—æ®µåæ¸…æ™°ï¼š`videos` è¡¨ç¤ºè§†é¢‘æ•°ï¼Œ`views` è¡¨ç¤ºæ’­æ”¾é‡
- å‰ç«¯ä½¿ç”¨æ—¶æ ‡ç­¾æ˜ç¡®ï¼š`videos` â†’ "æ€»è§†é¢‘"ï¼Œ`views` â†’ "æ€»æ’­æ”¾"

---

### æ£€æŸ¥åœºæ™¯3ï¼šå‰ç«¯æ˜¾ç¤ºæ—¶

**å¯èƒ½çš„é—®é¢˜**: å‰ç«¯æ˜¯å¦å¯èƒ½å°† `videos` å’Œ `views` çš„ä½ç½®æåï¼Ÿ

**æ£€æŸ¥ç»“æœ**: âœ… **æ— é—®é¢˜**
- å‰ç«¯ä»£ç ä¸­ï¼š
  - `userStat.views` â†’ æ˜¾ç¤º"æ€»æ’­æ”¾" âœ…
  - `userStat.videos` â†’ æ˜¾ç¤º"æ€»è§†é¢‘" âœ…
- æ ‡ç­¾å’Œå­—æ®µå¯¹åº”å…³ç³»æ­£ç¡®

---

## ğŸ“Š å­—æ®µå¯¹åº”å…³ç³»è¡¨

| å±‚çº§ | æ€»æ’­æ”¾é‡å­—æ®µ | æ€»è§†é¢‘æ•°å­—æ®µ | çŠ¶æ€ |
|------|------------|------------|------|
| **æ•°æ®åº“** | `views_count` / `views_formatted` | `videos_count` | âœ… |
| **APIè¿”å›** | `user_stat.views` | `user_stat.videos` | âœ… |
| **å‰ç«¯æ˜¾ç¤º** | `userStat.views` â†’ "æ€»æ’­æ”¾" | `userStat.videos` â†’ "æ€»è§†é¢‘" | âœ… |

---

## ğŸ¯ æœ€ç»ˆç»“è®º

### âœ… å­—æ®µå¯¹åº”å…³ç³»ï¼š**å®Œå…¨æ­£ç¡®ï¼Œæ— é—®é¢˜**

**æ€»æ’­æ”¾é‡**:
- æ•°æ®åº“ `views_count` â†’ API `user_stat.views` â†’ å‰ç«¯ `userStat.views` â†’ æ˜¾ç¤º"æ€»æ’­æ”¾" âœ…

**æ€»è§†é¢‘æ•°**:
- æ•°æ®åº“ `videos_count` â†’ API `user_stat.videos` â†’ å‰ç«¯ `userStat.videos` â†’ æ˜¾ç¤º"æ€»è§†é¢‘" âœ…

### æ£€æŸ¥ç»“æœ

1. âœ… **æ•°æ®åº“å­—æ®µå®šä¹‰æ­£ç¡®**ï¼šå­—æ®µåæ¸…æ™°ï¼Œç±»å‹åˆé€‚
2. âœ… **æ•°æ®æŠ“å–æ˜ å°„æ­£ç¡®**ï¼š`user_stat['videos']` â†’ `videos_count`ï¼Œ`user_stat['views']` â†’ `views_count`
3. âœ… **APIè¿”å›æ˜ å°„æ­£ç¡®**ï¼š`videos_count` â†’ `user_stat.videos`ï¼Œ`views_count` â†’ `user_stat.views`
4. âœ… **å‰ç«¯æ˜¾ç¤ºæ­£ç¡®**ï¼šå­—æ®µä½¿ç”¨æ­£ç¡®ï¼Œæ ‡ç­¾åŒ¹é…æ­£ç¡®
5. âœ… **æ— å­—æ®µæ··æ·†**ï¼šæ‰€æœ‰å±‚çº§çš„å­—æ®µå«ä¹‰ä¸€è‡´ï¼Œæ— æ­§ä¹‰

---

## ğŸ’¡ å»ºè®®

è™½ç„¶å­—æ®µå¯¹åº”å…³ç³»æ­£ç¡®ï¼Œä½†ä¸ºäº†è¿›ä¸€æ­¥æé«˜ä»£ç å¯ç»´æŠ¤æ€§ï¼Œå»ºè®®ï¼š

1. **æ·»åŠ å­—æ®µæ³¨é‡Š**ï¼šåœ¨å…³é”®ä½ç½®æ·»åŠ æ³¨é‡Šï¼Œè¯´æ˜å­—æ®µå«ä¹‰
2. **ç»Ÿä¸€å‘½åè§„èŒƒ**ï¼šç¡®ä¿æ‰€æœ‰å±‚çº§ä½¿ç”¨ä¸€è‡´çš„å‘½å
3. **æ·»åŠ æ•°æ®éªŒè¯**ï¼šåœ¨APIè¿”å›å‰éªŒè¯æ•°æ®å®Œæ•´æ€§

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šæ ¹æ®ä»£ç å˜æ›´æ›´æ–°  
**æœ€åæ›´æ–°**ï¼š2025-12-18

