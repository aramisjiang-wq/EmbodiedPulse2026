# 具身视频页面数据流转完整流程

## 一、数据流转总览

### 1.1 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                      B站API接口层                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. user.get_user_info()      → UP主基本信息                    │
│ 2. user.get_user_stat()       → UP主统计数据                    │
│ 3. user.get_videos()          → 视频列表                        │
│ 4. 兜底接口 (fallback)        → 公开API获取数据                 │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              bilibili_client.py (数据转换层)                     │
├─────────────────────────────────────────────────────────────────┤
│ • get_user_info()        → 统一UP主信息格式                     │
│ • get_user_stat()        → 统一统计数据格式                     │
│ • get_user_videos()      → 统一视频列表格式                     │
│ • format_number()        → 数值格式化（万/亿）                  │
│ • format_timestamp()     → 时间戳格式化                         │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│          fetch_bilibili_data.py (数据处理和保存层)               │
├─────────────────────────────────────────────────────────────────┤
│ • fetch_and_save_up_data()                                      │
│   - 处理UP主信息 → BilibiliUp表                                 │
│   - 处理视频数据 → BilibiliVideo表                              │
│   - 格式化数值字段                                               │
│   - 处理时间戳转换                                               │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              bilibili_models.py (数据库存储层)                   │
├─────────────────────────────────────────────────────────────────┤
│ • BilibiliUp表                                                   │
│   - 存储UP主基本信息 + 统计数据                                  │
│ • BilibiliVideo表                                                │
│   - 存储视频详细信息 + 统计数据                                  │
│ • to_dict()方法                                                  │
│   - 转换为API格式                                                │
│   - 处理数据为0的情况（从视频表计算）                            │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│              app.py /api/bilibili/all (API接口层)                 │
├─────────────────────────────────────────────────────────────────┤
│ • 从数据库查询所有活跃UP主                                      │
│ • 对每个UP主：                                                   │
│   - 查询视频列表（最多200条）                                    │
│   - 调用to_dict()转换                                            │
│   - 如果统计数据为0，从视频表计算                                │
│ • 返回JSON格式数据                                               │
│ • 缓存机制（5分钟）                                              │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│    templates/bilibili.html + static/js/app.js (前端展示层)      │
├─────────────────────────────────────────────────────────────────┤
│ • fetch('/api/bilibili/all') 获取数据                            │
│ • 渲染UP主卡片：                                                 │
│   - 使用格式化数值（fans, views, likes）                         │
│   - 显示最新5个视频                                              │
│ • 渲染视频列表：                                                 │
│   - 使用格式化播放量（play）                                     │
│   - 使用格式化时间（pubdate）                                    │
│   - 按pubdate_raw排序                                            │
└─────────────────────────────────────────────────────────────────┘
```

## 二、各环节数据结构详解

### 2.1 B站API接口返回数据

#### 2.1.1 UP主信息API (`user.get_user_info()`)

**API端点：** `bilibili-api-python` 库的 `user.User.get_user_info()`

**返回数据结构：**
```python
{
    'mid': 1172054289,              # UP主UID
    'name': '逐际动力',              # UP主名称
    'face': 'https://i0.hdslb.com/...',  # 头像URL
    'sign': '签名内容',              # 个人签名
    'level_info': {
        'current_level': 5          # 等级
    },
    'fans': 12345,                  # 粉丝数
    'friend': 100                   # 关注数
}
```

#### 2.1.2 UP主统计数据API (`user.get_user_stat()` / `upstat`)

**API端点：** 
- 主接口：`bilibili-api-python` 库的 `user.User.get_user_stat()`
- 兜底接口：`https://api.bilibili.com/x/space/upstat?mid={mid}`

**返回数据结构：**
```python
{
    'archive': {
        'view': 1000000,            # 总播放量
        'danmaku': 5000,            # 弹幕数
        'reply': 2000,              # 评论数
        'favorite': 3000,           # 收藏数
        'coin': 1000,               # 投币数
        'share': 500,               # 分享数
        'like': 5000                # 点赞数
    },
    'likes': 50000                  # 获赞数
}
```

**兜底接口返回：**
```json
{
    "code": 0,
    "data": {
        "archive": {
            "view": 1000000
        },
        "likes": 50000
    }
}
```

#### 2.1.3 视频列表API (`user.get_videos()`)

**API端点：** `bilibili-api-python` 库的 `user.User.get_videos(pn=page, ps=page_size)`

**返回数据结构：**
```python
{
    'list': {
        'vlist': [
            {
                'bvid': 'BV1xx411c7mD',      # 视频BV号
                'aid': 123456789,             # 视频AID
                'title': '视频标题',          # 视频标题
                'pic': 'https://i0.hdslb.com/...',  # 封面图URL
                'description': '视频描述',    # 视频描述
                'length': '10:30',            # 视频时长
                'play': 50000,                # 播放量（可能在stat.view中）
                'video_review': 100,          # 评论数（可能在stat.reply中）
                'favorites': 200,             # 收藏数（可能在stat.favorite中）
                'created': 1703123456,        # 发布时间戳（秒）
                'pubdate': 1703123456,        # 发布时间戳（秒，备用）
                'stat': {                     # 统计数据（备用）
                    'view': 50000,
                    'reply': 100,
                    'favorite': 200
                }
            }
        ]
    }
}
```

**兜底接口：** `https://api.bilibili.com/x/space/arc/search?mid={mid}&ps={page_size}&pn={page}&order=pubdate`

**返回数据结构：**
```json
{
    "code": 0,
    "data": {
        "list": {
            "vlist": [
                {
                    "bvid": "BV1xx411c7mD",
                    "aid": 123456789,
                    "title": "视频标题",
                    "pic": "https://i0.hdslb.com/...",
                    "description": "视频描述",
                    "length": "10:30",
                    "play": 50000,
                    "video_review": 100,
                    "favorites": 200,
                    "created": 1703123456,
                    "pubdate": 1703123456
                }
            ]
        }
    }
}
```

### 2.2 bilibili_client.py 数据转换

#### 2.2.1 `get_user_info()` 转换

**输入：** B站API返回的UP主信息

**输出：**
```python
{
    'mid': 1172054289,
    'name': '逐际动力',
    'face': 'https://i0.hdslb.com/...',
    'sign': '签名内容',
    'level': 5,                    # 从 level_info.current_level 提取
    'fans': 12345,
    'friend': 100
}
```

#### 2.2.2 `get_user_stat()` 转换

**输入：** B站API返回的统计数据

**输出：**
```python
{
    'videos': 50,                  # 视频数量（从视频列表计算）
    'likes': 50000,                # 获赞数（从upstat.likes获取）
    'views': 1000000               # 总播放量（从upstat.archive.view获取）
}
```

#### 2.2.3 `get_user_videos()` 转换

**输入：** B站API返回的视频列表

**输出：**
```python
[
    {
        'bvid': 'BV1xx411c7mD',
        'aid': 123456789,
        'title': '视频标题',
        'pic': 'https://i0.hdslb.com/...',
        'play': 50000,             # 从 play 或 stat.view 获取
        'video_review': 100,       # 从 video_review 或 stat.reply 获取
        'favorites': 200,          # 从 favorites 或 stat.favorite 获取
        'pubdate': 1703123456,     # 从 created 或 pubdate 获取，处理毫秒转秒
        'description': '视频描述',
        'length': '10:30'
    }
]
```

**字段处理逻辑：**
- `play`: 优先使用 `video.get('play')`，如果为0则使用 `video.get('stat', {}).get('view', 0)`
- `video_review`: 优先使用 `video.get('video_review')`，如果为0则使用 `video.get('stat', {}).get('reply', 0)`
- `favorites`: 优先使用 `video.get('favorites')`，如果为0则使用 `video.get('stat', {}).get('favorite', 0)`
- `pubdate`: 优先使用 `video.get('created')`，如果为0则使用 `video.get('pubdate')`，如果时间戳>当前时间*10则除以1000（处理毫秒转秒）

### 2.3 fetch_bilibili_data.py 数据处理

#### 2.3.1 UP主数据处理

**从 `bilibili_client.get_all_data()` 获取：**
```python
{
    'user_info': {
        'mid': 1172054289,
        'name': '逐际动力',
        'face': 'https://...',
        'sign': '签名',
        'level': 5,
        'fans': 12345,
        'friend': 100
    },
    'user_stat': {
        'videos': 50,
        'likes': 50000,
        'views': 1000000
    },
    'videos': [...]
}
```

**保存到数据库 `BilibiliUp` 表：**
```python
BilibiliUp(
    uid=1172054289,                    # ← user_info['mid']
    name='逐际动力',                   # ← user_info['name']
    face='https://...',                # ← user_info['face']
    sign='签名',                        # ← user_info['sign']
    level=5,                           # ← user_info['level']
    fans=12345,                        # ← user_info['fans']
    fans_formatted='1.2万',            # ← format_number(user_info['fans'])
    friend=100,                        # ← user_info['friend']
    space_url='https://space.bilibili.com/1172054289',
    videos_count=50,                   # ← user_stat['videos']
    views_count=1000000,               # ← user_stat['views']
    views_formatted='100.0万',         # ← format_number(user_stat['views'])
    likes_count=50000,                 # ← user_stat['likes']
    likes_formatted='5.0万',          # ← format_number(user_stat['likes'])
    is_active=True,
    last_fetch_at=datetime.now(),
    fetch_error=None
)
```

#### 2.3.2 视频数据处理

**从 `bilibili_client.get_all_data()` 获取：**
```python
[
    {
        'bvid': 'BV1xx411c7mD',
        'aid': 123456789,
        'title': '视频标题',
        'pic': 'https://...',
        'play': 50000,
        'video_review': 100,
        'favorites': 200,
        'pubdate': 1703123456,
        'description': '视频描述',
        'length': '10:30'
    }
]
```

**保存到数据库 `BilibiliVideo` 表：**
```python
BilibiliVideo(
    bvid='BV1xx411c7mD',               # ← video['bvid']
    aid=123456789,                     # ← video['aid']
    uid=1172054289,                    # ← UP主UID
    title='视频标题',                  # ← video['title']
    pic='https://...',                 # ← video['pic']
    description='视频描述',            # ← video['description']
    length='10:30',                    # ← video['length']
    play=50000,                        # ← video['play'] (只更新>0的值)
    play_formatted='5.0万',           # ← format_number(video['play'])
    video_review=100,                  # ← video['video_review']
    video_review_formatted='100',      # ← format_number(video['video_review'])
    favorites=200,                     # ← video['favorites']
    favorites_formatted='200',         # ← format_number(video['favorites'])
    pubdate=datetime.fromtimestamp(1703123456),  # ← datetime.fromtimestamp(video['pubdate'])
    pubdate_raw=1703123456,            # ← video['pubdate']
    url='https://www.bilibili.com/video/BV1xx411c7mD',
    is_deleted=False
)
```

### 2.4 数据库存储结构

#### 2.4.1 `bilibili_ups` 表结构

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| uid | BigInteger (PK) | UP主UID | user_info['mid'] |
| name | String | UP主名称 | user_info['name'] |
| face | Text | 头像URL | user_info['face'] |
| sign | Text | 签名 | user_info['sign'] |
| level | Integer | 等级 | user_info['level'] |
| fans | BigInteger | 粉丝数（原始） | user_info['fans'] |
| fans_formatted | String | 粉丝数（格式化） | format_number(fans) |
| friend | Integer | 关注数 | user_info['friend'] |
| space_url | Text | 空间链接 | 构造 |
| videos_count | Integer | 视频总数 | user_stat['videos'] |
| views_count | BigInteger | 总播放量（原始） | user_stat['views'] |
| views_formatted | String | 总播放量（格式化） | format_number(views_count) |
| likes_count | BigInteger | 获赞数（原始） | user_stat['likes'] |
| likes_formatted | String | 获赞数（格式化） | format_number(likes_count) |
| is_active | Boolean | 是否活跃 | True |
| last_fetch_at | DateTime | 最后抓取时间 | datetime.now() |
| fetch_error | Text | 抓取错误信息 | None |
| created_at | DateTime | 创建时间 | datetime.now() |
| updated_at | DateTime | 更新时间 | datetime.now() |

#### 2.4.2 `bilibili_videos` 表结构

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| bvid | String (PK) | 视频BV号 | video['bvid'] |
| aid | BigInteger | 视频AID | video['aid'] |
| uid | BigInteger | UP主UID | UP主UID |
| title | Text | 视频标题 | video['title'] |
| pic | Text | 封面图URL | video['pic'] |
| description | Text | 视频描述 | video['description'] |
| length | String | 视频时长 | video['length'] |
| play | BigInteger | 播放量（原始） | video['play'] |
| play_formatted | String | 播放量（格式化） | format_number(play) |
| video_review | Integer | 评论数（原始） | video['video_review'] |
| video_review_formatted | String | 评论数（格式化） | format_number(video_review) |
| favorites | Integer | 收藏数（原始） | video['favorites'] |
| favorites_formatted | String | 收藏数（格式化） | format_number(favorites) |
| pubdate | DateTime | 发布时间 | datetime.fromtimestamp(pubdate_raw) |
| pubdate_raw | BigInteger | 发布时间戳（秒） | video['pubdate'] |
| url | Text | 视频链接 | 构造 |
| is_deleted | Boolean | 是否已删除 | False |
| created_at | DateTime | 创建时间 | datetime.now() |
| updated_at | DateTime | 更新时间 | datetime.now() |

### 2.5 API接口返回数据

#### 2.5.1 `/api/bilibili/all` 接口

**路由：** `@app.route('/api/bilibili/all')`

**返回数据结构：**
```json
{
    "success": true,
    "data": {
        "ups": [
            {
                "uid": 1172054289,
                "name": "逐际动力",
                "face": "https://...",
                "sign": "签名",
                "level": 5,
                "fans": "1.2万",              // ← fans_formatted
                "fans_raw": 12345,            // ← fans
                "fans_formatted": "1.2万",    // ← fans_formatted
                "friend": "100",
                "space_url": "https://space.bilibili.com/1172054289",
                "videos_count": 50,           // ← videos_count
                "views": "100.0万",           // ← views_formatted
                "views_formatted": "100.0万", // ← views_formatted
                "views_raw": 1000000,         // ← views_count
                "views_count": 1000000,       // ← views_count
                "likes": "5.0万",             // ← likes_formatted
                "likes_formatted": "5.0万",   // ← likes_formatted
                "likes_raw": 50000,           // ← likes_count
                "likes_count": 50000,         // ← likes_count
                "last_fetch_at": "2025-12-19T10:00:00",
                "fetch_error": null,
                "videos": [
                    {
                        "bvid": "BV1xx411c7mD",
                        "title": "视频标题",
                        "pic": "https://...",
                        "play": "5.0万",              // ← play_formatted
                        "play_raw": 50000,            // ← play
                        "favorites": "200",           // ← favorites_formatted
                        "video_review": "100",        // ← video_review_formatted
                        "pubdate": "2023-12-19 10:00", // ← format_timestamp(pubdate_raw)
                        "pubdate_raw": 1703123456,    // ← pubdate_raw
                        "description": "视频描述",
                        "length": "10:30",
                        "url": "https://www.bilibili.com/video/BV1xx411c7mD"
                    }
                ]
            }
        ]
    }
}
```

**数据转换逻辑（`BilibiliUp.to_dict()`）：**
```python
{
    'uid': self.uid,
    'name': self.name,
    'face': self.face or '',
    'sign': self.sign or '',
    'level': self.level,
    'fans': self.fans_formatted or format_number(self.fans),  # 格式化显示
    'fans_raw': self.fans,                                    # 原始数值
    'fans_formatted': self.fans_formatted or format_number(self.fans),
    'friend': str(self.friend) if self.friend else '0',
    'space_url': self.space_url or f"https://space.bilibili.com/{self.uid}",
    'videos_count': videos_count,                             # 如果为0，从视频表计算
    'views': format_number(views_count) if views_count > 0 else (self.views_formatted or '0'),
    'views_formatted': format_number(views_count) if views_count > 0 else (self.views_formatted or '0'),
    'views_raw': views_count,
    'views_count': views_count,
    'likes': self.likes_formatted or format_number(self.likes_count) if self.likes_count else '0',
    'likes_formatted': self.likes_formatted or format_number(self.likes_count) if self.likes_count else '0',
    'likes_raw': self.likes_count,
    'likes_count': self.likes_count or 0,
    'last_fetch_at': self.last_fetch_at.isoformat() if self.last_fetch_at else None,
    'fetch_error': self.fetch_error
}
```

**数据转换逻辑（`BilibiliVideo.to_dict()`）：**
```python
{
    'bvid': self.bvid,
    'aid': self.aid,
    'title': self.title or '',
    'pic': self.pic or '',
    'description': self.description or '',
    'length': self.length or '',
    'play': self.play_formatted or '0',                       # 格式化显示
    'play_raw': self.play,                                    # 原始数值
    'video_review': self.video_review_formatted or '0',
    'favorites': self.favorites_formatted or '0',
    'pubdate': self.pubdate.strftime('%Y-%m-%d %H:%M:%S') if self.pubdate else '',
    'pubdate_raw': self.pubdate_raw,
    'url': self.url or f"https://www.bilibili.com/video/{self.bvid}"
}
```

### 2.6 前端展示数据

#### 2.6.1 前端API调用

**调用接口：** `GET /api/bilibili/all`

**JavaScript代码：**
```javascript
const response = await fetch('/api/bilibili/all');
const result = await response.json();
const ups = result.data.ups;
```

#### 2.6.2 前端数据展示

**UP主卡片展示：**
```javascript
// 从API获取的数据
const up = {
    uid: 1172054289,
    name: '逐际动力',
    face: 'https://...',
    fans: '1.2万',              // 使用格式化值
    views: '100.0万',           // 使用格式化值
    likes: '5.0万',             // 使用格式化值
    videos_count: 50,
    videos: [...]
}

// HTML渲染
`
<div class="bilibili-card">
    <div class="bilibili-card-header">
        <img src="${up.face}" alt="${up.name}">
        <div>
            <h3>${up.name}</h3>
            <p>${up.sign}</p>
        </div>
    </div>
    <div class="bilibili-card-stats">
        <span>粉丝: ${up.fans}</span>           <!-- 使用 fans -->
        <span>播放: ${up.views}</span>          <!-- 使用 views -->
        <span>获赞: ${up.likes}</span>          <!-- 使用 likes -->
    </div>
    <div class="bilibili-card-videos">
        ${up.videos.slice(0, 5).map(video => `
            <a href="${video.url}">
                <div>${video.title}</div>
                <div>
                    <span>播放: ${video.play}</span>      <!-- 使用 play -->
                    <span>时间: ${video.pubdate}</span>   <!-- 使用 pubdate -->
                </div>
            </a>
        `).join('')}
    </div>
</div>
`
```

**视频列表展示：**
```javascript
// 从API获取的视频数据
const video = {
    bvid: 'BV1xx411c7mD',
    title: '视频标题',
    play: '5.0万',              // 使用格式化值
    play_raw: 50000,            // 用于排序
    pubdate: '2023-12-19 10:00', // 格式化时间
    pubdate_raw: 1703123456,    // 用于排序
    url: 'https://www.bilibili.com/video/BV1xx411c7mD'
}

// HTML渲染
`
<a href="${video.url}" class="bilibili-video-item">
    <div class="bilibili-video-title">${video.title}</div>
    <div class="bilibili-video-meta">
        <span><i class="fas fa-play"></i> ${video.play}</span>      <!-- 使用 play -->
        <span><i class="fas fa-clock"></i> ${video.pubdate}</span>   <!-- 使用 pubdate -->
    </div>
</a>
`
```

## 三、字段对应关系表

### 3.1 UP主信息字段映射

| B站API | bilibili_client | 数据库字段 | API返回字段 | 前端展示 |
|--------|----------------|-----------|------------|---------|
| `mid` | `mid` | `uid` | `uid` | `up.uid` |
| `name` | `name` | `name` | `name` | `up.name` |
| `face` | `face` | `face` | `face` | `up.face` |
| `sign` | `sign` | `sign` | `sign` | `up.sign` |
| `level_info.current_level` | `level` | `level` | `level` | `up.level` |
| `fans` | `fans` | `fans` | `fans_raw` | `up.fans_raw` |
| `fans` | `fans` | `fans_formatted` | `fans` / `fans_formatted` | `up.fans` |
| `friend` | `friend` | `friend` | `friend` | `up.friend` |
| - | - | `space_url` | `space_url` | `up.space_url` |
| `archive.view` | `views` | `views_count` | `views_raw` / `views_count` | `up.views_raw` |
| `archive.view` | `views` | `views_formatted` | `views` / `views_formatted` | `up.views` |
| `likes` | `likes` | `likes_count` | `likes_raw` / `likes_count` | `up.likes_raw` |
| `likes` | `likes` | `likes_formatted` | `likes` / `likes_formatted` | `up.likes` |
| 视频列表长度 | `videos` | `videos_count` | `videos_count` | `up.videos_count` |

### 3.2 视频信息字段映射

| B站API | bilibili_client | 数据库字段 | API返回字段 | 前端展示 |
|--------|----------------|-----------|------------|---------|
| `bvid` | `bvid` | `bvid` | `bvid` | `video.bvid` |
| `aid` | `aid` | `aid` | `aid` | `video.aid` |
| - | - | `uid` | - | - |
| `title` | `title` | `title` | `title` | `video.title` |
| `pic` | `pic` | `pic` | `pic` | `video.pic` |
| `description` | `description` | `description` | `description` | `video.description` |
| `length` | `length` | `length` | `length` | `video.length` |
| `play` / `stat.view` | `play` | `play` | `play_raw` | `video.play_raw` |
| `play` / `stat.view` | `play` | `play_formatted` | `play` | `video.play` |
| `video_review` / `stat.reply` | `video_review` | `video_review` | `video_review` | `video.video_review` |
| `video_review` / `stat.reply` | `video_review` | `video_review_formatted` | `video_review` | `video.video_review` |
| `favorites` / `stat.favorite` | `favorites` | `favorites` | `favorites` | `video.favorites` |
| `favorites` / `stat.favorite` | `favorites` | `favorites_formatted` | `favorites` | `video.favorites` |
| `created` / `pubdate` | `pubdate` | `pubdate_raw` | `pubdate_raw` | `video.pubdate_raw` |
| `created` / `pubdate` | `pubdate` | `pubdate` | `pubdate` | `video.pubdate` |
| - | - | `url` | `url` | `video.url` |

## 四、数据流转详细流程

### 4.1 数据抓取流程

```
1. fetch_bilibili_data.py 调用
   ↓
2. BilibiliClient.get_all_data(uid)
   ↓
3. 并发调用：
   - _get_user_info_async() → 获取UP主信息
   - _get_user_stat_async() → 获取统计数据
   - _get_user_videos_async() → 获取视频列表
   ↓
4. 如果主接口失败，使用兜底接口：
   - _fallback_user_info() → 公开API获取UP主信息
   - _get_upstat() → 公开API获取统计数据
   - _fallback_user_videos() → 公开API获取视频列表
   ↓
5. 返回统一格式的数据字典
```

### 4.2 数据处理流程

```
1. fetch_and_save_up_data() 接收数据
   ↓
2. 处理UP主信息：
   - 查询或创建 BilibiliUp 记录
   - 更新基本信息（name, face, sign, level, fans, friend）
   - 更新统计数据（videos_count, views_count, likes_count）
   - 格式化数值（fans_formatted, views_formatted, likes_formatted）
   ↓
3. 处理视频数据：
   - 遍历视频列表
   - 查询或创建 BilibiliVideo 记录
   - 更新视频信息（title, pic, description, length）
   - 更新统计数据（play, video_review, favorites）
   - 格式化数值（play_formatted, video_review_formatted, favorites_formatted）
   - 处理时间戳（pubdate_raw → pubdate）
   ↓
4. 提交数据库事务
```

### 4.3 数据查询流程

```
1. 前端调用 /api/bilibili/all
   ↓
2. app.py 路由处理：
   - 查询所有活跃UP主（is_active=True）
   - 对每个UP主：
     a. 查询该UP主的视频（按pubdate_raw倒序，最多200条）
     b. 调用 to_dict() 转换为字典
     c. 如果统计数据为0，从视频表计算
   ↓
3. 返回JSON格式数据
```

### 4.4 前端展示流程

```
1. 页面加载时调用 loadBilibili()
   ↓
2. fetch('/api/bilibili/all') 获取数据
   ↓
3. 解析返回的JSON数据
   ↓
4. 渲染UP主卡片：
   - 使用 fans, views, likes（格式化值）
   - 显示最新5个视频
   ↓
5. 渲染视频列表：
   - 使用 play（格式化值）
   - 使用 pubdate（格式化时间）
   - 按 pubdate_raw 排序
```

## 五、关键处理逻辑

### 5.1 数值格式化

**函数：** `bilibili_client.format_number(num)`

**逻辑：**
```python
if num >= 100000000:
    return f"{num / 100000000:.1f}亿"
elif num >= 10000:
    return f"{num / 10000:.1f}万"
else:
    return str(num)
```

**示例：**
- 12345 → "1.2万"
- 1000000 → "100.0万"
- 500000000 → "5.0亿"

### 5.2 时间戳处理

**函数：** `bilibili_client.format_timestamp(timestamp)`

**逻辑：**
```python
# 处理毫秒转秒
if pubdate > current_timestamp * 10:
    pubdate = pubdate // 1000

# 转换为中国时区
tz = timezone(timedelta(hours=8))
dt = datetime.fromtimestamp(pubdate, tz=tz)
return dt.strftime('%Y-%m-%d %H:%M')
```

### 5.3 数据更新策略

**UP主数据：**
- 基本信息：每次抓取都更新
- 统计数据：只更新有效数据（>0），避免覆盖为0
- 如果API返回0，尝试从视频表计算

**视频数据：**
- 新视频：创建新记录
- 已存在视频：更新所有字段
- 播放量：只更新>0的值，避免覆盖有效数据

### 5.4 兜底机制

**当主接口失败时：**
1. UP主信息：使用 `_fallback_user_info()` → `https://api.bilibili.com/x/web-interface/card`
2. 统计数据：使用 `_get_upstat()` → `https://api.bilibili.com/x/space/upstat`
3. 视频列表：使用 `_fallback_user_videos()` → `https://api.bilibili.com/x/space/arc/search`

## 六、常见问题

### 6.1 数据为0的问题

**原因：**
- API返回0（可能被风控）
- 数据库存储为0

**解决方案：**
- 如果API返回0且数据库也是0，尝试从视频表计算
- 代码位置：`bilibili_models.py` 的 `BilibiliUp.to_dict()` 方法

### 6.2 时间戳格式问题

**问题：** API可能返回毫秒级时间戳

**解决方案：** 
- 检查时间戳是否>当前时间*10
- 如果是，除以1000转换为秒
- 代码位置：`bilibili_client.py` 的 `_get_user_videos_async()` 方法

### 6.3 统计数据字段不一致

**问题：** B站API在不同接口中，统计数据字段名不同

**解决方案：**
- 优先使用 `play`，如果为0则使用 `stat.view`
- 优先使用 `video_review`，如果为0则使用 `stat.reply`
- 优先使用 `favorites`，如果为0则使用 `stat.favorite`
- 代码位置：`bilibili_client.py` 的 `_get_user_videos_async()` 方法

## 七、数据验证

### 7.1 数据库验证

```sql
-- 检查UP主数据
SELECT uid, name, fans, views_count, videos_count 
FROM bilibili_ups 
WHERE is_active = 1;

-- 检查视频数据
SELECT bvid, title, play, pubdate 
FROM bilibili_videos 
WHERE uid = 1172054289 
ORDER BY pubdate_raw DESC 
LIMIT 10;
```

### 7.2 API验证

```bash
# 测试API接口
curl http://localhost:5001/api/bilibili/all | jq '.data.ups[0]'
```

### 7.3 前端验证

```javascript
// 在浏览器控制台检查
const response = await fetch('/api/bilibili/all');
const data = await response.json();
console.log('UP主数据:', data.data.ups);
console.log('视频数据:', data.data.ups[0].videos);
```

