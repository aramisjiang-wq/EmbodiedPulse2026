# 刷新新闻数据问题排查

**创建时间**：2025年12月11日  
**更新时间**：2025年12月11日  
**问题1**：点击"刷新全局数据"按钮后，没有抓取到新新闻  
**问题2**：浏览器控制台只看到论文的API抓取，没有看到新闻和岗位机会的API抓取更新动作

---

## 🔍 问题分析

### 现象
- 手动执行 `python3 fetch_news.py --yes` 可以抓取到新新闻
- 点击"刷新全局数据"按钮后，没有抓取到新新闻

### 可能原因

#### 1. 清理逻辑过于激进

`fetch_news.py` 中的 `fetch_and_save_news()` 函数会：
1. **先清理24小时前的旧新闻**
2. **然后抓取新新闻**

**问题**：
- 如果抓取失败或抓取到的新闻数量少于被清理的数量，总数会减少
- 如果抓取到的新闻都是已存在的（更新而非新建），总数可能不变

#### 2. 时间窗口问题

- 清理逻辑使用 `datetime.now() - timedelta(hours=24)` 作为截止时间
- 如果新闻的 `published_at` 或 `created_at` 刚好在24小时前，会被清理
- 但新抓取的新闻可能还没有足够的新内容

#### 3. 去重逻辑

- 如果抓取到的新闻已经存在于数据库中（基于链接或标题+日期去重）
- 会执行"更新"而非"新建"
- 如果更新后的新闻仍然在24小时内，总数不变

---

## ✅ 解决方案（已实施）

### 方案1：调整清理时机（已采用）

**问题**：先清理再抓取，可能导致数据丢失

**解决**：先抓取，再清理（已修复）

**修改内容**：
- 将清理逻辑从抓取前移到抓取后
- 确保新抓取的新闻不会被误删
- 保持数据库整洁（清理旧数据）

**修改位置**：`fetch_news.py` 第40-61行 → 移到第188-201行（保存新闻之后）

### 方案2：禁用自动清理

**问题**：清理逻辑可能过于激进

**解决**：在刷新时禁用自动清理，只保留抓取逻辑

```python
def fetch_and_save_news(cleanup_old=True):
    if cleanup_old:
        # 清理24小时前的旧新闻
        cleanup_old_news()
    # 抓取新新闻
    ...
```

### 方案3：改进清理逻辑

**问题**：清理时可能误删新抓取的新闻

**解决**：在清理时排除刚抓取的新闻

```python
def cleanup_old_news(exclude_ids=None):
    cutoff_time = datetime.now() - timedelta(hours=24)
    query = session.query(News).filter(...)
    if exclude_ids:
        query = query.filter(~News.id.in_(exclude_ids))
    deleted = query.delete()
```

---

## 🔧 推荐修复

**建议采用方案1**：调整清理时机，先抓取再清理

这样可以：
1. 确保新抓取的新闻不会被误删
2. 即使抓取失败，也不会丢失现有数据
3. 保持数据库整洁（清理旧数据）

---

## 🔍 问题2：浏览器控制台看不到新闻和招聘API调用

### 现象
- 点击"刷新全局数据"按钮后，浏览器控制台只看到论文的API抓取
- 没有看到 `/api/jobs` 和 `/api/news` 的API调用

### 原因分析
- 刷新完成后，前端确实调用了 `loadJobs()` 和 `loadNews()`
- 但这些函数可能因为某些原因没有执行，或者API调用被缓存了
- 刷新状态判断逻辑可能有问题，导致没有正确触发数据重新加载

### 解决方案（已实施）

1. **增强前端日志**：
   - 在 `loadJobs()` 和 `loadNews()` 函数中添加详细日志
   - 在刷新完成后的数据重新加载过程中添加日志
   - 确保所有API调用都能在控制台看到

2. **改进刷新状态判断**：
   - 修改前端刷新状态判断逻辑，确保所有任务都完成后才触发数据重新加载
   - 修改后端 `/api/refresh-status` 接口，改进任务完成判断逻辑

3. **添加延迟重新加载**：
   - 在刷新完成后立即重新加载数据
   - 2秒后再次重新加载，确保后端数据已更新

### 修改内容

**前端 (`static/js/app.js`)**：
- 在 `loadJobs()` 和 `loadNews()` 函数中添加 `console.log` 日志
- 在刷新完成后的数据重新加载过程中添加详细日志
- 改进刷新状态判断逻辑，确保所有任务都完成后才触发

**后端 (`app.py`)**：
- 改进 `/api/refresh-status` 接口的任务完成判断逻辑
- 添加更详细的日志输出

### 测试方法

1. 打开浏览器控制台（F12）
2. 点击"刷新全局数据"按钮
3. 观察控制台输出，应该看到：
   - `/api/refresh-all` 调用
   - `/api/refresh-status` 轮询
   - 刷新完成后：`loadJobs()` 调用 `/api/jobs`
   - 刷新完成后：`loadNews()` 调用 `/api/news`
   - 延迟重新加载：再次调用这些API

---

**最后更新**：2025年12月11日  
**维护者**：AI开发助手





