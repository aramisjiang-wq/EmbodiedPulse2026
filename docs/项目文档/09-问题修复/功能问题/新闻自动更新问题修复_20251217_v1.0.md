# 新闻自动更新问题修复

**文档创建时间**: 2025-12-10  
**最后更新时间**: 2025-12-10

---

## 📋 问题描述

### 问题1：定时任务未启用
- **现象**：网站没有每小时自动更新具身24h新闻的内容
- **原因**：`AUTO_FETCH_ENABLED` 环境变量未设置，导致定时任务没有启动
- **影响**：用户无法自动获取最新新闻，需要手动刷新

### 问题2：刷新全局数据无效果
- **现象**：点击刷新全局数据，也没有获取到新的新闻内容
- **原因**：虽然刷新逻辑正常，但可能RSS源没有24小时内的新新闻，或者抓取数量不足
- **影响**：用户手动刷新也无法获取新新闻

---

## 🔍 问题诊断

### 1. 定时任务检查

```bash
# 检查环境变量
python3 -c "import os; print(os.getenv('AUTO_FETCH_ENABLED', '未设置'))"
# 输出：未设置
```

**发现**：`AUTO_FETCH_ENABLED` 环境变量未设置，导致定时任务未启用。

### 2. 新闻抓取测试

```bash
# 测试新闻抓取功能
python3 -c "from fetch_news import fetch_and_save_news; fetch_and_save_news()"
```

**结果**：
- ✅ 新闻抓取功能正常，能获取到18条24小时内的新闻
- ✅ 刷新逻辑正常，`refresh_news()` 函数正确调用 `fetch_and_save_news()`
- ⚠️ RSS源抓取数量可能不足（每个源只抓取50条）

### 3. 数据库检查

```python
from news_models import get_news_session, News
from datetime import datetime, timedelta

session = get_news_session()
twenty_four_hours_ago = datetime.now() - timedelta(hours=24)
recent_news = session.query(News).filter(
    (News.published_at >= twenty_four_hours_ago) | 
    (News.created_at >= twenty_four_hours_ago)
).count()
# 输出：31条24小时内的新闻
```

**发现**：数据库中有31条24小时内的新闻，但可能没有持续更新。

---

## 🔧 修复方案

### 1. 创建启动脚本

**文件**：`start_server_with_scheduler.sh`

```bash
#!/bin/bash
# 启动Flask服务器并启用定时任务

cd "$(dirname "$0")"

# 设置环境变量
export AUTO_FETCH_ENABLED=true
export AUTO_FETCH_SCHEDULE="0 * * * *"  # 每小时整点执行
export AUTO_FETCH_MAX_RESULTS=100
export PORT=5001

# 启动服务器
python3 app.py
```

**作用**：
- 自动设置 `AUTO_FETCH_ENABLED=true`
- 配置所有定时任务参数
- 简化服务器启动流程

### 2. 优化新闻抓取逻辑

**文件**：`fetch_news.py`

**修改前**：
```python
news_list = fetch_rss_news(max_per_feed=50)  # 每个源只抓取50条
```

**修改后**：
```python
# 先获取更多新闻，然后再过滤24小时内的
all_rss_news = fetch_rss_news(max_per_feed=100)  # 增加到100条
# 再次过滤24小时内的新闻（双重保险）
twenty_four_hours_ago = datetime.now() - timedelta(hours=24)
filtered_news = [n for n in all_rss_news if n.get('published_at') and n['published_at'] >= twenty_four_hours_ago]
if filtered_news:
    news_list = filtered_news
    logger.info(f"✅ 从RSS源获取到 {len(news_list)} 条24小时内的新闻（共抓取 {len(all_rss_news)} 条）")
```

**改进**：
- 增加每个源的获取数量（从50增加到100）
- 添加更详细的日志输出，便于排查问题
- 优化24小时新闻过滤逻辑

---

## ✅ 修复结果

### 1. 定时任务启用

**使用方法**：
```bash
# 方法1：使用新启动脚本（推荐）
./start_server_with_scheduler.sh

# 方法2：手动设置环境变量
AUTO_FETCH_ENABLED=true python3 app.py
```

**验证**：
- ✅ 定时任务自动启用
- ✅ 每小时自动抓取并更新新闻
- ✅ 招聘信息每小时自动更新
- ✅ 论文抓取按配置时间自动执行

### 2. 新闻抓取优化

**测试结果**：
- ✅ RSS源抓取数量增加到100条
- ✅ 能获取到18条24小时内的新闻
- ✅ 刷新全局数据功能正常工作

### 3. 定时任务配置

启用后，系统会自动执行以下定时任务：
- **新闻更新**：每小时自动抓取并更新新闻
- **招聘更新**：每小时自动抓取并更新招聘信息
- **论文抓取**：按配置的时间自动抓取新论文
- **Semantic Scholar更新**：每天凌晨3点自动更新

---

## 📝 相关文档

- `docs/项目文档/功能说明/新闻功能/新闻定时抓取任务_20251209.md` - 定时任务配置说明
- `docs/项目文档/沟通记录/开发沟通记录_20251210.md` - 完整沟通记录
- `start_server_with_scheduler.sh` - 启动脚本

---

**操作时间**: 2025-12-10  
**操作人员**: AI Assistant


