# 问题诊断与修复方案

## 问题一：B站API到数据库的更新流程检查

### 检查方法

运行诊断脚本：
```bash
python3 scripts/check_bilibili_api_to_db.py
```

### 数据流转路径

```
B站API → BilibiliClient → fetch_and_save_up_data() → 数据库
```

**关键文件**:
- `bilibili_client.py` - API客户端
- `fetch_bilibili_data.py` - 数据抓取和保存逻辑
- `bilibili_models.py` - 数据库模型

### 更新机制

1. **定时任务**（每6小时）：
   - 配置：`.env` 中的 `AUTO_FETCH_BILIBILI_SCHEDULE=0 */6 * * *`
   - 执行：`app.py` 中的 `scheduled_fetch_bilibili()` 函数
   - 调用：`fetch_bilibili_data.py` 中的 `fetch_all_bilibili_data()`

2. **手动更新**：
   ```bash
   python3 fetch_bilibili_data.py
   ```

3. **数据更新逻辑**：
   - UP主数据：查找已存在记录，存在则更新所有字段，不存在则创建
   - 视频数据：查找已存在记录（基于bvid），存在则更新所有字段（播放量、评论数等），不存在则创建

### 可能的问题

1. **定时任务未启动**
   - 检查：`AUTO_FETCH_ENABLED=true` 是否设置
   - 检查：服务器是否重启以加载新的环境变量

2. **API风控**
   - 检查：`bilibili_client.py` 中的重试和延迟机制
   - 检查：是否有 `BILI_SESSDATA` 等凭证配置

3. **数据库连接问题**
   - 检查：`bilibili.db` 文件是否存在
   - 检查：数据库权限是否正确

---

## 问题二：论文刷新按钮的问题

### 问题分析

#### 1. 前端显示问题

**当前实现**：
- 轮询间隔：5秒（`setInterval(checkStatus, 5000)`）
- 状态更新：通过 `/api/fetch-status` 获取
- 进度显示：通过解析脚本输出获取

**问题**：
- 轮询间隔太长，用户感觉响应慢
- 进度更新不够实时
- 状态条可能不够明显

#### 2. 并发安全问题

**当前实现**：
- 使用 `fetch_status_lock` 线程锁保护状态
- 检查 `fetch_status['running']` 防止重复启动
- 使用后台线程执行任务

**潜在问题**：
- 如果多个用户同时点击，虽然会检查 `running` 状态，但如果检查时状态还未更新，可能会启动多个任务
- 没有用户级别的限制（所有用户共享一个状态）
- 如果任务异常退出，状态可能不会正确重置

### 修复方案

#### 方案1：改进前端显示（推荐）

1. **缩短轮询间隔**：从5秒改为2秒
2. **改进进度显示**：更明显的进度条和状态信息
3. **添加实时日志**：显示当前抓取的关键词

#### 方案2：增强并发保护

1. **原子性检查**：使用锁保护整个检查-设置过程
2. **任务队列**：如果任务正在运行，将新请求加入队列
3. **用户级别限制**：每个用户只能有一个运行中的任务（可选）

#### 方案3：改进状态同步

1. **WebSocket**：使用WebSocket实现实时状态推送（复杂）
2. **Server-Sent Events (SSE)**：服务器主动推送状态更新（中等复杂度）
3. **更频繁的轮询**：缩短轮询间隔（简单，但增加服务器负载）

---

## 推荐的修复方案

### 优先级1：改进前端显示（立即实施）

1. 缩短轮询间隔到2秒
2. 改进状态条显示
3. 添加更详细的进度信息

### 优先级2：增强并发保护（重要）

1. 改进锁机制，确保原子性操作
2. 添加任务超时检测（如果超过10分钟，自动重置状态）
3. 添加更详细的错误处理

### 优先级3：优化用户体验（可选）

1. 添加WebSocket或SSE支持（实时推送）
2. 添加任务取消功能
3. 添加任务历史记录

---

## 实施步骤

### 步骤1：检查B站数据更新流程

```bash
python3 scripts/check_bilibili_api_to_db.py
```

根据检查结果：
- 如果数据过旧，手动运行 `python3 fetch_bilibili_data.py`
- 如果定时任务未启动，检查 `.env` 配置并重启服务器

### 步骤2：修复论文刷新按钮的前端显示

修改 `static/js/app.js`：
- 缩短轮询间隔
- 改进状态显示
- 添加更详细的进度信息

### 步骤3：增强并发保护

修改 `app.py`：
- 改进锁机制
- 添加超时检测
- 改进错误处理

---

## 测试建议

### B站数据更新测试

1. 运行诊断脚本检查当前状态
2. 手动触发一次数据更新
3. 验证数据库中的数据是否更新
4. 检查前端显示的数据是否最新

### 论文刷新按钮测试

1. 单个用户测试：
   - 点击刷新按钮
   - 观察状态显示是否正常
   - 验证数据是否更新

2. 并发测试：
   - 两个用户同时点击刷新按钮
   - 验证是否只有一个任务运行
   - 验证第二个用户是否收到"任务正在运行"的提示

3. 异常情况测试：
   - 在任务运行期间刷新页面
   - 验证状态是否正确恢复
   - 验证任务是否继续运行

---

## 代码修改清单

### 需要修改的文件

1. `static/js/app.js` - 改进前端显示
2. `app.py` - 增强并发保护
3. `scripts/check_bilibili_api_to_db.py` - 新增诊断脚本

### 预计修改时间

- 前端显示改进：30分钟
- 并发保护增强：1小时
- 测试和验证：30分钟

**总计：约2小时**

