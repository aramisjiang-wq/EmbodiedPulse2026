# 定时任务重试机制 - 安全实施方案

**文档版本**: v1.0  
**创建日期**: 2025-12-18  
**实施原则**: 安全第一，不影响现有系统稳定性

---

## 🛡️ 安全设计原则

### 1. 默认关闭，按需启用
- ✅ 重试机制默认**关闭**，不影响现有代码
- ✅ 通过环境变量 `SCHEDULER_RETRY_ENABLED=true` 启用
- ✅ 可以随时关闭，立即恢复原有行为

### 2. 向后兼容
- ✅ 不修改现有定时任务函数逻辑
- ✅ 只添加装饰器，原有代码保持不变
- ✅ 即使装饰器出错，也不影响原函数执行

### 3. 渐进式实施
- ✅ 先在一个不重要的任务上测试
- ✅ 验证无误后，逐步推广到其他任务
- ✅ 每个阶段都可以回滚

### 4. 完善的监控和日志
- ✅ 详细记录每次重试的信息
- ✅ 记录重试配置和状态
- ✅ 便于问题排查和回滚

---

## 📋 实施步骤

### 阶段1：添加工具模块（已完成，不影响系统）

**文件**: `scheduler_utils.py`

**特点**:
- 独立的工具模块，不修改现有代码
- 默认关闭，需要环境变量启用
- 可以随时删除，不影响系统

**验证**:
```bash
# 检查模块是否可以正常导入
python3 -c "from scheduler_utils import is_retry_enabled; print(is_retry_enabled())"
# 应该输出: False（默认关闭）
```

---

### 阶段2：在测试环境验证（推荐）

**步骤**:
1. 在测试环境部署新代码
2. 启用重试机制：`export SCHEDULER_RETRY_ENABLED=true`
3. 测试一个不重要的任务（如招聘信息抓取）
4. 观察日志，验证重试机制是否正常工作
5. 模拟失败场景，验证重试逻辑

**验证命令**:
```bash
# 检查重试配置
python3 -c "from scheduler_utils import get_retry_config; import json; print(json.dumps(get_retry_config(), indent=2))"
```

---

### 阶段3：在单个任务上应用（生产环境）

**选择任务**: 招聘信息抓取任务（相对不重要，失败影响小）

**修改代码**:
```python
# 在 app.py 中，只修改这一个任务
from scheduler_utils import retry_on_failure

@retry_on_failure(max_retries=3, retry_delay=60)
def scheduled_fetch_jobs():
    """定时抓取招聘信息任务"""
    try:
        logger.info("开始执行定时招聘信息抓取任务...")
        from fetch_jobs import fetch_and_save_jobs
        fetch_and_save_jobs()
        logger.info("定时招聘信息抓取任务完成")
    except Exception as e:
        logger.error(f"定时招聘信息抓取任务失败: {e}")
```

**部署**:
1. 部署代码（重试机制默认关闭）
2. 观察1-2天，确认系统稳定
3. 启用重试：`export SCHEDULER_RETRY_ENABLED=true`
4. 重启应用
5. 观察日志，确认重试机制正常工作

---

### 阶段4：逐步推广到其他任务

**推广顺序**（按重要性从低到高）:
1. ✅ 招聘信息抓取（已完成）
2. 新闻信息抓取
3. B站数据抓取
4. Semantic Scholar更新
5. 论文抓取（最重要，最后实施）

**每个任务实施步骤**:
1. 添加装饰器
2. 部署代码（默认关闭）
3. 观察1-2天
4. 启用重试
5. 观察1周
6. 继续下一个任务

---

## 🔧 代码修改示例

### 修改前（原有代码，保持不变）

```python
def scheduled_fetch_jobs():
    """定时抓取招聘信息任务"""
    try:
        logger.info("开始执行定时招聘信息抓取任务...")
        from fetch_jobs import fetch_and_save_jobs
        fetch_and_save_jobs()
        logger.info("定时招聘信息抓取任务完成")
    except Exception as e:
        logger.error(f"定时招聘信息抓取任务失败: {e}")
```

### 修改后（添加装饰器，保持原有逻辑）

```python
from scheduler_utils import retry_on_failure

@retry_on_failure(max_retries=3, retry_delay=60)
def scheduled_fetch_jobs():
    """定时抓取招聘信息任务"""
    try:
        logger.info("开始执行定时招聘信息抓取任务...")
        from fetch_jobs import fetch_and_save_jobs
        fetch_and_save_jobs()
        logger.info("定时招聘信息抓取任务完成")
    except Exception as e:
        logger.error(f"定时招聘信息抓取任务失败: {e}")
```

**关键点**:
- ✅ 原有代码逻辑完全不变
- ✅ 只是添加了装饰器
- ✅ 默认不启用，不影响现有行为
- ✅ 即使装饰器出错，原函数仍会执行

---

## ⚙️ 环境变量配置

### 基础配置

```bash
# .env 文件

# 启用重试机制（默认false，确保安全）
SCHEDULER_RETRY_ENABLED=false

# 重试配置（可选，使用默认值）
SCHEDULER_MAX_RETRIES=3
SCHEDULER_RETRY_DELAY=60
SCHEDULER_BACKOFF_FACTOR=2
```

### 启用重试机制

```bash
# 方式1：环境变量
export SCHEDULER_RETRY_ENABLED=true

# 方式2：.env 文件
echo "SCHEDULER_RETRY_ENABLED=true" >> .env

# 方式3：Docker环境变量
docker-compose.yml:
  environment:
    - SCHEDULER_RETRY_ENABLED=true
```

### 关闭重试机制（紧急回滚）

```bash
# 立即关闭，恢复原有行为
export SCHEDULER_RETRY_ENABLED=false
# 重启应用即可
```

---

## 🧪 测试方案

### 测试1：验证默认行为（不启用重试）

```python
# 测试脚本: test_retry_disabled.py
from scheduler_utils import is_retry_enabled, retry_on_failure

@retry_on_failure(max_retries=3)
def test_task():
    print("执行任务")
    raise Exception("模拟失败")

# 默认不启用，应该只执行一次就失败
try:
    test_task()
except:
    print("任务失败（预期行为）")
```

**预期结果**: 任务只执行一次就失败，不会重试

---

### 测试2：验证启用重试

```bash
# 启用重试
export SCHEDULER_RETRY_ENABLED=true

# 运行测试
python3 test_retry_disabled.py
```

**预期结果**: 任务失败后会重试3次

---

### 测试3：验证不影响正常执行

```python
# 测试脚本: test_retry_normal.py
from scheduler_utils import retry_on_failure

@retry_on_failure(max_retries=3)
def test_task():
    print("执行任务")
    return "成功"

# 正常执行，不应该有重试
result = test_task()
print(f"结果: {result}")
```

**预期结果**: 任务正常执行，返回"成功"，没有重试

---

## 📊 监控和日志

### 日志格式

**重试日志示例**:
```
⚠️  定时任务 scheduled_fetch_jobs 失败 (尝试 1/4): Connection timeout
⏳ 等待 60 秒后重试...
✅ 定时任务 scheduled_fetch_jobs 重试成功 (第 2 次尝试)
```

**最终失败日志示例**:
```
❌ 定时任务 scheduled_fetch_jobs 失败，已重试 3 次: Connection timeout
告警信息: 🚨 定时任务失败告警...
```

### 监控指标

建议监控以下指标：
1. 任务执行成功率
2. 重试次数统计
3. 最终失败任务数量
4. 重试延迟时间

---

## 🚨 紧急回滚方案

### 情况1：发现重试机制有问题

```bash
# 立即关闭重试机制
export SCHEDULER_RETRY_ENABLED=false

# 重启应用
sudo systemctl restart embodiedpulse
```

**效果**: 立即恢复原有行为，所有任务按原逻辑执行

---

### 情况2：需要回滚代码

```bash
# 如果修改了 app.py，可以回滚
git checkout app.py

# 或者只删除装饰器，保留其他修改
# 删除 @retry_on_failure 这一行即可
```

**效果**: 代码恢复到修改前状态

---

### 情况3：删除工具模块（极端情况）

```bash
# 删除工具模块
rm scheduler_utils.py

# 删除 app.py 中的导入
# 删除 from scheduler_utils import retry_on_failure

# 删除装饰器
# 删除 @retry_on_failure 这一行
```

**效果**: 完全恢复到原始状态

---

## ✅ 安全检查清单

### 部署前检查

- [ ] 工具模块 `scheduler_utils.py` 已创建
- [ ] 环境变量 `SCHEDULER_RETRY_ENABLED` 默认为 `false`
- [ ] 测试环境已验证功能正常
- [ ] 回滚方案已准备

### 部署后检查

- [ ] 系统正常运行
- [ ] 日志正常输出
- [ ] 定时任务正常执行
- [ ] 没有异常错误

### 启用重试后检查

- [ ] 重试机制正常工作
- [ ] 日志记录详细
- [ ] 告警功能正常（如果配置）
- [ ] 系统性能正常

---

## 📝 实施时间表

### 第1周：准备阶段
- ✅ 创建工具模块
- ✅ 编写测试脚本
- ✅ 在测试环境验证

### 第2周：试点阶段
- 在单个任务（招聘信息）上应用
- 观察1-2天
- 启用重试，观察1周

### 第3-4周：推广阶段
- 逐步推广到其他任务
- 每个任务观察1周
- 最后实施论文抓取任务

### 第5周：优化阶段
- 根据实际运行情况调整参数
- 优化告警机制
- 完善监控

---

## 🎯 预期效果

### 改进前
- 任务失败后，需要等到下次定时执行
- 数据可能缺失数小时
- 需要人工查看日志才能发现问题

### 改进后
- 任务失败后立即重试（最多3次）
- 临时故障可以自动恢复
- 最终失败后发送告警，及时通知管理员
- 数据更新更及时，系统更稳定

---

## 📚 相关文档

- [定时任务失败重试机制方案](./定时任务失败重试机制方案_20251218_v1.0.md) - 详细技术方案
- [完整测试报告](../08-测试文档/完整测试报告与任务清单_20251218_v1.0.md) - 问题发现

---

**文档维护**：根据实施情况更新  
**最后更新**：2025-12-18

