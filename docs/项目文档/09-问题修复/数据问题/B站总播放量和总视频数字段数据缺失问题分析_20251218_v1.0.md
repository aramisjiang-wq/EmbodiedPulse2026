# Bç«™æ€»æ’­æ”¾é‡å’Œæ€»è§†é¢‘æ•°å­—æ®µæ•°æ®ç¼ºå¤±é—®é¢˜åˆ†æ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-18  
**æœ€åæ›´æ–°**: 2025-12-18  
**é—®é¢˜æè¿°**: æ•°æ®åº“ä¸­ `views_count` å’Œ `videos_count` å­—æ®µæ•°æ®å¼‚å¸¸

## âš ï¸ å®é™…å‘ç°çš„é—®é¢˜

### é—®é¢˜ç°è±¡

é€šè¿‡æ£€æŸ¥è„šæœ¬ `scripts/check_bilibili_stats_fields.py` å‘ç°ï¼š

1. **æ•°æ®æœ‰å€¼ï¼Œä½†å­—æ®µå€¼å¼‚å¸¸**ï¼š
   - `videos_count` å’Œ `views_count` çš„å€¼**å®Œå…¨ç›¸åŒ**
   - ä¾‹å¦‚ï¼š`videos_count: 3307108` å’Œ `views_count: 3307108`
   - ä½†å®é™…è§†é¢‘æ•°é‡åªæœ‰49ä¸ªï¼Œæ€»æ’­æ”¾é‡æ˜¯3307108

2. **å­—æ®µæ··æ·†**ï¼š
   - `videos_count` åº”è¯¥æ˜¯è§†é¢‘æ•°é‡ï¼ˆæ¯”å¦‚49ã€50ä¸ªï¼‰
   - `views_count` åº”è¯¥æ˜¯æ€»æ’­æ”¾é‡ï¼ˆæ¯”å¦‚3307108ï¼‰
   - ä½†ç°åœ¨ `videos_count` çš„å€¼å®é™…ä¸Šæ˜¯æ€»æ’­æ”¾é‡ï¼

3. **æ‰€æœ‰UPä¸»éƒ½æœ‰è¿™ä¸ªé—®é¢˜**ï¼š
   - æ£€æŸ¥çš„12ä¸ªUPä¸»ï¼Œ`videos_count` å’Œ `views_count` éƒ½ç›¸åŒ
   - è¯´æ˜è¿™æ˜¯ç³»ç»Ÿæ€§é—®é¢˜ï¼Œä¸æ˜¯ä¸ªåˆ«æ•°æ®é”™è¯¯

### æ ¹æœ¬åŸå› 

**æ ¸å¿ƒé—®é¢˜**ï¼š`_get_upstat()` æ¥å£è¿”å›çš„ `archive.view`ï¼ˆæ€»æ’­æ”¾é‡ï¼‰æ²¡æœ‰è¢«å……åˆ†åˆ©ç”¨

1. **`_get_user_stat_async()` æ–¹æ³•çš„é—®é¢˜**ï¼š
   - ä¼˜å…ˆå°è¯•ä½¿ç”¨ `get_user_stat()` æ–¹æ³•ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
   - åªåœ¨è·å–è·èµæ•°æ—¶ä½¿ç”¨äº† `_get_upstat()`ï¼Œ**æ²¡æœ‰ä½¿ç”¨ `archive.view` è·å–æ€»æ’­æ”¾é‡**
   - å¦‚æœ `get_user_stat()` å¤±è´¥ï¼Œåªèƒ½ä»è§†é¢‘åˆ—è¡¨è®¡ç®—ï¼Œä½†åªè·å–äº†50ä¸ªè§†é¢‘

2. **`_fallback_user_stat()` æ–¹æ³•çš„é—®é¢˜**ï¼š
   - åªåœ¨è·å–è·èµæ•°æ—¶ä½¿ç”¨äº† `_get_upstat()`
   - **æ²¡æœ‰ä½¿ç”¨ `archive.view` è·å–æ€»æ’­æ”¾é‡**
   - åªèƒ½ä»å·²è·å–çš„è§†é¢‘åˆ—è¡¨è®¡ç®—ï¼Œæ•°æ®ä¸å®Œæ•´

### ä¿®å¤æ–¹æ¡ˆ

**å·²ä¿®å¤**ï¼ˆ2025-12-18ï¼‰ï¼š

1. **ä¿®æ”¹ `_get_user_stat_async()` æ–¹æ³•**ï¼š
   - âœ… ä¼˜å…ˆä½¿ç”¨ `_get_upstat()` æ¥å£è·å–æ€»æ’­æ”¾é‡
   - âœ… ä» `archive.view` è·å–æ€»æ’­æ”¾é‡ï¼Œè€Œä¸æ˜¯ä»è§†é¢‘åˆ—è¡¨è®¡ç®—

2. **ä¿®æ”¹ `_fallback_user_stat()` æ–¹æ³•**ï¼š
   - âœ… ä¼˜å…ˆä½¿ç”¨ `_get_upstat()` æ¥å£è·å–æ€»æ’­æ”¾é‡
   - âœ… ä» `archive.view` è·å–æ€»æ’­æ”¾é‡

3. **æ”¹è¿›é”™è¯¯å¤„ç†**ï¼š
   - âœ… åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œä¹Ÿå°è¯•ä½¿ç”¨ `_get_upstat()` è·å–æ€»æ’­æ”¾é‡

---

## ğŸ” é—®é¢˜åˆ†æ

### å½“å‰æ•°æ®è·å–æµç¨‹

#### 1. æ•°æ®è·å–è·¯å¾„ï¼ˆbilibili_client.pyï¼‰

**è·¯å¾„1ï¼š`_get_user_stat_async()` æ–¹æ³•**
```python
# ç¬¬354-361è¡Œï¼šå°è¯•ä½¿ç”¨ get_user_stat æ–¹æ³•
if hasattr(u, 'get_user_stat'):
    stat_info = await u.get_user_stat()
    archive = stat_info.get('archive', {})
    total_views = archive.get('view', 0)  # âœ… ä»archive.viewè·å–æ€»æ’­æ”¾é‡
```

**è·¯å¾„2ï¼šä»è§†é¢‘åˆ—è¡¨è®¡ç®—ï¼ˆå¤‡é€‰ï¼‰**
```python
# ç¬¬380-391è¡Œï¼šå¦‚æœæ€»æ’­æ”¾æ•°ä¸º0ï¼Œä»è§†é¢‘åˆ—è¡¨è®¡ç®—
if not total_views:
    videos_result = await u.get_videos(pn=1, ps=50)  # âš ï¸ åªè·å–50ä¸ªè§†é¢‘
    vlist = videos_result.get('list', {}).get('vlist', [])
    video_count = len(vlist)  # è§†é¢‘æ•°é‡ï¼ˆåªæœ‰50ä¸ªï¼‰
    total_views = sum(v.get('play', 0) for v in vlist)  # æ€»æ’­æ”¾é‡ï¼ˆåªæœ‰50ä¸ªè§†é¢‘çš„ï¼‰
```

**è·¯å¾„3ï¼šfallbackæ–¹æ³•**
```python
# ç¬¬193-218è¡Œï¼š_fallback_user_stat()
# å¦‚æœAPIå¤±è´¥ï¼Œä»å·²è·å–çš„è§†é¢‘åˆ—è¡¨è®¡ç®—
total_views = sum(v.get('play', 0) for v in videos)  # âš ï¸ åªè®¡ç®—å·²è·å–çš„è§†é¢‘
video_count = len(videos)  # âš ï¸ åªè®¡ç®—å·²è·å–çš„è§†é¢‘æ•°é‡
```

---

## âš ï¸ é—®é¢˜æ ¹æº

### é—®é¢˜1ï¼š`get_user_stat()` æ–¹æ³•å¯èƒ½ä¸å­˜åœ¨

**ä»£ç ä½ç½®**: `bilibili_client.py` ç¬¬356è¡Œ

```python
if hasattr(u, 'get_user_stat'):  # âš ï¸ å¯èƒ½è¿”å›False
    stat_info = await u.get_user_stat()
```

**é—®é¢˜**ï¼š
- `bilibili-api-python` åº“çš„ `user.User` ç±»å¯èƒ½æ²¡æœ‰ `get_user_stat()` æ–¹æ³•
- å¦‚æœæ–¹æ³•ä¸å­˜åœ¨ï¼Œ`total_views` ä¼šä¿æŒä¸º0
- ç„¶åä¼šå°è¯•ä»è§†é¢‘åˆ—è¡¨è®¡ç®—ï¼Œä½†åªè·å–äº†50ä¸ªè§†é¢‘

---

### é—®é¢˜2ï¼šä»è§†é¢‘åˆ—è¡¨è®¡ç®—ä¸å‡†ç¡®

**ä»£ç ä½ç½®**: `bilibili_client.py` ç¬¬382è¡Œ

```python
videos_result = await u.get_videos(pn=1, ps=50)  # âš ï¸ åªè·å–50ä¸ªè§†é¢‘
```

**é—®é¢˜**ï¼š
- åªè·å–äº†å‰50ä¸ªè§†é¢‘ï¼Œä¸æ˜¯å…¨éƒ¨è§†é¢‘
- å¦‚æœUPä¸»æœ‰è¶…è¿‡50ä¸ªè§†é¢‘ï¼Œæ€»æ’­æ”¾é‡ä¼šä¸å‡†ç¡®
- è§†é¢‘æ•°é‡ä¹Ÿä¼šä¸å‡†ç¡®ï¼ˆåªæœ‰50ä¸ªï¼‰

---

### é—®é¢˜3ï¼š`_get_upstat()` æ¥å£æœªå……åˆ†åˆ©ç”¨

**ä»£ç ä½ç½®**: `bilibili_client.py` ç¬¬180-191è¡Œ

```python
def _get_upstat(self, mid: int) -> Optional[Dict]:
    """é€šè¿‡å…¬å¼€APIè·å–UPä¸»ç»Ÿè®¡æ•°æ®"""
    url = "https://api.bilibili.com/x/space/upstat"
    data = self._request_json(url, params={"mid": mid})
    stat_data = data.get("data", {})
    return {
        'archive': stat_data.get('archive', {}),  # âš ï¸ åŒ…å«äº†æ€»æ’­æ”¾é‡ï¼Œä½†æ²¡æœ‰ä½¿ç”¨
        'article': stat_data.get('article', {}),
        'likes': stat_data.get('likes', 0),
    }
```

**é—®é¢˜**ï¼š
- `_get_upstat()` è¿”å›äº† `archive` æ•°æ®ï¼Œå…¶ä¸­åŒ…å« `archive.view`ï¼ˆæ€»æ’­æ”¾é‡ï¼‰
- ä½†åœ¨ `_get_user_stat_async()` ä¸­ï¼Œåªåœ¨è·å–è·èµæ•°æ—¶ä½¿ç”¨äº† `upstat`ï¼Œ**æ²¡æœ‰ä½¿ç”¨ `archive.view` æ¥è·å–æ€»æ’­æ”¾é‡**
- è¿™æ˜¯ä¸€ä¸ª**å…³é”®é—æ¼**ï¼

---

### é—®é¢˜4ï¼šfallbackæ–¹æ³•æ•°æ®ä¸å®Œæ•´

**ä»£ç ä½ç½®**: `bilibili_client.py` ç¬¬193-218è¡Œ

```python
def _fallback_user_stat(self, mid: int, videos: List[Dict]) -> Dict:
    total_views = sum(v.get('play', 0) for v in videos)  # âš ï¸ åªè®¡ç®—å·²è·å–çš„è§†é¢‘
    video_count = len(videos)  # âš ï¸ åªè®¡ç®—å·²è·å–çš„è§†é¢‘æ•°é‡
```

**é—®é¢˜**ï¼š
- å¦‚æœAPIå¤±è´¥ï¼Œfallbackæ–¹æ³•åªèƒ½ä»å·²è·å–çš„è§†é¢‘åˆ—è¡¨è®¡ç®—
- å¦‚æœåªè·å–äº†éƒ¨åˆ†è§†é¢‘ï¼ˆæ¯”å¦‚10ä¸ªï¼‰ï¼Œè®¡ç®—å‡ºçš„æ•°æ®ä¼šä¸å‡†ç¡®

---

## ğŸ¯ æ ¹æœ¬åŸå› 

### æ ¸å¿ƒé—®é¢˜ï¼š`_get_upstat()` æ¥å£çš„æ•°æ®æœªè¢«å……åˆ†åˆ©ç”¨

**Bç«™API `/x/space/upstat` è¿”å›çš„æ•°æ®ç»“æ„**ï¼š
```json
{
  "code": 0,
  "data": {
    "archive": {
      "view": 12345678,  // âœ… æ€»æ’­æ”¾é‡
      "article": {
        "view": 0
      }
    },
    "likes": 12345  // è·èµæ•°
  }
}
```

**å½“å‰ä»£ç çš„é—®é¢˜**ï¼š
1. âœ… `_get_upstat()` è·å–äº† `archive` æ•°æ®
2. âŒ ä½†åœ¨ `_get_user_stat_async()` ä¸­ï¼Œ**æ²¡æœ‰ä½¿ç”¨ `archive.view` æ¥è·å–æ€»æ’­æ”¾é‡**
3. âŒ åªåœ¨è·å–è·èµæ•°æ—¶ä½¿ç”¨äº† `upstat.get('likes', 0)`
4. âŒ æ€»æ’­æ”¾é‡åªèƒ½ä»è§†é¢‘åˆ—è¡¨è®¡ç®—ï¼Œä½†åªè·å–äº†50ä¸ªè§†é¢‘

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå……åˆ†åˆ©ç”¨ `_get_upstat()` æ¥å£ï¼ˆæ¨èï¼‰

**ä¿®æ”¹ `_get_user_stat_async()` æ–¹æ³•**ï¼š

```python
async def _get_user_stat_async(self, mid: int) -> Optional[Dict]:
    """å¼‚æ­¥è·å–UPä¸»ç»Ÿè®¡æ•°æ®"""
    try:
        u = user.User(uid=mid, credential=self.credential)
        info = await u.get_user_info()
        
        likes = 0
        total_views = 0
        video_count = 0
        
        # âœ… ä¼˜å…ˆä½¿ç”¨ upstat æ¥å£è·å–ç»Ÿè®¡æ•°æ®ï¼ˆåŒ…å«æ€»æ’­æ”¾é‡ï¼‰
        try:
            upstat = self._get_upstat(mid)
            if upstat:
                archive = upstat.get('archive', {})
                if isinstance(archive, dict):
                    total_views = archive.get('view', 0)  # âœ… ä»upstatè·å–æ€»æ’­æ”¾é‡
                likes = upstat.get('likes', 0)
        except Exception as upstat_error:
            logger.debug(f"é€šè¿‡upstatæ¥å£è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: {upstat_error}")
        
        # å¦‚æœupstatå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ get_user_stat æ–¹æ³•
        if not total_views:
            try:
                if hasattr(u, 'get_user_stat'):
                    stat_info = await u.get_user_stat()
                    if isinstance(stat_info, dict):
                        archive = stat_info.get('archive', {})
                        total_views = archive.get('view', 0) if isinstance(archive, dict) else 0
                        if not likes:
                            likes = stat_info.get('likes', 0)
            except Exception as stat_error:
                logger.debug(f"get_user_stat æ–¹æ³•ä¸å¯ç”¨: {stat_error}")
        
        # å¦‚æœè¿˜æ˜¯è·å–ä¸åˆ°è·èµæ•°ï¼Œå°è¯•ä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–
        if not likes:
            likes = info.get('likes', 0)
        
        # è·å–è§†é¢‘æ•°é‡ï¼ˆéœ€è¦è·å–æ‰€æœ‰è§†é¢‘ï¼Œæˆ–ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼‰
        # âš ï¸ æ³¨æ„ï¼šè§†é¢‘æ•°é‡ä¸èƒ½ä»upstatè·å–ï¼Œéœ€è¦ä»è§†é¢‘åˆ—è¡¨è·å–
        if not video_count:
            try:
                # å°è¯•è·å–è§†é¢‘æ€»æ•°ï¼ˆå¯èƒ½éœ€è¦åˆ†é¡µè·å–ï¼‰
                videos_result = await u.get_videos(pn=1, ps=50)
                vlist = videos_result.get('list', {}).get('vlist', [])
                # å¦‚æœåªæœ‰50ä¸ªè§†é¢‘ï¼Œè¯´æ˜å¯èƒ½å·²ç»è·å–å®Œ
                # å¦‚æœæœ‰æ›´å¤šï¼Œéœ€è¦åˆ†é¡µè·å–ï¼ˆä½†è¿™é‡Œå…ˆä½¿ç”¨50ä¸ªä½œä¸ºè¿‘ä¼¼å€¼ï¼‰
                video_count = len(vlist)
                
                # å¦‚æœæ€»æ’­æ”¾é‡è¿˜æ˜¯0ï¼Œä»è§†é¢‘åˆ—è¡¨è®¡ç®—ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
                if not total_views:
                    total_views = sum(
                        v.get('play', 0) or (v.get('stat', {}).get('view', 0) if isinstance(v.get('stat'), dict) else 0)
                        for v in vlist
                    )
            except Exception as video_error:
                logger.debug(f"è·å–è§†é¢‘æ•°é‡å¤±è´¥: {video_error}")
        
        return {
            'videos': video_count,
            'likes': likes,
            'views': total_views,
        }
    except Exception as e:
        logger.error(f"è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: {e}")
        # ... é”™è¯¯å¤„ç†
```

---

### æ–¹æ¡ˆ2ï¼šä»æ•°æ®åº“è§†é¢‘è¡¨è®¡ç®—å¹¶æ›´æ–°ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

**å¦‚æœAPIæ— æ³•è·å–ï¼Œå¯ä»¥ä»æ•°æ®åº“è§†é¢‘è¡¨è®¡ç®—**ï¼š

```python
# åœ¨ fetch_bilibili_data.py ä¸­æ·»åŠ 
def update_stats_from_videos(up, session):
    """ä»è§†é¢‘è¡¨è®¡ç®—å¹¶æ›´æ–°ç»Ÿè®¡æ•°æ®"""
    # ç»Ÿè®¡è§†é¢‘æ•°é‡
    video_count = session.query(func.count(BilibiliVideo.bvid)).filter_by(
        uid=up.uid,
        is_deleted=False
    ).scalar()
    
    # ç»Ÿè®¡æ€»æ’­æ”¾é‡
    total_views = session.query(func.sum(BilibiliVideo.play)).filter_by(
        uid=up.uid,
        is_deleted=False
    ).scalar() or 0
    
    # æ›´æ–°åˆ°UPä¸»è¡¨
    if video_count > 0:
        up.videos_count = video_count
    if total_views > 0:
        up.views_count = total_views
        up.views_formatted = format_number(total_views)
    
    return video_count, total_views
```

---

## ğŸ“Š æ•°æ®æµåˆ†æ

### å½“å‰æ•°æ®æµï¼ˆæœ‰é—®é¢˜ï¼‰

```
Bç«™API
  â†“
get_all_data()
  â†“
_get_user_stat_async()
  â†“
å°è¯• get_user_stat() â†’ å¯èƒ½å¤±è´¥
  â†“
å°è¯•ä»è§†é¢‘åˆ—è¡¨è®¡ç®— â†’ åªè·å–50ä¸ªè§†é¢‘ â†’ æ•°æ®ä¸å‡†ç¡®
  â†“
è¿”å› user_stat = {'videos': 50, 'views': éƒ¨åˆ†æ’­æ”¾é‡}
  â†“
ä¿å­˜åˆ°æ•°æ®åº“ â†’ videos_count=50, views_count=éƒ¨åˆ†æ’­æ”¾é‡ âŒ
```

### ä¿®å¤åçš„æ•°æ®æµ

```
Bç«™API
  â†“
get_all_data()
  â†“
_get_user_stat_async()
  â†“
ä¼˜å…ˆä½¿ç”¨ _get_upstat() â†’ è·å– archive.viewï¼ˆæ€»æ’­æ”¾é‡ï¼‰âœ…
  â†“
ä»è§†é¢‘åˆ—è¡¨è·å–è§†é¢‘æ•°é‡ï¼ˆå¯èƒ½éœ€è¦åˆ†é¡µï¼‰
  â†“
è¿”å› user_stat = {'videos': å®é™…æ•°é‡, 'views': å®é™…æ€»æ’­æ”¾é‡}
  â†“
ä¿å­˜åˆ°æ•°æ®åº“ â†’ videos_count=å®é™…æ•°é‡, views_count=å®é™…æ€»æ’­æ”¾é‡ âœ…
```

---

## ğŸ” æ£€æŸ¥è„šæœ¬

å·²åˆ›å»ºæ£€æŸ¥è„šæœ¬ï¼š`scripts/check_bilibili_stats_fields.py`

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
python3 scripts/check_bilibili_stats_fields.py
```

**åŠŸèƒ½**ï¼š
- æ£€æŸ¥æ•°æ®åº“ä¸­æ¯ä¸ªUPä¸»çš„ `videos_count` å’Œ `views_count` å­—æ®µ
- å¯¹æ¯”è§†é¢‘è¡¨ä¸­çš„å®é™…æ•°æ®
- è¯†åˆ«æ•°æ®ç¼ºå¤±æˆ–ä¸ä¸€è‡´çš„æƒ…å†µ
- æä¾›ä¿®å¤å»ºè®®

---

## ğŸ¯ ä¿®å¤å»ºè®®

### ç«‹å³ä¿®å¤ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **ä¿®æ”¹ `_get_user_stat_async()` æ–¹æ³•**
   - ä¼˜å…ˆä½¿ç”¨ `_get_upstat()` æ¥å£è·å–æ€»æ’­æ”¾é‡
   - ä» `archive.view` è·å–æ€»æ’­æ”¾é‡ï¼Œè€Œä¸æ˜¯ä»è§†é¢‘åˆ—è¡¨è®¡ç®—

2. **æ”¹è¿›è§†é¢‘æ•°é‡è·å–**
   - å¦‚æœå¯èƒ½ï¼Œè·å–æ‰€æœ‰è§†é¢‘çš„æ•°é‡
   - æˆ–è€…ä½¿ç”¨Bç«™APIçš„å…¶ä»–æ¥å£è·å–è§†é¢‘æ€»æ•°

3. **æ”¹è¿›fallbackæ–¹æ³•**
   - åœ¨ `_fallback_user_stat()` ä¸­ä¹Ÿå°è¯•ä½¿ç”¨ `_get_upstat()` æ¥å£

### ä¸´æ—¶æ–¹æ¡ˆï¼ˆå¦‚æœAPIæ— æ³•ä¿®å¤ï¼‰

1. **ä»æ•°æ®åº“è§†é¢‘è¡¨è®¡ç®—å¹¶æ›´æ–°**
   - åˆ›å»ºè„šæœ¬ï¼Œä»è§†é¢‘è¡¨ç»Ÿè®¡å¹¶æ›´æ–° `videos_count` å’Œ `views_count`
   - å®šæœŸè¿è¡Œï¼Œç¡®ä¿æ•°æ®å‡†ç¡®

2. **æ•°æ®ä¿®å¤è„šæœ¬**
   - åˆ›å»ºè„šæœ¬ä¿®å¤ç°æœ‰æ•°æ®
   - ä»è§†é¢‘è¡¨è®¡ç®—å¹¶æ›´æ–°æ‰€æœ‰UPä¸»çš„ç»Ÿè®¡æ•°æ®

---

## ğŸ“ ä¿®å¤ä»£ç ç¤ºä¾‹

### ä¿®å¤ `_get_user_stat_async()` æ–¹æ³•

```python
async def _get_user_stat_async(self, mid: int) -> Optional[Dict]:
    """å¼‚æ­¥è·å–UPä¸»ç»Ÿè®¡æ•°æ®"""
    try:
        u = user.User(uid=mid, credential=self.credential)
        info = await u.get_user_info()
        
        likes = 0
        total_views = 0
        video_count = 0
        
        # âœ… ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ upstat æ¥å£è·å–æ€»æ’­æ”¾é‡
        try:
            upstat = self._get_upstat(mid)
            if upstat:
                archive = upstat.get('archive', {})
                if isinstance(archive, dict):
                    # âœ… ä» archive.view è·å–æ€»æ’­æ”¾é‡
                    total_views = archive.get('view', 0)
                    logger.debug(f"ä»upstatæ¥å£è·å–æ€»æ’­æ”¾é‡: {total_views}")
                likes = upstat.get('likes', 0)
        except Exception as upstat_error:
            logger.debug(f"é€šè¿‡upstatæ¥å£è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: {upstat_error}")
        
        # å¦‚æœupstatå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ get_user_stat æ–¹æ³•
        if not total_views:
            try:
                if hasattr(u, 'get_user_stat'):
                    stat_info = await u.get_user_stat()
                    if isinstance(stat_info, dict):
                        archive = stat_info.get('archive', {})
                        total_views = archive.get('view', 0) if isinstance(archive, dict) else 0
                        if not likes:
                            likes = stat_info.get('likes', 0)
            except Exception as stat_error:
                logger.debug(f"get_user_stat æ–¹æ³•ä¸å¯ç”¨: {stat_error}")
        
        # å¦‚æœè¿˜æ˜¯è·å–ä¸åˆ°è·èµæ•°ï¼Œå°è¯•ä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–
        if not likes:
            likes = info.get('likes', 0)
        
        # è·å–è§†é¢‘æ•°é‡
        if not video_count:
            try:
                videos_result = await u.get_videos(pn=1, ps=50)
                vlist = videos_result.get('list', {}).get('vlist', [])
                video_count = len(vlist)
                
                # å¦‚æœæ€»æ’­æ”¾é‡è¿˜æ˜¯0ï¼Œä»è§†é¢‘åˆ—è¡¨è®¡ç®—ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
                if not total_views:
                    total_views = sum(
                        v.get('play', 0) or (v.get('stat', {}).get('view', 0) if isinstance(v.get('stat'), dict) else 0)
                        for v in vlist
                    )
            except Exception as video_error:
                logger.debug(f"è·å–è§†é¢‘æ•°é‡å¤±è´¥: {video_error}")
        
        return {
            'videos': video_count,
            'likes': likes,
            'views': total_views,
        }
    except Exception as e:
        logger.error(f"è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: {e}")
        import traceback
        logger.error(traceback.format_exc())
        # å…œåº•ï¼šå°è¯•ä½¿ç”¨upstatæ¥å£
        try:
            upstat = self._get_upstat(mid)
            if upstat:
                archive = upstat.get('archive', {})
                total_views = archive.get('view', 0) if isinstance(archive, dict) else 0
                return {
                    'videos': 0,  # æ— æ³•è·å–è§†é¢‘æ•°é‡
                    'likes': upstat.get('likes', 0),
                    'views': total_views,  # âœ… è‡³å°‘è·å–æ€»æ’­æ”¾é‡
                }
        except Exception as fallback_error:
            logger.debug(f"å…œåº•è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: {fallback_error}")
        return {
            'videos': 0,
            'likes': 0,
            'views': 0,
        }
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€

```bash
# è¿è¡Œæ£€æŸ¥è„šæœ¬
python3 scripts/check_bilibili_stats_fields.py
```

### æ­¥éª¤2ï¼šä¿®å¤ä»£ç 

1. ä¿®æ”¹ `bilibili_client.py` ä¸­çš„ `_get_user_stat_async()` æ–¹æ³•
2. ä¼˜å…ˆä½¿ç”¨ `_get_upstat()` æ¥å£è·å–æ€»æ’­æ”¾é‡
3. æ”¹è¿›é”™è¯¯å¤„ç†å’Œfallbacké€»è¾‘

### æ­¥éª¤3ï¼šæµ‹è¯•éªŒè¯

1. æµ‹è¯•å•ä¸ªUPä¸»çš„æ•°æ®è·å–
2. éªŒè¯ `views_count` å’Œ `videos_count` æ˜¯å¦æ­£ç¡®å¡«å……
3. æ£€æŸ¥APIè¿”å›çš„æ•°æ®

### æ­¥éª¤4ï¼šé‡æ–°æŠ“å–æ•°æ®

```bash
# é‡æ–°æŠ“å–æ‰€æœ‰UPä¸»æ•°æ®
python3 fetch_bilibili_data.py
```

### æ­¥éª¤5ï¼šéªŒè¯ä¿®å¤

```bash
# å†æ¬¡è¿è¡Œæ£€æŸ¥è„šæœ¬
python3 scripts/check_bilibili_stats_fields.py
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
- `views_count` å¯èƒ½ä¸º0æˆ–åªæœ‰éƒ¨åˆ†è§†é¢‘çš„æ’­æ”¾é‡
- `videos_count` å¯èƒ½åªæœ‰50ï¼ˆåªè·å–äº†50ä¸ªè§†é¢‘ï¼‰

### ä¿®å¤å
- `views_count` ä» `archive.view` è·å–ï¼Œæ˜¯çœŸå®çš„æ€»æ’­æ”¾é‡
- `videos_count` ä»è§†é¢‘åˆ—è¡¨è·å–ï¼ˆå¯èƒ½éœ€è¦æ”¹è¿›ï¼‰

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šæ ¹æ®ä¿®å¤æƒ…å†µæ›´æ–°  
**æœ€åæ›´æ–°**ï¼š2025-12-18

