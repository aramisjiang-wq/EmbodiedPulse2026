# 前端显示旧数据问题完整解决方案

## 问题总结

**现象**: 服务器数据库已更新（播放量171,419），但前端页面仍显示旧数据（5530）

**根本原因**: 后端API有5分钟缓存机制，初始加载时使用了缓存的旧数据

## 完整数据流分析

### 数据流转路径

```
┌─────────────────────────────────────────────────────────────┐
│ 1. B站API                                                   │
│    播放量: 171,419 ✅                                        │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. 数据库 (bilibili.db)                                      │
│    播放量: 171,419 ✅ (已确认更新)                            │
│    字段: play = 171419, play_formatted = "17.1万"            │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 后端API (/api/bilibili/all)                              │
│    ⚠️  问题：有5分钟缓存                                      │
│    缓存位置: bilibili_cache['all_data']                      │
│    缓存时间: 300秒 (5分钟)                                    │
│    如果缓存存在且未过期 → 返回缓存数据（可能是旧数据）         │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. 前端JavaScript (loadBilibiliAll函数)                      │
│    调用: fetch('/api/bilibili/all')                          │
│    ⚠️  问题：没有使用force=1参数，可能获取到缓存数据          │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. 前端数据处理 (renderLatestVideos函数)                      │
│    数据来源: cards[].videos[]                                │
│    显示字段: video.play (第1997行)                           │
│    筛选: 7天内的视频 (第1974行)                              │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│ 6. 前端页面显示                                              │
│    HTML: <span><i class="fas fa-play"></i> ${videoPlay}</span> │
│    ⚠️  显示旧数据: 5530                                      │
└─────────────────────────────────────────────────────────────┘
```

## 问题诊断

### 已确认的状态

✅ **数据库**: 播放量已更新为 171,419  
✅ **服务**: 已重启  
❌ **前端**: 仍显示 5530

### 可能的问题点

1. **后端缓存未清除** ⚠️ 最可能
   - 缓存键: `bilibili_cache['all_data']`
   - 缓存时间: 5分钟
   - 即使重启服务，如果重启前缓存已生成，重启后可能仍使用旧缓存

2. **前端未使用force参数** ⚠️ 已修复
   - 初始加载: `fetch('/api/bilibili/all')` → 可能使用缓存
   - 刷新按钮: `fetch('/api/bilibili/all?force=1')` → 清除缓存

3. **浏览器缓存** ⚠️ 可能
   - 浏览器可能缓存了API响应
   - 需要强制刷新（Ctrl+F5）

## 解决方案

### 方案1：清除后端缓存（立即执行）

在服务器上运行：

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

# 方法1: 使用诊断脚本
python3 scripts/diagnose_bilibili_cache.py

# 方法2: 手动清除缓存
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app

with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
    app.bilibili_cache['data'] = None
    app.bilibili_cache['expires_at'] = None
    print("✅ 所有缓存已清除")
EOF

# 重启服务
systemctl restart embodiedpulse
```

### 方案2：修改前端使用force参数（已修复）

我已经修改了 `templates/bilibili.html`，初始加载时也使用 `force=1` 参数：

```javascript
// 修改前
const response = await fetchWithTimeout('/api/bilibili/all');

// 修改后
const response = await fetchWithTimeout(`/api/bilibili/all?force=1&t=${timestamp}`);
```

### 方案3：在服务器上验证API返回

```bash
# 在服务器上运行
python3 << 'EOF'
import requests
import json

url = 'http://localhost:5001/api/bilibili/all?force=1'
response = requests.get(url, timeout=10)
data = response.json()

if data.get('success'):
    cards = data.get('data', [])
    for card in cards:
        if card.get('user_info', {}).get('mid') == 1172054289:
            videos = card.get('videos', [])
            for video in videos:
                if video.get('bvid') == 'BV1L8qEBKEFW':
                    print(f"✅ API返回:")
                    print(f"   播放量(play): {video.get('play')}")
                    print(f"   播放量(play_raw): {video.get('play_raw')}")
                    break
EOF
```

## 立即执行的步骤

### 步骤1：在服务器上清除缓存

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
bash scripts/clear_bilibili_cache.sh
```

### 步骤2：验证API返回

```bash
python3 scripts/diagnose_bilibili_cache.py
```

### 步骤3：前端验证

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 勾选 "Disable cache"
4. 访问: `https://essay.gradmotion.com/bilibili?force=1`
5. 查看 `/api/bilibili/all` 请求的响应

### 步骤4：检查前端显示

在浏览器控制台运行：

```javascript
// 检查API返回的数据
fetch('/api/bilibili/all?force=1')
  .then(r => r.json())
  .then(data => {
    const cards = data.data || [];
    const limxCard = cards.find(c => c.user_info?.mid === 1172054289);
    if (limxCard) {
      const video = limxCard.videos.find(v => v.bvid === 'BV1L8qEBKEFW');
      if (video) {
        console.log('目标视频:', {
          bvid: video.bvid,
          title: video.title,
          play: video.play,
          play_raw: video.play_raw
        });
      }
    }
  });
```

## 已创建的脚本

1. ✅ `scripts/diagnose_bilibili_cache.py` - 诊断缓存问题
2. ✅ `scripts/clear_bilibili_cache.sh` - 清除缓存并重启服务
3. ✅ `templates/bilibili.html` - 已修改为使用force参数

## 下一步

1. **立即执行**: 在服务器上运行 `bash scripts/clear_bilibili_cache.sh`
2. **验证**: 运行 `python3 scripts/diagnose_bilibili_cache.py` 检查状态
3. **前端验证**: 在浏览器中强制刷新页面（Ctrl+F5）
4. **如果仍有问题**: 检查浏览器控制台的API响应

