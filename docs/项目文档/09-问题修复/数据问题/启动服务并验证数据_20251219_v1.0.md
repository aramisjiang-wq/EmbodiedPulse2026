# 启动服务并验证数据

## 问题描述

服务未启动导致前端无法获取数据，数据库中的数据是正常的。

## 解决步骤

### 步骤1：检查服务状态

```bash
sudo systemctl status embodiedpulse
```

### 步骤2：如果服务未运行，启动服务

```bash
sudo systemctl start embodiedpulse
```

### 步骤3：如果启动失败，查看错误日志

```bash
sudo journalctl -u embodiedpulse -n 100 --no-pager
```

### 步骤4：检查服务是否正常启动

```bash
# 等待几秒
sleep 5

# 检查服务状态
sudo systemctl status embodiedpulse --no-pager -l | head -30

# 检查端口监听（应用运行在5001端口）
netstat -tlnp | grep 5001
# 或
lsof -i :5001
```

### 步骤5：测试API（使用正确的端口5001）

```bash
# 测试API返回
python3 scripts/test_api_response.py

# 或直接curl测试
curl "http://localhost:5001/api/bilibili/all?force=1" | python3 -m json.tool | head -50
```

### 步骤6：验证逐际动力数据

```bash
# 检查数据库中的逐际动力数据
python3 scripts/check_limx_data.py

# 检查API返回中是否包含逐际动力
python3 scripts/test_api_response.py | grep -A 20 "逐际动力"
```

## 重要提示

**应用运行在端口 5001，不是 5000！**

- Gunicorn配置：`gunicorn_config.py` 中 `port = os.getenv('PORT', '5001')`
- 测试脚本已修复为使用端口 5001
- Nginx反向代理应该将请求转发到 `http://127.0.0.1:5001`

## 验证数据是否恢复

服务启动后，验证数据：

1. **检查服务状态**：
   ```bash
   sudo systemctl status embodiedpulse
   ```

2. **测试API**：
   ```bash
   python3 scripts/test_api_response.py
   ```

3. **检查逐际动力数据**：
   ```bash
   python3 scripts/check_limx_data.py
   ```

4. **访问前端页面**，查看数据是否显示

## 如果服务启动失败

### 常见错误1：代码语法错误

```bash
# 检查代码语法
python3 -m py_compile app.py
```

### 常见错误2：依赖包缺失

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
pip install -r requirements.txt
```

### 常见错误3：数据库连接失败

```bash
# 检查环境变量
cat .env | grep DATABASE

# 测试数据库连接
python3 -c "from models import get_engine; print('DB OK')"
```

### 常见错误4：端口被占用

```bash
# 检查端口占用
lsof -i :5001

# 如果被占用，杀死进程
kill -9 $(lsof -ti:5001)
```

## 完整重启流程

```bash
# 1. 停止服务
sudo systemctl stop embodiedpulse

# 2. 检查并清理端口
lsof -i :5001 && kill -9 $(lsof -ti:5001) || echo "端口未被占用"

# 3. 重新加载配置
sudo systemctl daemon-reload

# 4. 启动服务
sudo systemctl start embodiedpulse

# 5. 等待启动
sleep 5

# 6. 检查状态
sudo systemctl status embodiedpulse

# 7. 测试API
python3 scripts/test_api_response.py
```


