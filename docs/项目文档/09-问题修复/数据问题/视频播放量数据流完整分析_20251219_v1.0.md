# 视频播放量数据流完整分析

## 问题描述

用户反馈：前端每个单独视频的播放量还是老的，没有更新。

## 完整数据流分析

### 1. 数据更新流程

#### 1.1 `update_video_play_counts.py` 脚本
- **作用**：从 Bilibili API 抓取视频播放量数据，更新到数据库
- **数据流**：`Bilibili API` → `数据库 BilibiliVideo 表`
- **更新的字段**：
  - `play`（原始数字）
  - `play_formatted`（格式化字符串，如 "1.2万"）
  - `updated_at`（更新时间）

#### 1.2 后端API `/api/bilibili/all`
- **作用**：从数据库读取数据，返回给前端
- **数据流**：`数据库 BilibiliVideo 表` → `后端API` → `前端`
- **返回的字段**：
  ```python
  {
      'play': video.play_formatted or '0',  # 格式化字符串
      'play_raw': video.play or 0,          # 原始数字
  }
  ```

#### 1.3 前端显示
- **位置**：`templates/bilibili.html` 第1840行
- **代码**：
  ```javascript
  const playValue = video.play_raw || video.play || 0;
  const playFormatted = typeof playValue === 'number' ? formatNumber(playValue) : escapeHtml(video.play || '0');
  ```

## 问题排查

### 可能的问题点

1. **脚本没有成功更新数据库**
   - 检查：脚本运行后，数据库中的 `play` 字段是否真的更新了
   - 方法：直接查询数据库

2. **API缓存问题**
   - 检查：`/api/bilibili/all` 接口有5分钟缓存
   - 位置：`app.py` 第1223行
   - 解决：使用 `?force=1` 参数强制刷新

3. **前端缓存问题**
   - 检查：浏览器可能缓存了API响应
   - 解决：强制刷新浏览器（Ctrl+F5）

4. **脚本查询条件问题**
   - 检查：脚本只更新7天前未更新的视频，或播放量为0的视频
   - 如果视频的 `updated_at` 在7天内，且 `play > 0`，脚本不会更新
   - 解决：使用 `--force` 参数强制更新所有视频

## 诊断步骤

### 步骤1：检查数据库中的实际数据

```bash
# 在服务器上执行
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 scripts/check_video_update_status.py
```

### 步骤2：检查脚本是否真的更新了数据

```bash
# 运行脚本并查看输出
python3 scripts/update_video_play_counts.py --force
```

### 步骤3：检查API返回的数据

```bash
# 使用 curl 测试API（带 force=1 参数清除缓存）
curl "http://localhost:5000/api/bilibili/all?force=1" | jq '.data[0].videos[0] | {bvid, play, play_raw}'
```

### 步骤4：检查前端显示

- 打开浏览器开发者工具（F12）
- 查看 Network 标签，找到 `/api/bilibili/all` 请求
- 检查返回的 `play` 和 `play_raw` 字段
- 检查前端是否正确使用了这些字段

## 解决方案

### 方案1：强制更新所有视频（推荐）

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 scripts/update_video_play_counts.py --force
```

### 方案2：清除API缓存并刷新前端

1. 访问：`http://your-domain/api/bilibili/all?force=1`
2. 前端强制刷新：`Ctrl+F5` 或 `Cmd+Shift+R`

### 方案3：改进脚本逻辑

如果发现脚本的查询条件有问题，可以修改 `update_video_play_counts.py`：
- 降低更新时间阈值（从7天改为1天）
- 或者总是更新所有视频（但要注意API限流）

## 验证方法

### 验证数据库是否更新

```sql
-- 连接到数据库
SELECT bvid, title, play, play_formatted, updated_at 
FROM bilibili_videos 
WHERE is_deleted = false 
ORDER BY updated_at DESC 
LIMIT 10;
```

### 验证API返回

```bash
# 测试API
curl "http://localhost:5000/api/bilibili/all?force=1" | jq '.data[0].videos[0]'
```

### 验证前端显示

1. 打开浏览器开发者工具
2. 查看 Console 日志
3. 检查 Network 请求的响应数据
4. 检查页面显示的播放量是否与API返回一致

## 总结

**数据流**：
```
Bilibili API → update_video_play_counts.py → 数据库 BilibiliVideo.play
                                                      ↓
数据库 BilibiliVideo.play → /api/bilibili/all → 前端显示
```

**关键点**：
1. 脚本更新的是数据库，不是前端
2. API有5分钟缓存，需要 `?force=1` 清除
3. 前端使用 `play_raw` 优先，如果没有则使用 `play`
4. 脚本默认只更新7天前未更新的视频，可能需要 `--force` 强制更新


