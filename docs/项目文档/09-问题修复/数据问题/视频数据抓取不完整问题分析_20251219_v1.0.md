# 视频数据抓取不完整问题分析

## 问题描述

用户反馈：视频 `BV1L8qEBKEFW` 在 Bilibili API 中存在（播放量 109,422），但数据库中不存在。这不是个例，是整个数据流转出现问题。

## 根本原因分析

### 1. 数据抓取限制

**问题代码位置**：
- `fetch_bilibili_data.py` 第40行：`def fetch_and_save_up_data(uid, video_count=50)`
- `bilibili_client.py` 第548行：`videos_task = self._get_user_videos_async(mid, page=1, page_size=video_count)`

**问题**：
- 默认只抓取每个UP主**最新的50个视频**（`video_count=50`）
- 只抓取**第1页**（`page=1`）
- 如果某个视频不在最新的50个视频中，**就不会被抓取到数据库**

### 2. 数据流分析

```
Bilibili API (所有视频)
    ↓
get_all_data(uid, video_count=50)  ← 只获取最新50个
    ↓
fetch_and_save_up_data(uid, video_count=50)  ← 只保存50个
    ↓
数据库 BilibiliVideo (只有最新50个视频)
    ↓
/api/bilibili/all API
    ↓
前端显示 (只显示数据库中的视频)
```

**结果**：如果视频不在最新的50个中，前端就看不到！

### 3. 具体案例

- 视频 `BV1L8qEBKEFW`（逐际动力）
- Bilibili API 播放量：109,422
- 数据库：不存在
- 原因：该视频可能不在逐际动力的最新50个视频中

## 解决方案

### 方案1：增加抓取数量（快速修复）

**优点**：简单快速
**缺点**：仍然有限制，如果UP主视频超过限制，还是会有遗漏

```python
# 修改 fetch_bilibili_data.py
def fetch_and_save_up_data(uid, video_count=200):  # 从50改为200
```

### 方案2：分页抓取所有视频（推荐）

**优点**：完整抓取所有视频
**缺点**：需要更多时间和API请求

实现逻辑：
1. 循环分页抓取，直到没有更多视频
2. 每页抓取50个视频
3. 合并所有页面的视频

### 方案3：定期全量抓取 + 增量更新（最佳）

**优点**：
- 定期全量抓取确保完整性
- 增量更新保持数据新鲜
- 平衡性能和完整性

**实现**：
1. 每天凌晨全量抓取所有视频（分页抓取）
2. 每小时增量更新最新视频的播放量

## 立即修复步骤

### 步骤1：检查当前数据库中的视频数量

```bash
# 在服务器上执行
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 -c "
from bilibili_models import get_bilibili_session, BilibiliVideo, BilibiliUp
from sqlalchemy import func

session = get_bilibili_session()
for up in session.query(BilibiliUp).filter_by(is_active=True).all():
    video_count = session.query(func.count(BilibiliVideo.bvid)).filter_by(
        uid=up.uid, is_deleted=False
    ).scalar()
    print(f'{up.name} (UID: {up.uid}): 数据库中有 {video_count} 个视频')
session.close()
"
```

### 步骤2：增加抓取数量并重新抓取

```bash
# 修改抓取数量为200
python3 fetch_bilibili_data.py --video-count 200
```

### 步骤3：实现分页抓取（长期方案）

需要修改 `bilibili_client.py` 和 `fetch_bilibili_data.py`，实现分页抓取所有视频。

## 代码修复

### 修复1：增加默认抓取数量

```python
# fetch_bilibili_data.py
def fetch_and_save_up_data(uid, video_count=200):  # 从50改为200
```

### 修复2：实现分页抓取（推荐）

需要修改 `bilibili_client.py` 的 `get_all_data` 方法，支持分页抓取。

## 验证方法

1. 检查数据库中每个UP主的视频数量
2. 对比Bilibili API返回的视频总数
3. 检查是否有遗漏的视频（如 `BV1L8qEBKEFW`）

## 总结

**问题根源**：只抓取最新50个视频，导致较旧的视频没有被抓取。

**影响范围**：所有UP主，所有不在最新50个视频中的视频都会遗漏。

**修复优先级**：高（影响数据完整性）

**建议**：立即增加抓取数量到200，然后实现分页抓取确保完整性。


