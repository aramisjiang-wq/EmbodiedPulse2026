# 服务器B站页面错误检查指南

## 检查方法

### 方法1: 在服务器上直接执行（推荐）

SSH连接到服务器后执行：

```bash
cd /srv/EmbodiedPulse2026
bash scripts/check_server_bilibili_errors.sh
```

### 方法2: 通过SSH远程执行

在本地执行：

```bash
# 设置服务器信息
export SERVER_HOST=your-server-ip
export SERVER_USER=root

# 执行检查
bash scripts/check_server_bilibili_errors_remote.sh
```

### 方法3: 直接测试API端点

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 scripts/check_bilibili_api_direct.py
```

## 检查内容

### 1. 服务状态
- systemd服务是否运行
- 服务启动时间
- 最近的重启记录

### 2. 系统日志
- systemd journal日志
- 最近的错误和异常
- B站相关的错误信息

### 3. API端点测试
- `/api/bilibili/all` 端点是否正常
- 返回的状态码
- 错误信息（如果有）

### 4. 数据库连接
- 数据库URL配置
- 连接是否成功
- 数据统计（UP主数、视频数）

### 5. 错误堆栈
- 完整的Python错误堆栈
- Traceback信息
- 异常详情

## 常见错误及解决方案

### 错误1: 数据库连接失败

**症状**: `ModuleNotFoundError: No module named 'sqlalchemy'` 或数据库连接错误

**解决**:
```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
pip install -r requirements.txt
systemctl restart embodiedpulse
```

### 错误2: 导入模块失败

**症状**: `ImportError: cannot import name 'xxx' from 'xxx'`

**解决**: 检查代码是否已更新到服务器
```bash
cd /srv/EmbodiedPulse2026
git pull
systemctl restart embodiedpulse
```

### 错误3: 数据库文件不存在

**症状**: `OperationalError: no such table: bilibili_ups`

**解决**: 初始化数据库
```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 << 'EOF'
from bilibili_models import init_bilibili_db
init_bilibili_db()
EOF
```

### 错误4: 环境变量未设置

**症状**: 使用默认的相对路径数据库

**解决**: 设置环境变量
```bash
cd /srv/EmbodiedPulse2026
echo "BILIBILI_DATABASE_URL=sqlite:////srv/EmbodiedPulse2026/bilibili.db" >> .env
systemctl restart embodiedpulse
```

## 快速诊断命令

### 查看最近错误
```bash
journalctl -u embodiedpulse -n 100 --no-pager | grep -i error
```

### 查看B站相关错误
```bash
journalctl -u embodiedpulse --since "1 hour ago" --no-pager | grep -i bilibili
```

### 查看完整堆栈
```bash
journalctl -u embodiedpulse -n 200 --no-pager | grep -A 20 "Traceback"
```

### 测试API
```bash
curl http://localhost:5001/api/bilibili/all?force=1
```

## 日志文件位置

- systemd日志: `journalctl -u embodiedpulse`
- 应用日志: `/srv/EmbodiedPulse2026/logs/` (如果配置了)
- Gunicorn日志: 通过systemd捕获

## 下一步

根据检查结果，确定具体的错误原因，然后：
1. 修复代码问题
2. 更新依赖
3. 修复数据库配置
4. 重启服务

