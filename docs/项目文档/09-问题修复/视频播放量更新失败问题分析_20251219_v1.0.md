# 视频播放量更新失败问题分析

## 问题描述

逐际动力最新视频（BV1bSq3BuER6）的播放量已经达到50万（用户反馈），但数据库中显示只有57，且更新脚本未能自动更新。

## 问题分析

### 1. 数据对比

**检查时间：** 2025-12-19 13:09

| 数据源 | 播放量 | 状态 |
|--------|--------|------|
| 数据库（更新前） | 57 | ❌ 过时 |
| B站API | 37,727 | ✅ 最新 |
| 数据库（更新后） | 37,727 | ✅ 已更新 |

**注意：** 用户反馈播放量是50万，但API返回的是37,727。可能的原因：
1. 用户看错了视频
2. 播放量还在快速增长
3. 用户看到的是另一个视频

### 2. 更新失败原因

#### 问题根源

更新脚本 `scripts/update_video_play_counts.py` 的过滤逻辑：

```python
# 只更新最近7天未更新的视频
cutoff_date = datetime.now() - timedelta(days=7)
query = query.filter(
    (BilibiliVideo.updated_at < cutoff_date) | 
    (BilibiliVideo.updated_at.is_(None)) |
    (BilibiliVideo.play == 0)
)
```

**问题：**
- 该视频在 2025-12-17 17:05:20 更新过
- 检查时间是 2025-12-19，距离上次更新只有约2天
- 因为 `updated_at < cutoff_date` 条件不满足，所以被跳过更新

#### 为什么会出现这个问题？

1. **新视频播放量增长快**：新发布的视频在短时间内播放量会快速增长
2. **更新策略过于保守**：7天的更新间隔对于新视频来说太长
3. **没有考虑视频发布时间**：只根据 `updated_at` 判断，没有考虑视频是否是新发布的

### 3. 解决方案

#### 方案1：改进更新逻辑（已实施）

修改 `scripts/update_video_play_counts.py`，增加对新视频的特殊处理：

```python
# ✅ 改进：如果视频发布时间在最近30天内，即使updated_at在7天内也更新（新视频播放量增长快）
if not force_update:
    from datetime import timedelta
    cutoff_date = datetime.now() - timedelta(days=7)
    # 新视频判断：发布时间在最近30天内
    recent_video_date = datetime.now() - timedelta(days=30)
    query = query.filter(
        (BilibiliVideo.updated_at < cutoff_date) | 
        (BilibiliVideo.updated_at.is_(None)) |
        (BilibiliVideo.play == 0) |  # ✅ 播放量为0的视频也需要更新
        ((BilibiliVideo.pubdate >= recent_video_date) & (BilibiliVideo.updated_at < datetime.now() - timedelta(hours=6)))  # ✅ 新视频（30天内发布）且6小时未更新
    )
```

**改进点：**
- 新视频（30天内发布）每6小时更新一次
- 保持对旧视频的7天更新策略
- 避免过度请求API

#### 方案2：手动更新（临时方案）

使用 `scripts/fetch_single_video.py` 手动更新特定视频：

```bash
python3 scripts/fetch_single_video.py BV1bSq3BuER6 --uid 1172054289
```

#### 方案3：强制更新（批量更新）

使用 `scripts/update_video_play_counts.py` 强制更新：

```bash
# 强制更新所有视频
python3 scripts/update_video_play_counts.py --force

# 只更新逐际动力的视频
python3 scripts/update_video_play_counts.py --uids 1172054289 --force
```

## 当前状态

### 最新视频播放量（2025-12-19 13:09更新）

| BV号 | 标题 | 播放量 | 发布时间 | 更新时间 |
|------|------|--------|----------|----------|
| BV1bSq3BuER6 | TRON 2 向上的力量 | 37,727 (3.8万) | 2025-12-17 | 2025-12-19 13:09 |
| BV1omqhB3EX1 | TRON 2 点亮未来 | 4,853 | 2025-12-16 | 2025-12-17 17:05 |
| BV14fm1B4EJ6 | TRON 2 意动行随 | 41,223 (4.1万) | 2025-12-15 | 2025-12-17 17:05 |
| BV13vmjBnE9S | 起猛了！看到机器人舞团了！ | 54,709 (5.5万) | 2025-12-12 | 2025-12-17 17:05 |
| BV1gpSuBAE66 | 全尺寸人形机器人Oli... | 66,664 (6.7万) | 2025-11-28 | 2025-12-17 17:05 |

### 更新脚本改进

✅ **已改进更新逻辑**：
- 新视频（30天内发布）每6小时更新一次
- 旧视频保持7天更新策略
- 播放量为0的视频始终更新

## 建议

### 1. 定期检查新视频

对于新发布的视频（30天内），建议：
- 每天至少更新一次
- 或者使用定时任务每6小时更新一次

### 2. 监控播放量异常

如果发现播放量明显异常（如用户反馈50万但数据库显示57），应该：
1. 立即手动更新该视频
2. 检查更新脚本是否正常运行
3. 检查是否有API限制或错误

### 3. 优化更新策略

考虑根据视频发布时间和播放量增长率动态调整更新频率：
- 新视频（7天内）：每1小时更新
- 较新视频（30天内）：每6小时更新
- 旧视频：每7天更新

## 相关文件

- `scripts/update_video_play_counts.py` - 视频播放量更新脚本
- `scripts/fetch_single_video.py` - 单个视频抓取脚本
- `scripts/check_specific_video.py` - 视频数据检查脚本

## 更新记录

- **2025-12-19 13:09**：手动更新 BV1bSq3BuER6 播放量（57 → 37,727）
- **2025-12-19 13:10**：改进更新逻辑，支持新视频更频繁更新

