# 视频播放量自动更新方案

**日期**: 2025-12-19  
**需求**: 所有视频的播放量需要稳定自动定时更新

---

## 📊 现状分析

### 当前问题

1. **视频播放量未自动更新**
   - 抓取脚本只更新新视频或已获取的视频
   - 遇到 412 错误时，视频列表可能为空，播放量无法更新
   - 没有独立的视频播放量更新机制

2. **更新频率**
   - B站数据抓取：每6小时一次（避免风控）
   - 但视频播放量更新不完整

### 需求

- 所有视频的播放量需要定期更新
- 例如："定义具身机器人通用基座丨TRON 2 正式发布！" 已经10万多了，但数据库还是旧数据
- 需要稳定、自动、定时实现

---

## 🎯 解决方案

### 方案1：独立的视频播放量更新定时任务（推荐）

**优点**：
- ✅ 独立于UP主数据抓取，更灵活
- ✅ 可以单独控制更新频率
- ✅ 支持分批更新，避免触发风控
- ✅ 支持进度保存，断点续传

**实现方式**：
1. 创建独立的定时任务函数
2. 使用 `update_video_play_counts.py` 脚本的逻辑
3. 添加到 `start_scheduler()` 中

**更新策略**：
- **增量更新**：只更新最近7天未更新的视频（默认）
- **分批处理**：每批10个视频，批次之间延迟3秒
- **错误重试**：失败自动重试，最多3次
- **更新频率**：建议每天更新一次（可配置）

### 方案2：改进现有抓取逻辑

**优点**：
- ✅ 与现有抓取流程集成
- ✅ 不需要额外的定时任务

**缺点**：
- ❌ 如果抓取失败，播放量也无法更新
- ❌ 更新频率受限于抓取频率（每6小时）

---

## 🚀 推荐方案：独立定时任务

### 实施步骤

#### 步骤1：创建定时任务函数

在 `app.py` 的 `start_scheduler()` 中添加：

```python
def scheduled_update_video_play_counts():
    """定时更新视频播放量任务"""
    try:
        logger.info("=" * 60)
        logger.info("开始执行定时视频播放量更新任务...")
        logger.info("=" * 60)
        
        from scripts.update_video_play_counts import update_video_play_counts
        # 只更新最近7天未更新的视频（增量更新）
        update_video_play_counts(force_update=False)
        
        logger.info("=" * 60)
        logger.info("定时视频播放量更新任务完成")
        logger.info("=" * 60)
    except Exception as e:
        logger.error("=" * 60)
        logger.error(f"定时视频播放量更新任务失败: {e}")
        logger.error("=" * 60)
        import traceback
        logger.error(traceback.format_exc())

# 配置视频播放量更新定时任务（每天凌晨2点执行）
scheduler.add_job(
    scheduled_update_video_play_counts,
    trigger=CronTrigger(hour=2, minute=0),  # 每天凌晨2点
    id='daily_update_video_play_counts',
    name='视频播放量更新（每天）',
    replace_existing=True
)
logger.info("视频播放量更新定时任务已配置: 每天凌晨2点执行")
```

#### 步骤2：配置环境变量（可选）

支持通过环境变量自定义更新频率：

```bash
# .env 文件
AUTO_UPDATE_VIDEO_PLAYS_ENABLED=true
AUTO_UPDATE_VIDEO_PLAYS_SCHEDULE=0 2 * * *  # 每天凌晨2点
```

#### 步骤3：改进 update_video_play_counts.py

确保脚本可以：
- 从命令行调用
- 支持增量更新（默认）
- 支持强制更新（可选）
- 支持指定UP主（可选）

---

## 📋 完整实施方案

### 1. 修改 app.py 添加定时任务

在 `start_scheduler()` 函数中添加视频播放量更新任务。

### 2. 配置更新频率

- **默认**：每天凌晨2点执行
- **可配置**：通过环境变量 `AUTO_UPDATE_VIDEO_PLAYS_SCHEDULE` 自定义

### 3. 更新策略

- **增量更新**：只更新最近7天未更新的视频（默认）
- **分批处理**：每批10个视频，批次之间延迟3秒
- **错误重试**：失败自动重试，最多3次
- **进度保存**：支持断点续传

### 4. 监控和日志

- 记录更新进度
- 记录失败的视频
- 记录更新统计（更新数、跳过数、失败数）

---

## ⚙️ 配置选项

### 环境变量

```bash
# 启用视频播放量自动更新
AUTO_UPDATE_VIDEO_PLAYS_ENABLED=true

# 更新频率（cron表达式）
AUTO_UPDATE_VIDEO_PLAYS_SCHEDULE=0 2 * * *  # 每天凌晨2点

# 或者每小时更新一次（更频繁）
AUTO_UPDATE_VIDEO_PLAYS_SCHEDULE=0 * * * *  # 每小时整点
```

### 脚本参数

```bash
# 增量更新（只更新最近7天未更新的）
python3 scripts/update_video_play_counts.py

# 强制更新所有视频
python3 scripts/update_video_play_counts.py --force

# 只更新指定UP主的视频
python3 scripts/update_video_play_counts.py --uids 1172054289 521974986
```

---

## 🔧 实施代码

### 修改 app.py

在 `start_scheduler()` 函数中添加视频播放量更新任务。

### 改进 update_video_play_counts.py

确保脚本可以作为模块导入，并支持从定时任务调用。

---

## 📊 预期效果

### 更新频率

- **每天凌晨2点**：自动更新所有需要更新的视频播放量
- **增量更新**：只更新最近7天未更新的视频，减少API调用
- **分批处理**：避免触发B站风控

### 数据准确性

- 所有视频的播放量保持最新（最多7天延迟）
- 新视频的播放量会在下次更新时获取
- 热门视频的播放量会定期更新

---

## ⚠️ 注意事项

1. **避免频繁请求**：
   - 批次之间至少延迟3秒
   - 视频之间至少延迟1秒
   - 建议每天更新一次，不要过于频繁

2. **监控更新进度**：
   - 查看日志文件 `logs/video_update.log`
   - 检查进度文件 `video_update_progress.json`

3. **错误处理**：
   - 脚本会自动重试失败的视频
   - 如果某个视频一直失败，会跳过并继续

4. **数据备份**：
   - 更新前建议备份数据库
   - 可以使用 `scripts/backup_databases.sh`

---

## 📝 总结

**推荐方案**：独立的视频播放量更新定时任务

**优点**：
- ✅ 独立于UP主数据抓取，更灵活
- ✅ 支持增量更新，减少API调用
- ✅ 分批处理，避免触发风控
- ✅ 支持进度保存，断点续传
- ✅ 可配置更新频率

**实施步骤**：
1. 修改 `app.py` 添加定时任务
2. 配置环境变量（可选）
3. 测试验证
4. 监控运行情况


