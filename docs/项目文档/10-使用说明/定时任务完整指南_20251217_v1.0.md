# 定时任务完整指南

**创建时间**：2025-12-17  
**项目名称**：Embodied Pulse（具身脉搏）  
**版本**：v1.0  
**最后更新**：2025-12-17

---

## 📋 目录

1. [概述](#概述)
2. [Cron表达式格式](#cron表达式格式)
3. [环境变量配置](#环境变量配置)
4. [配置示例](#配置示例)
5. [部署前检查清单](#部署前检查清单)
6. [部署方式](#部署方式)
7. [验证配置](#验证配置)
8. [常见场景](#常见场景)
9. [故障排查](#故障排查)

---

## 📖 概述

Embodied Pulse 支持使用**Cron表达式**来配置定时任务，可以灵活控制论文抓取、视频数据更新、新闻刷新的执行时间。

### 支持的定时任务

1. **论文抓取**：从ArXiv抓取最新论文
2. **视频数据更新**：更新B站UP主和视频数据
3. **新闻抓取**：抓取具身智能相关新闻
4. **招聘信息抓取**：抓取招聘信息（可选）
5. **Semantic Scholar更新**：更新论文的引用数和发表信息

### 配置方式

- **环境变量**：通过环境变量配置cron表达式（推荐）
- **Docker Compose**：在`docker-compose.yml`中配置
- **直接运行**：在启动命令中设置环境变量

---

## ⏰ Cron表达式格式

### 标准格式

```
分钟 小时 日 月 星期
```

### 字段说明

| 字段 | 取值范围 | 说明 |
|------|---------|------|
| **分钟** | 0-59 | 每小时的第几分钟执行 |
| **小时** | 0-23 | 每天的第几小时执行 |
| **日** | 1-31 | 每月的第几天执行 |
| **月** | 1-12 | 每年的第几月执行 |
| **星期** | 0-7 | 每周的第几天执行（0和7都表示周日） |

### 特殊字符

| 字符 | 说明 | 示例 |
|------|------|------|
| `*` | 匹配所有值 | `* * * * *` 表示每分钟执行 |
| `,` | 指定多个值 | `0 8,20 * * *` 表示每天8点和20点执行 |
| `-` | 指定范围 | `0 9-17 * * *` 表示每天9点到17点每小时执行 |
| `/` | 指定间隔 | `0 */6 * * *` 表示每6小时执行一次（0点、6点、12点、18点） |

---

## ⚙️ 环境变量配置

### 启用定时任务

**环境变量**：`AUTO_FETCH_ENABLED`

**说明**：必须设置为 `true` 才能启用定时任务

**示例**：
```bash
export AUTO_FETCH_ENABLED=true
```

### 论文抓取配置

**环境变量**：`AUTO_FETCH_SCHEDULE`

**说明**：配置论文抓取的cron表达式

**默认值**：`0 * * * *`（每小时整点执行）

**示例**：
```bash
# 每小时整点执行
export AUTO_FETCH_SCHEDULE="0 * * * *"

# 每天凌晨2点执行
export AUTO_FETCH_SCHEDULE="0 2 * * *"

# 每天8点和20点执行
export AUTO_FETCH_SCHEDULE="0 8,20 * * *"

# 每6小时执行一次
export AUTO_FETCH_SCHEDULE="0 */6 * * *"
```

### 视频数据更新配置

**环境变量**：`AUTO_FETCH_BILIBILI_SCHEDULE`

**说明**：配置B站数据更新的cron表达式

**默认值**：`0 */6 * * *`（每6小时执行一次）

**示例**：
```bash
# 每6小时执行一次
export AUTO_FETCH_BILIBILI_SCHEDULE="0 */6 * * *"

# 每天凌晨3点执行
export AUTO_FETCH_BILIBILI_SCHEDULE="0 3 * * *"
```

### 新闻抓取配置

**环境变量**：`AUTO_FETCH_NEWS_SCHEDULE`

**说明**：配置新闻抓取的cron表达式

**默认值**：`0 * * * *`（每小时整点执行）

**示例**：
```bash
# 每小时整点执行
export AUTO_FETCH_NEWS_SCHEDULE="0 * * * *"
```

### 招聘信息抓取配置

**环境变量**：`AUTO_FETCH_JOBS_SCHEDULE`

**说明**：配置招聘信息抓取的cron表达式

**默认值**：`0 * * * *`（每小时整点执行）

**示例**：
```bash
# 每小时整点执行
export AUTO_FETCH_JOBS_SCHEDULE="0 * * * *"
```

### Semantic Scholar更新配置

**环境变量**：`SEMANTIC_UPDATE_LIMIT`

**说明**：每次更新Semantic Scholar数据的论文数量限制

**默认值**：`200`

**示例**：
```bash
export SEMANTIC_UPDATE_LIMIT=200
```

---

## 📋 部署前检查清单

### 1. 依赖检查

- [ ] **APScheduler 已安装**
  ```bash
  pip install apscheduler
  # 或
  pip install -r requirements.txt
  ```

- [ ] **所有Python依赖已安装**
  ```bash
  pip install -r requirements.txt
  ```

### 2. 环境变量配置

#### 必需环境变量

- [ ] **`AUTO_FETCH_ENABLED=true`**
  ```bash
  export AUTO_FETCH_ENABLED=true
  ```

#### 可选环境变量（建议配置）

- [ ] **`AUTO_FETCH_SCHEDULE`** - 论文抓取时间（默认：`0 * * * *`，每小时整点）
  ```bash
  export AUTO_FETCH_SCHEDULE="0 * * * *"
  ```

- [ ] **`AUTO_FETCH_BILIBILI_SCHEDULE`** - 视频数据更新时间（默认：`0 */6 * * *`，每6小时）
  ```bash
  export AUTO_FETCH_BILIBILI_SCHEDULE="0 */6 * * *"
  ```

- [ ] **`AUTO_FETCH_NEWS_SCHEDULE`** - 新闻抓取时间（默认：`0 * * * *`，每小时整点）
  ```bash
  export AUTO_FETCH_NEWS_SCHEDULE="0 * * * *"
  ```

- [ ] **`AUTO_FETCH_JOBS_SCHEDULE`** - 招聘抓取时间（默认：`0 * * * *`，每小时整点）
  ```bash
  export AUTO_FETCH_JOBS_SCHEDULE="0 * * * *"
  ```

- [ ] **`SEMANTIC_UPDATE_LIMIT`** - Semantic Scholar更新限制（默认：200）
  ```bash
  export SEMANTIC_UPDATE_LIMIT=200
  ```

### 3. 配置文件检查

- [ ] **`config.yaml` 存在且配置正确**
  ```bash
  ls -l config.yaml
  ```

- [ ] **数据库文件可写**
  ```bash
  touch papers.db bilibili.db news.db jobs.db
  chmod 666 papers.db bilibili.db news.db jobs.db
  ```

### 4. 代码检查

- [ ] **`app.py` 中的 `start_scheduler()` 函数存在**
- [ ] **定时任务函数已正确注册**

---

## 🚀 部署方式

### 方式1：直接运行（开发环境）

**启动命令**：
```bash
export AUTO_FETCH_ENABLED=true
export AUTO_FETCH_SCHEDULE="0 * * * *"
export AUTO_FETCH_BILIBILI_SCHEDULE="0 */6 * * *"
python3 app.py
```

**验证**：
- 查看启动日志，应该看到：`✅ 自动定时抓取已启用`
- 检查定时任务是否启动

### 方式2：使用 .env 文件（推荐）

**创建 `.env` 文件**：
```bash
AUTO_FETCH_ENABLED=true
AUTO_FETCH_SCHEDULE=0 * * * *
AUTO_FETCH_BILIBILI_SCHEDULE=0 */6 * * *
AUTO_FETCH_NEWS_SCHEDULE=0 * * * *
AUTO_FETCH_JOBS_SCHEDULE=0 * * * *
SEMANTIC_UPDATE_LIMIT=200
```

**启动命令**：
```bash
python3 app.py
```

### 方式3：使用 Gunicorn（生产环境）

**启动命令**：
```bash
gunicorn -c gunicorn_config.py app:app
```

**注意**：确保 `gunicorn_config.py` 中的 `when_ready` hook 已配置：
```python
def when_ready(server):
    from app import start_scheduler
    start_scheduler()
```

### 方式4：使用 Docker Compose

**在 `docker-compose.yml` 中配置**：
```yaml
services:
  web:
    environment:
      - AUTO_FETCH_ENABLED=true
      - AUTO_FETCH_SCHEDULE=0 * * * *
      - AUTO_FETCH_BILIBILI_SCHEDULE=0 */6 * * *
```

---

## ✅ 验证配置

### 1. 检查定时任务是否启动

**查看启动日志**：
```bash
# 如果使用 nohup
tail -f /tmp/flask_app.log

# 如果使用 systemd
journalctl -u embodied-pulse -f
```

**应该看到**：
```
✅ 自动定时抓取已启用
📅 论文抓取任务已配置: 0 * * * *
📅 视频数据更新任务已配置: 0 */6 * * *
```

### 2. 检查定时任务执行

**查看API状态**：
```bash
curl http://localhost:5001/api/fetch-status
```

**返回示例**：
```json
{
  "running": false,
  "progress": 0,
  "total": 0,
  "current_keyword": "",
  "message": "",
  "last_update": "2025-12-17 10:00:00"
}
```

### 3. 检查数据库更新

**查看论文数据**：
```bash
sqlite3 papers.db "SELECT COUNT(*) FROM papers;"
```

**查看视频数据**：
```bash
sqlite3 bilibili.db "SELECT COUNT(*) FROM up_info;"
```

---

## 📝 常见场景

### 场景1：每小时抓取论文

**配置**：
```bash
export AUTO_FETCH_SCHEDULE="0 * * * *"
```

### 场景2：每天凌晨2点抓取论文

**配置**：
```bash
export AUTO_FETCH_SCHEDULE="0 2 * * *"
```

### 场景3：每6小时更新视频数据

**配置**：
```bash
export AUTO_FETCH_BILIBILI_SCHEDULE="0 */6 * * *"
```

### 场景4：每天8点和20点抓取

**配置**：
```bash
export AUTO_FETCH_SCHEDULE="0 8,20 * * *"
```

### 场景5：每周一凌晨2点抓取

**配置**：
```bash
export AUTO_FETCH_SCHEDULE="0 2 * * 1"
```

---

## 🐛 故障排查

### 问题1：定时任务没有启动

**检查清单**：
1. 检查 `AUTO_FETCH_ENABLED` 是否设置为 `true`
2. 检查启动日志是否有错误
3. 检查 APScheduler 是否已安装
4. 检查 `app.py` 中的 `start_scheduler()` 函数是否被调用

### 问题2：定时任务没有执行

**检查清单**：
1. 检查 cron 表达式是否正确
2. 检查系统时间是否正确
3. 查看日志是否有错误信息
4. 检查数据库连接是否正常

### 问题3：定时任务执行失败

**检查清单**：
1. 查看日志错误信息
2. 检查网络连接（ArXiv API、B站API等）
3. 检查数据库权限
4. 检查配置文件是否正确

### 问题4：定时任务执行太频繁

**解决方案**：
- 调整 cron 表达式，增加执行间隔
- 例如：从 `0 * * * *`（每小时）改为 `0 */6 * * *`（每6小时）

---

## 📚 相关文档

- [脚本命令参考手册](./脚本命令参考手册_20251217_v1.0.md)
- [Web应用快速入门](./Web应用快速入门_20251217_v1.0.md)
- [完整使用指南](./完整使用指南_20251217_v1.0.md)

---

**最后更新**：2025-12-17  
**维护者**：AI开发助手  
**版本**：v1.0

