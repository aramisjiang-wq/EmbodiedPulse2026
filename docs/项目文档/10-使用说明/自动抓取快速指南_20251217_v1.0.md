# 自动抓取快速指南

## ✅ 当前状态

**自动定时抓取已启用！**

- ⏰ **抓取时间**: 每天凌晨 2:00
- 📊 **抓取数量**: 每类 10 篇论文
- 🔄 **自动运行**: 无需人工干预

---

## 🚀 方法一：环境变量配置（当前使用）

### 启动命令

```bash
cd /Users/dong/Documents/Cursor/Embodied Pulse

AUTO_FETCH_ENABLED=true \
AUTO_FETCH_SCHEDULE="0 2 * * *" \
AUTO_FETCH_MAX_RESULTS=10 \
python3 app.py
```

### 后台运行

```bash
cd /Users/dong/Documents/Cursor/Embodied Pulse

AUTO_FETCH_ENABLED=true \
AUTO_FETCH_SCHEDULE="0 2 * * *" \
AUTO_FETCH_MAX_RESULTS=10 \
nohup python3 app.py > /tmp/flask_app.log 2>&1 &
```

---

## ⚙️ 配置说明

### 环境变量

| 变量 | 说明 | 当前值 | 示例 |
|------|------|--------|------|
| `AUTO_FETCH_ENABLED` | 启用自动抓取 | `true` | `true` / `false` |
| `AUTO_FETCH_SCHEDULE` | 抓取时间（Cron表达式） | `0 2 * * *` | 见下方示例 |
| `AUTO_FETCH_MAX_RESULTS` | 每类抓取数量 | `10` | `5`, `10`, `20` |

### Cron 表达式示例

格式：`分钟 小时 日 月 星期`

```bash
0 2 * * *      # 每天凌晨2点
0 8 * * *      # 每天早上8点
0 */6 * * *    # 每6小时一次（0点、6点、12点、18点）
0 8,20 * * *   # 每天8点和20点
0 2 * * 1      # 每周一凌晨2点
0 0 1 * *      # 每月1号凌晨0点
```

---

## 📊 查看运行状态

### 1. 查看日志
```bash
tail -f /tmp/flask_app.log
```

### 2. 检查服务器状态
```bash
curl http://localhost:5000/api/fetch-status
```

返回示例：
```json
{
  "running": false,
  "progress": 0,
  "total": 9,
  "current_keyword": "",
  "message": "",
  "last_update": "2025-12-08 02:00:00"
}
```

### 3. 查看论文统计
```bash
curl http://localhost:5000/api/stats
```

---

## 🔧 修改配置

### 修改抓取时间

如果想改为每天早上 8 点抓取：

```bash
# 停止服务器
lsof -ti:5001 | xargs kill

# 重新启动（改为8点）
AUTO_FETCH_ENABLED=true \
AUTO_FETCH_SCHEDULE="0 8 * * *" \
AUTO_FETCH_MAX_RESULTS=10 \
nohup python3 app.py > /tmp/flask_app.log 2>&1 &
```

### 修改抓取数量

如果想每次抓取更多论文（每类 20 篇）：

```bash
# 停止服务器
lsof -ti:5001 | xargs kill

# 重新启动（增加数量）
AUTO_FETCH_ENABLED=true \
AUTO_FETCH_SCHEDULE="0 2 * * *" \
AUTO_FETCH_MAX_RESULTS=20 \
nohup python3 app.py > /tmp/flask_app.log 2>&1 &
```

⚠️ **注意**: 数量太大可能触发 ArXiv API 速率限制，建议 5-15 篇。

---

## 📝 日志记录

### 定时任务执行日志

成功执行时的日志示例：
```
[INFO] 开始执行定时抓取任务...
[INFO] Manipulation: 抓取到 10 篇论文
[INFO] VLM: 抓取到 10 篇论文
...
[INFO] 定时抓取任务完成
```

失败时的日志示例：
```
[ERROR] 定时抓取任务失败: HTTP Error 429 (Too Many Requests)
```

### 查看完整日志
```bash
# 实时查看日志
tail -f /tmp/flask_app.log

# 查看最近100行
tail -100 /tmp/flask_app.log

# 搜索定时任务相关日志
grep "定时抓取" /tmp/flask_app.log
```

---

## ⚠️ 注意事项

### 1. ArXiv API 速率限制
- 建议每次抓取 5-15 篇/类别
- 避免频繁抓取（建议每天 1-2 次）
- 遇到 429 错误说明触发了速率限制

### 2. 服务器持续运行
- 自动抓取需要服务器持续运行
- 如果服务器重启，需要重新启动（带环境变量）
- 建议使用 `nohup` 或系统服务管理

### 3. 时区问题
- Cron 表达式使用**服务器本地时间**
- Mac/Linux 默认使用系统时区
- 可通过 `date` 命令查看当前系统时间

### 4. 数据库自动去重
- 相同论文不会重复插入
- 已存在的论文会更新信息
- 定时任务安全运行，不会造成数据重复

---

## 🔍 故障排查

### 问题1: 定时任务没有执行

**检查服务器是否运行**:
```bash
lsof -ti:5001
```

**检查日志**:
```bash
grep "定时抓取" /tmp/flask_app.log
```

**确认自动抓取已启用**:
日志中应该看到：`✅ 自动定时抓取已启用`

### 问题2: 抓取失败

**常见原因**:
- ArXiv API 速率限制（等待后自动恢复）
- 网络连接问题
- 配置文件错误

**解决方法**:
```bash
# 查看错误详情
tail -50 /tmp/flask_app.log

# 手动测试抓取
curl -X POST http://localhost:5000/api/fetch \
  -H "Content-Type: application/json" \
  -d '{"max_results": 5}'
```

### 问题3: 服务器意外停止

**检查进程**:
```bash
ps aux | grep python3 | grep app.py
```

**重新启动**:
```bash
cd /Users/dong/Documents/Cursor/Embodied Pulse
AUTO_FETCH_ENABLED=true \
AUTO_FETCH_SCHEDULE="0 2 * * *" \
AUTO_FETCH_MAX_RESULTS=10 \
nohup python3 app.py > /tmp/flask_app.log 2>&1 &
```

---

## 📱 手动触发抓取

即使启用了自动抓取，仍然可以随时手动触发：

### 方法1: Web 界面
1. 访问 http://localhost:5000
2. 点击"抓取新论文"按钮
3. 配置参数后点击"开始抓取"

### 方法2: API 调用
```bash
curl -X POST http://localhost:5000/api/fetch \
  -H "Content-Type: application/json" \
  -d '{
    "max_results": 10,
    "config_path": "config.yaml"
  }'
```

---

## 🎯 最佳实践

### 推荐配置

**日常使用**:
- 抓取时间: 凌晨 2:00 或 3:00（避开高峰期）
- 抓取数量: 每类 10 篇
- 抓取频率: 每天 1 次

**大量数据需求**:
- 抓取时间: 凌晨 2:00
- 抓取数量: 每类 5-8 篇
- 抓取频率: 每 12 小时 1 次（2:00 和 14:00）

**测试环境**:
- 使用较小数量（每类 3-5 篇）
- 可以设置更频繁的时间来测试

### 生产环境建议

1. **使用系统服务**（systemd/launchd）管理进程
2. **配置日志轮转**，避免日志文件过大
3. **监控磁盘空间**，定期清理旧数据
4. **设置告警**，抓取失败时发送通知

---

## 📚 相关文档

- [自动抓取环境配置指南](./自动抓取环境配置指南_20251208.md) - 详细配置说明
- [论文抓取功能详解](../功能说明/论文抓取功能详解（手动和自动）_20251208.md) - 完整功能说明
- [完整使用指南](./完整使用指南_20251208.md) - 项目使用指南

---

**创建日期**: 2025-12-08  
**当前状态**: ✅ 自动抓取已启用  
**下次抓取**: 明天凌晨 2:00


