# 代码推送规范

**版本**: v1.0  
**日期**: 2025-12-17  
**目的**: 确保代码推送时不会意外覆盖服务器数据

---

## ⚠️ 重要规则

### 数据库文件禁止推送

**规则**: 所有数据库文件（`*.db`）和备份文件（`backups/`）**禁止**推送到GitHub。

**原因**: 
- 避免本地数据库覆盖服务器的最新数据
- 保护服务器数据安全
- 减少仓库大小

---

## 📋 推送前检查清单

### 1. 检查 `.gitignore` 配置

确保 `.gitignore` 包含以下规则：

```gitignore
# 数据库文件（重要：不要推送数据库文件到GitHub，避免覆盖服务器数据）
*.db
*.db-journal
*.sqlite
*.sqlite3
# 备份目录（包含数据库备份）
backups/
instance/*.db
```

### 2. 检查待推送文件

**推送前执行**:

```bash
# 查看所有待推送文件
git status

# 检查是否有数据库文件
git status | grep -E "\.db$|backups/"

# 如果有数据库文件，需要从暂存区移除
git reset HEAD *.db
git reset HEAD backups/
```

### 3. 验证 `.gitignore` 生效

```bash
# 测试数据库文件是否被忽略
git check-ignore papers.db
git check-ignore bilibili.db
git check-ignore backups/

# 应该都返回文件路径，表示被忽略
```

---

## 🔍 常见问题

### 问题1：数据库文件已被添加到Git

**症状**: `git status` 显示数据库文件被跟踪

**解决方法**:

```bash
# 1. 从Git跟踪中移除（但保留本地文件）
git rm --cached *.db
git rm --cached -r backups/

# 2. 确认 .gitignore 已配置
cat .gitignore | grep "\.db"

# 3. 提交更改
git add .gitignore
git commit -m "chore: 移除数据库文件跟踪，更新.gitignore"
```

### 问题2：误推送了数据库文件

**症状**: 发现数据库文件已被推送到GitHub

**解决方法**:

```bash
# 1. 从Git历史中移除（危险操作，谨慎使用）
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch *.db" \
  --prune-empty --tag-name-filter cat -- --all

# 2. 强制推送（需要团队协调）
git push origin --force --all

# 3. 更安全的方法：联系仓库管理员，使用BFG Repo-Cleaner
```

**⚠️ 注意**: 如果数据库文件已推送，建议：
1. 立即从服务器重新拉取数据库
2. 检查服务器数据是否受影响
3. 更新 `.gitignore` 防止再次发生

---

## ✅ 标准推送流程

### 日常代码推送

```bash
# 1. 检查工作区状态
git status

# 2. 确认没有数据库文件
git status | grep -E "\.db$|backups/" || echo "✅ 没有数据库文件"

# 3. 添加代码文件
git add .

# 4. 再次确认（查看暂存区）
git status

# 5. 提交
git commit -m "feat: 描述你的更改"

# 6. 推送
git push origin main
```

### 数据库迁移（服务器操作）

**数据库迁移不在本地Git操作中**，而是在服务器上执行：

```bash
# 在服务器上执行
cd /srv/EmbodiedPulse2026

# 使用迁移脚本
bash scripts/migrate_database_to_server.sh

# 或手动上传
scp papers.db root@server:/srv/EmbodiedPulse2026/
```

---

## 📝 最佳实践

1. **推送前必检查**: 每次推送前检查 `git status`
2. **定期验证**: 定期验证 `.gitignore` 配置
3. **团队协作**: 团队成员都要遵守此规范
4. **文档更新**: 数据库结构变更时更新文档，不推送数据库文件

---

## 🔗 相关文档

- [数据库迁移指南](./docs/项目文档/06-安装部署/配置指南/数据库迁移指南.md)
- [数据库迁移紧急修复指南](./docs/项目文档/06-安装部署/配置指南/数据库迁移紧急修复指南_20251217_v1.0.md)

---

**文档版本**: v1.0  
**最后更新**: 2025-12-17  
**维护者**: AI Assistant

