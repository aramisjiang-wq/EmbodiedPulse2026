# 论文抓取功能完整说明

## 📋 功能概述

网站**支持通过 API 自动更新抓取新论文数据**，有两种方式：

1. **手动触发**（已实现）✅
2. **自动定时抓取**（已实现）✅

## 🔄 实现过程详解

### 方式 1: 手动触发抓取

#### 实现流程

```
┌─────────────────────────────────────────┐
│  1. 用户操作                              │
│     - Web界面：点击"抓取新论文"按钮        │
│     - 或直接调用 API                      │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  2. API 接收请求                          │
│     POST /api/fetch                       │
│     Body: {                               │
│       "max_results": 10,                  │
│       "config_path": "config.yaml"        │
│     }                                     │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  3. 检查任务状态                          │
│     - 如果已有任务运行，返回错误           │
│     - 否则创建后台线程                    │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  4. 后台线程执行                          │
│     - 更新 fetch_status 状态              │
│     - 调用 demo() 函数                    │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  5. 抓取论文数据                          │
│     - 遍历配置的关键词类别                │
│     - 调用 ArXiv API                     │
│     - 解析论文信息                        │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  6. 保存数据                              │
│     - 去重检查（数据库主键）              │
│     - 保存到 SQLite 数据库                │
│     - 更新 JSON 文件（备份）              │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  7. 更新状态                              │
│     - fetch_status['running'] = False     │
│     - 记录完成时间                        │
└─────────────────────────────────────────┘
```

#### 代码位置

**API 端点** (`app.py:256-309`):
```python
@app.route('/api/fetch', methods=['POST'])
def trigger_fetch():
    """触发论文抓取"""
    # 1. 检查任务状态
    # 2. 创建后台线程
    # 3. 执行抓取
```

**抓取逻辑** (`daily_arxiv.py:434-487`):
```python
def demo(**config):
    """主抓取函数"""
    # 1. 遍历关键词
    # 2. 调用 get_daily_papers()
    # 3. 保存数据
```

**数据保存** (`save_paper_to_db.py`):
```python
def save_paper_to_db(paper_data, category):
    """保存到数据库"""
    # 去重 + 保存/更新
```

### 方式 2: 自动定时抓取

#### 实现流程

```
┌─────────────────────────────────────────┐
│  1. 服务器启动                            │
│     - 检查 AUTO_FETCH_ENABLED 环境变量    │
│     - 如果启用，启动 APScheduler          │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  2. 定时任务调度器                        │
│     - 根据 Cron 表达式定时触发             │
│     - 默认：每天凌晨2点                   │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  3. 执行抓取任务                          │
│     - 检查是否有任务正在运行              │
│     - 调用 demo() 函数                    │
│     - 使用较小的 max_results（避免限制）   │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  4. 保存数据（同手动触发）                │
│     - 去重检查                            │
│     - 保存到数据库                        │
│     - 更新 JSON 文件                      │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  5. 记录日志                              │
│     - 成功/失败日志                       │
│     - 不影响 Web 服务                    │
└─────────────────────────────────────────┘
```

#### 代码位置

**定时任务启动** (`app.py:311-370`):
```python
def start_scheduler():
    """启动定时任务调度器"""
    # 1. 创建 BackgroundScheduler
    # 2. 配置 Cron 触发器
    # 3. 启动调度器
```

## 🛠️ 使用方法

### 手动触发

#### 方法 1: Web 界面
1. 打开 http://localhost:5001
2. 点击"抓取新论文"按钮
3. 配置参数（可选）
4. 点击"开始抓取"
5. 查看进度和结果

#### 方法 2: API 调用
```bash
curl -X POST http://localhost:5001/api/fetch \
  -H "Content-Type: application/json" \
  -d '{
    "max_results": 10,
    "config_path": "config.yaml"
  }'
```

#### 方法 3: Python 代码
```python
import requests

response = requests.post(
    'http://localhost:5001/api/fetch',
    json={
        'max_results': 10,
        'config_path': 'config.yaml'
    }
)
print(response.json())
```

### 自动定时抓取

#### 启用步骤

1. **安装依赖**
   ```bash
   pip install apscheduler
   ```

2. **设置环境变量**
   ```bash
   export AUTO_FETCH_ENABLED=true
   export AUTO_FETCH_SCHEDULE="0 2 * * *"  # 每天凌晨2点
   export AUTO_FETCH_MAX_RESULTS=10
   ```

3. **启动服务器**
   ```bash
   python3 app.py
   ```

4. **查看日志**
   - 定时任务执行时会记录日志
   - 可以通过日志查看执行情况

## 📊 数据流程

### 抓取 → 处理 → 存储

```
ArXiv API
    ↓
get_daily_papers()
    ↓
解析论文数据
    ↓
去重检查（数据库主键）
    ↓
保存到数据库 (SQLite)
    ↓
更新 JSON 文件（备份）
    ↓
完成
```

### 去重机制

- **数据库主键**: ArXiv ID 作为主键，自动去重
- **更新策略**: 如果论文已存在，更新信息而不是重复插入
- **代码位置**: `save_paper_to_db.py`

## 🔍 状态监控

### 查看抓取状态

```bash
# API 查询
curl http://localhost:5001/api/fetch-status

# 返回示例
{
  "running": false,
  "progress": 0,
  "total": 5,
  "current_keyword": "",
  "message": "抓取完成！",
  "last_update": "2025-12-08 17:00:00"
}
```

### 查看日志

定时任务和手动抓取都会记录日志：
- 控制台输出
- Flask 日志系统
- 错误信息会详细记录

## ⚙️ 配置选项

### 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `AUTO_FETCH_ENABLED` | 启用自动抓取 | `false` |
| `AUTO_FETCH_SCHEDULE` | Cron 表达式 | `0 2 * * *` |
| `AUTO_FETCH_MAX_RESULTS` | 每次抓取数量 | `10` |
| `PORT` | 服务器端口 | `5001` |

### config.yaml

```yaml
max_results: 20  # 手动抓取时的默认数量
keywords:
  Manipulation:
    filters: ["Robot Manipulation", ...]
  # ...
```

## ⚠️ 注意事项

1. **ArXiv API 速率限制**
   - 建议定时任务使用较小的 `max_results`（5-10）
   - 避免短时间内大量请求

2. **任务冲突**
   - 如果已有任务运行，新任务会被拒绝
   - 定时任务会检查状态，避免冲突

3. **数据一致性**
   - 数据库主键确保去重
   - JSON 文件作为备份保留

4. **错误处理**
   - 抓取失败会记录日志
   - 不会影响 Web 服务运行

## 📝 总结

### ✅ 已实现功能

1. **手动触发抓取**
   - Web 界面按钮
   - RESTful API
   - 后台异步执行

2. **自动定时抓取**
   - APScheduler 调度器
   - Cron 表达式配置
   - 环境变量控制

3. **数据管理**
   - 数据库存储（SQLite）
   - 自动去重
   - JSON 备份

4. **状态监控**
   - 实时状态查询
   - 日志记录
   - 错误处理

### 🎯 使用建议

- **开发环境**: 使用手动触发
- **生产环境**: 启用自动定时抓取
- **抓取频率**: 建议每天1-2次
- **每次数量**: 5-10篇/类别（避免速率限制）

**网站完全支持通过 API 自动更新抓取新论文数据！** 🎉

