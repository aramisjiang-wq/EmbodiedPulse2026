# B站播放量API查询数据不一致问题诊断

## 问题现象

- **代码已修复**: ✅ `format_number(video.play)` 已应用
- **数据库查询**: play = 194,030 ✅
- **API返回**: play_raw = 5530 ❌

## 可能原因

1. **API查询时使用了不同的数据库连接**
2. **数据库中有多条记录，查询到了错误的记录**
3. **数据库更新没有提交（事务问题）**
4. **查询时使用了缓存的数据**

## 诊断命令

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

echo "【1. 检查数据库中的实际数据】"
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo

session = get_bilibili_session()

# 检查所有BV1L8qEBKEFW的记录
videos = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').all()
print(f"BV1L8qEBKEFW的记录数: {len(videos)}")
for i, v in enumerate(videos, 1):
    print(f"\n记录 {i}:")
    print(f"  play: {v.play:,}")
    print(f"  play_formatted: {v.play_formatted}")
    print(f"  uid: {v.uid}")
    print(f"  is_deleted: {v.is_deleted}")
    print(f"  updated_at: {v.updated_at}")

session.close()
PYEOF

echo ""
echo "【2. 模拟API查询逻辑，检查实际查询到的数据】"
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo, BilibiliUp

LIMX_UID = 1172054289
session = get_bilibili_session()

# 模拟API查询逻辑
up = session.query(BilibiliUp).filter_by(uid=LIMX_UID, is_active=True).first()
if up:
    videos_query = session.query(BilibiliVideo).filter_by(
        uid=up.uid,
        is_deleted=False
    ).order_by(BilibiliVideo.pubdate_raw.desc()).limit(200)
    
    videos = videos_query.all()
    print(f"✅ API查询逻辑返回的视频（前3个）:")
    for i, v in enumerate(videos[:3], 1):
        print(f"{i}. {v.bvid} - {v.title[:40]}...")
        print(f"   play: {v.play:,}, play_raw: {v.play}")
        print(f"   uid: {v.uid}, is_deleted: {v.is_deleted}")
        
        # 如果是BV1L8qEBKEFW，详细检查
        if v.bvid == 'BV1L8qEBKEFW':
            print(f"   ⚠️  这是目标视频，但play={v.play:,}")

session.close()
PYEOF

echo ""
echo "【3. 检查是否有事务未提交】"
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo

session = get_bilibili_session()

# 直接查询，不使用事务
video = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').first()
if video:
    print(f"✅ 直接查询结果:")
    print(f"   play: {video.play:,}")
    print(f"   play_formatted: {video.play_formatted}")
    
    # 刷新对象，确保获取最新数据
    session.refresh(video)
    print(f"\n✅ 刷新后:")
    print(f"   play: {video.play:,}")
    print(f"   play_formatted: {video.play_formatted}")

session.close()
PYEOF

echo ""
echo "【4. 检查数据库文件】"
ls -lh /srv/EmbodiedPulse2026/bilibili.db
sqlite3 /srv/EmbodiedPulse2026/bilibili.db "SELECT bvid, play, play_formatted, uid, is_deleted FROM bilibili_videos WHERE bvid='BV1L8qEBKEFW';"
```

