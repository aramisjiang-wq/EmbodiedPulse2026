# B站播放量API缓存问题最终诊断

## 问题确认

- **数据库**: play = 194,030 ✅
- **模拟API查询**: play = 194,030 ✅
- **实际API返回**: play_raw = 5530 ❌

## 根本原因

**缓存问题**：虽然清除了缓存，但API返回时可能又使用了缓存，或者服务进程中的缓存没有被清除。

## 完整解决方案

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

echo "=========================================="
echo "B站播放量API缓存问题最终修复"
echo "=========================================="
echo ""

echo "【1. 强制清除所有缓存（包括运行中的服务）】"
# 方法1: 通过API清除缓存
curl -s "http://localhost:5001/api/bilibili/all?force=1" > /dev/null

# 方法2: 重启服务（这会清除所有内存缓存）
systemctl restart embodiedpulse
sleep 5

echo ""
echo "【2. 检查服务是否真正重启】"
systemctl status embodiedpulse --no-pager -l | head -10

echo ""
echo "【3. 直接测试运行中的服务API】"
curl -s "http://localhost:5001/api/bilibili/all?force=1" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if data.get('success'):
    cards = data.get('data', [])
    for card in cards:
        if card.get('user_info', {}).get('mid') == 1172054289:
            videos = card.get('videos', [])
            if videos:
                latest = videos[0]
                print(f'✅ 运行中服务API返回:')
                print(f'   BV号: {latest.get(\"bvid\")}')
                print(f'   play: {latest.get(\"play\")}')
                print(f'   play_raw: {latest.get(\"play_raw\")}')
                break
"

echo ""
echo "【4. 如果仍返回5530，检查代码中是否有硬编码或缓存逻辑】"
grep -n "5530\|play.*5530" app.py bilibili_models.py || echo "✅ 代码中没有硬编码5530"

echo ""
echo "【5. 检查format_number函数是否正确】"
python3 << 'PYEOF'
from bilibili_client import format_number

test_values = [5530, 194030, 171419]
print("测试format_number函数:")
for val in test_values:
    formatted = format_number(val)
    print(f"  {val:,} -> {formatted}")
PYEOF

echo ""
echo "【6. 完整测试：从数据库到API返回】"
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo, BilibiliUp
from bilibili_client import format_number

LIMX_UID = 1172054289
session = get_bilibili_session()

# 1. 从数据库获取
up = session.query(BilibiliUp).filter_by(uid=LIMX_UID, is_active=True).first()
videos_query = session.query(BilibiliVideo).filter_by(
    uid=up.uid,
    is_deleted=False
).order_by(BilibiliVideo.pubdate_raw.desc()).limit(1)

video = videos_query.first()
if video:
    print(f"✅ 数据库查询:")
    print(f"   play: {video.play:,}")
    
    # 2. 模拟API格式化
    play_formatted = format_number(video.play) if video.play else '0'
    play_raw = video.play or 0
    
    print(f"\n✅ 模拟API格式化:")
    print(f"   play: {play_formatted}")
    print(f"   play_raw: {play_raw}")

session.close()
PYEOF

echo ""
echo "=========================================="
echo "如果以上都正确，但API仍返回5530，"
echo "可能是Gunicorn worker进程缓存问题"
echo "=========================================="
echo ""
echo "【7. 完全重启服务（杀死所有进程）】"
systemctl stop embodiedpulse
sleep 2
pkill -f "gunicorn.*app:app" || true
sleep 2
systemctl start embodiedpulse
sleep 5
systemctl status embodiedpulse --no-pager -l | head -10

echo ""
echo "【8. 再次测试API】"
curl -s "http://localhost:5001/api/bilibili/all?force=1" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if data.get('success'):
    cards = data.get('data', [])
    for card in cards:
        if card.get('user_info', {}).get('mid') == 1172054289:
            videos = card.get('videos', [])
            if videos:
                latest = videos[0]
                print(f'✅ 重启后API返回:')
                print(f'   BV号: {latest.get(\"bvid\")}')
                print(f'   play: {latest.get(\"play\")}')
                print(f'   play_raw: {latest.get(\"play_raw\")}')
                if latest.get('play_raw') == 194030:
                    print('✅ 数据正确！')
                break
"
```

