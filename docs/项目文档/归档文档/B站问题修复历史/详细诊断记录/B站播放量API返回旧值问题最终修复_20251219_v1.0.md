# B站播放量API返回旧值问题最终修复

## 问题确认

- **数据库**: play = 194,030 ✅
- **API返回**: play = 5530, play_raw = 5530 ❌
- **视频排序**: 正确，BV1L8qEBKEFW是第一个 ✅

## 根本原因

API代码可能没有修复，或者修复后没有重启服务，导致返回的是旧数据。

## 完整修复步骤

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

echo "=========================================="
echo "B站播放量API返回旧值问题修复"
echo "=========================================="
echo ""

echo "【1. 检查代码是否已修复】"
echo "检查 app.py 第1322行:"
grep -n "format_number(video.play)" app.py | head -1 || echo "❌ app.py 未修复"

echo "检查 bilibili_models.py 第157行:"
grep -n "format_number(self.play)" bilibili_models.py | head -1 || echo "❌ bilibili_models.py 未修复"

echo ""
echo "【2. 如果未修复，立即修复】"
python3 << 'PYEOF'
import re

# 修复 app.py
with open('app.py', 'r', encoding='utf-8') as f:
    content = f.read()

if 'format_number(video.play)' not in content:
    old_pattern = r"'play':\s*video\.play_formatted\s+or\s+'0'"
    new_pattern = "'play': format_number(video.play) if video.play else '0'"
    
    if re.search(old_pattern, content):
        content = re.sub(old_pattern, new_pattern, content)
        with open('app.py', 'w', encoding='utf-8') as f:
            f.write(content)
        print("✅ app.py 已修复")
    else:
        print("⚠️  app.py 未找到需要修复的代码")
else:
    print("✅ app.py 已修复")

# 修复 bilibili_models.py
with open('bilibili_models.py', 'r', encoding='utf-8') as f:
    content = f.read()

if 'format_number(self.play)' not in content:
    # 添加import
    if 'from bilibili_client import format_number' not in content:
        if 'from bilibili_client import' in content:
            content = re.sub(
                r'(from bilibili_client import[^\n]+)',
                lambda m: m.group(1) + ', format_number' if 'format_number' not in m.group(1) else m.group(1),
                content
            )
        else:
            lines = content.split('\n')
            for i, line in enumerate(lines):
                if 'from sqlalchemy' in line:
                    lines.insert(i+1, 'from bilibili_client import format_number')
                    break
            content = '\n'.join(lines)
    
    # 替换play字段
    old_pattern = r"'play':\s*self\.play_formatted\s+or\s+'0'"
    new_pattern = "'play': format_number(self.play) if self.play else '0'"
    
    if re.search(old_pattern, content):
        content = re.sub(old_pattern, new_pattern, content)
        with open('bilibili_models.py', 'w', encoding='utf-8') as f:
            f.write(content)
        print("✅ bilibili_models.py 已修复")
    else:
        print("⚠️  bilibili_models.py 未找到需要修复的代码")
else:
    print("✅ bilibili_models.py 已修复")
PYEOF

echo ""
echo "【3. 验证修复】"
grep -n "format_number(video.play)" app.py | head -1
grep -n "format_number(self.play)" bilibili_models.py | head -1

echo ""
echo "【4. 清除所有缓存】"
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app
with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
    app.bilibili_cache['data'] = None
    app.bilibili_cache['expires_at'] = None
print("✅ 缓存已清除")
EOF

echo ""
echo "【5. 重启服务】"
systemctl restart embodiedpulse
sleep 5
systemctl status embodiedpulse --no-pager -l | head -15

echo ""
echo "【6. 测试API（使用force=1绕过缓存）】"
python3 << 'PYEOF'
from app import app

with app.test_client() as client:
    response = client.get('/api/bilibili/all?force=1')
    data = response.get_json()
    if data and data.get('success'):
        cards = data.get('data', [])
        for card in cards:
            if card.get('user_info', {}).get('mid') == 1172054289:
                videos = card.get('videos', [])
                if videos:
                    latest = videos[0]
                    print(f"✅ API返回:")
                    print(f"   BV号: {latest.get('bvid')}")
                    print(f"   play: {latest.get('play')}")
                    print(f"   play_raw: {latest.get('play_raw')}")
                    if latest.get('play_raw') == 194030:
                        print("✅ 数据正确！")
                    else:
                        print(f"❌ 数据错误，期望194030，实际{latest.get('play_raw')}")
                    break
PYEOF

echo ""
echo "=========================================="
echo "修复完成！"
echo "=========================================="
```

