# B站播放量API返回错误问题诊断

## 问题现象

- **数据库已更新**: 171,419 → 194,030 ✅
- **API返回**: play=5530, play_raw=5530 ❌

## 可能原因

1. **API返回的视频不是最新的**：排序问题，第一个视频不是BV1L8qEBKEFW
2. **查询条件问题**：可能查询到了错误的视频
3. **缓存问题**：虽然清除了，但可能又缓存了旧数据

## 诊断命令

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

echo "【1. 检查数据库中的实际数据】"
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo
from sqlalchemy import desc

session = get_bilibili_session()

# 检查BV1L8qEBKEFW
video = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').first()
if video:
    print(f"✅ 数据库中的BV1L8qEBKEFW:")
    print(f"   play: {video.play:,}")
    print(f"   play_formatted: {video.play_formatted}")
    print(f"   pubdate_raw: {video.pubdate_raw}")
    print(f"   更新时间: {video.updated_at}")

# 检查逐际动力的最新5个视频（按pubdate_raw排序）
LIMX_UID = 1172054289
latest_videos = session.query(BilibiliVideo).filter_by(
    uid=LIMX_UID, is_deleted=False
).order_by(desc(BilibiliVideo.pubdate_raw)).limit(5).all()

print(f"\n✅ 逐际动力的最新5个视频（按pubdate_raw排序）:")
for i, v in enumerate(latest_videos, 1):
    print(f"{i}. {v.bvid} - {v.title[:40]}...")
    print(f"   play: {v.play:,}, pubdate_raw: {v.pubdate_raw}")

session.close()
PYEOF

echo ""
echo "【2. 检查API返回的视频列表】"
python3 << 'PYEOF'
from app import app

with app.test_client() as client:
    response = client.get('/api/bilibili/all?force=1')
    data = response.get_json()
    if data and data.get('success'):
        cards = data.get('data', [])
        for card in cards:
            if card.get('user_info', {}).get('mid') == 1172054289:
                videos = card.get('videos', [])
                print(f"✅ API返回的视频列表（前5个）:")
                for i, v in enumerate(videos[:5], 1):
                    print(f"{i}. {v.get('bvid')} - {v.get('title', '')[:40]}...")
                    print(f"   play: {v.get('play')}, play_raw: {v.get('play_raw')}, pubdate_raw: {v.get('pubdate_raw')}")
                break
PYEOF

echo ""
echo "【3. 检查API查询逻辑】"
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo, BilibiliUp
from sqlalchemy import desc

LIMX_UID = 1172054289
session = get_bilibili_session()

# 模拟API查询逻辑
up = session.query(BilibiliUp).filter_by(uid=LIMX_UID, is_active=True).first()
if up:
    videos_query = session.query(BilibiliVideo).filter_by(
        uid=up.uid,
        is_deleted=False
    ).order_by(BilibiliVideo.pubdate_raw.desc()).limit(200)
    
    videos = videos_query.all()
    print(f"✅ API查询逻辑返回的视频（前5个）:")
    for i, v in enumerate(videos[:5], 1):
        print(f"{i}. {v.bvid} - {v.title[:40]}...")
        print(f"   play: {v.play:,}, pubdate_raw: {v.pubdate_raw}")

session.close()
PYEOF
```

## 如果发现API返回的不是最新视频

需要检查：
1. `pubdate_raw` 字段是否正确
2. 排序逻辑是否正确
3. 是否有多个视频的 `pubdate_raw` 相同

## 如果发现API返回的是旧数据

需要：
1. 强制清除缓存
2. 重启服务
3. 使用 `force=1` 参数绕过缓存

