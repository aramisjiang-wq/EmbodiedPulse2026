# B站播放量数据不一致问题诊断

## 问题发现

API返回：`play=5530, play_raw=5530`

这说明**数据库中的 `play` 字段本身就是 5530**，不是之前检查时看到的 171,419。

## 可能的原因

1. **数据被更新了**：之前更新到 171,419，但后来又被更新回 5530
2. **查询的是不同的视频**：可能查询的不是最新的视频
3. **数据库中有多条记录**：同一个BV号可能有多个记录

## 需要检查

### 1. 检查数据库中BV1L8qEBKEFW的实际数据

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo
from sqlalchemy import desc

session = get_bilibili_session()

# 检查所有BV1L8qEBKEFW的记录
videos = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').all()
print(f"BV1L8qEBKEFW的记录数: {len(videos)}")
for i, v in enumerate(videos, 1):
    print(f"\n记录 {i}:")
    print(f"  play: {v.play:,}")
    print(f"  play_formatted: {v.play_formatted}")
    print(f"  发布时间: {v.pubdate}")
    print(f"  更新时间: {v.updated_at}")
    print(f"  is_deleted: {v.is_deleted}")

# 检查逐际动力的最新视频
LIMX_UID = 1172054289
latest_videos = session.query(BilibiliVideo).filter_by(
    uid=LIMX_UID, is_deleted=False
).order_by(desc(BilibiliVideo.pubdate_raw)).limit(5).all()

print(f"\n逐际动力的最新5个视频:")
for i, v in enumerate(latest_videos, 1):
    print(f"{i}. {v.bvid} - {v.title[:40]}...")
    print(f"   play: {v.play:,}, 发布时间: {v.pubdate}")

session.close()
PYEOF
```

### 2. 检查API返回的视频列表排序

```bash
python3 << 'PYEOF'
from app import app

with app.test_client() as client:
    response = client.get('/api/bilibili/all?force=1')
    data = response.get_json()
    if data and data.get('success'):
        cards = data.get('data', [])
        for card in cards:
            if card.get('user_info', {}).get('mid') == 1172054289:
                videos = card.get('videos', [])
                print(f"API返回的视频列表（前5个）:")
                for i, v in enumerate(videos[:5], 1):
                    print(f"{i}. {v.get('bvid')} - {v.get('title', '')[:40]}...")
                    print(f"   play: {v.get('play')}, play_raw: {v.get('play_raw')}, pubdate_raw: {v.get('pubdate_raw')}")
                break
PYEOF
```

### 3. 从B站API获取最新播放量

```bash
python3 << 'PYEOF'
from bilibili_client import BilibiliClient

client = BilibiliClient()
bvid = 'BV1L8qEBKEFW'

# 直接从B站API获取视频信息
url = "https://api.bilibili.com/x/web-interface/view"
params = {"bvid": bvid}
data = client._request_json(url, params=params)

if data and data.get('code') == 0:
    video_data = data.get('data', {})
    stat = video_data.get('stat', {})
    play_count = stat.get('view', 0)
    title = video_data.get('title', '')
    
    print(f"✅ B站API返回:")
    print(f"   BV号: {bvid}")
    print(f"   标题: {title[:50]}...")
    print(f"   播放量: {play_count:,}")
else:
    print(f"❌ 获取失败: {data}")
PYEOF
```

### 4. 更新数据库中的播放量

如果B站API返回的播放量是 171,419，需要更新数据库：

```bash
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo
from bilibili_client import format_number

session = get_bilibili_session()
video = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').first()

if video:
    print(f"更新前: play={video.play:,}, play_formatted={video.play_formatted}")
    
    # 从B站API获取最新播放量
    from bilibili_client import BilibiliClient
    client = BilibiliClient()
    url = "https://api.bilibili.com/x/web-interface/view"
    params = {"bvid": video.bvid}
    data = client._request_json(url, params=params)
    
    if data and data.get('code') == 0:
        stat = data.get('data', {}).get('stat', {})
        new_play = stat.get('view', 0)
        
        if new_play > 0:
            video.play = new_play
            video.play_formatted = format_number(new_play)
            session.commit()
            print(f"✅ 更新成功: play={video.play:,}, play_formatted={video.play_formatted}")
        else:
            print("❌ 获取到的播放量为0")
    else:
        print(f"❌ 从B站API获取失败")
else:
    print("❌ 未找到视频")

session.close()
PYEOF
```

## 完整诊断和修复流程

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

echo "=========================================="
echo "B站播放量数据诊断和修复"
echo "=========================================="
echo ""

echo "【1. 检查数据库中的实际数据】"
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo
from sqlalchemy import desc

session = get_bilibili_session()

# 检查BV1L8qEBKEFW
video = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').first()
if video:
    print(f"✅ 找到视频:")
    print(f"   play: {video.play:,}")
    print(f"   play_formatted: {video.play_formatted}")
    print(f"   更新时间: {video.updated_at}")
else:
    print("❌ 未找到视频")

# 检查逐际动力的最新视频
LIMX_UID = 1172054289
latest = session.query(BilibiliVideo).filter_by(
    uid=LIMX_UID, is_deleted=False
).order_by(desc(BilibiliVideo.pubdate_raw)).first()

if latest:
    print(f"\n✅ 最新视频:")
    print(f"   BV号: {latest.bvid}")
    print(f"   标题: {latest.title[:50]}...")
    print(f"   play: {latest.play:,}")
    print(f"   发布时间: {latest.pubdate}")

session.close()
PYEOF

echo ""
echo "【2. 从B站API获取最新播放量】"
python3 << 'PYEOF'
from bilibili_client import BilibiliClient

client = BilibiliClient()
bvid = 'BV1L8qEBKEFW'

url = "https://api.bilibili.com/x/web-interface/view"
params = {"bvid": bvid}
data = client._request_json(url, params=params)

if data and data.get('code') == 0:
    video_data = data.get('data', {})
    stat = video_data.get('stat', {})
    play_count = stat.get('view', 0)
    title = video_data.get('title', '')
    
    print(f"✅ B站API返回:")
    print(f"   标题: {title[:50]}...")
    print(f"   播放量: {play_count:,}")
else:
    print(f"❌ 获取失败: {data}")
PYEOF

echo ""
echo "【3. 更新数据库（如果需要）】"
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo
from bilibili_client import format_number, BilibiliClient

session = get_bilibili_session()
video = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').first()

if video:
    # 从B站API获取最新播放量
    client = BilibiliClient()
    url = "https://api.bilibili.com/x/web-interface/view"
    params = {"bvid": video.bvid}
    data = client._request_json(url, params=params)
    
    if data and data.get('code') == 0:
        stat = data.get('data', {}).get('stat', {})
        new_play = stat.get('view', 0)
        
        if new_play > 0 and new_play != video.play:
            old_play = video.play
            video.play = new_play
            video.play_formatted = format_number(new_play)
            session.commit()
            print(f"✅ 更新成功:")
            print(f"   旧值: {old_play:,}")
            print(f"   新值: {new_play:,}")
            print(f"   格式化: {video.play_formatted}")
        elif new_play == video.play:
            print(f"✅ 数据库数据已是最新: {video.play:,}")
        else:
            print("❌ 获取到的播放量为0")
    else:
        print(f"❌ 从B站API获取失败")
else:
    print("❌ 未找到视频")

session.close()
PYEOF

echo ""
echo "【4. 清除缓存并重启服务】"
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app
with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
print("✅ 缓存已清除")
EOF

systemctl restart embodiedpulse
sleep 3

echo ""
echo "【5. 验证修复后的API】"
python3 << 'PYEOF'
from app import app
with app.test_client() as client:
    response = client.get('/api/bilibili/all?force=1')
    data = response.get_json()
    if data and data.get('success'):
        cards = data.get('data', [])
        for card in cards:
            if card.get('user_info', {}).get('mid') == 1172054289:
                videos = card.get('videos', [])
                if videos:
                    latest = videos[0]
                    print(f"✅ API返回:")
                    print(f"   BV号: {latest.get('bvid')}")
                    print(f"   play: {latest.get('play')}")
                    print(f"   play_raw: {latest.get('play_raw')}")
                    break
PYEOF

echo ""
echo "=========================================="
echo "诊断完成"
echo "=========================================="
```

