# B站播放量显示问题修复方案

## 问题描述

前端显示的播放量（5530）与数据库中的实际播放量（171,419）不一致。

## 根本原因

1. **数据库数据正确**：`play` 字段 = 171,419 ✅
2. **格式化字段可能过时**：`play_formatted` 字段可能是旧的（如"5.5万"）
3. **前端使用格式化字段**：前端代码使用 `video.play`（格式化字符串）而不是 `video.play_raw`（原始数字）

## 解决方案

### 1. 修复前端代码 ✅

已修改 `templates/bilibili.html` 的 `renderLatestVideos` 函数：

**修改前**：
```javascript
const videoPlay = escapeHtml(video.play || '0');
```

**修改后**：
```javascript
// 修复：使用play_raw（原始数字）而不是play（格式化字符串），确保显示最新数据
const playRaw = video.play_raw || video.play || 0;
const videoPlay = typeof playRaw === 'number' ? formatNumber(playRaw) : escapeHtml(video.play || '0');
```

### 2. 更新数据库中的格式化字段

创建了 `scripts/update_play_formatted.py` 脚本，用于更新所有视频的 `play_formatted` 字段。

## 部署步骤

### 步骤1: 在服务器上创建更新脚本

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

cat > scripts/update_play_formatted.py << 'PYEOF'
#!/usr/bin/env python3
"""
更新数据库中所有视频的play_formatted字段
确保格式化字段与原始播放量一致
"""
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from bilibili_models import get_bilibili_session, BilibiliVideo
from bilibili_client import format_number

def update_play_formatted():
    """更新所有视频的play_formatted字段"""
    session = get_bilibili_session()
    
    try:
        # 获取所有视频
        videos = session.query(BilibiliVideo).filter_by(is_deleted=False).all()
        total = len(videos)
        updated = 0
        skipped = 0
        
        print(f"共找到 {total} 个视频")
        print("-" * 80)
        
        for video in videos:
            if not video.play:
                skipped += 1
                continue
            
            # 计算期望的格式化值
            expected_formatted = format_number(video.play)
            
            # 如果格式化值不一致，则更新
            if video.play_formatted != expected_formatted:
                old_formatted = video.play_formatted or 'None'
                video.play_formatted = expected_formatted
                updated += 1
                
                if updated <= 10:  # 只显示前10个更新
                    print(f"✅ {video.bvid[:12]}... 播放量: {video.play:,}")
                    print(f"   格式化: {old_formatted} → {expected_formatted}")
        
        session.commit()
        
        print("-" * 80)
        print(f"更新完成: {updated} 个视频已更新, {skipped} 个跳过（播放量为0）")
        
    except Exception as e:
        session.rollback()
        print(f"❌ 更新失败: {e}")
        import traceback
        traceback.print_exc()
    finally:
        session.close()

if __name__ == '__main__':
    update_play_formatted()
PYEOF

chmod +x scripts/update_play_formatted.py
```

### 步骤2: 运行更新脚本

```bash
python3 scripts/update_play_formatted.py
```

### 步骤3: 确保前端代码已部署

前端代码修改在 `templates/bilibili.html`，需要确保服务器上的文件已更新。

检查服务器上的代码：
```bash
grep -A 3 "playRaw = video.play_raw" /srv/EmbodiedPulse2026/templates/bilibili.html
```

如果不存在，需要从Git拉取最新代码或手动更新文件。

### 步骤4: 重启服务

```bash
systemctl restart embodiedpulse
```

### 步骤5: 清除缓存（已完成）

```bash
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app
with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
print("✅ 缓存已清除")
EOF
```

## 验证

1. **检查数据库**：
```bash
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo
session = get_bilibili_session()
video = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').first()
if video:
    print(f"播放量: {video.play:,}")
    print(f"格式化: {video.play_formatted}")
session.close()
PYEOF
```

2. **检查API返回**：
访问 `https://essay.gradmotion.com/api/bilibili/all?force=1`，查看返回的 `play` 和 `play_raw` 字段。

3. **检查前端显示**：
访问 `https://essay.gradmotion.com/bilibili`，查看最新视频的播放量是否正确显示。

## 预期结果

- 数据库：`play` = 171,419，`play_formatted` = "17.1万"
- API返回：`play` = "17.1万"，`play_raw` = 171419
- 前端显示：17.1万 ✅

## 注意事项

1. 前端代码修改后，即使 `play_formatted` 字段过时，也会使用 `play_raw` 在前端格式化，确保显示正确。
2. 更新 `play_formatted` 字段是为了保持数据一致性，但不是必需的（因为前端已修复）。
3. 建议定期运行 `update_play_formatted.py` 脚本，确保数据库中的格式化字段是最新的。

