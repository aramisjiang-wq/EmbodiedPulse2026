# B站播放量显示问题修复部署方案

## 问题总结

前端页面显示的播放量数据（5530）与数据库实际值（171,419）不一致。

## 根本原因

1. **API层问题**：`app.py` 和 `bilibili_models.py` 中的 `play` 字段使用 `play_formatted`（可能过时）
2. **数据库问题**：`play_formatted` 字段可能是旧的
3. **前端fallback逻辑**：当 `play_raw` 不存在时，使用格式化字符串可能导致显示错误

## 已修复的代码

### 1. API层修复 ✅

**文件**：`app.py` 第1321行

**修改前**：
```python
'play': video.play_formatted or '0',
```

**修改后**：
```python
'play': format_number(video.play) if video.play else '0',  # 实时格式化
```

### 2. 模型层修复 ✅

**文件**：`bilibili_models.py` 第153行

**修改前**：
```python
'play': self.play_formatted or '0',
```

**修改后**：
```python
'play': format_number(self.play) if self.play else '0',  # 实时格式化
```

### 3. 前端层改进 ✅

**文件**：`templates/bilibili.html` 第1997-1999行

**修改后**：
```javascript
// 优先使用play_raw（原始数字），确保显示最新数据
let playRaw = video.play_raw;
if (!playRaw && video.play) {
    // 如果play是数字字符串，转换为数字
    const playNum = typeof video.play === 'string' ? parseFloat(video.play.replace(/[^\d.]/g, '')) : video.play;
    playRaw = typeof playNum === 'number' && !isNaN(playNum) ? playNum : 0;
}
const videoPlay = playRaw && typeof playRaw === 'number' ? formatNumber(playRaw) : (video.play || '0');
```

## 部署步骤

### 步骤1: 确保代码已更新到服务器

```bash
cd /srv/EmbodiedPulse2026
git pull origin main  # 或你的主分支名
```

或者手动检查以下文件是否已更新：
- `app.py` 第1321行：应该是 `format_number(video.play)`
- `bilibili_models.py` 第153行：应该是 `format_number(self.play)`
- `templates/bilibili.html` 第1997-2005行：应该有改进的fallback逻辑

### 步骤2: 更新数据库中的play_formatted字段（可选但推荐）

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

# 创建更新脚本（如果不存在）
cat > scripts/update_play_formatted.py << 'PYEOF'
#!/usr/bin/env python3
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from bilibili_models import get_bilibili_session, BilibiliVideo
from bilibili_client import format_number

def update_play_formatted():
    session = get_bilibili_session()
    try:
        videos = session.query(BilibiliVideo).filter_by(is_deleted=False).all()
        total = len(videos)
        updated = 0
        skipped = 0
        
        print(f"共找到 {total} 个视频")
        print("-" * 80)
        
        for video in videos:
            if not video.play:
                skipped += 1
                continue
            
            expected_formatted = format_number(video.play)
            if video.play_formatted != expected_formatted:
                old_formatted = video.play_formatted or 'None'
                video.play_formatted = expected_formatted
                updated += 1
                
                if updated <= 10:
                    print(f"✅ {video.bvid[:12]}... 播放量: {video.play:,}")
                    print(f"   格式化: {old_formatted} → {expected_formatted}")
        
        session.commit()
        print("-" * 80)
        print(f"更新完成: {updated} 个视频已更新, {skipped} 个跳过")
    except Exception as e:
        session.rollback()
        print(f"❌ 更新失败: {e}")
        import traceback
        traceback.print_exc()
    finally:
        session.close()

if __name__ == '__main__':
    update_play_formatted()
PYEOF

chmod +x scripts/update_play_formatted.py

# 运行更新脚本
python3 scripts/update_play_formatted.py
```

### 步骤3: 清除缓存

```bash
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app
with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
    app.bilibili_cache['data'] = None
    app.bilibili_cache['expires_at'] = None
print("✅ 缓存已清除")
EOF
```

### 步骤4: 重启服务

```bash
systemctl restart embodiedpulse
systemctl status embodiedpulse
```

## 验证步骤

### 1. 检查数据库数据

```bash
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo
session = get_bilibili_session()
video = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').first()
if video:
    print(f"✅ 数据库数据:")
    print(f"   播放量(play): {video.play:,}")
    print(f"   格式化(play_formatted): {video.play_formatted}")
else:
    print("❌ 未找到视频")
session.close()
PYEOF
```

### 2. 检查API返回数据

```bash
# 测试用户端API
curl -s "https://essay.gradmotion.com/api/bilibili/all?force=1" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if data.get('success'):
    cards = data.get('data', [])
    for card in cards:
        if card.get('user_info', {}).get('mid') == 1172054289:
            videos = card.get('videos', [])
            if videos:
                latest = videos[0]
                print(f\"✅ API返回数据:\")
                print(f\"   BV号: {latest.get('bvid')}\")
                print(f\"   播放量(play): {latest.get('play')}\")
                print(f\"   播放量原始(play_raw): {latest.get('play_raw')}\")
                break
"

# 测试管理端API（需要认证token）
# 可以在浏览器控制台执行：
# fetch('/api/admin/bilibili/videos?page=1&per_page=1&search=BV1L8qEBKEFW', {
#   headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
# }).then(r => r.json()).then(d => console.log(d))
```

### 3. 检查前端显示

访问以下页面，查看播放量是否正确显示：
- `https://essay.gradmotion.com/bilibili` - 用户端页面
- `https://admin123.gradmotion.com/admin/bilibili` - 管理端页面

## 预期结果

- **数据库**：`play` = 171,419，`play_formatted` = "17.1万"
- **API返回**：`play` = "17.1万"，`play_raw` = 171419
- **前端显示**：17.1万 ✅

## 故障排查

### 如果前端仍显示旧值

1. **检查浏览器缓存**：
   - 强制刷新：`Ctrl+Shift+R` (Windows/Linux) 或 `Cmd+Shift+R` (Mac)
   - 清除浏览器缓存

2. **检查API返回**：
   - 打开浏览器开发者工具（F12）
   - 查看 Network 标签
   - 找到 `/api/bilibili/all` 请求
   - 检查返回的 `play` 和 `play_raw` 字段

3. **检查服务日志**：
```bash
journalctl -u embodiedpulse -n 50 --no-pager
```

4. **手动清除缓存并重启**：
```bash
# 清除缓存
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app
with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
print("✅ 缓存已清除")
EOF

# 重启服务
systemctl restart embodiedpulse
```

## 注意事项

1. **API层修复是核心**：即使数据库中的 `play_formatted` 是旧的，API也会实时格式化，确保返回最新值。

2. **前端fallback逻辑**：即使API返回的 `play` 是格式化字符串，前端也会优先使用 `play_raw`。

3. **数据库更新**：更新 `play_formatted` 字段不是必需的，但有助于保持数据一致性。

4. **缓存问题**：如果修改后仍显示旧值，可能是浏览器缓存或后端缓存，需要清除。

