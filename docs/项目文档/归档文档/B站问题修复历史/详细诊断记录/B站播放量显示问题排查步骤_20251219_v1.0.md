# B站播放量显示问题排查步骤

## 快速排查

如果修复后仍显示旧值，请按以下步骤排查：

### 步骤1: 在服务器上运行诊断脚本

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
bash scripts/diagnose_play_count_issue.sh
```

### 步骤2: 检查代码是否已部署

```bash
# 检查 app.py
grep -n "format_number(video.play)" /srv/EmbodiedPulse2026/app.py

# 检查 bilibili_models.py
grep -n "format_number(self.play)" /srv/EmbodiedPulse2026/bilibili_models.py

# 检查前端代码
grep -n "playRaw = video.play_raw" /srv/EmbodiedPulse2026/templates/bilibili.html
```

如果这些命令没有输出，说明代码没有部署到服务器。

### 步骤3: 手动部署代码

如果代码未部署，需要手动更新：

#### 3.1 更新 app.py

```bash
cd /srv/EmbodiedPulse2026
# 备份原文件
cp app.py app.py.backup

# 修改第1321行
sed -i 's/video.play_formatted or '\''0'\''/format_number(video.play) if video.play else '\''0'\''/g' app.py

# 验证修改
grep -n "format_number(video.play)" app.py
```

#### 3.2 更新 bilibili_models.py

```bash
# 备份原文件
cp bilibili_models.py bilibili_models.py.backup

# 修改第153行附近
# 需要手动编辑文件，将：
# 'play': self.play_formatted or '0',
# 改为：
# 'play': format_number(self.play) if self.play else '0',
# 并在文件开头添加：from bilibili_client import format_number

# 或者使用Python脚本修改
python3 << 'PYEOF'
import re

with open('bilibili_models.py', 'r', encoding='utf-8') as f:
    content = f.read()

# 检查是否已修复
if 'format_number(self.play)' in content:
    print("✅ 已修复")
else:
    # 添加import（如果不存在）
    if 'from bilibili_client import format_number' not in content:
        content = content.replace(
            'from sqlalchemy import create_engine',
            'from sqlalchemy import create_engine\nfrom bilibili_client import format_number'
        )
    
    # 替换play字段
    content = re.sub(
        r"'play':\s*self\.play_formatted\s+or\s+'0'",
        "'play': format_number(self.play) if self.play else '0'",
        content
    )
    
    with open('bilibili_models.py', 'w', encoding='utf-8') as f:
        f.write(content)
    print("✅ 已修复")
PYEOF
```

#### 3.3 更新前端代码

```bash
# 检查是否需要更新
grep -n "playRaw = video.play_raw" templates/bilibili.html

# 如果需要更新，手动编辑 templates/bilibili.html
# 找到 renderLatestVideos 函数中的相关代码并更新
```

### 步骤4: 清除缓存并重启

```bash
# 清除缓存
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app
with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
    app.bilibili_cache['data'] = None
    app.bilibili_cache['expires_at'] = None
print("✅ 缓存已清除")
EOF

# 重启服务
systemctl restart embodiedpulse
sleep 3
systemctl status embodiedpulse --no-pager -l | head -10
```

### 步骤5: 验证修复

```bash
# 测试API
python3 << 'PYEOF'
from app import app

with app.test_client() as client:
    response = client.get('/api/bilibili/all?force=1')
    data = response.get_json()
    if data and data.get('success'):
        cards = data.get('data', [])
        for card in cards:
            if card.get('user_info', {}).get('mid') == 1172054289:
                videos = card.get('videos', [])
                if videos:
                    latest = videos[0]
                    print(f"✅ API返回:")
                    print(f"   play: {latest.get('play')}")
                    print(f"   play_raw: {latest.get('play_raw')}")
                    if latest.get('play_raw') == 171419:
                        print("✅ 数据正确！")
                    else:
                        print(f"❌ 数据错误，期望171419，实际{latest.get('play_raw')}")
                    break
PYEOF
```

### 步骤6: 清除浏览器缓存

如果API返回正确，但前端仍显示旧值：

1. **强制刷新**：`Ctrl+Shift+R` (Windows) 或 `Cmd+Shift+R` (Mac)
2. **清除浏览器缓存**：
   - Chrome: 设置 → 隐私和安全 → 清除浏览数据
   - Firefox: 设置 → 隐私与安全 → Cookie和网站数据 → 清除数据
3. **使用无痕模式**：测试是否显示正确

### 步骤7: 检查浏览器控制台

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 刷新页面
4. 找到 `/api/bilibili/all` 请求
5. 查看 Response，检查 `play` 和 `play_raw` 字段

## 常见问题

### Q1: 代码已修复但API仍返回旧值

**原因**：缓存未清除或服务未重启

**解决**：
```bash
# 清除缓存
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app
with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
print("✅ 缓存已清除")
EOF

# 重启服务
systemctl restart embodiedpulse
```

### Q2: API返回正确但前端仍显示旧值

**原因**：浏览器缓存

**解决**：
1. 强制刷新：`Ctrl+Shift+R`
2. 清除浏览器缓存
3. 检查前端代码是否正确

### Q3: 代码修改后服务无法启动

**原因**：语法错误或导入错误

**解决**：
```bash
# 检查Python语法
python3 -m py_compile app.py
python3 -m py_compile bilibili_models.py

# 查看服务日志
journalctl -u embodiedpulse -n 50 --no-pager
```

### Q4: 数据库数据正确但API返回错误

**原因**：代码未修复或缓存问题

**解决**：
1. 确认代码已修复（见步骤2）
2. 清除缓存并重启服务（见步骤4）

## 完整修复命令（一键执行）

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

# 1. 修复 app.py
sed -i "s/'play': video.play_formatted or '0'/'play': format_number(video.play) if video.play else '0'/g" app.py

# 2. 修复 bilibili_models.py
python3 << 'PYEOF'
import re

with open('bilibili_models.py', 'r', encoding='utf-8') as f:
    content = f.read()

if 'from bilibili_client import format_number' not in content:
    content = content.replace(
        'from sqlalchemy import create_engine',
        'from sqlalchemy import create_engine\nfrom bilibili_client import format_number'
    )

content = re.sub(
    r"'play':\s*self\.play_formatted\s+or\s+'0'",
    "'play': format_number(self.play) if self.play else '0'",
    content
)

with open('bilibili_models.py', 'w', encoding='utf-8') as f:
    f.write(content)
print("✅ bilibili_models.py 已修复")
PYEOF

# 3. 清除缓存
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app
with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
print("✅ 缓存已清除")
EOF

# 4. 重启服务
systemctl restart embodiedpulse

echo "✅ 修复完成，请验证前端显示"
```

