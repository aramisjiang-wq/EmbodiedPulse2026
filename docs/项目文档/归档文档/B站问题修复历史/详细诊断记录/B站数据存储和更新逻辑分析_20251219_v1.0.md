# B站数据存储和更新逻辑分析

**日期**: 2025-12-19  
**问题**: 
1. 部分企业的总播放和总视频数据缺失
2. 所有视频播放量数据没有更新

---

## 📊 数据存储结构

### 1. UP主统计数据（存储在数据库）

**表**: `bilibili_ups`  
**字段**:
- `videos_count` (Integer) - 视频总数（**存储在数据库**）
- `views_count` (BigInteger) - 总播放量（**存储在数据库**）
- `views_formatted` (String) - 总播放量（格式化）

**数据来源**:
- **不是实时计算的**，而是从API获取后存储在数据库中
- 在 `fetch_bilibili_data.py` 第91-92行更新：
  ```python
  up.videos_count = user_stat.get('videos', 0)
  up.views_count = user_stat.get('views', 0)
  ```

**前端显示**:
- 在 `app.py` 第1321-1322行，**直接从数据库读取**：
  ```python
  videos_val = format_number(up.videos_count) if up.videos_count else '0'
  views_val = up.views_formatted or (format_number(up.views_count) if up.views_count else '0')
  ```

### 2. 视频播放量（存储在数据库）

**表**: `bilibili_videos`  
**字段**:
- `play` (BigInteger) - 播放量（**存储在数据库**）
- `play_formatted` (String) - 播放量（格式化）

**数据来源**:
- 在 `fetch_bilibili_data.py` 第134-136行更新：
  ```python
  play_raw = video_data.get('play', 0) or 0
  video.play = play_raw
  video.play_formatted = format_number(play_raw)
  ```

---

## 🔍 问题根源分析

### 问题1：部分企业统计数据缺失

**数据流**:
```
抓取脚本运行
  ↓
调用 bilibili_client.get_all_data()
  ↓
遇到 412 错误（B站风控）
  ↓
_get_user_stat_async() 返回 {'videos': 0, 'views': 0, 'likes': 0}
  ↓
fetch_bilibili_data.py 更新数据库
  ↓
up.videos_count = 0  ❌ 覆盖了之前的值！
up.views_count = 0   ❌ 覆盖了之前的值！
```

**为什么有的有，有的没有？**
- **有数据的企业**：抓取时 API 成功返回了数据，或者之前成功抓取过
- **没有数据的企业**：最近一次抓取时 API 失败，返回了 `{'videos': 0, 'views': 0}`，**覆盖了数据库中的值**

**关键问题**：
- 代码在 `fetch_bilibili_data.py` 第91-92行**无条件更新**，即使值是0也会覆盖
- 没有检查数据是否有效就直接更新

### 问题2：视频播放量没有更新

**数据流**:
```
抓取脚本运行
  ↓
调用 bilibili_client.get_all_data()
  ↓
遇到 412 错误（B站风控）
  ↓
_get_user_videos_async() 失败
  ↓
使用 fallback 方法获取视频列表
  ↓
但 fallback 方法可能：
  1. 返回的视频列表为空
  2. 返回的视频数据不完整（没有播放量）
  3. 或者根本没有执行到视频更新逻辑
```

**关键问题**：
- 如果视频列表获取失败，`videos` 为空列表
- 循环 `for video_data in videos:` 不会执行
- 视频播放量就不会更新

---

## 🎯 解决方案

### 方案1：改进数据更新逻辑（防止覆盖有效数据）

**修改 `fetch_bilibili_data.py`**：

```python
# 更新统计数据（只更新有效数据，不覆盖为0）
if user_stat.get('videos', 0) > 0:
    up.videos_count = user_stat.get('videos', 0)
elif up.videos_count == 0:
    # 如果数据库也是0，尝试从视频表计算
    video_count = session.query(func.count(BilibiliVideo.bvid)).filter_by(
        uid=uid, is_deleted=False
    ).scalar()
    if video_count > 0:
        up.videos_count = video_count

if user_stat.get('views', 0) > 0:
    up.views_count = user_stat.get('views', 0)
    up.views_formatted = format_number(up.views_count)
elif up.views_count == 0:
    # 如果数据库也是0，尝试从视频表计算
    total_views = session.query(func.sum(BilibiliVideo.play)).filter_by(
        uid=uid, is_deleted=False
    ).scalar() or 0
    if total_views > 0:
        up.views_count = total_views
        up.views_formatted = format_number(total_views)
```

### 方案2：确保视频播放量更新

**问题**：如果视频列表为空，播放量不会更新

**解决方案**：
1. 即使视频列表为空，也要尝试更新已存在的视频
2. 或者创建独立的视频播放量更新脚本（已创建）

---

## 📝 总结

**数据存储方式**：
- ✅ `videos_count` 和 `views_count` **存储在数据库**（不是实时计算）
- ✅ 视频播放量 **存储在数据库**（不是实时计算）

**问题根源**：
1. **统计数据缺失**：API失败返回0值，**覆盖了数据库中的有效数据**
2. **视频播放量未更新**：遇到412错误时，视频列表获取失败，播放量无法更新

**修复方向**：
1. 改进更新逻辑，**不覆盖有效数据**
2. 如果API返回0，尝试从视频表计算
3. 创建独立的视频播放量更新机制

