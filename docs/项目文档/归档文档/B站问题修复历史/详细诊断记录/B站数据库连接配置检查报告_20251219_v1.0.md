# B站数据库连接配置检查报告

## 检查时间
2025-12-19

## 检查范围
- 管理端页面：`https://admin123.gradmotion.com/admin/bilibili`
- 前端页面：`https://essay.gradmotion.com/bilibili`

## 问题描述
用户怀疑这两个页面连接的是本地数据库而不是服务器数据库。

---

## 一、代码配置分析

### 1.1 数据库配置代码

**文件**: `bilibili_models.py` (第165行)

```python
BILIBILI_DATABASE_URL = os.getenv('BILIBILI_DATABASE_URL', 'sqlite:///./bilibili.db')
```

**关键发现**:
- ✅ 默认值使用SQLite数据库
- ⚠️ **使用相对路径**: `sqlite:///./bilibili.db`
- ⚠️ **相对路径会在当前工作目录下创建数据库文件**
- ⚠️ **如果工作目录不同，会连接到不同的数据库文件**

### 1.2 数据库连接逻辑

**文件**: `bilibili_models.py` (第167-179行)

```python
def get_bilibili_engine():
    """获取B站数据库引擎"""
    if BILIBILI_DATABASE_URL.startswith('postgresql://') or BILIBILI_DATABASE_URL.startswith('postgres://'):
        return create_engine(...)  # PostgreSQL配置
    else:
        return create_engine(BILIBILI_DATABASE_URL, echo=False)  # SQLite配置
```

**关键发现**:
- 如果环境变量未设置，使用默认的相对路径SQLite
- SQLite相对路径会基于**当前工作目录**创建数据库文件

---

## 二、本地环境检查

### 2.1 环境变量配置

**检查结果**:
- ❌ `.env`文件中**未设置**`BILIBILI_DATABASE_URL`
- ❌ 系统环境变量**未设置**`BILIBILI_DATABASE_URL`
- ⚠️ 将使用代码中的默认值: `sqlite:///./bilibili.db`

### 2.2 本地数据库文件位置

**相对路径解析**:
- 默认路径: `sqlite:///./bilibili.db`
- 实际文件路径: `{当前工作目录}/bilibili.db`
- 本地开发时，通常在项目根目录下创建

---

## 三、服务器环境分析

### 3.1 Gunicorn配置

**文件**: `gunicorn_config.py`

**关键发现**:
- ❌ **未设置`chdir`参数**（工作目录）
- ⚠️ 工作目录取决于systemd服务的`WorkingDirectory`配置
- ⚠️ 如果systemd未设置，可能使用默认目录（通常是`/`或用户主目录）

### 3.2 Systemd服务配置

**需要检查**:
```bash
# 检查工作目录
systemctl show embodiedpulse | grep WorkingDirectory

# 检查环境变量
systemctl show embodiedpulse | grep Environment
cat /etc/systemd/system/embodiedpulse.service | grep -i env
```

### 3.3 潜在问题

#### 问题1: 相对路径导致数据库位置不确定
- **原因**: 使用相对路径`sqlite:///./bilibili.db`
- **影响**: 
  - 如果服务器工作目录是`/srv/EmbodiedPulse2026`，数据库在`/srv/EmbodiedPulse2026/bilibili.db`
  - 如果服务器工作目录是`/`，数据库在`/bilibili.db`
  - 如果服务器工作目录是其他目录，数据库会在那个目录下

#### 问题2: 本地和服务器使用不同的数据库文件
- **本地**: `{项目目录}/bilibili.db`
- **服务器**: `{服务器工作目录}/bilibili.db`
- **如果工作目录不同，会连接到完全不同的数据库文件**

#### 问题3: 环境变量未设置
- 如果服务器上未设置`BILIBILI_DATABASE_URL`环境变量
- 会使用默认的相对路径
- 实际文件位置取决于gunicorn的工作目录

---

## 四、数据流分析

### 4.1 管理端页面数据流

```
用户访问: https://admin123.gradmotion.com/admin/bilibili
  ↓
Nginx反向代理
  ↓
Gunicorn (Flask应用)
  ↓
auth_routes.py: get_bilibili_ups() / get_bilibili_videos()
  ↓
bilibili_models.py: get_bilibili_session()
  ↓
BILIBILI_DATABASE_URL = os.getenv('BILIBILI_DATABASE_URL', 'sqlite:///./bilibili.db')
  ↓
如果未设置环境变量 → 使用相对路径 → 在当前工作目录下查找/创建数据库
```

### 4.2 前端页面数据流

```
用户访问: https://essay.gradmotion.com/bilibili
  ↓
Nginx反向代理
  ↓
Gunicorn (Flask应用)
  ↓
app.py: get_all_bilibili()
  ↓
bilibili_models.py: get_bilibili_session()
  ↓
BILIBILI_DATABASE_URL = os.getenv('BILIBILI_DATABASE_URL', 'sqlite:///./bilibili.db')
  ↓
如果未设置环境变量 → 使用相对路径 → 在当前工作目录下查找/创建数据库
```

---

## 五、问题诊断

### 5.1 确认问题

**用户怀疑**: 两个页面连接的是本地数据库而不是服务器数据库

**实际情况**:
1. ✅ 如果服务器上未设置`BILIBILI_DATABASE_URL`环境变量
2. ✅ 如果服务器上的工作目录与预期不同
3. ✅ 可能会连接到错误的数据库文件（不是预期的服务器数据库）

### 5.2 验证方法

在服务器上执行以下检查：

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

# 1. 检查环境变量
echo $BILIBILI_DATABASE_URL
grep BILIBILI_DATABASE_URL .env

# 2. 检查实际使用的数据库
python3 << 'EOF'
import os
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
from bilibili_models import BILIBILI_DATABASE_URL
print(f"实际使用的数据库URL: {BILIBILI_DATABASE_URL}")
EOF

# 3. 检查数据库文件位置
find /srv/EmbodiedPulse2026 -name "bilibili.db" -type f
ls -lh /srv/EmbodiedPulse2026/bilibili.db 2>/dev/null

# 4. 检查systemd工作目录
systemctl show embodiedpulse | grep WorkingDirectory

# 5. 检查数据库中的数据
python3 << 'EOF'
from bilibili_models import get_bilibili_session, BilibiliUp, BilibiliVideo
session = get_bilibili_session()
up_count = session.query(BilibiliUp).count()
video_count = session.query(BilibiliVideo).count()
print(f"UP主数量: {up_count}")
print(f"视频数量: {video_count}")
session.close()
EOF
```

---

## 六、解决方案

### 方案1: 在服务器上设置环境变量（推荐）

**步骤1**: 在服务器上编辑`.env`文件

```bash
cd /srv/EmbodiedPulse2026
nano .env
```

**步骤2**: 添加或修改以下配置

```bash
# 使用绝对路径的SQLite（推荐用于单服务器）
BILIBILI_DATABASE_URL=sqlite:////srv/EmbodiedPulse2026/bilibili.db

# 或使用PostgreSQL（推荐用于生产环境）
BILIBILI_DATABASE_URL=postgresql://username:password@localhost:5432/embodied_pulse
```

**步骤3**: 重启服务

```bash
systemctl restart embodiedpulse
```

### 方案2: 在systemd服务中设置环境变量

**编辑systemd服务文件**:

```bash
sudo nano /etc/systemd/system/embodiedpulse.service
```

**添加环境变量**:

```ini
[Service]
Environment="BILIBILI_DATABASE_URL=sqlite:////srv/EmbodiedPulse2026/bilibili.db"
WorkingDirectory=/srv/EmbodiedPulse2026
```

**重新加载并重启**:

```bash
sudo systemctl daemon-reload
sudo systemctl restart embodiedpulse
```

### 方案3: 迁移到PostgreSQL（生产环境推荐）

**优点**:
- ✅ 避免文件路径问题
- ✅ 更好的并发性能
- ✅ 更好的数据完整性
- ✅ 支持多服务器部署

**步骤**: 参考 `scripts/migrate_sqlite_to_postgresql_server.sh`

---

## 七、检查脚本

### 7.1 本地检查脚本

```bash
python3 scripts/check_database_connection_report.py
```

### 7.2 服务器检查脚本

在服务器上执行：

```bash
bash scripts/check_server_database_connection.sh
```

或通过SSH：

```bash
ssh root@your-server 'cd /srv/EmbodiedPulse2026 && bash scripts/check_server_database_connection.sh'
```

---

## 八、总结

### 8.1 问题确认

✅ **用户怀疑是正确的**:
- 如果服务器上未正确设置`BILIBILI_DATABASE_URL`
- 如果服务器上的工作目录与预期不同
- 两个页面可能会连接到错误的数据库文件

### 8.2 根本原因

1. **使用相对路径的SQLite数据库**
2. **环境变量未设置或配置不正确**
3. **工作目录不确定**

### 8.3 建议

1. **立即检查**: 在服务器上运行检查脚本，确认实际使用的数据库
2. **设置环境变量**: 在`.env`文件或systemd服务中设置`BILIBILI_DATABASE_URL`
3. **使用绝对路径**: 如果使用SQLite，使用绝对路径
4. **考虑PostgreSQL**: 生产环境建议使用PostgreSQL

---

## 九、下一步行动

1. ✅ 在服务器上运行检查脚本，确认实际配置
2. ⏳ 根据检查结果，设置正确的环境变量
3. ⏳ 验证两个页面是否连接到正确的数据库
4. ⏳ 考虑迁移到PostgreSQL（可选）

---

## 附录：检查命令汇总

### 快速检查（在服务器上执行）

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

# 一键检查
bash scripts/check_server_database_connection.sh
```

### 手动检查

```bash
# 1. 环境变量
echo $BILIBILI_DATABASE_URL
grep BILIBILI_DATABASE_URL .env

# 2. 数据库文件
find /srv/EmbodiedPulse2026 -name "bilibili.db" -type f -exec ls -lh {} \;

# 3. 实际使用的数据库
python3 -c "import sys; sys.path.insert(0, '/srv/EmbodiedPulse2026'); from bilibili_models import BILIBILI_DATABASE_URL; print(BILIBILI_DATABASE_URL)"

# 4. 数据统计
python3 -c "from bilibili_models import get_bilibili_session, BilibiliUp, BilibiliVideo; s=get_bilibili_session(); print(f'UP主: {s.query(BilibiliUp).count()}, 视频: {s.query(BilibiliVideo).count()}'); s.close()"
```

