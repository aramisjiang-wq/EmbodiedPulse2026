# B站数据库配置修复方案

## 问题诊断

根据服务器检查结果：

1. ✅ `.env`文件存在，配置了PostgreSQL：
   ```
   BILIBILI_DATABASE_URL=postgresql://embodied_user:MyStrongPass123%21%40%23@localhost:5432/embodied_pulse
   ```

2. ✅ systemd服务配置了加载`.env`文件：
   ```
   EnvironmentFiles=/srv/EmbodiedPulse2026/.env (ignore_errors=no)
   ```

3. ❌ **问题**：`bilibili_models.py`在模块级别直接读取环境变量，没有先加载`.env`文件：
   ```python
   BILIBILI_DATABASE_URL = os.getenv('BILIBILI_DATABASE_URL', 'sqlite:///./bilibili.db')
   ```
   如果环境变量未设置，就会使用默认值SQLite。

4. ✅ PostgreSQL数据库中确实有数据，但播放量是旧的（5,530）

## 解决方案

### 1. 修复代码：在`bilibili_models.py`中添加`.env`文件加载

在`bilibili_models.py`文件开头添加加载`.env`文件的逻辑，确保在读取环境变量之前先加载`.env`文件。

### 2. 验证修复

修复后需要：
1. 重启服务
2. 验证代码实际使用的数据库是PostgreSQL
3. 更新PostgreSQL数据库中的播放量数据

### 3. 更新PostgreSQL数据库中的播放量

由于PostgreSQL数据库中的播放量还是旧的（5,530），需要运行更新脚本。

## 修复步骤

### 步骤1：更新代码

已在`bilibili_models.py`中添加`.env`文件加载逻辑。

### 步骤2：部署到服务器

```bash
cd /srv/EmbodiedPulse2026
git pull  # 或者手动更新文件
```

### 步骤3：重启服务

```bash
systemctl restart embodiedpulse
sleep 5
systemctl status embodiedpulse
```

### 步骤4：验证数据库配置

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

python3 << 'PYEOF'
from bilibili_models import BILIBILI_DATABASE_URL, get_bilibili_engine

print(f"代码中的BILIBILI_DATABASE_URL: {BILIBILI_DATABASE_URL}")
engine = get_bilibili_engine()
print(f"实际使用的数据库: {engine.url}")

if 'postgres' in str(engine.url).lower():
    print("✅ 已切换到PostgreSQL")
    
    # 查询数据
    from bilibili_models import get_bilibili_session, BilibiliVideo
    session = get_bilibili_session()
    video = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').first()
    if video:
        print(f"✅ PostgreSQL数据库中的视频:")
        print(f"   play: {video.play:,}")
        print(f"   play_formatted: {video.play_formatted}")
    session.close()
else:
    print("❌ 仍在使用SQLite")
PYEOF
```

### 步骤5：更新PostgreSQL数据库中的播放量

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

# 更新播放量
python3 scripts/update_video_play_counts.py --force

# 或者更新特定视频
python3 scripts/fetch_single_video.py BV1L8qEBKEFW --uid 1172054289
```

### 步骤6：验证API返回

```bash
curl -s "http://localhost:5001/api/bilibili/all?force=1" | python3 -m json.tool | grep -A 5 "BV1L8qEBKEFW"
```

## 预期结果

修复后：
1. ✅ 代码使用PostgreSQL数据库
2. ✅ PostgreSQL数据库中的播放量已更新
3. ✅ API返回最新的播放量数据
4. ✅ 前端显示最新的播放量

