# B站数据库配置切换检查

## 问题

服务器上的数据库应该是PostgreSQL，但现在查的是SQLite。可能是环境变量没有正确设置。

## 完整检查命令

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

echo "=========================================="
echo "B站数据库配置检查"
echo "=========================================="
echo ""

echo "【1. 检查.env文件】"
if [ -f .env ]; then
    echo "✅ .env文件存在"
    echo "BILIBILI_DATABASE_URL配置:"
    grep -i "BILIBILI_DATABASE_URL" .env || echo "❌ 未找到BILIBILI_DATABASE_URL配置"
    echo ""
    echo "DATABASE_URL配置:"
    grep -i "^DATABASE_URL" .env | head -1 || echo "❌ 未找到DATABASE_URL配置"
else
    echo "❌ .env文件不存在"
fi

echo ""
echo "【2. 检查systemd服务配置】"
echo "EnvironmentFile配置:"
systemctl show embodiedpulse | grep EnvironmentFile || echo "❌ 未配置EnvironmentFile"

echo ""
echo "【3. 检查实际运行时的环境变量】"
python3 << 'PYEOF'
import os

print("实际运行时的环境变量:")
bilibili_db_url = os.getenv('BILIBILI_DATABASE_URL')
if bilibili_db_url:
    # 隐藏密码
    if '@' in bilibili_db_url:
        display_url = bilibili_db_url.split('@')[0] + '@***'
    else:
        display_url = bilibili_db_url
    print(f"  BILIBILI_DATABASE_URL: {display_url}")
    
    if 'postgres' in bilibili_db_url.lower():
        print("  ✅ 配置为PostgreSQL")
    else:
        print("  ❌ 配置为SQLite（需要切换）")
else:
    print("  ❌ BILIBILI_DATABASE_URL未设置，使用默认值SQLite")
PYEOF

echo ""
echo "【4. 检查代码中实际使用的数据库】"
python3 << 'PYEOF'
from bilibili_models import BILIBILI_DATABASE_URL, get_bilibili_engine
import os

print(f"代码中的BILIBILI_DATABASE_URL: {BILIBILI_DATABASE_URL}")

engine = get_bilibili_engine()
print(f"实际使用的数据库: {engine.url}")

if 'postgres' in str(engine.url).lower():
    print("✅ 使用PostgreSQL")
    
    # 查询PostgreSQL中的数据
    from bilibili_models import get_bilibili_session, BilibiliVideo
    session = get_bilibili_session()
    video = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').first()
    if video:
        print(f"✅ PostgreSQL数据库中的视频:")
        print(f"   play: {video.play:,}")
        print(f"   play_formatted: {video.play_formatted}")
    else:
        print("❌ PostgreSQL数据库中未找到该视频")
    session.close()
else:
    print("❌ 使用SQLite（需要切换到PostgreSQL）")
PYEOF

echo ""
echo "【5. 检查PostgreSQL数据库（如果存在）】"
python3 << 'PYEOF'
import os

# 尝试从.env文件读取
env_file = '/srv/EmbodiedPulse2026/.env'
if os.path.exists(env_file):
    with open(env_file, 'r') as f:
        for line in f:
            if line.startswith('BILIBILI_DATABASE_URL='):
                pg_url = line.split('=', 1)[1].strip()
                if 'postgres' in pg_url.lower():
                    print(f"✅ 找到PostgreSQL配置: {pg_url.split('@')[0]}@***")
                    
                    # 尝试连接
                    try:
                        from sqlalchemy import create_engine, text
                        engine = create_engine(pg_url)
                        with engine.connect() as conn:
                            result = conn.execute(text("SELECT bvid, play, play_formatted FROM bilibili_videos WHERE bvid='BV1L8qEBKEFW'"))
                            rows = result.fetchall()
                            if rows:
                                print(f"✅ PostgreSQL数据库查询结果:")
                                for row in rows:
                                    print(f"  BV号: {row[0]}, play: {row[1]:,}, play_formatted: {row[2]}")
                            else:
                                print("⚠️  PostgreSQL数据库中未找到该视频")
                    except Exception as e:
                        print(f"❌ PostgreSQL连接失败: {e}")
                    break
PYEOF

echo ""
echo "=========================================="
echo "检查完成"
echo "=========================================="
```

## 如果发现应该使用PostgreSQL但实际使用SQLite

### 修复步骤

1. **检查.env文件是否有PostgreSQL配置**
2. **检查systemd服务是否加载.env文件**
3. **更新systemd服务配置（如果需要）**
4. **重启服务**

### 修复命令

```bash
cd /srv/EmbodiedPulse2026

echo "【1. 检查.env文件】"
cat .env | grep -i "BILIBILI_DATABASE_URL\|DATABASE_URL"

echo ""
echo "【2. 检查systemd服务配置】"
cat /etc/systemd/system/embodiedpulse.service | grep -i "EnvironmentFile\|Environment"

echo ""
echo "【3. 如果.env文件有PostgreSQL配置但服务未加载，更新systemd配置】"
# 备份服务文件
cp /etc/systemd/system/embodiedpulse.service /etc/systemd/system/embodiedpulse.service.backup

# 检查是否有EnvironmentFile
if ! grep -q "EnvironmentFile" /etc/systemd/system/embodiedpulse.service; then
    echo "需要添加EnvironmentFile配置"
    # 在[Service]部分添加
    sed -i '/\[Service\]/a EnvironmentFile=/srv/EmbodiedPulse2026/.env' /etc/systemd/system/embodiedpulse.service
    systemctl daemon-reload
    echo "✅ 已添加EnvironmentFile配置"
fi

echo ""
echo "【4. 重启服务】"
systemctl restart embodiedpulse
sleep 5

echo ""
echo "【5. 验证】"
python3 << 'PYEOF'
from bilibili_models import BILIBILI_DATABASE_URL, get_bilibili_engine
engine = get_bilibili_engine()
print(f"重启后使用的数据库: {engine.url}")
if 'postgres' in str(engine.url).lower():
    print("✅ 已切换到PostgreSQL")
else:
    print("❌ 仍在使用SQLite")
PYEOF
```

