# B站数据库配置检查

## 问题发现

用户提到服务器上的数据库应该是PostgreSQL，但现在查的是SQLite。可能是数据库迁移后配置没有切换。

## 需要检查

### 1. 检查环境变量配置

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

echo "【1. 检查环境变量】"
echo "BILIBILI_DATABASE_URL:"
echo $BILIBILI_DATABASE_URL

echo ""
echo "检查.env文件:"
if [ -f .env ]; then
    grep -i "BILIBILI_DATABASE_URL\|DATABASE_URL" .env || echo "未找到BILIBILI_DATABASE_URL配置"
else
    echo "❌ .env文件不存在"
fi

echo ""
echo "检查systemd服务配置:"
systemctl show embodiedpulse | grep -i "envfile\|environment"
```

### 2. 检查代码中的默认值

```bash
echo "【2. 检查代码中的默认值】"
python3 << 'PYEOF'
import os
from bilibili_models import BILIBILI_DATABASE_URL

print(f"代码中的BILIBILI_DATABASE_URL: {BILIBILI_DATABASE_URL}")

# 检查环境变量
env_value = os.getenv('BILIBILI_DATABASE_URL')
if env_value:
    print(f"环境变量BILIBILI_DATABASE_URL: {env_value}")
else:
    print("环境变量BILIBILI_DATABASE_URL: 未设置")

# 检查实际使用的数据库
from bilibili_models import get_bilibili_engine
engine = get_bilibili_engine()
print(f"实际使用的数据库: {engine.url}")
PYEOF
```

### 3. 检查PostgreSQL数据库

```bash
echo "【3. 检查PostgreSQL数据库】"
python3 << 'PYEOF'
import os

# 检查常见的PostgreSQL环境变量
pg_url = os.getenv('BILIBILI_DATABASE_URL') or os.getenv('DATABASE_URL')
if pg_url and ('postgres' in pg_url.lower()):
    print(f"✅ 找到PostgreSQL配置: {pg_url.split('@')[0]}@***")
    
    # 尝试连接PostgreSQL
    try:
        from sqlalchemy import create_engine, text
        engine = create_engine(pg_url)
        with engine.connect() as conn:
            result = conn.execute(text("SELECT bvid, play, play_formatted FROM bilibili_videos WHERE bvid='BV1L8qEBKEFW'"))
            rows = result.fetchall()
            if rows:
                print(f"✅ PostgreSQL数据库查询结果:")
                for row in rows:
                    print(f"  BV号: {row[0]}, play: {row[1]:,}, play_formatted: {row[2]}")
            else:
                print("⚠️  PostgreSQL数据库中未找到该视频")
    except Exception as e:
        print(f"❌ PostgreSQL连接失败: {e}")
else:
    print("⚠️  未找到PostgreSQL配置")
PYEOF
```

### 4. 检查是否有多个数据库配置

```bash
echo "【4. 检查所有可能的数据库配置】"
python3 << 'PYEOF'
import os

print("所有相关的环境变量:")
for key in os.environ:
    if 'DATABASE' in key.upper() or 'BILIBILI' in key.upper():
        value = os.environ[key]
        # 隐藏密码
        if '@' in value:
            value = value.split('@')[0] + '@***'
        print(f"  {key}: {value}")
PYEOF
```

### 5. 修复数据库配置（如果需要）

如果发现应该使用PostgreSQL但实际使用的是SQLite，需要：

1. **更新.env文件**
2. **更新systemd服务配置**
3. **重启服务**

