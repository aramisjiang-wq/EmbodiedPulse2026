# B站数据更新稳妥方案

**日期**: 2025-12-19  
**问题**: 
1. 部分企业的视频数和总播放量依旧没有数据
2. 每个视频的播放量数据应该没有更新

---

## 🔍 问题分析

### 问题1：部分企业统计数据缺失

**受影响企业**：
- Unitree宇树科技 (521974986)
- 云深处科技 (22477177)
- 众擎机器人 (3546728498202679)
- 逐际动力 (1172054289)
- 傅利叶Fourier (519804427)
- 加速进化机器人 (3546665977907667)

**可能原因**：
1. B站API 412 风控导致数据获取失败
2. `upstat` 接口也失败
3. fallback 方法获取的视频列表为空或数据不完整
4. 数据库更新时数据为0，覆盖了之前的值

### 问题2：视频播放量未更新

**问题**：
- 视频播放量数据需要定期更新
- 当前抓取逻辑在遇到 412 错误时，视频数据可能无法更新
- 没有独立的视频播放量更新机制

---

## 🎯 解决方案

### 方案1：修复缺失的UP主统计数据

**脚本**: `scripts/fix_missing_up_stats.py`

**功能**：
1. 优先使用 `upstat` 接口获取总播放量
2. 如果失败，从视频表计算总播放量
3. 更新 `videos_count` 和 `views_count` 字段

**使用方法**：
```bash
python3 scripts/fix_missing_up_stats.py
```

**特点**：
- ✅ 安全：只更新缺失的数据
- ✅ 稳妥：优先使用API，失败则使用数据库计算
- ✅ 可重复执行：不会覆盖已有数据

---

### 方案2：诊断统计数据缺失问题

**脚本**: `scripts/diagnose_missing_stats.py`

**功能**：
1. 检查数据库中的统计数据
2. 从视频表计算实际数据
3. 尝试使用 `upstat` 接口获取数据
4. 分析问题原因

**使用方法**：
```bash
python3 scripts/diagnose_missing_stats.py
```

**输出**：
- 数据库字段值
- 视频表实际统计
- API接口返回的数据
- 问题分析和建议

---

### 方案3：稳妥更新视频播放量

**脚本**: `scripts/update_video_play_counts.py`

**功能**：
1. 分批更新视频播放量（避免触发风控）
2. 支持进度保存和断点续传
3. 错误重试机制
4. 只更新最近7天未更新的视频（可配置）

**使用方法**：

```bash
# 更新所有视频（只更新最近7天未更新的）
python3 scripts/update_video_play_counts.py

# 更新指定UP主的视频
python3 scripts/update_video_play_counts.py --uids 1172054289 521974986

# 强制更新所有视频（忽略时间限制）
python3 scripts/update_video_play_counts.py --force
```

**配置参数**（在脚本中修改）：
- `BATCH_SIZE = 10` - 每批处理的视频数量
- `DELAY_BETWEEN_BATCHES = 3` - 批次之间的延迟（秒）
- `DELAY_BETWEEN_VIDEOS = 1` - 视频之间的延迟（秒）
- `MAX_RETRIES = 3` - 最大重试次数

**特点**：
- ✅ 分批处理：避免触发B站风控
- ✅ 进度保存：支持断点续传
- ✅ 错误重试：自动重试失败的视频
- ✅ 智能更新：只更新需要更新的视频

---

## 🚀 实施步骤

### 步骤1：诊断问题

```bash
# 诊断缺失统计数据的企业
python3 scripts/diagnose_missing_stats.py
```

### 步骤2：修复UP主统计数据

```bash
# 修复缺失的统计数据
python3 scripts/fix_missing_up_stats.py
```

### 步骤3：更新视频播放量

```bash
# 更新所有视频的播放量（稳妥方式）
python3 scripts/update_video_play_counts.py

# 或者只更新指定UP主的视频
python3 scripts/update_video_play_counts.py --uids 1172054289 521974986 22477177
```

### 步骤4：验证修复

```bash
# 检查统计数据
python3 scripts/check_bilibili_stats_fields.py
```

---

## 📊 数据更新策略

### UP主统计数据更新

**优先级**：
1. **upstat API** - 最准确，包含总播放量
2. **视频表计算** - 备选方案，从已有视频数据计算

**更新频率**：
- 每次抓取时自动更新
- 如果数据缺失，运行 `fix_missing_up_stats.py` 修复

### 视频播放量更新

**更新策略**：
- **增量更新**：只更新最近7天未更新的视频（默认）
- **分批处理**：每批10个视频，批次之间延迟3秒
- **错误重试**：失败自动重试，最多3次

**更新频率**：
- 建议每周运行一次 `update_video_play_counts.py`
- 可以添加到定时任务中

---

## 🔧 定时任务配置

### 添加到定时任务（可选）

```bash
# 编辑 crontab
crontab -e

# 添加以下行（每周日凌晨2点更新视频播放量）
0 2 * * 0 cd /srv/EmbodiedPulse2026 && source venv/bin/activate && python3 scripts/update_video_play_counts.py >> logs/video_update.log 2>&1
```

---

## ⚠️ 注意事项

1. **避免频繁请求**：
   - 批次之间至少延迟3秒
   - 视频之间至少延迟1秒
   - 避免在短时间内大量请求

2. **监控进度**：
   - 进度保存在 `video_update_progress.json`
   - 如果中断，可以从上次进度继续

3. **错误处理**：
   - 脚本会自动重试失败的视频
   - 如果某个视频一直失败，会跳过并继续

4. **数据备份**：
   - 更新前建议备份数据库
   - 可以使用 `scripts/backup_databases.sh`

---

## 📝 总结

**已创建的脚本**：
1. `scripts/diagnose_missing_stats.py` - 诊断统计数据缺失问题
2. `scripts/fix_missing_up_stats.py` - 修复缺失的UP主统计数据
3. `scripts/update_video_play_counts.py` - 稳妥更新视频播放量

**使用顺序**：
1. 先诊断问题
2. 修复UP主统计数据
3. 更新视频播放量
4. 验证修复结果

**特点**：
- ✅ 安全稳妥：分批处理、错误重试、进度保存
- ✅ 可重复执行：不会覆盖已有数据
- ✅ 灵活配置：支持指定UP主、强制更新等选项

