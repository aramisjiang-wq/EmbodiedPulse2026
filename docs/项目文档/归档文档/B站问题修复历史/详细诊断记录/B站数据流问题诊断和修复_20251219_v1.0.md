# B站数据流问题诊断和修复方案

## 问题描述

1. **前端页面显示老数据**：`https://essay.gradmotion.com/bilibili` 显示旧播放量
2. **管理端500错误**：`https://admin123.gradmotion.com/admin/bilibili` 视频列表报500错误

## 问题分析

### 1. 数据库配置问题

根据之前的检查：
- `.env`文件配置了PostgreSQL
- systemd服务配置了加载`.env`文件
- 但`bilibili_models.py`在模块级别直接读取环境变量，没有先加载`.env`文件
- 导致代码使用默认的SQLite而不是PostgreSQL

### 2. 500错误可能原因

`/api/admin/bilibili/videos`端点使用了`join`查询：
```python
query = session.query(BilibiliVideo, BilibiliUp).join(
    BilibiliUp, BilibiliVideo.uid == BilibiliUp.uid
)
```

如果：
- 数据库连接失败
- 表不存在
- 表结构不匹配
- `to_dict()`方法出错

都会导致500错误。

## 诊断步骤

### 步骤1：运行诊断脚本

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
./scripts/diagnose_bilibili_data_flow.sh
```

### 步骤2：检查服务日志

```bash
journalctl -u embodiedpulse -n 100 --no-pager | grep -i "error\|exception\|traceback\|bilibili"
```

### 步骤3：手动测试数据库连接

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo, BilibiliUp

try:
    session = get_bilibili_session()
    
    # 测试查询
    ups_count = session.query(BilibiliUp).count()
    videos_count = session.query(BilibiliVideo).count()
    
    print(f"✅ UP主数量: {ups_count}")
    print(f"✅ 视频数量: {videos_count}")
    
    # 测试join查询（模拟API逻辑）
    results = session.query(BilibiliVideo, BilibiliUp).join(
        BilibiliUp, BilibiliVideo.uid == BilibiliUp.uid
    ).limit(5).all()
    
    print(f"✅ Join查询成功，返回 {len(results)} 条记录")
    
    # 测试to_dict
    if results:
        video, up = results[0]
        video_dict = video.to_dict()
        print(f"✅ to_dict()成功")
        print(f"   play: {video_dict.get('play')}")
        print(f"   play_raw: {video_dict.get('play_raw')}")
    
    session.close()
except Exception as e:
    print(f"❌ 错误: {e}")
    import traceback
    traceback.print_exc()
PYEOF
```

## 修复方案

### 方案1：确保代码已更新并重启服务

```bash
cd /srv/EmbodiedPulse2026

# 1. 检查代码是否已更新
grep -q "from dotenv import load_dotenv" bilibili_models.py && echo "✅ 代码已更新" || echo "❌ 代码未更新"

# 2. 如果代码未更新，需要更新
# git pull 或手动复制文件

# 3. 重启服务
systemctl restart embodiedpulse
sleep 5

# 4. 验证
python3 << 'PYEOF'
from bilibili_models import BILIBILI_DATABASE_URL, get_bilibili_engine
engine = get_bilibili_engine()
print(f"使用的数据库: {engine.url}")
if 'postgres' in str(engine.url).lower():
    print("✅ 已切换到PostgreSQL")
else:
    print("❌ 仍在使用SQLite")
PYEOF
```

### 方案2：如果PostgreSQL表不存在，初始化表结构

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

python3 << 'PYEOF'
from bilibili_models import init_bilibili_db

try:
    init_bilibili_db()
    print("✅ 表结构初始化成功")
except Exception as e:
    print(f"❌ 初始化失败: {e}")
    import traceback
    traceback.print_exc()
PYEOF
```

### 方案3：更新PostgreSQL数据库中的播放量

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

# 更新所有视频的播放量
python3 scripts/update_video_play_counts.py --force

# 或者更新特定视频
python3 scripts/fetch_single_video.py BV1L8qEBKEFW --uid 1172054289
```

### 方案4：清除后端缓存

```bash
# 重启服务会清除内存缓存
systemctl restart embodiedpulse
```

## 完整修复流程

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate

# 1. 确保代码已更新
echo "【1. 检查代码】"
grep -q "from dotenv import load_dotenv" bilibili_models.py && echo "✅ 代码已更新" || {
    echo "❌ 代码未更新，需要先更新代码"
    exit 1
}

# 2. 验证数据库配置
echo ""
echo "【2. 验证数据库配置】"
python3 << 'PYEOF'
from bilibili_models import BILIBILI_DATABASE_URL, get_bilibili_engine
engine = get_bilibili_engine()
print(f"使用的数据库: {engine.url}")
if 'postgres' not in str(engine.url).lower():
    print("❌ 仍在使用SQLite，需要检查.env文件")
    exit(1)
PYEOF

# 3. 初始化表结构（如果需要）
echo ""
echo "【3. 初始化表结构】"
python3 << 'PYEOF'
from bilibili_models import init_bilibili_db
try:
    init_bilibili_db()
    print("✅ 表结构已就绪")
except Exception as e:
    print(f"⚠️  表结构初始化: {e}")
PYEOF

# 4. 测试数据库连接
echo ""
echo "【4. 测试数据库连接】"
python3 << 'PYEOF'
from bilibili_models import get_bilibili_session, BilibiliVideo, BilibiliUp

try:
    session = get_bilibili_session()
    ups_count = session.query(BilibiliUp).count()
    videos_count = session.query(BilibiliVideo).count()
    print(f"✅ 数据库连接成功")
    print(f"   UP主: {ups_count}, 视频: {videos_count}")
    
    # 测试join查询
    results = session.query(BilibiliVideo, BilibiliUp).join(
        BilibiliUp, BilibiliVideo.uid == BilibiliUp.uid
    ).limit(1).all()
    
    if results:
        video, up = results[0]
        video_dict = video.to_dict()
        print(f"✅ Join查询和to_dict()测试成功")
    session.close()
except Exception as e:
    print(f"❌ 数据库测试失败: {e}")
    import traceback
    traceback.print_exc()
    exit(1)
PYEOF

# 5. 重启服务
echo ""
echo "【5. 重启服务】"
systemctl restart embodiedpulse
sleep 5

if systemctl is-active --quiet embodiedpulse; then
    echo "✅ 服务重启成功"
else
    echo "❌ 服务启动失败"
    journalctl -u embodiedpulse -n 50 --no-pager
    exit 1
fi

# 6. 测试API端点
echo ""
echo "【6. 测试API端点】"
sleep 3

echo "测试 /api/bilibili/all:"
curl -s "http://localhost:5001/api/bilibili/all?force=1" | python3 -m json.tool | head -30

echo ""
echo "=========================================="
echo "✅ 修复完成！"
echo "=========================================="
```

## 验证

修复后验证：

1. **前端页面**：访问 `https://essay.gradmotion.com/bilibili`，检查播放量是否更新
2. **管理端页面**：访问 `https://admin123.gradmotion.com/admin/bilibili`，检查视频列表是否正常加载
3. **API端点**：直接测试API返回的数据

