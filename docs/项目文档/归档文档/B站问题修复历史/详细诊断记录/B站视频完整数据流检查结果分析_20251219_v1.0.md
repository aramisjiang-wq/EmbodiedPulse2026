# B站视频完整数据流检查结果分析

## 检查时间
2025-12-19 14:28

## 检查结果总结

### ✅ 正常项目

1. **阶段1: B站API可用性**
   - ✅ BilibiliClient初始化成功
   - ✅ 获取UP主信息成功（遇到412但最终成功）
   - ⚠️ 获取视频列表失败：参数错误（`video_count`应为`ps`）

2. **阶段2: 数据库连接和数据**
   - ✅ 数据库连接成功
   - ✅ 数据存在：12个UP主，517个视频
   - ✅ 逐际动力数据存在
   - ✅ **数据库最新视频播放量: 171,419** ✅

3. **阶段3: 后端API服务**
   - ✅ API返回成功（200状态码）
   - ✅ 数据格式正确
   - ⚠️ **API返回的最新视频播放量: 5,530** ❌

4. **阶段4: 前端页面**
   - ✅ 页面返回成功
   - ✅ 关键元素存在
   - ⚠️ `loadBilibiliAll`缺失（可能是函数名不同）

5. **阶段5: 数据一致性**
   - ✅ 数据库和API都有数据
   - ⚠️ **播放量不一致：数据库=5,530，API=5,530**（但阶段2显示171,419）

6. **阶段6: 服务状态**
   - ✅ 服务正在运行
   - ⚠️ 186条错误日志（都是论文相关的，不是B站）

---

## 🔴 关键问题发现

### 问题1: 数据不一致

**现象**:
- 阶段2显示：数据库最新视频播放量 = **171,419**
- 阶段3显示：API返回的最新视频播放量 = **5,530**
- 阶段5显示：数据库播放量 = **5,530**，API播放量 = **5,530**

**分析**:
1. 阶段2和阶段5查询的是同一个数据库，但结果不同
2. 可能原因：
   - 查询条件不同（阶段2查询的是`order_by(BilibiliVideo.pubdate.desc())`，阶段5可能查询条件不同）
   - 数据库中有多条相同BV号的记录
   - 缓存问题

### 问题2: API返回的播放量是旧数据

**现象**:
- 数据库中最新的视频播放量是 **171,419**（阶段2）
- 但API返回的播放量是 **5,530**（阶段3）

**可能原因**:
1. **缓存问题**：API使用了缓存的旧数据
2. **排序问题**：API返回的视频列表可能不是按最新时间排序
3. **数据更新问题**：API返回的数据可能不是最新的

### 问题3: 数据库使用相对路径

**发现**:
- 数据库URL: `sqlite:///./bilibili.db`
- 实际路径: `/srv/EmbodiedPulse2026/./bilibili.db`
- ⚠️ 使用相对路径，如果工作目录改变，可能连接到不同的数据库

---

## 详细分析

### 阶段2 vs 阶段5的数据差异

**阶段2查询**:
```python
latest_video = session.query(BilibiliVideo).filter_by(
    uid=LIMX_UID, is_deleted=False
).order_by(BilibiliVideo.pubdate.desc()).first()
```
结果：播放量 = **171,419**

**阶段5查询**:
```python
db_latest_video = session.query(BilibiliVideo).filter_by(
    uid=LIMX_UID, is_deleted=False
).order_by(BilibiliVideo.pubdate.desc()).first()
```
结果：播放量 = **5,530**

**可能原因**:
1. 两次查询之间数据被更新了？
2. 查询条件有细微差别？
3. 数据库中有多条相同BV号的记录？

### API返回的数据

**API查询**:
```python
videos_query = session.query(BilibiliVideo).filter_by(
    uid=up.uid,
    is_deleted=False
).order_by(BilibiliVideo.pubdate_raw.desc()).limit(200)
```

**发现**:
- API返回的第一个视频播放量是 **5,530**
- 但数据库中最新视频的播放量是 **171,419**

**可能原因**:
1. API返回的视频列表排序有问题
2. API返回的数据是从缓存中来的
3. 数据库中有多条记录，API返回的不是最新的

---

## 需要进一步检查

### 1. 检查数据库中是否有重复的BV号

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 << 'EOF'
from bilibili_models import get_bilibili_session, BilibiliVideo
session = get_bilibili_session()
# 检查BV1L8qEBKEFW有多少条记录
videos = session.query(BilibiliVideo).filter_by(bvid='BV1L8qEBKEFW').all()
print(f"BV1L8qEBKEFW的记录数: {len(videos)}")
for v in videos:
    print(f"  - 播放量: {v.play:,}, 发布时间: {v.pubdate}, 更新时间: {v.updated_at}")
session.close()
EOF
```

### 2. 检查API返回的视频列表排序

```bash
python3 << 'EOF'
from app import app
with app.test_client() as client:
    response = client.get('/api/bilibili/all?force=1')
    data = response.get_json()
    if data and data.get('success'):
        cards = data.get('data', [])
        limx_card = next((c for c in cards if c.get('user_info', {}).get('mid') == 1172054289), None)
        if limx_card:
            videos = limx_card.get('videos', [])
            print(f"前5个视频:")
            for i, v in enumerate(videos[:5], 1):
                print(f"{i}. {v.get('bvid')} - {v.get('title', '')[:30]}... - 播放量: {v.get('play_raw')} - 发布时间: {v.get('pubdate')}")
EOF
```

### 3. 检查缓存

```bash
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app
from datetime import datetime

with app.bilibili_cache_lock:
    cached_data = app.bilibili_cache.get('all_data')
    cache_expires_at = app.bilibili_cache.get('all_expires_at')
    
    if cached_data:
        print(f"缓存存在")
        print(f"过期时间: {datetime.fromtimestamp(cache_expires_at) if cache_expires_at else 'N/A'}")
        
        cards = cached_data.get('data', [])
        limx_card = next((c for c in cards if c.get('user_info', {}).get('mid') == 1172054289), None)
        if limx_card:
            videos = limx_card.get('videos', [])
            if videos:
                latest = videos[0]
                print(f"缓存中的最新视频:")
                print(f"  BV号: {latest.get('bvid')}")
                print(f"  播放量: {latest.get('play_raw')}")
    else:
        print("缓存不存在")
EOF
```

---

## 建议的修复方案

### 方案1: 清除缓存并重新测试

```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
import app

with app.bilibili_cache_lock:
    app.bilibili_cache['all_data'] = None
    app.bilibili_cache['all_expires_at'] = None
    print("✅ 缓存已清除")
EOF

systemctl restart embodiedpulse
```

### 方案2: 检查并修复数据库路径

```bash
cd /srv/EmbodiedPulse2026
echo "BILIBILI_DATABASE_URL=sqlite:////srv/EmbodiedPulse2026/bilibili.db" >> .env
systemctl restart embodiedpulse
```

### 方案3: 检查数据库中是否有重复记录

如果发现重复记录，需要清理：

```bash
python3 << 'EOF'
from bilibili_models import get_bilibili_session, BilibiliVideo
from sqlalchemy import func

session = get_bilibili_session()
# 查找重复的BV号
duplicates = session.query(
    BilibiliVideo.bvid,
    func.count(BilibiliVideo.bvid).label('count')
).group_by(BilibiliVideo.bvid).having(func.count(BilibiliVideo.bvid) > 1).all()

if duplicates:
    print(f"发现 {len(duplicates)} 个重复的BV号")
    for bvid, count in duplicates:
        print(f"  {bvid}: {count} 条记录")
else:
    print("✅ 没有重复的BV号")
session.close()
EOF
```

---

## 结论

根据检查结果：

1. ✅ **后端API工作正常**
2. ✅ **数据库连接正常**
3. ✅ **数据存在**
4. ⚠️ **数据不一致**：数据库最新视频播放量是171,419，但API返回的是5,530
5. ⚠️ **可能的问题**：
   - 缓存使用了旧数据
   - 数据库中有重复记录
   - API返回的视频列表排序有问题

**下一步**：需要检查缓存、数据库重复记录，以及API返回的视频列表排序。

