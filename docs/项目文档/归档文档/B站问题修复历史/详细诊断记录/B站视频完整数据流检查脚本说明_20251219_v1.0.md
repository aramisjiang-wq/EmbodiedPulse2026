# B站视频完整数据流检查脚本说明

## 脚本功能

`scripts/check_bilibili_full_pipeline.sh` 是一个完整的端到端检查脚本，检查B站视频数据的整个数据流：

```
B站API → 后端服务 → 数据库 → 后端服务 → 前端
```

## 检查阶段

### 阶段1: B站API可用性检查
- ✅ 测试B站API客户端初始化
- ✅ 测试从B站API获取UP主信息
- ✅ 测试从B站API获取视频列表
- ✅ 验证API响应数据格式

### 阶段2: 数据库连接和数据检查
- ✅ 检查数据库配置（URL、路径）
- ✅ 测试数据库连接
- ✅ 检查数据库中的数据统计
- ✅ 检查逐际动力的详细数据
- ✅ 检查最新视频信息

### 阶段3: 后端API服务检查
- ✅ 测试 `/api/bilibili/all` 端点
- ✅ 验证API响应格式
- ✅ 检查数据完整性
- ✅ 验证逐际动力数据在API中的表现

### 阶段4: 前端页面检查
- ✅ 测试 `/bilibili` 页面路由
- ✅ 检查页面关键元素
- ✅ 验证JavaScript函数存在
- ✅ 检查API调用代码

### 阶段5: 数据一致性检查
- ✅ 比较数据库和API返回的数据
- ✅ 验证UP主信息一致性
- ✅ 验证最新视频信息一致性
- ✅ 检查播放量等关键字段

### 阶段6: 服务状态检查
- ✅ 检查systemd服务运行状态
- ✅ 检查最近的错误日志
- ✅ 统计B站相关的请求

## 使用方法

### 在服务器上执行

```bash
cd /srv/EmbodiedPulse2026
bash scripts/check_bilibili_full_pipeline.sh
```

### 通过SSH远程执行

```bash
ssh root@your-server 'cd /srv/EmbodiedPulse2026 && bash scripts/check_bilibili_full_pipeline.sh'
```

## 输出说明

### 成功标记
- ✅ 表示检查通过
- 绿色显示

### 失败标记
- ❌ 表示检查失败
- 红色显示

### 警告标记
- ⚠️  表示需要关注的问题
- 黄色显示

## 检查结果解读

### 正常情况
所有阶段都应该显示 ✅，表示：
- B站API可以正常访问
- 数据库连接正常
- 后端API工作正常
- 前端页面可以正常访问
- 数据一致性良好

### 问题诊断

#### 如果阶段1失败
- **问题**: B站API无法访问
- **可能原因**: 
  - 网络问题
  - B站API限制
  - 认证信息错误
- **解决**: 检查网络连接和API配置

#### 如果阶段2失败
- **问题**: 数据库连接或数据问题
- **可能原因**:
  - 数据库文件不存在
  - 数据库路径错误
  - 数据未初始化
- **解决**: 检查数据库配置，运行数据初始化脚本

#### 如果阶段3失败
- **问题**: 后端API服务问题
- **可能原因**:
  - 代码错误
  - 依赖缺失
  - 服务未运行
- **解决**: 检查服务状态，查看错误日志

#### 如果阶段4失败
- **问题**: 前端页面问题
- **可能原因**:
  - 模板文件缺失
  - JavaScript错误
  - 路由配置问题
- **解决**: 检查模板文件和静态资源

#### 如果阶段5不一致
- **问题**: 数据不一致
- **可能原因**:
  - 缓存问题
  - 数据更新延迟
  - 数据处理逻辑错误
- **解决**: 清除缓存，检查数据处理逻辑

## 常见问题

### Q: 脚本执行很慢？
A: 正常，因为需要测试多个阶段，包括网络请求和数据库查询。

### Q: 某些检查显示警告？
A: 警告通常表示需要注意但不影响功能的问题，如使用相对路径的数据库。

### Q: 如何查看详细的错误信息？
A: 脚本会输出详细的错误信息和堆栈跟踪，查看输出即可。

## 定期检查建议

建议定期运行此脚本，特别是在：
- 部署新代码后
- 发现数据异常时
- 服务重启后
- 定期维护时

## 自动化检查

可以将此脚本添加到cron任务中，定期自动检查：

```bash
# 每天凌晨2点检查
0 2 * * * cd /srv/EmbodiedPulse2026 && bash scripts/check_bilibili_full_pipeline.sh >> /var/log/bilibili_check.log 2>&1
```

