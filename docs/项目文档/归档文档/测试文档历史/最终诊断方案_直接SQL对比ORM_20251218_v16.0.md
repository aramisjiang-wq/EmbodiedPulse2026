# 最终诊断方案：直接SQL对比ORM查询

**问题**: ORM查询返回0，但直接查询数据库有值

---

## 立即执行

在服务器上执行以下命令：

```bash
cd /srv/EmbodiedPulse2026

# 1. 拉取最新代码（包含直接SQL查询对比）
git pull origin main

# 2. 重启应用
sudo systemctl restart embodiedpulse
sleep 5

# 3. 调用API触发日志
curl 'http://localhost:5001/api/bilibili/all?force=1' > /dev/null 2>&1

# 4. 查看对比日志（应该看到"DEBUG_直接SQL查询"和"DEBUG_ORM查询"）
sudo journalctl -u embodiedpulse -n 100 --no-pager | grep "DEBUG.*逐际动力" | tail -10

# 5. 同时直接SQL查询检查（独立脚本）
venv/bin/python3 << 'EOF'
import sys
import os
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from dotenv import load_dotenv
load_dotenv()

from sqlalchemy import create_engine, text

bilibili_db_url = os.getenv('BILIBILI_DATABASE_URL', 'sqlite:///./bilibili.db')
print(f"数据库URL: {bilibili_db_url}")

engine = create_engine(bilibili_db_url)

with engine.connect() as conn:
    result = conn.execute(text("""
        SELECT uid, name, videos_count, views_count, views_formatted 
        FROM bilibili_ups 
        WHERE name = '逐际动力' AND is_active = true
    """))
    
    row = result.fetchone()
    if row:
        print(f"\n✅ 直接SQL查询结果:")
        print(f"  uid: {row[0]}")
        print(f"  name: {row[1]}")
        print(f"  videos_count: {row[2]} (type: {type(row[2]).__name__})")
        print(f"  views_count: {row[3]} (type: {type(row[3]).__name__})")
        print(f"  views_formatted: {row[4]!r}")
    else:
        print("❌ 未找到记录")
    
    # 同时用ORM查询对比
    print(f"\n" + "="*60)
    print("ORM查询对比:")
    print("="*60)
    
    from bilibili_models import get_bilibili_session, BilibiliUp
    session = get_bilibili_session()
    up = session.query(BilibiliUp).filter_by(name='逐际动力', is_active=True).first()
    
    if up:
        print(f"✅ ORM查询结果:")
        print(f"  uid: {up.uid}")
        print(f"  name: {up.name}")
        print(f"  videos_count: {up.videos_count} (type: {type(up.videos_count).__name__})")
        print(f"  views_count: {up.views_count} (type: {type(up.views_count).__name__})")
        print(f"  views_formatted: {up.views_formatted!r}")
        
        print(f"\n对比结果:")
        if row[2] != up.videos_count:
            print(f"  ⚠️ videos_count不匹配: SQL={row[2]}, ORM={up.videos_count}")
        else:
            print(f"  ✅ videos_count匹配: {row[2]}")
            
        if row[3] != up.views_count:
            print(f"  ⚠️ views_count不匹配: SQL={row[3]}, ORM={up.views_count}")
        else:
            print(f"  ✅ views_count匹配: {row[3]}")
    else:
        print("❌ ORM查询未找到记录")
    
    session.close()
EOF
```

---

## 如果直接SQL有值但ORM返回0

可能是：
1. SQLAlchemy映射问题
2. 字段名不匹配
3. 数据库连接不同

需要检查表结构是否一致。

---

**文档结束**

