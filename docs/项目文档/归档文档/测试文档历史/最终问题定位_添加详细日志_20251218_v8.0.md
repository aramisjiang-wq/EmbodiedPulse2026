# 最终问题定位 - 添加详细日志

**问题**: 代码正确，数据库有值，但API返回0

---

## 添加详细日志定位问题

在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026

# 在第1311行前添加详细日志
sed -i '1311i\                        logger.info(f"DEBUG_BEFORE: {up.name} - videos_count={up.videos_count}, views_count={up.views_count}, views_formatted={up.views_formatted!r}")' app.py

# 在第1315行后添加日志
sed -i '1316i\                        logger.info(f"DEBUG_AFTER: {up.name} - user_stat={{\"videos\": \"{format_number(up.videos_count) if up.videos_count else \"0\"}\", \"views\": \"{up.views_formatted or (format_number(up.views_count) if up.views_count else \"0\")}\"}}")' app.py

# 重启应用
sudo systemctl restart embodiedpulse
sleep 5

# 测试API并查看日志
curl 'http://localhost:5001/api/bilibili/all?force=1' > /dev/null 2>&1
sudo journalctl -u embodiedpulse -n 100 --no-pager | grep "DEBUG" | tail -20
```

---

## 或者直接测试代码逻辑

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from bilibili_models import get_bilibili_session, BilibiliUp, BilibiliVideo
from bilibili_client import format_number, format_timestamp

session = get_bilibili_session()
ups = session.query(BilibiliUp).filter_by(is_active=True).all()

print(f"完整模拟API流程 - 处理 {len(ups)} 个UP主\n")

for up in ups[:3]:
    try:
        # 完全模拟API代码
        videos_query = session.query(BilibiliVideo).filter_by(
            uid=up.uid,
            is_deleted=False
        ).order_by(BilibiliVideo.pubdate_raw.desc()).limit(200)
        videos = videos_query.all()
        
        formatted_videos = []
        for video in videos[:2]:
            formatted_videos.append({
                'bvid': video.bvid,
                'title': video.title or '',
                'play': video.play_formatted or '0',
            })
        
        # 构建user_stat（完全模拟第1311-1315行）
        print(f"处理 {up.name}:")
        print(f"  videos_count = {up.videos_count} (type: {type(up.videos_count)})")
        print(f"  views_count = {up.views_count} (type: {type(up.views_count)})")
        print(f"  views_formatted = {up.views_formatted!r} (type: {type(up.views_formatted)})")
        
        videos_val = format_number(up.videos_count) if up.videos_count else '0'
        views_val = up.views_formatted or (format_number(up.views_count) if up.views_count else '0')
        
        user_stat = {
            'videos': videos_val,
            'likes': up.likes_formatted or (format_number(up.likes_count) if up.likes_count else '0'),
            'views': views_val,
        }
        
        print(f"  结果: {user_stat}\n")
        
    except Exception as e:
        print(f"❌ {up.name}: 异常 - {e}")
        import traceback
        traceback.print_exc()
        print()

session.close()
EOF
```

---

**文档结束**

