# 最终问题诊断方案

**日期**: 2025-12-18  
**问题**: API返回user_stat全为0，但数据库有值，代码逻辑正确

---

## 完整检查步骤

### 步骤1：检查是否有异常被捕获

```bash
cd /srv/EmbodiedPulse2026
sudo journalctl -u embodiedpulse -n 500 --no-pager | grep -i "error\|exception\|失败" | grep -i "bilibili\|UP主" | tail -30
```

### 步骤2：清除所有缓存并测试

```bash
cd /srv/EmbodiedPulse2026

# 清除应用内存缓存
venv/bin/python3 << 'PYEOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
from app import bilibili_cache, bilibili_cache_lock
with bilibili_cache_lock:
    bilibili_cache.clear()
    print("✅ 缓存已清除")
PYEOF

# 重启应用
sudo systemctl restart embodiedpulse
sleep 5

# 测试API（使用force=1）
curl 'http://localhost:5001/api/bilibili/all?force=1' | python3 -m json.tool | grep -A 4 '"user_stat"' | head -20
```

### 步骤3：直接测试代码逻辑

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from bilibili_models import get_bilibili_session, BilibiliUp, BilibiliVideo
from bilibili_client import format_number, format_timestamp

session = get_bilibili_session()
ups = session.query(BilibiliUp).filter_by(is_active=True).all()

print(f"完整模拟API流程 - 处理 {len(ups)} 个UP主\n")

for up in ups[:3]:
    try:
        # 完全模拟API代码（第1273-1319行）
        videos_query = session.query(BilibiliVideo).filter_by(
            uid=up.uid,
            is_deleted=False
        ).order_by(BilibiliVideo.pubdate_raw.desc()).limit(200)
        videos = videos_query.all()
        
        formatted_videos = []
        for video in videos[:2]:
            formatted_videos.append({
                'bvid': video.bvid,
                'title': video.title or '',
                'play': video.play_formatted or '0',
            })
        
        # 构建user_stat（第1311-1315行）
        user_stat = {
            'videos': format_number(up.videos_count) if up.videos_count else '0',
            'likes': up.likes_formatted or (format_number(up.likes_count) if up.likes_count else '0'),
            'views': up.views_formatted or (format_number(up.views_count) if up.views_count else '0'),
        }
        
        print(f"✅ {up.name}:")
        print(f"   user_stat: {user_stat}")
        
    except Exception as e:
        print(f"❌ {up.name}: 异常 - {e}")
        import traceback
        traceback.print_exc()

session.close()
EOF
```

### 步骤4：检查服务器上的代码是否与GitHub一致

```bash
cd /srv/EmbodiedPulse2026

# 检查是否有未提交的修改
git status app.py

# 检查第1311-1315行
sed -n '1311,1315p' app.py

# 如果代码不对，从GitHub拉取
git checkout app.py
git pull origin main
```

---

**文档结束**

