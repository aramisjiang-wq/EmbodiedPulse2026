# 检查为什么API返回0

**问题**: 代码已更新，但API返回的user_stat.videos和user_stat.views仍然是0

---

## 立即检查

在服务器上执行以下命令：

```bash
cd /srv/EmbodiedPulse2026

# 1. 检查是否有异常被捕获
sudo journalctl -u embodiedpulse -n 200 --no-pager | grep -E "ERROR|Exception|Traceback|处理UP主.*数据失败" | tail -30

# 2. 直接模拟API代码，看实际值
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from bilibili_models import get_bilibili_session, BilibiliUp
from bilibili_client import format_number

session = get_bilibili_session()
up = session.query(BilibiliUp).filter_by(name='逐际动力', is_active=True).first()

if up:
    print(f"UP主: {up.name}")
    print(f"videos_count = {up.videos_count} (type: {type(up.videos_count).__name__})")
    print(f"views_count = {up.views_count} (type: {type(up.views_count).__name__})")
    print(f"views_formatted = {up.views_formatted!r} (type: {type(up.views_formatted).__name__})")
    
    # 模拟API代码
    videos_val = format_number(up.videos_count) if up.videos_count else '0'
    views_val = up.views_formatted or (format_number(up.views_count) if up.views_count else '0')
    
    print(f"\n计算结果:")
    print(f"videos_val = {videos_val!r}")
    print(f"views_val = {views_val!r}")
else:
    print("❌ 找不到UP主")

session.close()
EOF

# 3. 检查API实际返回的完整数据结构
curl 'http://localhost:5001/api/bilibili/all?force=1' 2>/dev/null | python3 -c "
import sys, json
data = json.load(sys.stdin)
if data.get('success') and data.get('data') and len(data['data']) > 0:
    card = data['data'][0]
    print('第一个UP主完整数据:')
    print(json.dumps(card, indent=2, ensure_ascii=False))
else:
    print('❌ 数据为空')
" | head -100
```

---

## 可能的原因

1. **异常被捕获**：代码执行时抛出异常，被try-except捕获，返回了空的user_stat
2. **数据库值确实是0**：虽然模拟代码显示有值，但实际查询时可能是0
3. **缓存问题**：API返回的是缓存中的旧数据

---

**文档结束**

