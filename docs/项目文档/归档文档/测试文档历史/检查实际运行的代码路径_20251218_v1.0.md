# 检查实际运行的代码路径

**问题**: API返回0，但代码逻辑正确

---

## 检查步骤

### 步骤1：检查是否有异常被捕获

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from bilibili_models import get_bilibili_session, BilibiliUp
from bilibili_client import format_number

session = get_bilibili_session()
ups = session.query(BilibiliUp).filter_by(is_active=True).all()

print(f"找到 {len(ups)} 个UP主\n")

for up in ups[:3]:  # 只检查前3个
    try:
        # 完全模拟API代码（第1311-1315行）
        user_stat = {
            'videos': format_number(up.videos_count) if up.videos_count else '0',
            'likes': up.likes_formatted or (format_number(up.likes_count) if up.likes_count else '0'),
            'views': up.views_formatted or (format_number(up.views_count) if up.views_count else '0'),
        }
        print(f"✅ {up.name}: {user_stat}")
    except Exception as e:
        print(f"❌ {up.name}: 异常 - {e}")
        import traceback
        traceback.print_exc()

session.close()
EOF
```

### 步骤2：检查应用日志

```bash
sudo journalctl -u embodiedpulse -n 100 --no-pager | grep -i "bilibili\|error\|exception" | tail -20
```

### 步骤3：直接测试API函数

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

# 模拟Flask请求
from flask import Flask
app = Flask(__name__)

# 导入app模块
import app as app_module

# 创建一个测试请求上下文
with app.test_request_context('/api/bilibili/all?force=1'):
    try:
        # 调用实际的API函数
        response = app_module.get_all_bilibili()
        data = response.get_json()
        
        if data and 'data' in data and len(data['data']) > 0:
            first_up = data['data'][0]
            print(f"第一个UP主: {first_up.get('user_info', {}).get('name', 'Unknown')}")
            print(f"user_stat: {first_up.get('user_stat', {})}")
        else:
            print("❌ 返回数据为空")
    except Exception as e:
        print(f"❌ 调用API失败: {e}")
        import traceback
        traceback.print_exc()
EOF
```

---

**文档结束**

