# 清除缓存并修复API返回0问题

**问题**: 代码逻辑正确，但API返回0，可能是缓存问题

---

## 立即修复步骤

### 步骤1：清除应用内存缓存

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from app import bilibili_cache, bilibili_cache_lock

print("清除缓存前:")
print(f"  all_data存在: {'all_data' in bilibili_cache}")
print(f"  all_expires_at: {bilibili_cache.get('all_expires_at')}")

# 清除缓存
with bilibili_cache_lock:
    bilibili_cache.clear()
    print("\n✅ 缓存已清除")

print("\n清除缓存后:")
print(f"  缓存大小: {len(bilibili_cache)}")
EOF
```

### 步骤2：重启应用

```bash
sudo systemctl restart embodiedpulse
sleep 5
```

### 步骤3：测试API（使用force=1）

```bash
curl 'http://localhost:5001/api/bilibili/all?force=1' | python3 -m json.tool | grep -A 4 '"user_stat"' | head -20
```

---

## 一键修复命令

```bash
cd /srv/EmbodiedPulse2026 && \
venv/bin/python3 << 'PYEOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
from app import bilibili_cache, bilibili_cache_lock
with bilibili_cache_lock:
    bilibili_cache.clear()
    print("✅ 缓存已清除")
PYEOF
sudo systemctl restart embodiedpulse && \
sleep 5 && \
echo "测试API..." && \
curl 'http://localhost:5001/api/bilibili/all?force=1' | python3 -m json.tool | grep -A 4 '"user_stat"' | head -20
```

---

**文档结束**

