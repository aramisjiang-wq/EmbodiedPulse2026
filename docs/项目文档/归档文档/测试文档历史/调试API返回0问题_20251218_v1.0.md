# 调试API返回0问题

**问题**: 重启后API还是返回0，但数据库有值

---

## 调试步骤

### 步骤1：检查实际运行时UP对象的值

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 << 'EOF'
from bilibili_models import get_bilibili_session, BilibiliUp
from bilibili_client import format_number

session = get_bilibili_session()
up = session.query(BilibiliUp).filter_by(is_active=True).first()

if up:
    print(f"UP主: {up.name}")
    print(f"videos_count: {up.videos_count} (type: {type(up.videos_count)})")
    print(f"views_count: {up.views_count} (type: {type(up.views_count)})")
    print(f"views_formatted: {up.views_formatted!r} (type: {type(up.views_formatted)})")
    print(f"likes_count: {up.likes_count} (type: {type(up.likes_count)})")
    print(f"likes_formatted: {up.likes_formatted!r} (type: {type(up.likes_formatted)})")
    
    print("\n模拟API逻辑:")
    videos = format_number(up.videos_count) if up.videos_count else '0'
    print(f"  videos = format_number({up.videos_count}) if {up.videos_count} else '0'")
    print(f"  videos = {videos}")
    
    views = up.views_formatted or (format_number(up.views_count) if up.views_count else '0')
    print(f"  views = {up.views_formatted!r} or (format_number({up.views_count}) if {up.views_count} else '0')")
    print(f"  views = {views}")
    
    likes = up.likes_formatted or (format_number(up.likes_count) if up.likes_count else '0')
    print(f"  likes = {up.likes_formatted!r} or (format_number({up.likes_count}) if {up.likes_count} else '0')")
    print(f"  likes = {likes}")

session.close()
EOF
```

### 步骤2：检查format_number函数

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 << 'EOF'
from bilibili_client import format_number

# 测试format_number
print("测试format_number:")
print(f"  format_number(49) = {format_number(49)}")
print(f"  format_number(3307108) = {format_number(3307108)}")
print(f"  format_number(0) = {format_number(0)}")
print(f"  format_number(None) = {format_number(None) if hasattr(format_number, '__call__') else 'ERROR'}")

# 测试逻辑
videos_count = 49
views_count = 3307108
views_formatted = '330.7万'

videos = format_number(videos_count) if videos_count else '0'
views = views_formatted or (format_number(views_count) if views_count else '0')

print(f"\n测试逻辑:")
print(f"  videos = {videos}")
print(f"  views = {views}")
EOF
```

### 步骤3：直接测试API函数

```bash
cd /srv/EmbodiedPulse2026
venv/bin/python3 << 'EOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from app import app
from bilibili_models import get_bilibili_session, BilibiliUp
from bilibili_client import format_number

# 模拟API逻辑
session = get_bilibili_session()
up = session.query(BilibiliUp).filter_by(is_active=True).first()

if up:
    print(f"UP主: {up.name}")
    
    # 完全模拟API代码
    card_data = {
        'user_stat': {
            'videos': format_number(up.videos_count) if up.videos_count else '0',
            'likes': up.likes_formatted or (format_number(up.likes_count) if up.likes_count else '0'),
            'views': up.views_formatted or (format_number(up.views_count) if up.views_count else '0'),
        },
    }
    
    print(f"\nAPI返回的user_stat:")
    print(f"  {card_data['user_stat']}")

session.close()
EOF
```

---

**文档结束**

