# 修复服务器502错误

## 问题诊断

502错误通常表示：
- Docker容器未运行
- 容器启动失败
- 服务崩溃
- 代码未同步或部署失败

## 快速修复方案

### 方法一：在服务器上运行修复脚本

1. **SSH连接到服务器**：
```bash
ssh root@115.190.77.57
# 密码: ash@2025
```

2. **运行修复脚本**：
```bash
# 创建并运行修复脚本
cat > /tmp/fix_502.sh << 'EOF'
#!/bin/bash
set -e
PROJECT_DIR="/opt/EmbodiedPulse"
cd ${PROJECT_DIR} || { mkdir -p ${PROJECT_DIR} && cd ${PROJECT_DIR} && git clone https://github.com/aramisjiang-wq/EmbodiedPulse2026.git .; }

echo "更新代码..."
git fetch origin main
git reset --hard origin/main
git clean -fd

echo "停止旧容器..."
docker-compose down || true

echo "构建并启动..."
docker-compose up -d --build

echo "等待服务启动..."
sleep 30

echo "检查状态..."
docker-compose ps
docker-compose logs --tail=20 web
EOF

chmod +x /tmp/fix_502.sh
bash /tmp/fix_502.sh
```

### 方法二：手动修复步骤

在服务器上依次执行：

```bash
ssh root@115.190.77.57
cd /opt/EmbodiedPulse

# 1. 更新代码
git fetch origin main
git pull origin main

# 2. 停止所有容器
docker-compose down

# 3. 查看错误日志
docker-compose logs web

# 4. 重新构建并启动
docker-compose up -d --build

# 5. 等待启动
sleep 30

# 6. 检查状态
docker-compose ps

# 7. 查看日志
docker-compose logs --tail=50 web
```

### 方法三：完全重建

如果上述方法不行，完全重建：

```bash
ssh root@115.190.77.57
cd /opt/EmbodiedPulse

# 1. 停止并删除所有容器和镜像
docker-compose down -v
docker rmi embodied-pulse-web 2>/dev/null || true

# 2. 更新代码
git fetch origin main
git reset --hard origin/main

# 3. 重新构建
docker-compose build --no-cache

# 4. 启动服务
docker-compose up -d

# 5. 等待并检查
sleep 30
docker-compose ps
docker-compose logs web
```

## 常见问题排查

### 1. 检查容器是否运行

```bash
docker-compose ps
```

如果容器状态不是"Up"，说明容器未正常运行。

### 2. 查看容器日志

```bash
docker-compose logs web
```

查看错误信息，常见错误：
- 数据库连接失败
- 端口被占用
- 依赖安装失败
- 模板文件找不到

### 3. 检查端口占用

```bash
lsof -i:5001
netstat -tulpn | grep 5001
```

### 4. 检查Docker服务

```bash
systemctl status docker
docker ps -a
```

### 5. 检查防火墙

```bash
# CentOS/RHEL
firewall-cmd --list-ports
firewall-cmd --permanent --add-port=5001/tcp
firewall-cmd --reload

# Ubuntu/Debian
ufw status
ufw allow 5001/tcp
ufw reload
```

## 验证修复

修复后，访问：http://115.190.77.57:5001

应该能看到：
- ✅ 页面正常加载
- ✅ 没有502错误
- ✅ 功能正常（岗位机会挂件已隐藏）

## 如果还是502

1. **查看完整日志**：
   ```bash
   docker-compose logs web > /tmp/web.log 2>&1
   cat /tmp/web.log
   ```

2. **检查数据库连接**：
   ```bash
   docker-compose exec web python3 -c "from models import get_session; s = get_session(); print('数据库连接成功')"
   ```

3. **重启Docker服务**：
   ```bash
   systemctl restart docker
   docker-compose up -d
   ```

