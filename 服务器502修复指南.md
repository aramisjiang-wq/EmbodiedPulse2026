# 服务器502错误修复指南

## 🚨 当前问题

服务器返回 **HTTP 502错误**，检查发现：
- `/opt/EmbodiedPulse` 目录不是Git仓库
- 项目代码可能不完整
- 服务未正常运行

## 🔧 快速修复（在服务器上执行）

### 方法一：使用初始化脚本（推荐）

```bash
ssh root@115.190.77.57
# 密码: ash@2025

# 下载并执行初始化脚本
cd /tmp
cat > init_deploy.sh << 'SCRIPT_END'
#!/bin/bash
set -e
PROJECT_DIR="/opt/EmbodiedPulse"
REPO_URL="https://github.com/aramisjiang-wq/EmbodiedPulse2026.git"

# 安装Git（如果没有）
if ! command -v git &> /dev/null; then
    apt update && apt install -y git
fi

# 安装Docker（如果没有）
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com -o get-docker.sh && sh get-docker.sh && systemctl start docker && systemctl enable docker && rm get-docker.sh
fi

# 安装Docker Compose（如果没有）
if ! command -v docker-compose &> /dev/null; then
    curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose
fi

# 准备项目目录
if [ -d "${PROJECT_DIR}" ]; then
    cd ${PROJECT_DIR}
    if [ ! -d ".git" ]; then
        echo "不是Git仓库，重新克隆..."
        cd /opt
        rm -rf EmbodiedPulse
        git clone ${REPO_URL} EmbodiedPulse
        cd EmbodiedPulse
    else
        echo "更新代码..."
        git fetch origin main
        git reset --hard origin/main
        git clean -fd
    fi
else
    echo "克隆项目..."
    mkdir -p /opt
    cd /opt
    git clone ${REPO_URL} EmbodiedPulse
    cd EmbodiedPulse
fi

# 停止旧容器
docker-compose down -v 2>/dev/null || true

# 构建并启动
docker-compose build --no-cache
docker-compose up -d

# 等待启动
sleep 60

# 检查状态
docker-compose ps
docker-compose logs --tail=30 web
curl -I http://localhost:5001
SCRIPT_END

chmod +x init_deploy.sh
bash init_deploy.sh
```

### 方法二：手动修复步骤

```bash
ssh root@115.190.77.57

# 1. 安装Git（如果没有）
apt update && apt install -y git

# 2. 安装Docker（如果没有）
curl -fsSL https://get.docker.com -o get-docker.sh && sh get-docker.sh && systemctl start docker && systemctl enable docker && rm get-docker.sh

# 3. 安装Docker Compose（如果没有）
curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose

# 4. 重新克隆项目
cd /opt
rm -rf EmbodiedPulse
git clone https://github.com/aramisjiang-wq/EmbodiedPulse2026.git EmbodiedPulse
cd EmbodiedPulse

# 5. 停止旧容器
docker-compose down -v 2>/dev/null || true
docker ps -a | grep -E "embodied|pulse" | awk '{print $1}' | xargs docker rm -f 2>/dev/null || true

# 6. 构建并启动
docker-compose build --no-cache
docker-compose up -d

# 7. 等待启动
sleep 60

# 8. 检查状态
docker-compose ps
docker-compose logs web
curl -I http://localhost:5001
```

## 🔍 验证修复

修复后验证：

```bash
# 1. 检查容器状态
docker-compose ps
# 应该看到两个容器都在运行（postgres和web）

# 2. 测试HTTP连接
curl -I http://localhost:5001
# 应该返回 HTTP/1.1 200 OK

# 3. 查看日志
docker-compose logs --tail=50 web
# 应该没有严重错误

# 4. 访问网站
# 浏览器访问: http://115.190.77.57:5001
```

## 🆘 如果还是502

### 检查容器日志
```bash
docker-compose logs web
```

### 检查数据库连接
```bash
docker-compose logs postgres
docker-compose exec web python3 -c "from models import get_session; s = get_session(); print('数据库连接成功')"
```

### 完全重建
```bash
cd /opt/EmbodiedPulse
docker-compose down -v
docker rmi embodied-pulse-web 2>/dev/null || true
docker-compose build --no-cache
docker-compose up -d
sleep 60
docker-compose ps
```

## 📝 注意事项

1. **首次部署**：如果服务器上还没有项目，脚本会自动克隆
2. **代码更新**：如果项目已存在，脚本会更新到最新代码
3. **数据持久化**：PostgreSQL数据会保存在Docker卷中，不会丢失
4. **服务中断**：部署过程中服务会短暂中断（约1-2分钟）

