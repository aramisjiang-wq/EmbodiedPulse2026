# 服务器502错误修复步骤

## 快速诊断

在服务器上执行以下命令：

```bash
cd /srv/EmbodiedPulse2026

# 1. 检查服务状态
systemctl status embodiedpulse --no-pager -l | head -30

# 2. 查看最近的错误日志
journalctl -u embodiedpulse --since "5 minutes ago" --no-pager | tail -50

# 3. 检查应用日志
tail -50 app.log | grep -i "error\|exception\|traceback" | tail -20
```

## 可能的原因和修复

### 原因1: 代码语法错误

如果看到 `SyntaxError` 或 `IndentationError`：

```bash
# 检查语法
python3 -m py_compile bilibili_models.py
python3 -m py_compile auth_routes.py
```

### 原因2: 模块导入失败

如果看到 `ImportError` 或 `NameError`：

```bash
# 测试导入
python3 << 'PYEOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

try:
    from bilibili_models import get_bilibili_session, BilibiliUp, BilibiliVideo
    print("✅ bilibili_models 导入成功")
except Exception as e:
    print(f"❌ 错误: {e}")
    import traceback
    traceback.print_exc()
PYEOF
```

### 原因3: 代码未更新

如果 `bilibili_models.py` 还是旧代码：

```bash
# 强制拉取最新代码
git fetch origin
git reset --hard origin/main

# 或者手动修复（见下面的手动修复步骤）
```

## 手动修复步骤

如果git pull不工作，手动修复 `bilibili_models.py`：

```bash
cd /srv/EmbodiedPulse2026

# 1. 备份
cp bilibili_models.py bilibili_models.py.backup

# 2. 检查当前代码
grep -n "def to_dict" bilibili_models.py

# 3. 使用sed修复（如果第158行是简单的import）
# 找到 BilibiliVideo.to_dict 方法（大约第166行）
# 将：
#     from bilibili_client import format_number
# 替换为：
#     try:
#         from bilibili_client import format_number
#     except ImportError:
#         def format_number(num: int) -> str:
#             if num >= 100000000:
#                 return f"{num / 100000000:.1f}亿"
#             elif num >= 10000:
#                 return f"{num / 10000:.1f}万"
#             else:
#                 return str(num)
```

## 使用Python脚本自动修复

```bash
cd /srv/EmbodiedPulse2026

python3 << 'PYEOF'
import re

# 读取文件
with open('bilibili_models.py', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# 查找需要修复的位置
new_lines = []
i = 0
while i < len(lines):
    line = lines[i]
    new_lines.append(line)
    
    # 如果找到 to_dict 方法中的简单 import
    if 'def to_dict(self):' in line:
        # 跳过文档字符串和注释
        i += 1
        while i < len(lines) and ('"""' in lines[i] or '#' in lines[i] or lines[i].strip() == ''):
            new_lines.append(lines[i])
            i += 1
        
        # 如果下一行是简单的 import
        if i < len(lines) and 'from bilibili_client import format_number' in lines[i] and 'try:' not in lines[i-5:i]:
            # 替换为带异常处理的版本
            new_lines.append('        try:\n')
            new_lines.append('            from bilibili_client import format_number\n')
            new_lines.append('        except ImportError:\n')
            new_lines.append('            # 如果导入失败，定义本地format_number函数\n')
            new_lines.append('            def format_number(num: int) -> str:\n')
            new_lines.append('                """格式化数字（万、亿）"""\n')
            new_lines.append('                if num >= 100000000:\n')
            new_lines.append('                    return f"{num / 100000000:.1f}亿"\n')
            new_lines.append('                elif num >= 10000:\n')
            new_lines.append('                    return f"{num / 10000:.1f}万"\n')
            new_lines.append('                else:\n')
            new_lines.append('                    return str(num)\n')
            new_lines.append('        \n')
            i += 1  # 跳过原来的import行
            continue
    
    i += 1

# 写回文件
with open('bilibili_models.py', 'w', encoding='utf-8') as f:
    f.writelines(new_lines)

print("✅ 修复完成")
PYEOF

# 验证
python3 -m py_compile bilibili_models.py && echo "✅ 语法正确" || echo "❌ 语法错误"

# 重启服务
systemctl restart embodiedpulse
sleep 5
systemctl status embodiedpulse --no-pager -l | head -20
```

## 完整诊断脚本

我已经创建了诊断脚本，在服务器上执行：

```bash
cd /srv/EmbodiedPulse2026
bash scripts/fix_502_error.sh
```

或者直接复制脚本内容到服务器执行。

## 如果还是502

1. **检查Gunicorn进程**:
```bash
ps aux | grep gunicorn
```

2. **检查端口占用**:
```bash
netstat -tlnp | grep 5001
```

3. **手动启动测试**:
```bash
cd /srv/EmbodiedPulse2026
source venv/bin/activate
python3 -c "from app import app; print('App loaded successfully')"
```

4. **查看完整错误**:
```bash
journalctl -u embodiedpulse -n 100 --no-pager
```

