# 服务器更新步骤

服务器上 `git pull` 显示 "Already up to date"，但代码仍然报错，说明代码没有真正更新。

## 问题诊断

在服务器上执行以下命令检查：

```bash
cd /srv/EmbodiedPulse2026

# 1. 检查git状态
git status
git log --oneline -5

# 2. 检查远程仓库配置
git remote -v

# 3. 强制拉取最新代码
git fetch origin
git reset --hard origin/main

# 4. 验证代码是否更新
grep -A 10 "def to_dict(self):" bilibili_models.py | head -15
```

## 手动更新方法（如果git pull不工作）

如果git pull不工作，可以手动更新文件：

### 方法1: 直接编辑文件

```bash
cd /srv/EmbodiedPulse2026
nano bilibili_models.py
```

找到 `BilibiliVideo` 类的 `to_dict` 方法（大约第155行），修改为：

```python
def to_dict(self):
    """转换为字典"""
    # 导入format_number函数（延迟导入避免循环依赖）
    try:
        from bilibili_client import format_number
    except ImportError:
        # 如果导入失败，定义本地format_number函数
        def format_number(num: int) -> str:
            """格式化数字（万、亿）"""
            if num >= 100000000:
                return f"{num / 100000000:.1f}亿"
            elif num >= 10000:
                return f"{num / 10000:.1f}万"
            else:
                return str(num)
    
    return {
        'bvid': self.bvid,
        'aid': self.aid,
        'title': self.title or '',
        'pic': self.pic or '',
        'description': self.description or '',
        'length': self.length or '',
        # 修复：实时格式化play字段，不依赖可能过时的play_formatted
        'play': format_number(self.play) if self.play else '0',
        'play_raw': self.play,
        'video_review': self.video_review_formatted or '0',
        'favorites': self.favorites_formatted or '0',
        'pubdate': self.pubdate.strftime('%Y-%m-%d %H:%M:%S') if self.pubdate else '',
        'pubdate_raw': self.pubdate_raw,
        'url': self.url or f"https://www.bilibili.com/video/{self.bvid}",
    }
```

同样修改 `BilibiliUp` 类的 `to_dict` 方法（大约第58行）。

### 方法2: 使用sed命令快速修复

```bash
cd /srv/EmbodiedPulse2026

# 备份原文件
cp bilibili_models.py bilibili_models.py.backup

# 检查当前代码
grep -n "from bilibili_client import format_number" bilibili_models.py
```

如果看到第158行和第61行只有简单的 `from bilibili_client import format_number`，说明代码确实没有更新。

## 推荐操作步骤

```bash
cd /srv/EmbodiedPulse2026

# 1. 检查git远程仓库
git remote -v

# 2. 如果远程仓库正确，强制拉取
git fetch origin
git reset --hard origin/main

# 3. 如果还是不行，检查当前commit
git log --oneline -1
# 应该看到最新的commit: 3827cfca 修复B站数据问题

# 4. 如果commit不对，手动重置
git fetch origin
git reset --hard origin/main

# 5. 验证修复
grep -A 5 "try:" bilibili_models.py | grep -A 5 "from bilibili_client import format_number"
# 应该看到 try/except 结构

# 6. 重启服务
systemctl restart embodiedpulse

# 7. 测试
python3 << 'PYEOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')
from bilibili_models import get_bilibili_session, BilibiliVideo, BilibiliUp

session = get_bilibili_session()
try:
    video = session.query(BilibiliVideo).first()
    if video:
        video_dict = video.to_dict()
        print(f"✅ to_dict成功: {video_dict.get('title', '')[:30]}")
    else:
        print("⚠️  没有视频数据")
except Exception as e:
    print(f"❌ 错误: {e}")
    import traceback
    traceback.print_exc()
finally:
    session.close()
PYEOF
```

