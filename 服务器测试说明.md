# 服务器端测试说明

## 问题
我之前只在本地测试了代码逻辑，没有在服务器上实际测试。服务器环境可能不同（数据库类型、数据内容、环境变量等）。

## 服务器端测试步骤

### 方法1: 使用SSH登录服务器执行测试脚本

1. **上传测试脚本到服务器**:
```bash
# 在本地执行
scp scripts/test_server_bilibili.sh user@server:/srv/EmbodiedPulse2026/scripts/
```

2. **SSH登录服务器**:
```bash
ssh user@server
cd /srv/EmbodiedPulse2026
```

3. **执行测试脚本**:
```bash
bash scripts/test_server_bilibili.sh
```

### 方法2: 直接在服务器上创建并执行测试脚本

1. **SSH登录服务器**
2. **创建测试脚本**:
```bash
cd /srv/EmbodiedPulse2026
nano scripts/test_server_bilibili.sh
# 复制脚本内容
```

3. **执行测试**:
```bash
chmod +x scripts/test_server_bilibili.sh
bash scripts/test_server_bilibili.sh
```

### 方法3: 使用Python直接测试（如果无法执行shell脚本）

SSH登录服务器后，直接执行Python代码：

```python
# 在服务器上执行
cd /srv/EmbodiedPulse2026
source venv/bin/activate  # 如果使用虚拟环境

python3 << 'PYEOF'
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

# 测试数据库连接
from bilibili_models import get_bilibili_session, BilibiliUp, BilibiliVideo

session = get_bilibili_session()
try:
    up_count = session.query(BilibiliUp).count()
    video_count = session.query(BilibiliVideo).count()
    print(f"UP主: {up_count}, 视频: {video_count}")
    
    # 测试管理后台查询
    from sqlalchemy import join
    query = session.query(BilibiliVideo, BilibiliUp).join(
        BilibiliUp, BilibiliVideo.uid == BilibiliUp.uid
    ).order_by(BilibiliVideo.pubdate.desc())
    
    total = query.count()
    print(f"管理后台查询总数: {total}")
    
    results = query.limit(5).all()
    print(f"成功获取 {len(results)} 条记录")
    
except Exception as e:
    print(f"错误: {e}")
    import traceback
    traceback.print_exc()
finally:
    session.close()
PYEOF
```

## 需要检查的关键信息

1. **数据库类型**: SQLite还是PostgreSQL？
   ```python
   from bilibili_models import BILIBILI_DATABASE_URL
   print(BILIBILI_DATABASE_URL)
   ```

2. **实际错误信息**: 查看服务器日志
   ```bash
   # 查看应用日志
   tail -100 app.log | grep -i error
   
   # 查看systemd日志
   journalctl -u embodiedpulse --since "24 hours ago" | grep -i error
   ```

3. **管理后台API实际错误**: 
   - 在浏览器开发者工具中查看Network标签
   - 查看实际返回的错误信息

4. **定时任务状态**:
   ```bash
   systemctl status embodiedpulse
   # 或检查APScheduler是否运行
   ```

## 测试脚本功能

测试脚本会检查：
1. ✅ 数据库连接
2. ✅ 数据完整性（孤立视频、NULL值）
3. ✅ 管理后台查询逻辑（两种排序方式）
4. ✅ 实际API端点
5. ✅ 数据新鲜度
6. ✅ 定时任务状态
7. ✅ 错误日志

## 下一步

执行测试后，请提供：
1. 测试脚本的完整输出
2. 服务器日志中的错误信息
3. 浏览器开发者工具中的API错误详情

这样我才能准确定位问题并修复。

