# 服务器状态检查方法

## 🔍 如何检查服务器状态

### 1. 检查容器是否运行

在服务器上执行：

```bash
ssh root@115.190.77.57
cd /opt/EmbodiedPulse
docker-compose ps
```

**正常输出示例**：
```
NAME                      IMAGE                    COMMAND                  SERVICE    CREATED        STATUS          PORTS
embodied-pulse-postgres   postgres:15-alpine       "docker-entrypoint.s…"   postgres   2 minutes ago   Up 2 minutes    0.0.0.0:5432->5432/tcp
embodied-pulse-web        embodied-pulse-web       "python3 app.py"         web        2 minutes ago   Up 2 minutes    0.0.0.0:5001->5001/tcp
```

**检查要点**：
- ✅ 应该看到两个容器：`embodied-pulse-postgres` 和 `embodied-pulse-web`
- ✅ 状态（STATUS）应该显示 `Up` 或 `Up X minutes`
- ❌ 如果看到 `Exited` 或 `Restarting`，说明容器有问题

### 2. 检查HTTP状态码

在服务器上执行：

```bash
curl -I http://localhost:5001
```

**正常输出示例**：
```
HTTP/1.1 200 OK
Server: Werkzeug/3.1.3 Python/3.9.6
Date: Thu, 12 Dec 2025 14:30:00 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 12345
```

**检查要点**：
- ✅ 第一行应该显示 `HTTP/1.1 200 OK`
- ❌ 如果显示 `502 Bad Gateway` 或其他错误码，说明服务有问题

**或者使用更简单的命令**：
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:5001
```
这个命令只输出状态码，应该显示 `200`

### 3. 检查日志是否有严重错误

在服务器上执行：

```bash
cd /opt/EmbodiedPulse
docker-compose logs --tail=50 web
```

**正常日志示例**：
```
web_1  | [INFO] Flask应用初始化 - 文件路径: /app/app.py
web_1  | [INFO] 模板目录存在: True
web_1  | [INFO]  * Running on all addresses (0.0.0.0)
web_1  | [INFO]  * Running on http://127.0.0.1:5001
web_1  | 127.0.0.1 - - [12/Dec/2025 14:30:00] "GET / HTTP/1.1" 200 -
```

**检查要点**：
- ✅ 应该看到 `Running on http://127.0.0.1:5001`
- ✅ 应该看到 `200` 状态码的请求记录
- ❌ 如果看到 `ERROR`、`Exception`、`Traceback`，说明有错误
- ❌ 如果看到 `TemplateNotFound`、`Connection refused`，说明有问题

**查看PostgreSQL日志**：
```bash
docker-compose logs --tail=30 postgres
```

### 4. 完整检查命令（一键执行）

在服务器上执行以下命令，一次性检查所有状态：

```bash
ssh root@115.190.77.57
cd /opt/EmbodiedPulse

echo "=========================================="
echo "1. 容器状态检查"
echo "=========================================="
docker-compose ps

echo ""
echo "=========================================="
echo "2. HTTP状态码检查"
echo "=========================================="
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001)
echo "HTTP状态码: $HTTP_CODE"
if [ "$HTTP_CODE" = "200" ]; then
    echo "✅ 服务正常"
else
    echo "❌ 服务异常"
fi

echo ""
echo "=========================================="
echo "3. Web容器日志（最后30行）"
echo "=========================================="
docker-compose logs --tail=30 web

echo ""
echo "=========================================="
echo "4. PostgreSQL容器日志（最后20行）"
echo "=========================================="
docker-compose logs --tail=20 postgres

echo ""
echo "=========================================="
echo "5. 容器资源使用情况"
echo "=========================================="
docker stats --no-stream
```

## 🌐 从本地浏览器检查

### 方法1：直接访问
在浏览器中打开：
```
http://115.190.77.57:5001
```

**正常情况**：
- ✅ 页面正常加载
- ✅ 显示论文列表
- ✅ 没有502错误

**异常情况**：
- ❌ 显示 "502 Bad Gateway"
- ❌ 显示 "无法访问此网站"
- ❌ 页面一直加载中

### 方法2：使用开发者工具
1. 打开浏览器开发者工具（F12）
2. 访问 http://115.190.77.57:5001
3. 查看 Network 标签
4. 检查请求状态码

**正常情况**：
- ✅ 状态码显示 `200`
- ✅ 响应时间正常（< 2秒）

**异常情况**：
- ❌ 状态码显示 `502`、`503`、`504`
- ❌ 请求失败（Failed）

## 📊 快速诊断命令

### 检查容器健康状态
```bash
docker-compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
```

### 检查服务响应时间
```bash
time curl -s http://localhost:5001 > /dev/null
```

### 检查数据库连接
```bash
docker-compose exec web python3 -c "from models import get_session; s = get_session(); print('✅ 数据库连接成功')"
```

### 检查端口占用
```bash
netstat -tulpn | grep 5001
lsof -i:5001
```

## 🆘 常见问题判断

### 问题1：容器未运行
**现象**：`docker-compose ps` 显示容器状态为 `Exited`
**解决**：
```bash
docker-compose up -d
docker-compose ps
```

### 问题2：HTTP 502错误
**现象**：`curl -I http://localhost:5001` 返回 `502`
**检查**：
```bash
docker-compose logs web | grep -i error
docker-compose ps
```

### 问题3：服务启动失败
**现象**：日志中有 `ERROR` 或 `Exception`
**检查**：
```bash
docker-compose logs web | tail -100
```

## ✅ 健康检查清单

执行以下检查，全部通过说明服务正常：

- [ ] `docker-compose ps` 显示两个容器都在运行（状态为 `Up`）
- [ ] `curl -I http://localhost:5001` 返回 `HTTP/1.1 200 OK`
- [ ] `docker-compose logs web` 中没有 `ERROR` 或 `Exception`
- [ ] 浏览器访问 http://115.190.77.57:5001 能正常显示页面
- [ ] 页面功能正常（能显示论文列表、搜索等）

---

**提示**：如果所有检查都通过，但浏览器还是无法访问，可能是防火墙问题，需要检查服务器防火墙设置。

