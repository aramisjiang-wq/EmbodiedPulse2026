# 服务器诊断方法（无需SSH上传）

由于SSH连接问题，提供以下替代方案：

## 方法1: 直接在服务器上创建测试脚本（推荐）

SSH登录服务器后，直接创建并执行：

```bash
# 1. SSH登录服务器（使用正确的地址和用户名）
ssh root@essay.gradmotion.com
# 或
ssh your-user@essay.gradmotion.com

# 2. 进入项目目录
cd /srv/EmbodiedPulse2026

# 3. 创建测试脚本
cat > test_bilibili_diagnosis.py << 'PYEOF'
#!/usr/bin/env python3
import sys
sys.path.insert(0, '/srv/EmbodiedPulse2026')

from bilibili_models import get_bilibili_session, BilibiliUp, BilibiliVideo
from sqlalchemy import func

print("=" * 60)
print("B站数据诊断")
print("=" * 60)

# 1. 测试数据库连接
session = get_bilibili_session()
try:
    up_count = session.query(BilibiliUp).count()
    video_count = session.query(BilibiliVideo).count()
    print(f"\n✅ 数据库连接成功")
    print(f"   UP主: {up_count}, 视频: {video_count}")
except Exception as e:
    print(f"❌ 数据库连接失败: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

# 2. 测试管理后台查询
print("\n测试管理后台视频列表查询:")
try:
    query = session.query(BilibiliVideo, BilibiliUp).join(
        BilibiliUp, BilibiliVideo.uid == BilibiliUp.uid
    ).order_by(BilibiliVideo.pubdate.desc())
    
    total = query.count()
    print(f"   ✅ 查询成功，总记录数: {total}")
    
    results = query.limit(5).all()
    print(f"   ✅ 成功获取前5条记录")
    
    # 测试to_dict
    for video, up in results:
        try:
            video_dict = video.to_dict()
            video_dict['up_name'] = up.name
            print(f"   ✅ {video.bvid}: {video_dict.get('title', '')[:30]}...")
        except Exception as e:
            print(f"   ❌ to_dict失败 ({video.bvid}): {e}")
            
except Exception as e:
    print(f"   ❌ 查询失败: {e}")
    import traceback
    traceback.print_exc()

# 3. 检查数据新鲜度
print("\n检查数据新鲜度:")
from datetime import datetime
ups = session.query(BilibiliUp).filter_by(is_active=True).limit(5).all()
now = datetime.now()
for up in ups:
    if up.last_fetch_at:
        age_hours = (now - up.last_fetch_at).total_seconds() / 3600
        print(f"   {up.name}: {age_hours:.1f} 小时前更新")
    else:
        print(f"   {up.name}: 从未更新")

session.close()
print("\n" + "=" * 60)
print("诊断完成")
print("=" * 60)
PYEOF

# 4. 执行测试
python3 test_bilibili_diagnosis.py
```

## 方法2: 通过浏览器开发者工具查看错误（最简单）

**无需SSH，直接在浏览器中查看：**

1. **打开管理后台页面**:
   - 访问 `https://admin123.gradmotion.com/admin/bilibili`
   - 登录后点击"视频列表"标签

2. **打开开发者工具**:
   - 按 `F12` 或右键 → "检查"
   - 切换到 `Network`（网络）标签

3. **查看失败的请求**:
   - 点击"视频列表"后，在Network标签中找到失败的请求
   - 通常是 `/api/admin/bilibili/videos` 这个请求
   - 点击该请求，查看：
     - **Status**: HTTP状态码（如500、401等）
     - **Response**: 响应内容（错误信息）
     - **Preview**: 格式化后的响应

4. **截图或复制错误信息**:
   - 将错误信息发给我，我可以准确定位问题

## 方法3: 使用curl测试API（如果SSH可用）

```bash
# SSH登录服务器后执行
cd /srv/EmbodiedPulse2026

# 测试前端API（不需要认证）
curl -s "http://localhost:5001/api/bilibili/all?force=1" | python3 -m json.tool | head -50

# 测试管理后台API（需要认证token）
# 先获取token（从浏览器开发者工具的请求头中复制）
TOKEN="your-token-here"
curl -s -H "Authorization: Bearer $TOKEN" "http://localhost:5001/api/admin/bilibili/videos?page=1&per_page=20" | python3 -m json.tool
```

## 方法4: 查看服务器日志

```bash
# SSH登录服务器后执行
cd /srv/EmbodiedPulse2026

# 查看应用日志
tail -100 app.log | grep -i "bilibili\|error\|exception" | tail -30

# 查看systemd日志
journalctl -u embodiedpulse --since "24 hours ago" --no-pager | grep -i "bilibili\|error\|exception" | tail -30
```

## 推荐流程

1. **先使用方法2**（浏览器开发者工具）- 最快，无需SSH
2. **如果SSH可用，使用方法1**（创建测试脚本）- 最全面
3. **如果SSH可用，使用方法4**（查看日志）- 了解历史错误

请告诉我：
- 浏览器开发者工具中看到的错误信息
- 或者测试脚本的输出结果
- 或者日志中的错误信息

这样我就能准确定位问题并修复！

